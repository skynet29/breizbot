!function(t){var e=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},n=10;function i(){this._events={},this._conf&&o.call(this,this._conf)}function o(e){e?(this._conf=e,e.delimiter&&(this.delimiter=e.delimiter),this._maxListeners=e.maxListeners!==t?e.maxListeners:n,e.wildcard&&(this.wildcard=e.wildcard),e.newListener&&(this.newListener=e.newListener),e.verboseMemoryLeak&&(this.verboseMemoryLeak=e.verboseMemoryLeak),this.wildcard&&(this.listenerTree={})):this._maxListeners=n}function s(t,e){var n="(node) warning: possible EventEmitter memory leak detected. "+t+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(n+=" Event name: "+e+"."),"undefined"!=typeof process&&process.emitWarning){var i=new Error(n);i.name="MaxListenersExceededWarning",i.emitter=this,i.count=t,process.emitWarning(i)}else console.error(n),console.trace&&console.trace()}function a(t){this._events={},this.newListener=!1,this.verboseMemoryLeak=!1,o.call(this,t)}function r(t,e,n,i){if(!n)return[];var o,s,a,l,c,p,d,f=[],u=e.length,h=e[i],m=e[i+1];if(i===u&&n._listeners){if("function"==typeof n._listeners)return t&&t.push(n._listeners),[n];for(o=0,s=n._listeners.length;o<s;o++)t&&t.push(n._listeners[o]);return[n]}if("*"===h||"**"===h||n[h]){if("*"===h){for(a in n)"_listeners"!==a&&n.hasOwnProperty(a)&&(f=f.concat(r(t,e,n[a],i+1)));return f}if("**"===h){for(a in(d=i+1===u||i+2===u&&"*"===m)&&n._listeners&&(f=f.concat(r(t,e,n,u))),n)"_listeners"!==a&&n.hasOwnProperty(a)&&("*"===a||"**"===a?(n[a]._listeners&&!d&&(f=f.concat(r(t,e,n[a],u))),f=f.concat(r(t,e,n[a],i))):f=a===m?f.concat(r(t,e,n[a],i+2)):f.concat(r(t,e,n[a],i)));return f}f=f.concat(r(t,e,n[h],i+1))}if((l=n["*"])&&r(t,e,l,i+1),c=n["**"])if(i<u)for(a in c._listeners&&r(t,e,c,u),c)"_listeners"!==a&&c.hasOwnProperty(a)&&(a===m?r(t,e,c[a],i+2):a===h?r(t,e,c[a],i+1):((p={})[a]=c[a],r(t,e,{"**":p},i+1)));else c._listeners?r(t,e,c,u):c["*"]&&c["*"]._listeners&&r(t,e,c["*"],u);return f}a.EventEmitter2=a,a.prototype.delimiter=".",a.prototype.setMaxListeners=function(e){e!==t&&(this._maxListeners=e,this._conf||(this._conf={}),this._conf.maxListeners=e)},a.prototype.event="",a.prototype.once=function(t,e){return this._once(t,e,!1)},a.prototype.prependOnceListener=function(t,e){return this._once(t,e,!0)},a.prototype._once=function(t,e,n){return this._many(t,1,e,n),this},a.prototype.many=function(t,e,n){return this._many(t,e,n,!1)},a.prototype.prependMany=function(t,e,n){return this._many(t,e,n,!0)},a.prototype._many=function(t,e,n,i){var o=this;if("function"!=typeof n)throw new Error("many only accepts instances of Function");function s(){return 0==--e&&o.off(t,s),n.apply(this,arguments)}return s._origin=n,this._on(t,s,i),o},a.prototype.emit=function(){this._events||i.call(this);var t=arguments[0];if("newListener"===t&&!this.newListener&&!this._events.newListener)return!1;var e,n,o,s,a,l=arguments.length;if(this._all&&this._all.length){if(a=this._all.slice(),l>3)for(e=new Array(l),s=0;s<l;s++)e[s]=arguments[s];for(o=0,n=a.length;o<n;o++)switch(this.event=t,l){case 1:a[o].call(this,t);break;case 2:a[o].call(this,t,arguments[1]);break;case 3:a[o].call(this,t,arguments[1],arguments[2]);break;default:a[o].apply(this,e)}}if(this.wildcard){a=[];var c="string"==typeof t?t.split(this.delimiter):t.slice();r.call(this,a,c,this.listenerTree,0)}else{if("function"==typeof(a=this._events[t])){switch(this.event=t,l){case 1:a.call(this);break;case 2:a.call(this,arguments[1]);break;case 3:a.call(this,arguments[1],arguments[2]);break;default:for(e=new Array(l-1),s=1;s<l;s++)e[s-1]=arguments[s];a.apply(this,e)}return!0}a&&(a=a.slice())}if(a&&a.length){if(l>3)for(e=new Array(l-1),s=1;s<l;s++)e[s-1]=arguments[s];for(o=0,n=a.length;o<n;o++)switch(this.event=t,l){case 1:a[o].call(this);break;case 2:a[o].call(this,arguments[1]);break;case 3:a[o].call(this,arguments[1],arguments[2]);break;default:a[o].apply(this,e)}return!0}if(!this._all&&"error"===t)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},a.prototype.emitAsync=function(){this._events||i.call(this);var t=arguments[0];if("newListener"===t&&!this.newListener&&!this._events.newListener)return Promise.resolve([!1]);var e,n,o,s,a,l=[],c=arguments.length;if(this._all){if(c>3)for(e=new Array(c),s=1;s<c;s++)e[s]=arguments[s];for(o=0,n=this._all.length;o<n;o++)switch(this.event=t,c){case 1:l.push(this._all[o].call(this,t));break;case 2:l.push(this._all[o].call(this,t,arguments[1]));break;case 3:l.push(this._all[o].call(this,t,arguments[1],arguments[2]));break;default:l.push(this._all[o].apply(this,e))}}if(this.wildcard){a=[];var p="string"==typeof t?t.split(this.delimiter):t.slice();r.call(this,a,p,this.listenerTree,0)}else a=this._events[t];if("function"==typeof a)switch(this.event=t,c){case 1:l.push(a.call(this));break;case 2:l.push(a.call(this,arguments[1]));break;case 3:l.push(a.call(this,arguments[1],arguments[2]));break;default:for(e=new Array(c-1),s=1;s<c;s++)e[s-1]=arguments[s];l.push(a.apply(this,e))}else if(a&&a.length){if(a=a.slice(),c>3)for(e=new Array(c-1),s=1;s<c;s++)e[s-1]=arguments[s];for(o=0,n=a.length;o<n;o++)switch(this.event=t,c){case 1:l.push(a[o].call(this));break;case 2:l.push(a[o].call(this,arguments[1]));break;case 3:l.push(a[o].call(this,arguments[1],arguments[2]));break;default:l.push(a[o].apply(this,e))}}else if(!this._all&&"error"===t)return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(l)},a.prototype.on=function(t,e){return this._on(t,e,!1)},a.prototype.prependListener=function(t,e){return this._on(t,e,!0)},a.prototype.onAny=function(t){return this._onAny(t,!1)},a.prototype.prependAny=function(t){return this._onAny(t,!0)},a.prototype.addListener=a.prototype.on,a.prototype._onAny=function(t,e){if("function"!=typeof t)throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),e?this._all.unshift(t):this._all.push(t),this},a.prototype._on=function(e,n,o){if("function"==typeof e)return this._onAny(e,n),this;if("function"!=typeof n)throw new Error("on only accepts instances of Function");return this._events||i.call(this),this.emit("newListener",e,n),this.wildcard?(function(e,n){for(var i=0,o=(e="string"==typeof e?e.split(this.delimiter):e.slice()).length;i+1<o;i++)if("**"===e[i]&&"**"===e[i+1])return;for(var a=this.listenerTree,r=e.shift();r!==t;){if(a[r]||(a[r]={}),a=a[r],0===e.length)return a._listeners?("function"==typeof a._listeners&&(a._listeners=[a._listeners]),a._listeners.push(n),!a._listeners.warned&&this._maxListeners>0&&a._listeners.length>this._maxListeners&&(a._listeners.warned=!0,s.call(this,a._listeners.length,r))):a._listeners=n,!0;r=e.shift()}return!0}.call(this,e,n),this):(this._events[e]?("function"==typeof this._events[e]&&(this._events[e]=[this._events[e]]),o?this._events[e].unshift(n):this._events[e].push(n),!this._events[e].warned&&this._maxListeners>0&&this._events[e].length>this._maxListeners&&(this._events[e].warned=!0,s.call(this,this._events[e].length,e))):this._events[e]=n,this)},a.prototype.off=function(n,i){if("function"!=typeof i)throw new Error("removeListener only takes instances of Function");var o,s=[];if(this.wildcard){var a="string"==typeof n?n.split(this.delimiter):n.slice();s=r.call(this,null,a,this.listenerTree,0)}else{if(!this._events[n])return this;o=this._events[n],s.push({_listeners:o})}for(var l=0;l<s.length;l++){var c=s[l];if(o=c._listeners,e(o)){for(var p=-1,d=0,f=o.length;d<f;d++)if(o[d]===i||o[d].listener&&o[d].listener===i||o[d]._origin&&o[d]._origin===i){p=d;break}if(p<0)continue;return this.wildcard?c._listeners.splice(p,1):this._events[n].splice(p,1),0===o.length&&(this.wildcard?delete c._listeners:delete this._events[n]),this.emit("removeListener",n,i),this}(o===i||o.listener&&o.listener===i||o._origin&&o._origin===i)&&(this.wildcard?delete c._listeners:delete this._events[n],this.emit("removeListener",n,i))}return function e(n){if(n!==t){var i=Object.keys(n);for(var o in i){var s=i[o],a=n[s];a instanceof Function||"object"!=typeof a||null===a||(Object.keys(a).length>0&&e(n[s]),0===Object.keys(a).length&&delete n[s])}}}(this.listenerTree),this},a.prototype.offAny=function(t){var e,n=0,i=0;if(t&&this._all&&this._all.length>0){for(n=0,i=(e=this._all).length;n<i;n++)if(t===e[n])return e.splice(n,1),this.emit("removeListenerAny",t),this}else{for(n=0,i=(e=this._all).length;n<i;n++)this.emit("removeListenerAny",e[n]);this._all=[]}return this},a.prototype.removeListener=a.prototype.off,a.prototype.removeAllListeners=function(t){if(0===arguments.length)return!this._events||i.call(this),this;if(this.wildcard)for(var e="string"==typeof t?t.split(this.delimiter):t.slice(),n=r.call(this,null,e,this.listenerTree,0),o=0;o<n.length;o++){n[o]._listeners=null}else this._events&&(this._events[t]=null);return this},a.prototype.listeners=function(t){if(this.wildcard){var n=[],o="string"==typeof t?t.split(this.delimiter):t.slice();return r.call(this,n,o,this.listenerTree,0),n}return this._events||i.call(this),this._events[t]||(this._events[t]=[]),e(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]},a.prototype.eventNames=function(){return Object.keys(this._events)},a.prototype.listenerCount=function(t){return this.listeners(t).length},a.prototype.listenersAny=function(){return this._all?this._all:[]},"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof exports?module.exports=a:window.EventEmitter2=a}(),$$.control.registerControl("breizbot.appTab",{props:{appUrl:"about:blank"},template:'<iframe bn-attr="{src: appUrl}" bn-bind="iframe" bn-event="load: onFrameLoaded"></iframe>',init:function(t){const{appUrl:e}=this.props,n=$$.viewController(t,{data:{appUrl:e},events:{onFrameLoaded:function(){console.log("onFrameLoaded")}}});this.onAppExit=function(){console.log("[appTab] onAppExit",n.model.appUrl);const t=$(n.scope.iframe.get(0).contentWindow.document).find(".rootPage").iface();return t&&"function"==typeof t.onAppExit?t.onAppExit():Promise.resolve()},this.onAppSuspend=function(){console.log("[appTab] onAppSuspend",n.model.appUrl);const t=$(n.scope.iframe.get(0).contentWindow.document).find(".rootPage").iface();t&&"function"==typeof t.onAppSuspend&&t.onAppSuspend()},this.onAppResume=function(){console.log("[appTab] onAppResume",n.model.appUrl);const t=$(n.scope.iframe.get(0).contentWindow.document).find(".rootPage").iface();t&&"function"==typeof t.onAppResume&&t.onAppResume()},this.setAppUrl=function(t){console.log("[appTab] setAppUrl",t),n.setData({appUrl:t+"&date="+Date.now()})}}}),$$.control.registerControl("breizbot.apps",{props:{apps:[],showActivated:!1},$iface:"setData(data)",template:'<div class="scrollPanel">\n\t<div bn-each="apps" bn-iter="app" class="main" bn-event="click.tile: onTileClick">\t\t\t\n\t\t<div bn-attr="{class: `tile w3-btn ${app.props.colorCls}`}" bn-data="{item: app}">\n\t\t\t<div class="arrow-right" bn-show="showActivated && app.activated"></div>\n\t\t\t<div bn-show="typeof app.props.iconCls == \'string\'" style="margin-bottom: 5px;">\n\t\t\t\t<i bn-attr="{class: app.props.iconCls}"></i>\n\t\t\t</div>\n\n\t\t\t<span bn-text="app.props.title"></span>\n\t\t</div>\n\n\t</div>\n</div>',init:function(t){const{apps:e,showActivated:n}=this.props,i=$$.viewController(t,{data:{apps:e,showActivated:n},events:{onTileClick:function(e){t.trigger("appclick",$(this).data("item"))}}});this.setData=function(t){i.setData({apps:t.apps.filter(t=>0!=t.props.visible&&"template"!=t.appName)})}},$iface:"setData(data)",$events:"appclick"}),$$.control.registerControl("breizbot.contacts",{deps:["breizbot.users"],props:{showSelection:!1,showDeleteButton:!1},template:'<p bn-show="contacts.length == 0">You have no contacts</p>\n<ul class="w3-ul w3-border w3-white" \n\tbn-event="click.w3-bar: onItemClick, click.delete: onDeleteItem"\n\tbn-each="contacts"\n\tbn-show="contacts.length > 0"\n\t>\n\t<li class="w3-bar" bn-data="{item: $i}">\n\t\t<span class="w3-button w3-right delete" title="Delete" bn-show="showDeleteButton"><i class="fa fa-trash"></i></span>\n\n\t\t<div class="w3-bar-item">\n\t\t\t<i class="fa fa-user w3-text-blue"></i>\n\t\t\t<strong bn-text="$i.contactName"></strong><br>\n\t\t\t<i class="fa fa-envelope w3-text-blue"></i>\n\t\t\t<span bn-text="$i.contactEmail"></span>\n\t\t</div>\n\t</li>\n</ul>\t\t\n',init:function(t,e){const{showSelection:n,showDeleteButton:i}=this.props,o=$$.viewController(t,{data:{contacts:[],showDeleteButton:i},events:{onItemClick:function(){const e=$(this).data("item");console.log("onItemClick",e),n&&$(this).toggleClass("w3-blue"),t.trigger("contactclick",e)},onDeleteItem:function(t){t.stopPropagation();const n=$(this).closest("li").data("item");console.log("onDeleteItem",n),e.removeContact(n._id).then(s)}}});function s(){e.getContacts().then(t=>{console.log("contacts",t),o.setData({contacts:t})})}s(),this.update=s,this.getSelection=function(){const e=[];return t.find("li.w3-blue").each(function(){e.push($(this).data("item"))}),console.log("ret",e),e}}}),$$.control.registerControl("breizbot.files",{deps:["breizbot.files"],props:{$pager:null,cmd:"",showToolbar:!1,imageOnly:!1,filterExtension:void 0,showThumbnail:!1,thumbnailSize:"?x100",maxUploadSize:4124672},template:'<div class="contentPanel">\n\n\t<div class="toolbar" bn-show="showToolbar">\n\t\t<div bn-control="brainjs.controlgroup">\n\t\t\t<button \n\t\t\t\ttitle="New folder"\n\t\t\t\tbn-event="click: onCreateFolder"\n\t\t\t><i class="fa fa-folder-open"></i></button>\t\t\n\n\t\t\t<button \n\t\t\t\ttitle="Import file"\n\t\t\t\tbn-event="click: onImportFile"\n\t\t\t><i class="fa fa-upload"></i></button>\t\t\n\n\t\t\t<button \n\t\t\t\ttitle="Download selected file"\n\t\t\t\tbn-event="click: onDownloadFile"\n\t\t\t\tbn-prop="{disabled: nbSelection != 1 || !isFile}"\n\t\t\t><i class="fa fa-download"></i></button>\t\t\n\n\t\n\t\t</div>\n\n\t\t<div bn-control="brainjs.controlgroup">\n\t\t\t<button \n\t\t\t\ttitle="Toggle Select Mode"\n\t\t\t\tbn-event="click: onToggleSelMode"\n\t\t\t><i class="fa fa-check"></i></button>\n\n\t\t\t<button \n\t\t\t\ttitle="Reload"\n\t\t\t\tbn-event="click: onReload"\n\t\t\t><i class="fa fa-sync-alt"></i></button>\t\n\t\t</div>\n\n\t\t<div bn-control="brainjs.controlgroup">\n\t\t\t<button title="Delete"\n\t\t\t\tbn-event="click: onDeleteFiles"\n\t\t\t\tbn-prop="{disabled: nbSelection == 0}"\n\t\t\t><i class="fa fa-trash"></i></button>\n\n\t\t\t<button title="Cut"\n\t\t\t\tbn-prop="{disabled: nbSelection == 0}"\n\t\t\t\tbn-event="click: onCutFiles"\n\t\t\t><i class="fa fa-cut"></i></button>\t\n\n\t\t\t<button title="Copy"\n\t\t\t\tbn-prop="{disabled: nbSelection == 0}"\n\t\t\t\tbn-event="click: onCopyFiles"\n\t\t\t\t><i class="fa fa-copy"></i></button>\n\n\t\t\t<button title="Share"\n\t\t\t\tbn-prop="{disabled: nbSelection == 0 || rootDir.startsWith(\'/share/\') || isShareSelected}"\n\t\t\t\tbn-event="click: onShareFiles"\n\t\t\t\t><i class="fa fa-share-alt"></i></button>\n\n\t\t\t<button title="Paste"\n\t\t\t\tbn-prop="{disabled:  selectedFiles.length == 0}"\n\t\t\t\tbn-event="click: onPasteFiles"\n\t\t\t><i class="fa fa-paste"></i></button>\t\t\n\t\t</div>\n\t</div>\n\n\t<div class="pathPanel">\n\t\tPath:&nbsp;<span bn-text="rootDir"></span>\n\t</div>\n\n\t<div class="scrollPanel">\n\n\t\t<div bn-each="files" \n\t\t\tbn-iter="f" \n\t\t\tclass="container"\n\t\t\tbn-bind="files" \n\t\t\tbn-event="click.folder: onFolderClick, click.check: onCheckClick, click.file: onFileClick">\n\t\t\t\n\t\t\t<div class="thumbnail w3-btn" bn-data="{info: f}">\t\n\t\t\t\t\t<input type="checkbox" bn-show="selectMode && f.name != \'..\'" class="check w3-check">\t\t\n\t\t\t\t\t<div bn-if="f.folder" class="folder">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<i class="fa fa-4x fa-folder-open w3-text-blue-grey"></i>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<span bn-text="f.name"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div bn-if="!f.folder && (!f.isImage || !showThumbnail)" bn-attr="{title: f.name + \'\\n\' + getSize(f.size)}" class="file">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<i bn-attr="{class: `fa fa-4x w3-text-blue-grey ${getIconClass(f.name)}`}"></i>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<span bn-text="f.name.slice(0, 20)"></span>\n\t\t\t\t\t</div>\t\t\t\n\n\t\t\t\t\t<div bn-if="!f.folder && f.isImage && showThumbnail" bn-attr="{title: f.name + \'\\n\' + getSize(f.size)}" class="file">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<img bn-attr="{src: f.thumbnailUrl}">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<span bn-text="f.name.slice(0, 20)"></span>\n\t\t\t\t\t</div>\t\n\t\t\t\t\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>',init:function(t,e){const{$pager:n,cmd:i,showToolbar:o,maxUploadSize:s,filterExtension:a,imageOnly:r,thumbnailSize:l,showThumbnail:c}=this.props,p=$$.viewController(t,{data:{isFile:!1,showThumbnail:c,thumbnailSize:l,showToolbar:o,rootDir:"/",selectMode:!1,files:[],selectedFiles:[],operation:"none",nbSelection:0,isShareSelected:!1,getSize:function(t){let e="Ko";return(t/=1024)>1024&&(e="Mo",t/=1024),"Size : "+Math.floor(t)+" "+e},getIconClass:function(t){return t.endsWith(".pdf")?"fa-file-pdf":t.endsWith(".doc")?"fa-file-word":t.endsWith(".ogg")||t.endsWith(".mp3")?"fa-file-audio":t.endsWith(".mp4")?"fa-file-video":"fa-file"}},events:{onReload:function(t){u()},onFileClick:function(e){const o=$(this).closest(".thumbnail").data("info"),s={fileName:o.name,rootDir:p.model.rootDir,isImage:o.isImage,cmd:i};null!=n?n.popPage(s):t.trigger("fileclick",s)},onCheckClick:function(e){console.log("onCheckClick"),"share"==$(this).closest(".thumbnail").data("info").name&&"/"==p.model.rootDir&&(p.model.isShareSelected=$(this).getValue());const n=t.find(".check:checked"),i=n.length;let o=!1;if(1==i){o=!n.closest(".thumbnail").data("info").folder}p.setData({nbSelection:i,isFile:o})},onFolderClick:function(t){const e=$(this).closest(".thumbnail").data("info").name;if(".."==e){const t=p.model.rootDir.split("/");t.pop(),t.pop(),u(t.join("/")+"/")}else u(p.model.rootDir+e+"/")},onCreateFolder:function(){var t=p.model.rootDir;$$.ui.showPrompt({content:"Folder name:",title:"New Folder"},function(n){e.mkdir(t+n).then(function(t){console.log("resp",t),u()}).catch(function(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})})})},onToggleSelMode:function(){console.log("onToggleSelMode"),d(!p.model.selectMode)},onDeleteFiles:function(t){const n=f();0!=n.length?$$.ui.showConfirm({content:"Are you sure ?",title:"Delete files"},function(){e.removeFiles(n).then(function(t){console.log("resp",t),u()}).catch(function(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})})}):$$.ui.showAlert({title:"Delete files",content:"No files selected"})},onCutFiles:function(t){console.log("onCutFiles"),p.setData({selectedFiles:f(),operation:"cut"}),d(!1)},onCopyFiles:function(t){console.log("onCopyFiles"),p.setData({selectedFiles:f(),operation:"copy"}),d(!1)},onShareFiles:function(t){console.log("onShareFiles"),e.shareFiles(f()).then(function(t){console.log("resp",t),p.setData({selectedFiles:[],operation:"none"}),u()}).catch(function(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})})},onPasteFiles:function(t){console.log("onPasteFiles");const{rootDir:n,selectedFiles:i,operation:o}=p.model;("copy"==o?e.copyFiles(i,n):e.moveFiles(i,n)).then(function(t){console.log("resp",t),p.setData({selectedFiles:[],operation:"none"}),u()}).catch(function(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})})},onImportFile:function(t){$$.util.openFileDialog(function(t){t.size>s?$$.ui.showAlert({content:"File too big",title:"Import file"}):$$.util.readFileAsDataURL(t,function(n){const i=$$.util.dataURLtoBlob(n);e.uploadFile(i,t.name,p.model.rootDir).then(function(){u()}).catch(function(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})})})})},onDownloadFile:function(n){const i=t.find(".check:checked").closest(".thumbnail").data("info");console.log("onDownloadFile",i);const{rootDir:o}=p.model,s=document.createElement("a");s.href=e.fileUrl(o+i.name),s.download=i.name,s.click()}}});function d(t){0==t&&(p.model.nbSelection=0),p.model.selectMode=t,p.forceUpdate("files")}function f(){const e=[];return t.find(".check:checked").each(function(){const t=$(this).closest(".thumbnail").data("info");e.push(p.model.rootDir+t.name)}),console.log("selFiles",e),e}function u(t){null==t&&(t=p.model.rootDir),e.list(t,{filterExtension:a,imageOnly:r}).then(function(n){console.log("files",n),n.forEach(n=>{n.isImage&&(n.thumbnailUrl=e.fileThumbnailUrl(t+n.name,l))}),n.sort((t,e)=>t.folder&&!e.folder?-1:!t.folder&&e.folder?1:t.name>e.name),"/"!=t&&n.unshift({name:"..",folder:!0}),p.setData({files:n,rootDir:t,selectMode:!1,hasSelection:!1,nbSelection:0,isShareSelected:!1})})}u(),this.update=function(){console.log("[FileCtrl] update"),u()}},$iface:"update()",$events:"fileclick"}),$$.control.registerControl("breizbot.friends",{props:{showSelection:!1,showSendMessage:!1,showConnectionState:!0},deps:["breizbot.users","breizbot.broker"],template:'<ul class="w3-ul w3-border w3-white" \n\tbn-each="friends" bn-show="friends.length > 0" bn-event="click.w3-bar: onItemClick, click.notif: onSendMessage">\n\t<li class="w3-bar" bn-data="{item: $i}" style="cursor: pointer;">\n\t\t<span class="w3-button w3-right notif w3-blue" title="Send Message" bn-show="showSendMessage"><i class="fa fa-envelope"></i></span>\n\n\t\t<div class="w3-bar-item">\n\t\t\t<i class="fa fa-user" bn-class="{\n\t\t\t\t\'w3-text-green\': $i.isConnected && showConnectionState,\n\t\t\t\t\'w3-text-red\': !$i.isConnected && showConnectionState,\n\t\t\t\t\'w3-text-blue\': !showConnectionState\n\t\t\t}"></i>\n\t\t\t<span bn-text="$i.friendUserName"></span>\n\t\t</div>\n\t</li>\n</ul>\t\n<p bn-show="friends.length == 0">You have no friends</p>',init:function(t,e,n){const{showSelection:i,showSendMessage:o,showConnectionState:s}=this.props,a=$$.viewController(t,{data:{friends:[],showSendMessage:o,showConnectionState:s},events:{onItemClick:function(){const e=$(this).data("item").friendUserName;i&&($(this).siblings(".w3-blue").removeClass("w3-blue"),$(this).addClass("w3-blue")),t.trigger("friendclick",{userName:e})},onSendMessage:function(t){t.stopPropagation();const n=$(this).closest("li").data("item").friendUserName;$$.ui.showPrompt({title:"Send Message",label:"Message:"},function(t){e.sendNotif(n,{text:t,reply:!0})})}}});function r(t){if(!0===t.hist)return;const{isConnected:e,userName:n}=t.data;a.model.friends.find(t=>t.friendUserName==n).isConnected=e,a.update()}n.register("breizbot.friends",r),this.getSelection=function(){return t.find("li.w3-blue").data("item")},this.getFriends=function(){return a.model.friends.map(t=>t.friendUserName)},this.update=function(){e.getFriends().then(t=>{console.log("friends",t),a.setData({friends:t})})},this.dispose=function(){console.log("[friends] dispose"),n.unregister("breizbot.friends",r)},this.update()},$iface:"\n\t\tgetSelection():string;\n\t\tgetFriends():[string]\n\t",$events:"friendclick"}),$$.control.registerControl("breizbot.home",{deps:["breizbot.broker","breizbot.users","breizbot.rtc","breizbot.apps"],props:{userName:"Unknown"},template:'<div class="header w3-teal">\n\t<div>\n\t\t<button class="w3-button" title="FullScreen" bn-event="click: onFullScreen" bn-show="!fullScreen">\n\t\t\t<i class="fa fa-expand"></i></button>\n\t\t<div bn-show="hasIncomingCall" \n\t\t\tbn-control="brainjs.contextmenu"\n\t\t\tbn-event="contextmenuchange: onCallResponse"\n\t\t\tbn-data="{\n\t\t\t\ttrigger: \'left\', \n\t\t\t\ttitle: (callInfo && callInfo.from) || \'\' ,\n\t\t\t\titems: {\n\t\t\t\t\taccept: {name: \'Accept\'},\n\t\t\t\t\tdeny: {name: \'Decline\'},\n\t\t\t\t}\n\t\t\t}"\n\t\t\tclass="w3-button">\n\t\t\t<i class="fa fa-spinner fa-pulse"></i>\n\t\t\t<i bn-attr="{class: callInfo && callInfo.iconCls}"></i>\n\t\t</div>\n\t</div>\n\n\n\x3c!-- \t<strong bn-text="title"></strong>\n --\x3e\n\t<div>\n\t\t<button class="notification w3-button" title="Notification" bn-event="click: onNotification">\n\t\t\t<i class="fa fa-lg fa-bell w3-text-white" ></i>\n\t\t\t<span class="w3-badge w3-red w3-tiny" bn-text="nbNotif" bn-show="nbNotif > 0"></span>\t\t\t\n\t\t</button>\n\n\n\n\t\t<div bn-control="brainjs.contextmenu" \n\t\t\tbn-data="{\n\t\t\t\titems: {\n\t\t\t\t\tpwd: {name: \'Change password\', icon: \'fas fa-lock\'},\n\t\t\t\t\tapps: {name: \'Applications\', icon: \'fas fa-th\'},\n\t\t\t\t\tsep: \'------\',\n\t\t\t\t\tlogout: {name: \'Logout\', icon: \'fas fa-power-off\'}\n\t\t\t\t},\n\t\t\t\ttitle: userName\n\t\t\t}" \n\t\t\tdata-trigger="left" \n\t\t\tclass="w3-button" \n\t\t\tbn-event="contextmenuchange: onContextMenu">\n\t\t\t\t<i class="fa fa-user fa-lg"></i>\n\x3c!-- \t\t\t\t<span bn-text="userName"></span>\t\n --\x3e\t\t\t\t<i class="fa fa-angle-down fa-lg"></i>\n    \t\n\t\t</div>\n\t\t\n\t</div>\n\n\t\n</div>\n\n<div bn-control="brainjs.tabs" \n\tclass="content" \n\tbn-iface="tabs" \n\tbn-event="tabsremove: onTabRemove, tabsactivate: onTabActivate">\n\t<div bn-control="breizbot.apps" \n\t\tbn-data="{apps: getMyApps()}"\n\t\tbn-event="appclick: onAppClick"\n\t\ttitle="Home" \n\t\t>\t\t\n\t</div>\n\t\n</div>\n',init:function(t,e,n,i,o){const{userName:s}=this.props,a=function(){let t=null;return{play:function(){(t=new Audio("/assets/skype.mp3")).loop=!0,setTimeout(()=>{t.play()},100)},stop:function(){null!=t&&t.pause(),t=null}}}(),r=$$.viewController(t,{data:{apps:[],userName:s,nbNotif:0,hasIncomingCall:!1,callInfo:null,fullScreen:!1,getMyApps:function(){return apps.filter(t=>t.activated)}},events:{onAppClick:function(t,e){console.log("onAppClick",e),c(e.appName)},onContextMenu:function(t,e){console.log("onContextMenu",e),"logout"==e.cmd&&(location.href="/logout"),"apps"==e.cmd&&c("store"),"pwd"==e.cmd&&$$.ui.showPrompt({title:"Change Password",label:"New Password:"},function(t){n.changePwd(t).then(()=>{$$.ui.showAlert({title:"Change Password",content:"Password has been changed"})}).catch(t=>{$$.ui.showAlert({title:"Error",content:t.responseText})})})},onNotification:function(t){console.log("onNotification"),0==r.model.nbNotif?$$.ui.showAlert({content:"no notifications",title:"Notifications"}):c("notif")},onCallResponse:function(t,e){const{cmd:n}=e;if(console.log("onCallResponse",e),r.setData({hasIncomingCall:!1}),a.stop(),"accept"==n){const{from:t,appName:e}=r.model.callInfo;c(e,{caller:t,clientId:i.getRemoteClientId()})}"deny"==n&&i.deny()},onFullScreen:function(t){console.log("onFullScreen");const e=document.documentElement,n=e.requestFullscreen||e.webkitRequestFullscreen;n&&n.call(e)},onTabRemove:function(t,e){console.log("onTabRemove",e);const n=r.scope.tabs.getTabInfo(e);console.log("info",n),n.ctrlIface.onAppExit().then(()=>{r.scope.tabs.removeTab(e)})},onTabActivate:function(t,e){console.log("onTabActivate");const{newTab:n,oldTab:i}=e,o=n.index(),s=i.index();if(s>0){r.scope.tabs.getTabInfo(s).ctrlIface.onAppSuspend()}if(o>0){r.scope.tabs.getTabInfo(o).ctrlIface.onAppResume()}0==o&&p()}}});function l(t){r.setData({nbNotif:t})}function c(t,e){const n=r.model.apps.find(e=>e.appName==t).props.title;console.log("openApp",t,e);let i=r.scope.tabs.getTabIndexFromTitle(n);const o=function(t,e){return $$.util.getUrlParams(`/apps/${t}`,e)}(t,e);if(i<0)i=r.scope.tabs.addTab(n,{removable:!0,control:"breizbot.appTab",props:{appUrl:o}});else{const t=r.scope.tabs.getTabInfo(i);null!=e&&t.ctrlIface.setAppUrl(o)}r.scope.tabs.setSelectedTabIndex(i)}function p(){o.listAll().then(t=>{r.setData({apps:t})})}document.addEventListener("webkitfullscreenchange",function(t){console.log("fullscreenchange",t),r.setData({fullScreen:!r.model.fullScreen})}),document.addEventListener("fullscreenchange",function(t){console.log("fullscreenchange",t),r.setData({fullScreen:!r.model.fullScreen})}),e.register("breizbot.notifCount",function(t){l(t.data)}),e.register("breizbot.rtc.call",function(t){!0!==t.hist&&(console.log("msg",t),r.setData({hasIncomingCall:!0,callInfo:t.data}),i.setRemoteClientId(t.srcId),a.play())}),e.register("breizbot.rtc.cancel",function(t){!0!==t.hist&&(console.log("msg",t),r.setData({hasIncomingCall:!1}),a.stop())}),n.getNotifCount().then(l),p()}}),$$.control.registerControl("breizbot.media",{deps:["breizbot.media"],template:'<div class="contentPanel">\n\n\t<div class="toolbar" bn-show="drives.length > 0">\n\n\t\t<select \n\t\t\tbn-control="brainjs.selectmenu"\n\t\t\tbn-data="{items: drives}"\n\n\t\t></select>\n\t\t\n\t</div>\n\n\t<div bn-show="drives.length == 0 && errorMsg == \'\'">\n\t\tNo devices connected to your Homebox !\n\t</div>\n\n\t<div>\n\t\t<span bn-text="errorMsg" class="w3-text-red"></span>\n\t</div>\n\n\t<div class="pathPanel" bn-show="drives.length > 0">\n\t\tPath:&nbsp;<span bn-text="rootDir"></span>\n\t</div>\n\n\t<div class="scrollPanel">\n\n\t\t<div bn-each="files" \n\t\t\tbn-iter="f" \n\t\t\tclass="container"\n\t\t\tbn-bind="files" \n\t\t\tbn-event="click.folder: onFolderClick, click.file: onFileClick">\n\t\t\t\n\t\t\t<div class="thumbnail w3-btn" bn-data="{info: f}">\t\n\t\t\t\t\t<div bn-if="f.folder" class="folder">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<i class="fa fa-4x fa-folder-open w3-text-blue-grey"></i>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<span bn-text="f.name"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div bn-if="!f.folder" bn-attr="{title: f.name + \'\\n\' + getSize(f.size)}" class="file">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<i bn-attr="{class: `fa fa-4x w3-text-blue-grey ${getIconClass(f.name)}`}"></i>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<span bn-text="f.name.slice(0, 20)"></span>\n\t\t\t\t\t</div>\t\t\t\n\t\t\t\t\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>',init:function(t,e){const n=$$.viewController(t,{data:{rootDir:"/",files:[],drives:[],errorMsg:"",currentDrive:"",getSize:function(t){let e="Ko";return(t/=1024)>1024&&(e="Mo",t/=1024),"Size : "+Math.floor(t)+" "+e},getIconClass:function(t){return t.endsWith(".pdf")?"fa-file-pdf":t.endsWith(".doc")?"fa-file-word":t.endsWith(".ogg")||t.endsWith(".mp3")?"fa-file-audio":t.endsWith(".mp4")?"fa-file-video":"fa-file"}},events:{onFileClick:function(e){const i=$(this).closest(".thumbnail").data("info"),o={driveName:n.model.currentDrive,fileName:i.name,rootDir:n.model.rootDir};t.trigger("fileclick",o)},onFolderClick:function(t){const e=$(this).closest(".thumbnail").data("info").name;if(".."==e){const t=n.model.rootDir.split("/");t.pop(),t.pop(),i(t.join("/")+"/")}else i(n.model.rootDir+e+"/")}}});function i(t){null==t&&(t=n.model.rootDir),e.list(n.model.currentDrive,t).then(function(e){console.log("files",e),e.sort((t,e)=>t.folder&&!e.folder?-1:!t.folder&&e.folder?1:t.name>e.name),"/"!=t&&e.unshift({name:"..",folder:!0}),n.setData({files:e,rootDir:t})})}e.drive().then(function(t){if(0==t.length)return;const e=t[0];n.setData({drives:t,currentDrive:e}),i()}).catch(t=>{n.setData({errorMsg:t.responseText})})},$iface:"update()",$events:"fileclick"}),$$.control.registerControl("breizbot.pdf",{template:'<div class="toolbar">\n\t<div bn-show="wait" class="loading">\n\t\t<i class="fa fa-spinner fa-pulse"></i> Rendering...\n\t</div>\n\t<div bn-show="!wait">\n\t\t<button \n\t\t\tclass="w3-button" \n\t\t\ttitle="Fit" \n\t\t\tbn-event="click: onFit">\n\t\t\t\t<i class="fa fa-expand"></i>\n\t\t</button>\t\t\n\t</div>\n\t<div>\n\t</div>\n\t<div class="pages" bn-show="numPages > 1 && !wait">\n\t\t<div>\n\t\t\t<button class="w3-button" title="previous page" bn-event="click: onPrevPage">\n\t\t\t\t<i class="fa fa-angle-left"></i>\n\t\t\t</button>\t\n\n\t\t\t<button class="w3-button" title="next page" bn-event="click: onNextPage">\n\t\t\t\t<i class="fa fa-angle-right"></i>\n\t\t\t</button>\t\t\t\n\t\t</div>\n\t\t<div>\n\t\t\tPages: <span bn-text="currentPage"></span> / <span bn-text="numPages"></span>\t\t\n\t\t</div>\n\t</div>\n</div>\n\t\n<div bn-control="brainjs.pdf" \n\tbn-data="{worker: \'/brainjs/pdf/worker.js\'}"\n\tbn-iface="pdf"\n\t \n></div>\t\t\n',props:{url:""},deps:["breizbot.files"],init:function(t,e){const{url:n}=this.props,i=$$.viewController(t,{data:{numPages:0,title:"",currentPage:1,wait:!1},events:{onNextPage:function(t){i.setData({wait:!0}),i.scope.pdf.nextPage().then(t=>{i.setData({currentPage:t,wait:!1})})},onPrevPage:function(t){i.setData({wait:!0}),i.scope.pdf.prevPage().then(t=>{i.setData({currentPage:t,wait:!1})})},onFit:function(t){i.scope.pdf.fit()}}});function o(t,e){i.setData({wait:!0}),i.scope.pdf.openFile(t).then(t=>{console.log("file loaded"),i.setData({title:e,numPages:t,wait:!1})})}""!=n&&o(n),this.setData=function(t){console.log("setData",t),null!=t.url&&o(t.url)}},$iface:"\n\t\tsetData({url})\n\t"}),$$.control.registerControl("breizbot.addUser",{template:'<form bn-event="submit: onSubmit">\n\t<div bn-control="brainjs.inputgroup">\n\t\t<label>UserName</label>\n\t\t<input type="text" placeholder="username" name="username" required="">\n\t</div>\n\t<div bn-control="brainjs.inputgroup">\n\t\t<label>Pseudo</label>\n\t\t<input type="text" placeholder="pseudo" name="pseudo" required>\n\t</div>\n\t<div bn-control="brainjs.inputgroup">\n\t\t<label>Location</label>\n\t\t<input type="text" placeholder="location" name="location" required>\n\t</div>\n\t<div bn-control="brainjs.inputgroup">\n\t\t<label>Email</label>\n\t\t<input type="email" placeholder="email" name="email" required>\t\n\t</div>\n\t\n\t<input type="submit" hidden="" bn-bind="submit">\n</form>\n',props:{$pager:null},buttons:[{label:"Create",name:"create"}],init:function(t){const{$pager:e}=this.props,n=$$.viewController(t,{data:{},events:{onSubmit:function(t){t.preventDefault(),e.popPage($(this).getFormData())}}});this.onAction=function(t){n.scope.submit.click()}},$iface:"\n\t\tonAction(cmd)\n\t"}),$$.control.registerControl("breizbot.users",{deps:["breizbot.users"],template:'<div class="toolbar">\n\t<button bn-event="click: onUpdate" class="w3-btn w3-blue" title="Update">\n\t\t<i class="fa fa-redo"></i>\n\t</button>\t\n\t<button bn-event="click: onAddUser" class="w3-btn w3-blue btnAddUser" title="Add User">\n\t\t<i class="fa fa-user-plus"></i>\n\t</button>\t\n</div>\n\n<div class="scrollPanel">\n    <table class="w3-table-all w3-small">\n        <thead>\n            <tr class="w3-green">\n                <th>User Name</th>\n                <th>Pseudo</th>\n                <th>Location</th>\n                <th>Email</th>\n                <th>Create Date</th>\n                <th>Last Login Date</th>\n                <th>Actions</th>\n            </tr>\n        </thead>\n        <tbody bn-each="data" bn-event="click.delete: onDelete, click.notif: onNotif">\n  \t\t\t<tr bn-data="{item: $i}">\n\t\t\t\t<td bn-text="$i.username"></td>\n\t\t\t\t<td bn-text="$i.pseudo"></td>\n\t\t\t\t<td bn-text="$i.location"></td>\n\t\t\t\t<td bn-text="$i.email"></td>\n\t\t\t\t<td >\n\t\t\t\t\t<span bn-text="new Date($i.createDate).toLocaleDateString(\'fr-FR\')" bn-show="$i.createDate != undefined"></span>\n\t\t\t\t</td>\n\t\t\t\t<td>\n\t\t\t\t\t<span bn-show="$i.lastLoginDate != undefined && $i.lastLoginDate != 0">\n\n\t\t\t\t\t\t<span bn-text="new Date($i.lastLoginDate).toLocaleDateString(\'fr-FR\')"></span><br>\n\t\t\t\t\t\tat \n\t\t\t\t\t\t<span bn-text="new Date($i.lastLoginDate).toLocaleTimeString(\'fr-FR\')"></span>\n\t\t\t\t\t</span>\n\t\t\t\t</td>\n\t\t\t\t<td>\n\t\t\t\t\t<button class="delete w3-btn w3-blue" title="Delete User">\n\t\t\t\t\t\t<i class="fa fa-trash"></i>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class="notif w3-btn w3-blue" title="Send Notification">\n\t\t\t\t\t\t<i class="fa fa-bell"></i>\n\t\t\t\t\t</button>\n\t\t\t\t</td>\n\t\t\t</tr>      \t\n\n        </tbody>\n    </table>\n</div>',props:{$pager:null},init:function(t,e){const{$pager:n}=this.props,i=$$.viewController(t,{data:{data:[]},events:{onAddUser:function(t){n.pushPage("breizbot.addUser",{title:"Add User"})},onDelete:function(t){const n=$(this).closest("tr").data("item");$$.ui.showConfirm({title:"Delete User",content:"Are you sure ?"},function(){e.remove(n.username).then(o)})},onNotif:function(t){const n=$(this).closest("tr").data("item");console.log("onNotif",n),$$.ui.showPrompt({title:"Send Notification",label:"Message"},function(t){e.sendNotif(n.username,{text:t})})},onUpdate:function(){o()}}});function o(){e.list().then(t=>{console.log("data",t),i.setData({data:t})})}o(),this.onReturn=function(t){e.add(t).then(o)}},$iface:"\n\t\tonReturn(formData)\n\t"}),$$.control.registerControl("breizbot.viewer",{deps:["breizbot.files"],template:'<div \n\tclass="image" \n\tbn-control="brainjs.image" \n\tbn-data="{src: url}" \n\tbn-if="type == \'image\'"\n\tstyle="height: 100%">\n\t\t\n\t</div>\n\n<div \n\tclass="pdf" \n\tbn-control="breizbot.pdf" \n\tbn-data="{url}" \n\tbn-if="type == \'pdf\'"\n\tstyle="height: 100%">\n\t\t\n\t</div>\t\n\n<div bn-if="type == \'audio\'" class="audio">\n\t<audio bn-attr="{src: url}" controls="" controlsList=nodownload></audio>\n</div>\n\n<div bn-if="type == \'video\'" class="video">\n\t<video bn-attr="{src: url}" controls="" controlsList=nodownload></video>\n</div>',props:{type:"",url:"#"},init:function(t,e){let{type:n,url:i}=this.props;const o=$$.viewController(t,{data:{url:i,type:n}});this.remove=function(t,n){console.log("[Viewer] remove",{fullName:t}),$$.ui.showConfirm({title:"Remove file",content:"Are you sure ?"},function(){e.removeFiles([t]).then(function(t){console.log("resp",t),n()}).catch(function(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})})})},this.save=function(t,n,i){if(console.log("[Viewer] save",{destPath:t,fileName:n}),""==o.model.url)return void $$.ui.showAlert({title:"Error",content:"File not loaded, please wait"});const s=$$.util.dataURLtoBlob(o.model.url);e.uploadFile(s,n,t).then(function(t){console.log("resp",t),i()}).catch(function(t){$$.ui.showAlert({title:"Error",content:t.responseText})})},this.setData=function(t){console.log("[Viewer] setData",t),t.url&&o.setData({url:t.url})}},$iface:"\n\t\tremove(fullName, callback);\n\t\tsave(destPath, fileName, callback)\n\t\t"}),$$.service.registerService("breizbot.appData",{deps:["brainjs.http"],init:function(t,e){let n=t;return{getData:function(){return n},saveData:function(t){return n=t,e.post("/api/appData",t)}}},$iface:"\n\t\tgetData():Data;\n\t\tsaveData(data):Promise \n\t\t"}),$$.service.registerService("breizbot.apps",{deps:["brainjs.http"],init:function(t,e){return{listAll:function(){return e.get("/api/apps/all")}}},$iface:"\n\t\tlistAll():Promise;\n\t\t"}),function(){class t extends EventEmitter2{constructor(){super(),this.sock=null,this.isConnected=!1,this.tryReconnect=!0,this.topics=new EventEmitter2({wildcard:!0}),this.registeredTopics={};let{hostname:t,pathname:e,protocol:n}=location;n="http:"==n?"ws:":"wss:",this.url=`${n}//${t}:8090/hmi${e}`}connect(){console.log("try to connect..."),this.sock=new WebSocket(this.url),this.sock.addEventListener("open",()=>{console.log("Connected to broker"),this.isConnected=!0}),this.sock.addEventListener("message",t=>{const e=JSON.parse(t.data);"ready"==e.type&&(Object.keys(this.registeredTopics).forEach(t=>{this.sendMsg({type:"register",topic:t})}),this.emit("ready",{clientId:e.clientId})),"ping"==e.type&&this.sendMsg({type:"pong"}),"notif"==e.type&&this.topics.emit(e.topic,e),"error"==e.type&&(console.log("[Broker] log",e.text),this.tryReconnect=!1,sock.close())}),this.sock.addEventListener("close",(t,e)=>{this.isConnected&&console.log("[Broker] Disconnected !"),this.isConnected=!1,this.tryReconnect&&setTimeout(()=>{this.connect()},5e3)})}sendMsg(t){t.time=Date.now();var e=JSON.stringify(t);this.isConnected&&this.sock.send(e)}emitTopic(t,e){var n={type:"notif",topic:t,data:e};this.sendMsg(n)}onTopic(t,e){this.topics.on(t,e)}register(t,e){null==this.registeredTopics[t]?this.registeredTopics[t]=1:this.registeredTopics[t]++,this.topics.on(t,e),this.sendMsg({type:"register",topic:t})}unregister(t,e){this.topics.off(t,e),0==--this.registeredTopics[t]&&(delete this.registeredTopics[t],this.sendMsg({type:"unregister",topic:t}))}}$$.service.registerService("breizbot.broker",{init:function(e){const n=new t;return n.connect(),n},$iface:"\n\t\t\temitTopic(topicName, data);\n\t\t\tregister(topicName, callback);\n\t\t\tunregister(topicName, callback);\n\t\t\tonTopic(topicName, callback)\n\n\t\t"})}(),$$.service.registerService("breizbot.cities",{deps:["brainjs.http"],init:function(t,e){return{getCountries:function(){return e.get("/api/cities/countries")},getCities:function(t,n){return e.post("/api/cities/cities",{country:t,search:n})}}},$iface:"\n\t\tgetCountries():Promise;\n\t\tgetCities(country, search):Promise;\n\t\t"}),$$.service.registerService("breizbot.files",{deps:["brainjs.http"],init:function(t,e){return{list:function(t,n){return console.log("[FileService] list",t),e.post("/api/files/list",{path:t,options:n})},fileUrl:function(t){return $$.util.getUrlParams("/api/files/load",{fileName:t})},fileThumbnailUrl:function(t,e){return $$.util.getUrlParams("/api/files/loadThumbnail",{fileName:t,size:e})},uploadFile:function(t,n,i){if(console.log("[FileService] uploadFile",n,i),!(t instanceof Blob))return console.warn("File format not supported"),Promise.reject("File format not supported");var o=new FormData;return o.append("file",t,n),o.append("destPath",i),e.postFormData("/api/files/save",o)},removeFiles:function(t){return console.log("[FileService] removeFiles",t),e.post("/api/files/delete",t)},mkdir:function(t){return console.log("[FileService] mkdir",t),e.post("/api/files/mkdir",{fileName:t})},moveFiles:function(t,n){return console.log("[FileService] moveFiles",t,n),e.post("/api/files/move",{fileNames:t,destPath:n})},shareFiles:function(t){return console.log("[FileService] shareFiles",t),e.post("/api/files/move",{fileNames:t,destPath:"/share"})},copyFiles:function(t,n){return console.log("[FileService] copyFiles",t,n),e.post("/api/files/copy",{fileNames:t,destPath:n})}}},$iface:"\n\t\tlist(path, options):Promise;\n\t\tfileUrl(fileName):string;\n\t\tfileThumbnailUrl(fileName, size):string;\n\t\tuploadFile(blob, saveAsfileName, destPath):Promise;\n\t\tremoveFiles(fileNames):Promise;\n\t\tmkdir(fileName):Promise;\n\t\tmoveFiles(fileNames, destPath):Promise;\n\t\tcopyFiles(fileNames, destPath):Promise\t\t\t\n\t"}),$$.service.registerService("breizbot.mails",{deps:["brainjs.http"],init:function(t,e){return{getMailAccount:function(){return e.get("/api/mails/")},createMailAccount:function(t){return e.post("/api/mails",t)},getMailboxes:function(t){return e.post("/api/mails/getMailboxes",{name:t})},openMailbox:function(t,n,i){return e.post("/api/mails/openMailbox",{name:t,mailboxName:n,pageNo:i})},openMessage:function(t,n,i,o){return e.post("/api/mails/openMessage",{name:t,mailboxName:n,seqNo:i,partID:o})},openAttachment:function(t,n,i,o){return e.post("/api/mails/openAttachment",{name:t,mailboxName:n,seqNo:i,partID:o})},deleteMessage:function(t,n,i){return e.post("/api/mails/deleteMessage",{name:t,mailboxName:n,seqNos:i})},moveMessage:function(t,n,i,o){return e.post("/api/mails/moveMessage",{name:t,mailboxName:n,targetName:i,seqNos:o})},sendMail:function(t,n){return e.post("/api/mails/sendMail",{accountName:t,data:n})}}},$iface:"\n\t\tgetMailAccount():Promise;\n\t\tcreateMaiAccount(data):Promise;\n\t\tgetMailboxes(name):Promise;\n\t\topenMailbox(name, mailboxName, pageNo):Promise;\n\t\topenMessage(name, mailboxName, seqNo, partID):Promise;\n\t\topenAttachment(name, mailboxName, seqNo, partID):Promise;\n\t\tdeleteMessage(name, mailboxName, seqNos):Promise;\n\t\tmoveMessage(name, mailboxName, targetName, seqNos):Promise\n\t\t"}),$$.service.registerService("breizbot.media",{deps:["brainjs.http"],init:function(t,e){return{drive:function(){return e.get("/api/media/drive")},list:function(t,n){return e.post("/api/media/list",{driveName:t,destPath:n})},fileUrl:function(t,e){return`/api/media/load?driveName=${t}&fileName=${e}`}}},$iface:"\n\t\tdrive():Promise;\n\t\tlist(driveName, destPath):Promise\t\t\n\t"}),$$.service.registerService("breizbot.params",{init:function(t){return JSON.parse(t)}}),$$.service.registerService("breizbot.rtc",{deps:["brainjs.http","breizbot.broker"],init:function(t,e,n){let i,o;return{getRemoteClientId:function(){return o},setRemoteClientId:function(t){o=t},setLocalClientId:function(t){i=t},call:function(t,n,o){return e.post("/api/rtc/sendToUser",{to:t,srcId:i,type:"call",data:{appName:n,iconCls:o}})},cancel:function(t){return e.post("/api/rtc/sendToUser",{to:t,srcId:i,type:"cancel"})},accept:function(){return this.sendData("accept")},deny:function(){return this.sendData("deny")},bye:function(){return this.sendData("bye")},sendData:function(t,n){return e.post("/api/rtc/sendToClient",{destId:o,srcId:i,type:t,data:n})}}},$iface:"\n\t\tgetRemoteClientId():string;\n\t\tsetRemoteClientId(clientId);\n\t\tcall(to):Promise;\n\t\tcancel(to):Promise;\n\t\tdeny():Promise;\n\t\tbye():Promise;\n\t\tcandidate(info):Promise;\n\t\toffer(data):Promise;\n\t\tanswer(data):Promise\n\t"}),$$.service.registerService("breizbot.share",{deps:["brainjs.http"],init:function(t,e){return{list:function(t,n){return console.log("[Share] list",n),e.post("/api/share/list",{path:n,user:t}).then(t=>(t.forEach(t=>{t.isImage="image"==$$.util.getFileType(t.name)}),t))},fileUrl:function(t,e){return $$.util.getUrlParams("/api/share/load",{user:t,fileName:e})},fileThumbnailUrl:function(t,e,n){return $$.util.getUrlParams("/api/share/loadThumbnail",{user:t,fileName:e,size:n})}}},$iface:"\n\t\tlist(user, path):Promise;\n\t\tfileUrl(user, fileName):string;\n\t\tfileThumbnailUrl(user, fileName, size):string;\n\t"}),$$.service.registerService("breizbot.users",{deps:["brainjs.http"],init:function(t,e){return{list:function(){return e.get("/api/users")},match:function(t){return e.get(`/api/users?match=${t}`)},add:function(t){return e.post("/api/users",t)},remove:function(t){return e.delete(`/api/users/${t}`)},update:function(t,n){return e.put(`/api/users/${t}`,n)},get:function(t){return e.get(`/api/users/${t}`)},activateApp:function(t,n){return e.post("/api/users/activateApp",{appName:t,activated:n})},sendNotif:function(t,n){return e.post("/api/users/sendNotif",{to:t,notif:n})},removeNotif:function(t){return e.delete(`/api/users/removeNotif/${t}`)},getNotifs:function(){return e.get("/api/users/getNotifs")},getNotifCount:function(){return e.get("/api/users/getNotifCount")},getFriends:function(){return e.get("/api/users/getFriends")},addFriend:function(t){return e.post("/api/users/addFriend",{friendUserName:t})},changePwd:function(t){return e.post("/api/users/changePwd",{newPwd:t})},addContact:function(t,n){return e.post("/api/users/addContact",{name:t,email:n})},getContacts:function(){return e.get("/api/users/getContacts")},removeContact:function(t){return e.delete(`/api/users/removeContact/${t}`)}}},$iface:"\n\t\tlist():Promise;\n\t\tadd(data):Promise;\n\t\tremove(user):Promise;\n\t\tupdate(user, data):Promise;\n\t\tget(user):Promise;\n\t\tactivateApp(appName, activated):Promise;\n\t\tsendNotif(to, notif):Promise;\n\t\tremoveNotif(notifId):Promise;\n\t\tgetNotifs():Promise;\n\t\tgetNotifCount():Promise;\n\t\tgetFriends():Promise;\n\t\taddFriend(friendUserName):Promise;\n\t\tchangePwd(newPwd):Promise;\n\t\taddContact(name, email):Promise;\n\t\tgetContacts():Promise(contacts);\n\t\tremoveContact(contactId):Promise\n\t"});