$$.control.registerControl("rootPage",{template:'<div>\n    <div bn-control="DSKY" bn-event="key: onKey" bn-iface="dsky"></div>\n</div>\n\n<div>\n    <div bn-control="IMU" bn-iface="imu" bn-event="launch: onLaunch"></div>\n\n</div>\n',deps:["breizbot.files","app.emuAgc","brainjs.http"],props:{},init:function(t,n,e,s){const i=$$.viewController(t,{data:{},events:{onKey:function(t,n){const{val:s}=n;isNaN(s)||e.writeIo(13,s)},onLaunch:function(){console.log("onLaunch"),d||b||(e.writeIo(24,0,e.inputsMask.LIFTOFF),u=r,l.setReactor(0),b=!0)}}}),a=i.scope.dsky,l=i.scope.imu,o=Math.PI/180;let c=null,r=0,u=-1,d=!1,b=!1;l.update(),async function(){c=await s.get(n.assetsUrl("profile.json")),await e.loadRom(n.assetsUrl("Comanche055.bin")),e.reset(),e.on("channelUpdate",t=>{const{channel:n,value:s}=t;switch(n){case 8:a.process(n,s);break;case 10:s&e.outputsMask.ZERO_IMU&&l.zero();break;case 124:case 125:case 126:l.gyro_coarse_align(n,s);break;case 127:l.gyro_fine_align(n,s)}}),e.on("lightsUpdate",t=>{a.processLights(t)}),e.start(),setInterval(()=>{if(l.setSt(Math.round(r/10)),e.loop(),b){const t=Math.round((r-u)/10);if(l.setMet(t),d||t>=c.length)return d=!0,void(b=!1);if(l.accelerate([1.08*c[t][2],0,0]),l.rotate([-c[t][3]/10*o,-c[t][1]/10*o,0]),r%10==0&&l.update(),c[t][4]){const n=Math.round(c[t][4]);l.setReactor(n)}}r++,e.readAllIo()},100)}()}}),$$.service.registerService("app.emuAgc",{deps:["breizbot.files"],init:function(t){const n=Module.cwrap("set_fixed",null,["number"]),e=Module.cwrap("cpu_reset"),s=Module.cwrap("cpu_step",null,["number"]),i=Module.cwrap("packet_read","number"),a=Module.cwrap("packet_write",null,["number","number"]),l=Module.cwrap("get_erasable_ptr","number"),o=new EventEmitter2,c=.01172,r={channels:{},lamps:0};let u=0,d=0,b=null;function v(t){return 1<<t-1}const p={COMP_ACTY:v(2),UPLINK_ACTY:v(3),TEMP:v(4),KEY_REL:v(5),VERB_NOUN:v(6),OPER_ERR:v(7),RESTART:v(8),STBY:v(9)},h={PRIO_DISP:v(1),NO_DAP:v(2),VEL:v(3),NO_ATT:v(4),ALT:v(5),GIMBAL_LOCK:v(6),TRACKER:v(8),PROG:v(9)},f={LIFTOFF:v(5),ISS_TURN_ON:v(14),PROCEED:v(14)},m={ZERO_IMU:v(5)};return{writeIo:function(t,n,e){null!=e&&a(t+256,e),a(t,n)},loadRom:async function(t){const e=await fetch(t),s=await e.arrayBuffer(),i=new Uint8Array(s);console.log("romArray",i.length);const a=Module._malloc(i.length*i.BYTES_PER_ELEMENT);console.log("romPtr",a),Module.HEAP8.set(i,a),n(a),Module._free(a),b=l(),console.log("erasablePtr",b)},reset:e,stepCpu:s,on:o.on.bind(o),start:function(){u=performance.now(),d=0},loop:function(){const t=Math.floor((performance.now()-u)/c)-d;if(t<0||t>1e5)return u=performance.now(),void(d=0);s(t),d+=t},readAllIo:function(){let t;do{const n=(t=i())>>16,e=65535&t;if(r.channels[n],o.emit("channelUpdate",{channel:n,value:e}),9===n){const t=6;r.lamps=r.lamps&~t>>>0|e&t,o.emit("lightsUpdate",r.lamps)}else if(115===n){const t=504;r.lamps=r.lamps&~t>>>0|e&t,o.emit("lightsUpdate",r.lamps)}}while(t)},peek:function(t){return 32767&Module.getValue(b+2*t,"i16")},poke:function(t,n){Module.setValue(b+2*t,n,"i16")},lampMask:p,statusMask:h,inputsMask:f,outputsMask:m}}}),$$.control.registerControl("DSKY",{template:'\n<div class="top">\n    <div class="left">\n        <div class="col">\n            <div bn-style="uplink_acty"><span>UPLINK ACTY</span></div>\n            <div bn-style="no_att">NO ATT</div>\n            <div bn-style="stby">STBY</div>\n            <div bn-style="key_rel">KEY REL</div>\n            <div bn-style="opr_err">OPR ERR</div>\n            <div></div>\n            <div></div>\n        </div>\n\n        <div class="col">\n            <div bn-style="temp">TEMP</div>\n            <div bn-style="gimball_lock"><span>GIMBALL LOCK</span></div>\n            <div bn-style="prog">PROG</div>\n            <div>RESTART</div>\n            <div bn-style="tracker">TRACKER</div>\n            <div bn-style="alt">ALT</div>\n            <div bn-style="vel">VEL</div>\n        </div>\n\n    \n    </div>\n    \n    \n    <div class="right">\n        <div class="line">\n            <div class="compActy" bn-style="comp_acty"><span>COMP ACTY</span></div>\n            <div>\n                <div class="label">PROG</div>\n                <div class="digit" bn-html="prog00"></div>\n            </div>\n    \n        </div>\n        <div class="line">\n            <div>\n                <div class="label">VERB</div>\n                <div class="digit" bn-html="verb00"></div>\n            </div>\n            <div>\n                <div class="label">NOUN</div>\n                <div class="digit" bn-html="noun00"></div>\n            </div>\n        </div>\n        <div class="digit big" bn-html="r1"></div>\n        <div class="digit big" bn-html="r2"></div>\n        <div class="digit big" bn-html="r3"></div>\n    \n    </div>\n</div>\n\n<div class="bottom">\n    <div class="keyboard" bn-event="click.key: onKey">\n        <div>\n            <button class="label key">VERB</button>\n            <button class="label key">NOUN</button>\n        </div>\n        <div>\n            <button class="key">+</button>\n            <button class="key">-</button>\n            <button class="key">0</button>\n        </div>\n        <div>\n            <button class="key">1</button>\n            <button class="key">4</button>\n            <button class="key">7</button>\n        </div>\n        <div>\n            <button class="key">8</button>\n            <button class="key">5</button>\n            <button class="key">2</button>\n        </div>\n        <div>\n            <button class="key">9</button>\n            <button class="key">6</button>\n            <button class="key">3</button>\n        </div>\n        <div>\n            <button class="label key">CLR</button>\n            <button class="label key">PRO</button>\n            <button class="label key">KEY REL</button>\n        </div>\n        <div>\n            <button class="label key">ENTR</button>\n            <button class="label key">RSET</button>\n        </div>\n    \n    </div>\n</div>\n',deps:["breizbot.pager","app.emuAgc"],props:{},init:function(t,n,e){Math.floor,Math.round;const s={VERB:17,NOUN:31,"+":26,"-":27,0:16,CLR:30,"KEY REL":25,ENTR:28,RSET:18};function i(t){var n="E";switch(t){case 0:n="H";break;case 21:n="0";break;case 3:n="1";break;case 25:n="2";break;case 27:n="3";break;case 15:n="4";break;case 30:n="5";break;case 28:n="6";break;case 19:n="7";break;case 29:n="8";break;case 31:n="9"}return n}let a=0,l=0,o=0,c=0,r=0,u=0;const d="&nbsp;";function b(t){return{"background-color":t?"#ffc200":"#888888"}}function v(t){return{"background-color":t?"#ffffff":"#888888"}}const p=$$.viewController(t,{data:{lamps:0,status8:0,digits:"000000+00000+00000+00000",on:0,comp_acty:function(){return b(this.lamps&e.lampMask.COMP_ACTY)},uplink_acty:function(){return v(this.lamps&e.lampMask.UPLINK_ACTY)},temp:function(){return b(this.lamps&e.lampMask.TEMP)},key_rel:function(){return v(this.lamps&e.lampMask.KEY_REL)},opr_err:function(){return v(this.lamps&e.lampMask.OPER_ERR)},stby:function(){return v(this.lamps&e.lampMask.STBY)},vel:function(){return b(this.status8&e.statusMask.VEL)},no_att:function(){return v(this.status8&e.statusMask.NO_ATT)},alt:function(){return b(this.status8&e.statusMask.ALT)},gimball_lock:function(){return b(this.status8&e.statusMask.GIMBAL_LOCK)},tracker:function(){return b(this.status8&e.statusMask.TRACKER)},prog:function(){return b(this.status8&e.statusMask.PROG)},r1:function(){return this.digits.slice(6,12).replace(/H/g,d)},r2:function(){return this.digits.slice(12,18).replace(/H/g,d)},prog00:function(){return this.digits.slice(0,2).replace(/H/g,d)},r3:function(){return this.digits.slice(18,24).replace(/H/g,d)},verb00:function(){return this.lamps&e.lampMask.VERB_NOUN?d+d:this.digits.slice(2,4).replace(/H/g,d)},noun00:function(){return this.lamps&e.lampMask.VERB_NOUN?d+d:this.digits.slice(4,6).replace(/H/g,d)}},events:{onKey:function(n){const e=$(this).text();let i=s[e];null==i&&(i=parseInt(e)),n.stopPropagation(),t.trigger("key",{val:i})}}});this.processLights=function(t){p.setData({lamps:t})},this.process=function(t,n){if(0==n)return;const e=n>>11,s=n>>10&1,d=i(n>>5&31),b=i(31&n),v=p.model.digits.split("");switch(e){case 12:p.setData({status8:n});break;case 11:v[0]=d,v[1]=b;break;case 10:v[2]=d,v[3]=b;break;case 9:v[4]=d,v[5]=b;break;case 8:v[7]=b;break;case 7:v[8]=d,v[9]=b,a=s;break;case 6:v[10]=d,v[11]=b,l=s;break;case 5:v[13]=d,v[14]=b,o=s;break;case 4:v[15]=d,v[16]=b,c=s;break;case 3:v[17]=d,v[19]=b;break;case 2:v[20]=d,v[21]=b,r=s;break;case 1:v[22]=d,v[23]=b,u=s}if(12!=e){v[6]=a&&!l?"+":a||l?"-":"H",v[12]=o&&!c?"+":o||c?"-":"H",v[18]=r&&!u?"+":r||u?"-":"H";const t=v.join("");p.setData({digits:t})}}}}),$$.control.registerControl("IMU",{template:'<div class="top">\n    <div class="left">\n        <div class="imuGroup">\n            <label class="imuLabel">ST</label>\n            <div class="clock" bn-html="getSt"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">MET</label>\n            <div class="clock" bn-html="getMet"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">OGA</label>\n            <div class="imu" bn-html="imux"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">IGA</label>\n            <div class="imu" bn-html="imuy"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">MGA</label>\n            <div class="imu" bn-html="imuz"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">ROLL</label>\n            <div class="imu" bn-html="roll"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">PITCH</label>\n            <div class="imu" bn-html="pitch"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">YAW</label>\n            <div class="imu" bn-html="yaw"></div>\n        </div>\n    </div>\n\n    <div class="right">\n        <button bn-event="click: enableIMU">Enable IMU</button>\n        <button bn-event="click: launch">Launch</button>\n        <div class="light" bn-style="sic">S-IC</div>\n        <div class="light" bn-style="sii">S-II</div>\n        <div class="light" bn-style="sivb">S-IVB</div>\n    </div>\n</div>\n<div class="bottom">\n    <canvas width="200" height="200" bn-bind="fdai"></canvas>\n</div>',deps:["breizbot.pager","app.emuAgc"],props:{},init:function(t,n,e){const s=Math.abs,i=Math.floor,a=(Math.round,Math.sqrt,Math.sin),l=Math.cos,o=Math.atan2,c=Math.asin,r=Math.PI,u=r/180,d=180/r,b=75,v=.043948*u,p=.617981/3600*u,h=360/32768*u,f=.0585;let m,k,g,y,M,_,R,E,T=0;function L(){console.log("zero"),m=[0,0,0],k=[0,0,0],g=[0,0,0],y=[0,0,0],M=[0,0,0],R=[0,0,0],_=[0,0,0],E=!1,T=1,U()}function I(t,n,e){return t-(e-n)*i((t-n)/(e-n))}function P(t){let n=(t*d).toFixed(2);return n="000".substr(0,6-n.length)+n}function A(t){return(t*d).toFixed(1)}function O(t){const n=i(t/3600),e=i(t/60)%60,s=t%60;return(n<10?"0"+n:n)+":"+(e<10?"0"+e:e)+":"+(s<10?"0"+s:s)}function w(t){return{"background-color":t?"#ffc200":"#888888"}}const S=$$.viewController(t,{data:{st:0,met:0,c:-1,sic:function(){return w(0==this.c)},sii:function(){return w(1==this.c)},sivb:function(){return w(2==this.c)},getSt:function(){return O(this.st)},getMet:function(){return O(this.met)},imu_angle:[0,0,0],euler:[0,0,0],imux:function(){return P(this.imu_angle[0])},imuy:function(){return P(this.imu_angle[1])},imuz:function(){return P(this.imu_angle[2])},roll:function(){return A(this.euler[0])},pitch:function(){return A(this.euler[1])},yaw:function(){return A(this.euler[2])}},events:{enableIMU:function(t){console.log("enableIMU"),e.writeIo(24,0,e.inputsMask.ISS_TURN_ON)},launch:function(n){n.stopPropagation(),t.trigger("launch")}}}),C=S.scope.fdai.get(0),N=C.getContext("2d");function U(){S.setData({imu_angle:k,euler:g}),s(T)>.01&&(!function(){const t=a(k[0]),n=a(k[1]),e=a(k[2]),s=l(k[0]),i=l(k[1]),u=l(k[2]),d=e,b=u*s,v=i*e*t+n*s,p=-u*t,h=-n*e*t+i*s;g[0]=c(p),g[1]=o(v,h),g[2]=o(d,b);for(let t=0;t<3;t++)g[t]<-2*r?g[t]+=2*r:g[t]>=2*r&&(g[t]-=2*r)}(),function(){let t=g[0],n=g[1],e=g[2];N.fillStyle="#888888",N.fillRect(0,0,C.width,C.height),N.setTransform(1,0,0,1,C.width/2,C.height/2),N.strokeStyle="#FFFFFF",N.lineWidth=2;for(let t=0;t<36;t++){const n=10*t*u,e=t%3?10:15;N.beginPath(),N.moveTo((b+2)*l(n),(b+2)*a(n)),N.lineTo((b+e)*l(n),(b+e)*a(n)),N.stroke()}let i=1;N.rotate(-t),N.strokeStyle="#000",N.lineWidth=4,N.beginPath(),N.fillStyle="#FFFFFF",N.lineWidth=1,N.arc(0,0,b,0,2*r,!0),N.fill(),N.stroke(),N.save(),N.beginPath(),N.lineWidth=4,N.fillStyle="#000000",l(n)<0?(n+=r,N.arc(0,0,b,0,r,!0)):N.arc(0,0,b,0,r,!1),i=a(n),s(i)<.001?(N.moveTo(-b,0),N.lineTo(b,0)):(N.scale(1,i),N.arc(0,0,b,r,0,!0)),N.fill(),N.restore(),N.save(),N.beginPath(),N.strokeStyle="#aaa",l(e)<0&&(e+=r),e=I(e,-r,r),i=-a(e),s(i)<.01?(N.lineWidth=1,N.moveTo(0,-b),N.lineTo(0,b)):(N.lineWidth=4,N.scale(i,1),N.arc(0,0,b,-r/2,r/2,!0)),N.stroke(),N.restore(),N.beginPath(),N.strokeStyle="#F00",N.lineWidth=2,N.arc(0,0,10,0,2*r,!1),N.stroke()}(),T=0)}function F(t){if(E)return;for(let n=0;n<3;n++)if(t[n]){k[n]=I(k[n]+t[n],0,2*r);const a=I(k[n]-y[n],-r,r);T+=s(a);const l=a>0?1:-1;let o=i(s(a)/h);y[n]=I(y[n]+l*h*o,0,2*r);let c=e.peek(26+n);c=16384&c?-(32767^c):c,c+=l*o,e.poke(26+n,c<0?32767^-c:c)}}L(),this.rotate=function(t){const n=a(k[2]),e=l(k[2])*l(k[0]),s=a(k[0]),i=-l(k[2])*a(k[0]),o=l(k[0]),c=o*e-i*s;F([I(t[0]-(t[1]*o*n-t[2]*s*n)/c,-r,r),I((t[1]*o-t[2]*s)/c,-r,r),I((t[2]*e-t[1]*i)/c,-r,r)])},this.accelerate=function(t){const n=a(k[0]),s=a(k[1]),o=a(k[2]),c=l(k[0]),r=l(k[1]),u=l(k[2]),d=[u*r*t[0]+(-c*o*r+n*s)*t[1]+(n*o*r+c*s)*t[2],o*t[0]+c*u*t[1]-n*u*t[2],-u*s*t[0]+(c*o*s+n*r)*t[1]+(-n*o*s+c*r)*t[2]];for(let t=0;t<3;t++){R[t]+=d[t];const n=i((R[t]-_[t]*f)/f);_[t]+=n;let s=e.peek(31+t);s=16384&s?-(32767^s):s,s+=n,e.poke(31+t,s<0?32767^-s:s)}},this.update=U,this.gyro_coarse_align=function(t,n){const e=(16384&n?-1:1)*(16383&n);124===t?F([e*v,0,0]):125===t?F([0,e*v,0]):126===t&&F([0,0,e*v]),U()},this.zero=L,this.gyro_fine_align=function(t,n){const e=8192&n,s=4096&n,i=(16384&n?-1:1)*(2047&n);!e&&s&&F([i*p,0,0]),e&&!s&&F([0,i*p,0]),e&&s&&F([0,0,i*p]),U()},this.setSt=function(t){S.setData({st:t})},this.setMet=function(t){S.setData({met:t})},this.setReactor=function(t){S.setData({c:t})}}});