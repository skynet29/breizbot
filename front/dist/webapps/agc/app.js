$$.control.registerControl("rootPage",{template:'<div>\n    <div bn-control="DSKY" bn-event="key: onKey" bn-iface="dsky"></div>\n</div>\n\n<div>\n    <div bn-control="IMU" bn-iface="imu"></div>\n\n</div>\n',deps:["breizbot.files","app.emuAgc"],props:{},init:function(n,t,e){const i=$$.viewController(n,{data:{},events:{onKey:function(n,t){const{val:i}=t;isNaN(i)||e.writeIo(13,i)}}}),s=i.scope.dsky,a=i.scope.imu;console.log("imu",a);let l=0;a.update(),async function(){await e.loadRom(t.assetsUrl("Comanche055.bin")),e.reset(),e.on("channelUpdate",n=>{const{channel:t,value:e}=n;switch(t){case 8:case 9:case 11:s.process(t,e);break;case 10:16&e&&a.zero();break;case 124:case 125:case 126:a.gyro_coarse_align(t,e);break;case 127:a.gyro_fine_align(t,e)}}),e.on("lightsUpdate",n=>{s.processLights(n)}),e.start(),setInterval(function(){l+=.1,e.loop()},1e3/60)}()}}),$$.service.registerService("app.emuAgc",{deps:["breizbot.files"],init:function(n){const t=Module.cwrap("set_fixed",null,["number"]),e=Module.cwrap("cpu_reset"),i=Module.cwrap("cpu_step",null,["number"]),s=Module.cwrap("packet_read","number"),a=Module.cwrap("packet_write",null,["number","number"]),l=Module.cwrap("get_erasable_ptr","number"),o=new EventEmitter2,c=.01172,r={channels:{},lamps:0};let u=0,d=0,b=null;function v(n){return 1<<n-1}const p={COMP_ACTY:v(2),UPLINK_ACTY:v(3),TEMP:v(4),KEY_REL:v(5),VERB_NOUN:v(6),OPER_ERR:v(7),RESTART:v(8),STBY:v(9)},h={PRIO_DISP:v(1),NO_DAP:v(2),VEL:v(3),NO_ATT:v(4),ALT:v(5),GIMBAL_LOCK:v(6),TRACKER:v(8),PROG:v(9)};return{writeIo:a,loadRom:async function(n){const e=await fetch(n),i=await e.arrayBuffer(),s=new Uint8Array(i);console.log("romArray",s.length);const a=Module._malloc(s.length*s.BYTES_PER_ELEMENT);console.log("romPtr",a),Module.HEAP8.set(s,a),t(a),Module._free(a)},reset:e,stepCpu:i,on:o.on.bind(o),start:function(){u=performance.now(),d=0},loop:function(){const n=Math.floor((performance.now()-u)/c)-d;if(n<0||n>1e5)return u=performance.now(),void(d=0);i(n),d+=n,function(){let n;do{const t=(n=s())>>16,e=65535&n,i=r.channels[t];if(i!=e&&(r.channels[t]=e,o.emit("channelUpdate",{channel:t,value:e})),9===t){const n=6;r.lamps=r.lamps&~n>>>0|e&n,o.emit("lightsUpdate",r.lamps)}else if(115===t){const n=504;r.lamps=r.lamps&~n>>>0|e&n,o.emit("lightsUpdate",r.lamps)}}while(n)}()},getErasable:function(){if(!b){const n=l();console.log("getErable",n),b=new Uint16Array(Module.HEAP8.buffer,n,2048)}return b},lampMask:p,statusMask:h}}}),$$.control.registerControl("DSKY",{template:'\n<div class="top">\n    <div class="left">\n        <div class="col">\n            <div bn-style="uplink_acty"><span>UPLINK ACTY</span></div>\n            <div bn-style="no_att">NO ATT</div>\n            <div bn-style="stby">STBY</div>\n            <div bn-style="key_rel">KEY REL</div>\n            <div bn-style="opr_err">OPR ERR</div>\n            <div></div>\n            <div></div>\n        </div>\n\n        <div class="col">\n            <div bn-style="temp">TEMP</div>\n            <div bn-style="gimball_lock"><span>GIMBALL LOCK</span></div>\n            <div bn-style="prog">PROG</div>\n            <div>RESTART</div>\n            <div bn-style="tracker">TRACKER</div>\n            <div bn-style="alt">ALT</div>\n            <div bn-style="vel">VEL</div>\n        </div>\n\n    \n    </div>\n    \n    \n    <div class="right">\n        <div class="line">\n            <div class="compActy" bn-style="comp_acty"><span>COMP ACTY</span></div>\n            <div>\n                <div class="label">PROG</div>\n                <div class="digit" bn-html="prog00"></div>\n            </div>\n    \n        </div>\n        <div class="line">\n            <div>\n                <div class="label">VERB</div>\n                <div class="digit" bn-html="verb00"></div>\n            </div>\n            <div>\n                <div class="label">NOUN</div>\n                <div class="digit" bn-html="noun00"></div>\n            </div>\n        </div>\n        <div class="digit big" bn-html="r1"></div>\n        <div class="digit big" bn-html="r2"></div>\n        <div class="digit big" bn-html="r3"></div>\n    \n    </div>\n</div>\n\n<div class="bottom">\n    <div class="keyboard" bn-event="click.key: onKey">\n        <div>\n            <button class="label key">VERB</button>\n            <button class="label key">NOUN</button>\n        </div>\n        <div>\n            <button class="key">+</button>\n            <button class="key">-</button>\n            <button class="key">0</button>\n        </div>\n        <div>\n            <button class="key">1</button>\n            <button class="key">4</button>\n            <button class="key">7</button>\n        </div>\n        <div>\n            <button class="key">8</button>\n            <button class="key">5</button>\n            <button class="key">2</button>\n        </div>\n        <div>\n            <button class="key">9</button>\n            <button class="key">6</button>\n            <button class="key">3</button>\n        </div>\n        <div>\n            <button class="label key">CLR</button>\n            <button class="label key">PRO</button>\n            <button class="label key">KEY REL</button>\n        </div>\n        <div>\n            <button class="label key">ENTR</button>\n            <button class="label key">RSET</button>\n        </div>\n    \n    </div>\n</div>\n',deps:["breizbot.pager","app.emuAgc"],props:{},init:function(n,t,e){var i=Math.floor,s=Math.round;const a={VERB:17,NOUN:31,"+":26,"-":27,0:16,CLR:30,"KEY REL":25,ENTR:28,RSET:18};function l(n){var t="E";switch(n){case 0:t="H";break;case 21:t="0";break;case 3:t="1";break;case 25:t="2";break;case 27:t="3";break;case 15:t="4";break;case 30:t="5";break;case 28:t="6";break;case 19:t="7";break;case 29:t="8";break;case 31:t="9"}return t}let o=0,c=0,r=0,u=0,d=0,b=0;const v="&nbsp;";let p=0;function h(n){return{"background-color":n?"#ffc200":"#888888"}}function m(n){return{"background-color":n?"#ffffff":"#888888"}}const f=$$.viewController(n,{data:{lamps:0,status8:0,digits:"000000+00000+00000+00000",on:0,comp_acty:function(){return h(this.lamps&e.lampMask.COMP_ACTY)},uplink_acty:function(){return m(this.lamps&e.lampMask.UPLINK_ACTY)},temp:function(){return h(this.lamps&e.lampMask.TEMP)},key_rel:function(){return m(this.lamps&e.lampMask.KEY_REL)},opr_err:function(){return m(this.lamps&e.lampMask.OPER_ERR)},stby:function(){return m(this.lamps&e.lampMask.STBY)},vel:function(){return h(this.status8&e.statusMask.VEL)},no_att:function(){return m(this.status8&e.statusMask.NO_ATT)},alt:function(){return h(this.status8&e.statusMask.ALT)},gimball_lock:function(){return h(this.status8&e.statusMask.GIMBAL_LOCK)},tracker:function(){return h(this.status8&e.statusMask.TRACKER)},prog:function(){return h(this.status8&e.statusMask.PROG)},r1:function(){return this.digits.slice(6,12).replace(/H/g,v)},r2:function(){return this.digits.slice(12,18).replace(/H/g,v)},prog00:function(){return this.digits.slice(0,2).replace(/H/g,v)},r3:function(){return this.digits.slice(18,24).replace(/H/g,v)},verb00:function(){return this.lamps&e.lampMask.VERB_NOUN?v+v:this.digits.slice(2,4).replace(/H/g,v)},noun00:function(){return this.lamps&e.lampMask.VERB_NOUN?v+v:this.digits.slice(4,6).replace(/H/g,v)}},events:{onKey:function(t){const e=$(this).text();let i=a[e];null==i&&(i=parseInt(e)),t.stopPropagation(),n.trigger("key",{val:i})}}});this.tick=function(n){var t,e,a,l,o;return p%10==0&&(e=s(p/10),t=((a=i(e/3600))<10?"0"+a:a)+":"+((l=i(e/60)%60)<10?"0"+l:l)+":"+((o=e%60)<10?"0"+o:o),$("#st").html(t)),p++},this.processLights=function(n){f.setData({lamps:n})},this.process=function(n,t){if(0!=t&&8==n){const n=t>>11,e=t>>10&1,i=l(t>>5&31),s=l(31&t),a=f.model.digits.split("");switch(n){case 12:f.setData({status8:t});break;case 11:a[0]=i,a[1]=s;break;case 10:a[2]=i,a[3]=s;break;case 9:a[4]=i,a[5]=s;break;case 8:a[7]=s;break;case 7:a[8]=i,a[9]=s,o=e;break;case 6:a[10]=i,a[11]=s,c=e;break;case 5:a[13]=i,a[14]=s,r=e;break;case 4:a[15]=i,a[16]=s,u=e;break;case 3:a[17]=i,a[19]=s;break;case 2:a[20]=i,a[21]=s,d=e;break;case 1:a[22]=i,a[23]=s,b=e}if(12!=n){a[6]=o&&!c?"+":o||c?"-":"H",a[12]=r&&!u?"+":r||u?"-":"H",a[18]=d&&!b?"+":d||b?"-":"H";const n=a.join("");f.setData({digits:n})}}}}}),$$.control.registerControl("IMU",{template:'<div class="top">\n    <div class="left">\n        <div class="imuGroup">\n            <label class="imuLabel">OGA</label>\n            <div class="imu" bn-html="imux"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">IGA</label>\n            <div class="imu" bn-html="imuy"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">MGA</label>\n            <div class="imu" bn-html="imuz"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">ROLL</label>\n            <div class="imu" bn-html="roll"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">PITCH</label>\n            <div class="imu" bn-html="pitch"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">YAW</label>\n            <div class="imu" bn-html="yaw"></div>\n        </div>\n    </div>\n\n    <div class="right">\n        <button bn-event="click: enableIMU">Enable IMU</button>\n        <button bn-event="click: launch">Launch</button>\n        <div class="light">S-IC</div>\n        <div class="light">S-II</div>\n        <div class="light">S-IVB</div>\n    </div>\n</div>\n<div class="bottom">\n    <canvas width="200" height="200" bn-bind="fdai"></canvas>\n</div>',deps:["breizbot.pager","app.emuAgc"],props:{},init:function(n,t,e){const i=Math.abs,s=Math.floor,a=(Math.round,Math.sqrt,Math.sin),l=Math.cos,o=Math.atan2,c=Math.asin,r=Math.PI,u=r/180,d=180/r,b=75,v=.043948*u,p=.617981/3600*u,h=360/32768*u;let m,f,g,k,y,_,M,E,R=0;function T(){console.log("zero"),m=[0,0,0],f=[0,0,0],g=[0,0,0],k=[0,0,0],y=[0,0,0],M=[0,0,0],_=[0,0,0],E=!1,R=1,O()}function A(n,t,e){return n-(e-t)*s((n-t)/(e-t))}function L(n){let t=(n*d).toFixed(2);return t="000".substr(0,6-t.length)+t}function P(n){return(n*d).toFixed(1)}const w=$$.viewController(n,{data:{imu_angle:[0,0,0],euler:[0,0,0],imux:function(){return L(this.imu_angle[0])},imuy:function(){return L(this.imu_angle[1])},imuz:function(){return L(this.imu_angle[2])},roll:function(){return P(this.euler[0])},pitch:function(){return P(this.euler[1])},yaw:function(){return P(this.euler[2])}},events:{enableIMU:function(n){console.log("enableIMU"),e.writeIo(280,8192),e.writeIo(24,0)},launch:function(){console.log("launch")}}}),C=w.scope.fdai.get(0),I=C.getContext("2d");function O(){w.setData({imu_angle:f,euler:g}),i(R)>.01&&(!function(){const n=a(f[0]),t=a(f[1]),e=a(f[2]),i=l(f[0]),s=l(f[1]),u=l(f[2]),d=e,b=u*i,v=s*e*n+t*i,p=-u*n,h=-t*e*n+s*i;g[0]=c(p),g[1]=o(v,h),g[2]=o(d,b);for(let n=0;n<3;n++)g[n]<-2*r?g[n]+=2*r:g[n]>=2*r&&(g[n]-=2*r)}(),function(){let n=g[0],t=g[1],e=g[2];I.fillStyle="#888888",I.fillRect(0,0,C.width,C.height),I.setTransform(1,0,0,1,C.width/2,C.height/2),I.strokeStyle="#FFFFFF",I.lineWidth=2;for(let n=0;n<36;n++){const t=10*n*u,e=n%3?10:15;I.beginPath(),I.moveTo((b+2)*l(t),(b+2)*a(t)),I.lineTo((b+e)*l(t),(b+e)*a(t)),I.stroke()}let s=1;I.rotate(-n),I.strokeStyle="#000",I.lineWidth=4,I.beginPath(),I.fillStyle="#FFFFFF",I.lineWidth=1,I.arc(0,0,b,0,2*r,!0),I.fill(),I.stroke(),I.save(),I.beginPath(),I.lineWidth=4,I.fillStyle="#000000",l(t)<0?(t+=r,I.arc(0,0,b,0,r,!0)):I.arc(0,0,b,0,r,!1),s=a(t),i(s)<.001?(I.moveTo(-b,0),I.lineTo(b,0)):(I.scale(1,s),I.arc(0,0,b,r,0,!0)),I.fill(),I.restore(),I.save(),I.beginPath(),I.strokeStyle="#aaa",l(e)<0&&(e+=r),e=A(e,-r,r),s=-a(e),i(s)<.01?(I.lineWidth=1,I.moveTo(0,-b),I.lineTo(0,b)):(I.lineWidth=4,I.scale(s,1),I.arc(0,0,b,-r/2,r/2,!0)),I.stroke(),I.restore(),I.beginPath(),I.strokeStyle="#F00",I.lineWidth=2,I.arc(0,0,10,0,2*r,!1),I.stroke()}(),R=0)}function N(n){if(E)return;for(let t=0;t<3;t++)if(n[t]){f[t]=A(f[t]+n[t],0,2*r);const a=A(f[t]-k[t],-r,r);R+=i(a);const l=a>0?1:-1,o=s(i(a)/h);k[t]=A(k[t]+l*h*o,0,2*r);let c=e.getErasable[26+t];c=16384&c?-(32767^c):c,c+=l*o,e.getErasable[26+t]=c<0?32767^-c:c}}T(),this.update=O,this.gyro_coarse_align=function(n,t){console.log("gyro_coarse_align",n,t);const e=(16384&t?-1:1)*(16383&t);124===n?N([e*v,0,0]):125===n?N([0,e*v,0]):126===n&&N([0,0,e*v]),O()},this.zero=T,this.gyro_fine_align=function(n,t){console.log("gyro_fine_align",n,t);const e=8192&t,i=4096&t,s=(16384&t?-1:1)*(2047&t);!e&&i&&N([s*p,0,0]),e&&!i&&N([0,s*p,0]),e&&i&&N([0,0,s*p]),O()}}});