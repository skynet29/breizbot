$$.control.registerControl("rootPage",{template:'<div>\n    <div bn-control="DSKY" bn-event="key: onKey" bn-iface="dsky"></div>\n</div>\n\n<div>\n    <div bn-control="IMU" bn-iface="imu" bn-event="launch: onLaunch"></div>\n\n</div>\n',deps:["breizbot.files","app.emuAgc","brainjs.http"],props:{},init:function(t,n,e,i){const s=$$.viewController(t,{data:{},events:{onKey:function(t,n){const{val:i}=n;isNaN(i)||e.writeIo(13,i)},onLaunch:function(){console.log("onLaunch"),d||b||(e.writeIo(24,0,e.inputsMask.LIFTOFF),u=c,l.setReactor(0),b=!0)}}}),a=s.scope.dsky,l=s.scope.imu,o=Math.PI/180;let r=null,c=0,u=-1,d=!1,b=!1;!async function(){r=await i.get(n.assetsUrl("profile.json")),await e.loadRom(n.assetsUrl("Comanche055.bin")),e.reset(),e.on("channelUpdate",t=>{const{channel:n,value:i}=t;switch(n){case 8:a.process(n,i);break;case 10:i&e.outputsMask.ZERO_IMU&&l.zero();break;case 124:case 125:case 126:l.gyro_coarse_align(n,i);break;case 127:l.gyro_fine_align(n,i)}}),e.on("lightsUpdate",t=>{a.processLights(t)}),e.start(),setInterval(()=>{if(l.setSt(Math.round(c/10)),e.loop(),b){const t=Math.round((c-u)/10);if(l.setMet(t),d||t>=r.length)return d=!0,void(b=!1);if(l.accelerate([1.08*r[t][2],0,0]),l.rotate([-r[t][3]/10*o,-r[t][1]/10*o,0]),c%10==0&&l.update(),r[t][4]){const n=Math.round(r[t][4]);l.setReactor(n)}}c++,e.readAllIo()},100)}()}}),$$.service.registerService("app.emuAgc",{deps:["breizbot.files"],init:function(t){const n=Module.cwrap("set_fixed",null,["number"]),e=Module.cwrap("cpu_reset"),i=Module.cwrap("cpu_step",null,["number"]),s=Module.cwrap("packet_read","number"),a=Module.cwrap("packet_write",null,["number","number"]),l=Module.cwrap("get_erasable_ptr","number"),o=new EventEmitter2,r=.01172,c={channels:{},lamps:0};let u=0,d=0,b=null;function v(t){return 1<<t-1}const h={COMP_ACTY:v(2),UPLINK_ACTY:v(3),TEMP:v(4),KEY_REL:v(5),VERB_NOUN:v(6),OPER_ERR:v(7),RESTART:v(8),STBY:v(9)},p={PRIO_DISP:v(1),NO_DAP:v(2),VEL:v(3),NO_ATT:v(4),ALT:v(5),GIMBAL_LOCK:v(6),TRACKER:v(8),PROG:v(9)},f={LIFTOFF:v(5),ISS_TURN_ON:v(14),PROCEED:v(14)},m={ZERO_IMU:v(5)};return{writeIo:function(t,n,e){null!=e&&a(t+256,e),a(t,n)},loadRom:async function(t){const e=await fetch(t),i=await e.arrayBuffer(),s=new Uint8Array(i);console.log("romArray",s.length);const a=Module._malloc(s.length*s.BYTES_PER_ELEMENT);console.log("romPtr",a),Module.HEAP8.set(s,a),n(a),Module._free(a),b=l(),console.log("erasablePtr",b)},reset:e,stepCpu:i,on:o.on.bind(o),start:function(){u=performance.now(),d=0},loop:function(){const t=Math.floor((performance.now()-u)/r)-d;if(t<0||t>1e5)return u=performance.now(),void(d=0);i(t),d+=t},readAllIo:function(){let t;do{const n=(t=s())>>16,e=65535&t;if(c.channels[n],o.emit("channelUpdate",{channel:n,value:e}),9===n){const t=6;c.lamps=c.lamps&~t>>>0|e&t,o.emit("lightsUpdate",c.lamps)}else if(115===n){const t=504;c.lamps=c.lamps&~t>>>0|e&t,o.emit("lightsUpdate",c.lamps)}}while(t)},peek:function(t){return 32767&Module.getValue(b+2*t,"i16")},poke:function(t,n){Module.setValue(b+2*t,n,"i16")},lampMask:h,statusMask:p,inputsMask:f,outputsMask:m}}}),$$.control.registerControl("DSKY",{template:'\n<div class="top">\n    <div class="left">\n        <div class="col">\n            <div bn-style="uplink_acty"><span>UPLINK ACTY</span></div>\n            <div bn-style="no_att">NO ATT</div>\n            <div bn-style="stby">STBY</div>\n            <div bn-style="key_rel">KEY REL</div>\n            <div bn-style="opr_err">OPR ERR</div>\n            <div></div>\n            <div></div>\n        </div>\n\n        <div class="col">\n            <div bn-style="temp">TEMP</div>\n            <div bn-style="gimball_lock"><span>GIMBALL LOCK</span></div>\n            <div bn-style="prog">PROG</div>\n            <div>RESTART</div>\n            <div bn-style="tracker">TRACKER</div>\n            <div bn-style="alt">ALT</div>\n            <div bn-style="vel">VEL</div>\n        </div>\n\n    \n    </div>\n    \n    \n    <div class="right">\n        <div class="line">\n            <div class="compActy" bn-style="comp_acty"><span>COMP ACTY</span></div>\n            <div>\n                <div class="label">PROG</div>\n                <div class="digit" bn-html="prog00"></div>\n            </div>\n    \n        </div>\n        <div class="line">\n            <div>\n                <div class="label">VERB</div>\n                <div class="digit" bn-html="verb00"></div>\n            </div>\n            <div>\n                <div class="label">NOUN</div>\n                <div class="digit" bn-html="noun00"></div>\n            </div>\n        </div>\n        <div class="digit big" bn-html="r1"></div>\n        <div class="digit big" bn-html="r2"></div>\n        <div class="digit big" bn-html="r3"></div>\n    \n    </div>\n</div>\n\n<div class="bottom">\n    <div class="keyboard" bn-event="click.key: onKey">\n        <div>\n            <button class="label key">VERB</button>\n            <button class="label key">NOUN</button>\n        </div>\n        <div>\n            <button class="key">+</button>\n            <button class="key">-</button>\n            <button class="key">0</button>\n        </div>\n        <div>\n            <button class="key">1</button>\n            <button class="key">4</button>\n            <button class="key">7</button>\n        </div>\n        <div>\n            <button class="key">8</button>\n            <button class="key">5</button>\n            <button class="key">2</button>\n        </div>\n        <div>\n            <button class="key">9</button>\n            <button class="key">6</button>\n            <button class="key">3</button>\n        </div>\n        <div>\n            <button class="label key">CLR</button>\n            <button class="label key">PRO</button>\n            <button class="label key">KEY REL</button>\n        </div>\n        <div>\n            <button class="label key">ENTR</button>\n            <button class="label key">RSET</button>\n        </div>\n    \n    </div>\n</div>\n',deps:["breizbot.pager","app.emuAgc"],props:{},init:function(t,n,e){Math.floor,Math.round;const i={VERB:17,NOUN:31,"+":26,"-":27,0:16,CLR:30,"KEY REL":25,ENTR:28,RSET:18};function s(t){var n="E";switch(t){case 0:n="H";break;case 21:n="0";break;case 3:n="1";break;case 25:n="2";break;case 27:n="3";break;case 15:n="4";break;case 30:n="5";break;case 28:n="6";break;case 19:n="7";break;case 29:n="8";break;case 31:n="9"}return n}let a=0,l=0,o=0,r=0,c=0,u=0;const d="&nbsp;";function b(t){return{"background-color":t?"#ffc200":"#888888"}}function v(t){return{"background-color":t?"#ffffff":"#888888"}}const h=$$.viewController(t,{data:{lamps:0,status8:0,digits:"000000+00000+00000+00000",on:0,comp_acty:function(){return b(this.lamps&e.lampMask.COMP_ACTY)},uplink_acty:function(){return v(this.lamps&e.lampMask.UPLINK_ACTY)},temp:function(){return b(this.lamps&e.lampMask.TEMP)},key_rel:function(){return v(this.lamps&e.lampMask.KEY_REL)},opr_err:function(){return v(this.lamps&e.lampMask.OPER_ERR)},stby:function(){return v(this.lamps&e.lampMask.STBY)},vel:function(){return b(this.status8&e.statusMask.VEL)},no_att:function(){return v(this.status8&e.statusMask.NO_ATT)},alt:function(){return b(this.status8&e.statusMask.ALT)},gimball_lock:function(){return b(this.status8&e.statusMask.GIMBAL_LOCK)},tracker:function(){return b(this.status8&e.statusMask.TRACKER)},prog:function(){return b(this.status8&e.statusMask.PROG)},r1:function(){return this.digits.slice(6,12).replace(/H/g,d)},r2:function(){return this.digits.slice(12,18).replace(/H/g,d)},prog00:function(){return this.digits.slice(0,2).replace(/H/g,d)},r3:function(){return this.digits.slice(18,24).replace(/H/g,d)},verb00:function(){return this.lamps&e.lampMask.VERB_NOUN?d+d:this.digits.slice(2,4).replace(/H/g,d)},noun00:function(){return this.lamps&e.lampMask.VERB_NOUN?d+d:this.digits.slice(4,6).replace(/H/g,d)}},events:{onKey:function(n){const e=$(this).text();let s=i[e];null==s&&(s=parseInt(e)),n.stopPropagation(),t.trigger("key",{val:s})}}});this.processLights=function(t){h.setData({lamps:t})},this.process=function(t,n){if(0==n)return;const e=n>>11,i=n>>10&1,d=s(n>>5&31),b=s(31&n),v=h.model.digits.split("");switch(e){case 12:h.setData({status8:n});break;case 11:v[0]=d,v[1]=b;break;case 10:v[2]=d,v[3]=b;break;case 9:v[4]=d,v[5]=b;break;case 8:v[7]=b;break;case 7:v[8]=d,v[9]=b,a=i;break;case 6:v[10]=d,v[11]=b,l=i;break;case 5:v[13]=d,v[14]=b,o=i;break;case 4:v[15]=d,v[16]=b,r=i;break;case 3:v[17]=d,v[19]=b;break;case 2:v[20]=d,v[21]=b,c=i;break;case 1:v[22]=d,v[23]=b,u=i}if(12!=e){v[6]=a&&!l?"+":a||l?"-":"H",v[12]=o&&!r?"+":o||r?"-":"H",v[18]=c&&!u?"+":c||u?"-":"H";const t=v.join("");h.setData({digits:t})}}}}),$$.control.registerControl("FDAI",{template:'<svg width="350" height="360" bn-bind="svg">\n    <defs>\n      <marker id="triangle" viewBox="0 0 10 10"\n            refX="1" refY="5"\n            markerUnits="strokeWidth"\n            markerWidth="10" markerHeight="10"\n            orient="auto">\n        <path d="M 0 0 L 10 5 L 0 10 z" fill="black"/>\n      </marker>\n      <marker id="triangle2" viewBox="0 0 16 16"\n            refX="1" refY="8"\n            markerUnits="strokeWidth"\n            markerWidth="16" markerHeight="16"\n            orient="auto">\n        <path d="M 0 0 L 16 8 L 0 16 z" fill="black"/>\n      </marker>\n  \n  </defs>\n    \n  </svg>',deps:["breizbot.pager"],props:{},init:function(t,n){const e=$$.viewController(t,{data:{},events:{}}).scope.svg.get(0),i=150,s=180,a=180/Math.PI,l=42.1875/384;let o=0,r=0,c=0,u=0,d=0,b=0;function v(t,n){Object.keys(n).forEach(e=>{t.setAttribute(e,n[e])})}function h(t,n){const i=document.createElementNS("http://www.w3.org/2000/svg",t);return"object"==typeof n&&v(i,n),e.appendChild(i),i}function p(t,n,e,i,s,a){return h("line",Object.assign({x1:t,y1:n,x2:e,y2:i,stroke:s},a))}function f(t,n,e,i,s){const a=h("text",Object.assign({x:t,y:n,fill:i},s));return a.textContent=e,a}function m(t,n,e,i,s){return h("circle",Object.assign({r:e,cx:t,cy:n,fill:i},s))}const k={};function g(t,n){v(k[t],{x1:n,x2:n})}function M(t,n){v(k[t],{y1:n,y2:n})}function y(t,n,e,i,s){v(k[t],{x1:n,y1:e,x2:i,y2:s})}function _(t,n,e){v(k[t],{x:n,y:e})}function R(t,n,e,i,s,a){const l=i*Math.PI/180;return p(t+e*Math.sin(l),n+e*Math.cos(l),t+(e+=s)*Math.sin(l),n+e*Math.cos(l),a)}for(let t=-270;t<=270;t+=30){const n=t>=-180&&t<=0||t>=180&&t<=360?"black":"white";k[`PITCH_${t}`]=p(0,0,0,0,n);const e=t<0?t+360:t;k[`PITCH_TXT_${t}`]=f(0,0,e,n)}k.zAxisLM=p(0,0,0,0,"blue");for(let t=-270;t<=270;t+=30){k[`zAxis_${t}`]=p(0,0,0,0,"blue");const n=t<0?t+360:t;k[`zAxis_TXT_${t}`]=f(0,0,n,"blue")}k.RollMarker=p(0,0,0,0,"black",{"marker-end":"url(#triangle2)"}),k.YawErrorNeedle=p(0,s+10,0,s+100,"orange"),k.PitchErrorNeedle=p(i+10,0,i+100,0,"orange"),k.RollErrorNeedle=p(0,s-10,0,s-100,"orange"),m(i,s,190,"none",{stroke:"darkgrey","stroke-width":180});for(let t=70;t<110;t+=.5)R(i,s,100,t,10,"red");for(let t=250;t<290;t+=.5)R(i,s,100,t,10,"red");for(let t=0;t<360;t+=10){R(i,s,100,t,t%30==0?10:15,"white")}m(i,s,100,"none",{stroke:"black","stroke-width":4}),p(i-10,s,i+10,s,"white"),p(i,s-10,i,s+10,"white");for(let t=-5;t<=5;t++)p(i+10*t,310,i+10*t,315,"white");k.YawRateMarker=p(0,325,0,324,"black",{"marker-end":"url(#triangle)"}),f(i,310,"0","white"),f(i,340,"YAW RATE","white"),k.RollRateMarker=p(0,36,0,37,"black",{"marker-end":"url(#triangle)"}),f(i,62,"0","white"),f(i,30,"ROLL RATE","white");for(let t=-5;t<=5;t++)p(i+10*t,45,i+10*t,50,"white");for(let t=-5;t<=5;t++)p(280,s+10*t,285,s+10*t,"white");function w(t){const n=2*Math.PI;return t<-n?t+n:t>=n?t-n:t}function E(t,n,e){return Math.max(Math.min(e,t),n)}function T(n){const[e,h,p]=n,f=Math.sin(e),m=Math.sin(h),R=Math.sin(p),T=Math.cos(e),I=Math.cos(h),L=Math.cos(p),A=R,P=L*T,O=I*R*f+m*T,x=-L*f,C=-m*R*f+I*T,N=w(Math.atan2(A,P)),U=w(Math.atan2(O,C)),$=w(Math.asin(x)),S=N,Y=Math.sin(-1*S),K=Math.cos(-1*S),H=-1*$*a,z=U*a,G=N*a,B=H>0?360-H:Math.abs(H),D=z<0?z+360:z,V=G<0?G+360:G;t.trigger("data",{fdai:[B,D,V]}),g("YawRateMarker",i-10*E(b,-5,5)),M("PitchRateMarker",s-10*E(d,-5,5)),g("RollRateMarker",i+10*E(u,-5,5)),g("YawErrorNeedle",i+o*l),M("PitchErrorNeedle",s+r*l),g("RollErrorNeedle",i-c*l);const F=i+85*Math.sin(S+Math.PI),j=i+86*Math.sin(S+Math.PI),W=s+85*Math.cos(S+Math.PI),X=s+86*Math.cos(S+Math.PI);function Z(t,n){return{x:t*K-n*Y+i,y:t*Y+n*K+s}}v(k.RollMarker,{x1:F,y1:W,x2:j,y2:X});const q=z>180?z-180:z;for(let t=-270;t<=270;t+=30){const n=-50,e=50,i=-t+q,s=0,a=i,{x:l,y:o}=Z(s,a),{x:r,y:c}=Z(n,i),{x:u,y:d}=Z(e,i);_(`PITCH_TXT_${t}`,l,o),y(`PITCH_${t}`,r,c,u,d)}const J=H>180?H-180:H,Q=-280+J,tt=280+J,{x:nt,y:et}=Z(Q,0),{x:it,y:st}=Z(tt,0);y("zAxisLM",nt,et,it,st);for(let t=-270;t<=270;t+=30){const n=t+J,e=-2,i=t+J,s=3,a=t+J,l=10,{x:o,y:r}=Z(a,l),{x:c,y:u}=Z(n,e),{x:d,y:b}=Z(i,s);_(`zAxis_TXT_${t}`,o,r),y(`zAxis_${t}`,c,u,d,b)}}k.PitchRateMarker=p(296,0,295,0,"black",{"marker-end":"url(#triangle)"}),f(i+128-5,s,"0","white",{"alignment-baseline":"middle"}),f(i+155,s-30,"P","white"),f(i+155,s-22,"I","white"),f(i+155,s-14,"T","white"),f(i+155,s-6,"C","white"),f(i+155,s+2,"H","white"),f(i+155,s+18,"R","white"),f(i+155,s+26,"A","white"),f(i+155,s+34,"T","white"),f(i+155,s+42,"E","white"),T([0,0,0]),this.update=T}}),$$.control.registerControl("IMU",{template:'<div class="top">\n    <div class="left">\n        <div class="imuGroup">\n            <label class="imuLabel">ST</label>\n            <div class="clock" bn-html="getSt"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">MET</label>\n            <div class="clock" bn-html="getMet"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">OGA</label>\n            <div class="imu" bn-html="imux"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">IGA</label>\n            <div class="imu" bn-html="imuy"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">MGA</label>\n            <div class="imu" bn-html="imuz"></div>\n        </div>\n    </div>\n\n    <div class="middle">\n        <div class="imuGroup">\n            <label class="imuLabel">ROLL</label>\n            <div class="imu" bn-html="roll"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">PITCH</label>\n            <div class="imu" bn-html="pitch"></div>\n        </div>\n        <div class="imuGroup">\n            <label class="imuLabel">YAW</label>\n            <div class="imu" bn-html="yaw"></div>\n        </div>\n\n    </div>\n\n    <div class="right">\n        <button bn-event="click: enableIMU">Enable IMU</button>\n        <button bn-event="click: launch">Launch</button>\n        <div class="light" bn-style="sic">S-IC</div>\n        <div class="light" bn-style="sii">S-II</div>\n        <div class="light" bn-style="sivb">S-IVB</div>\n    </div>\n</div>\n<div class="bottom">\n    <div bn-control="FDAI" bn-iface="fdai" bn-event="data: onData"></div>\n</div>\n',deps:["breizbot.pager","app.emuAgc"],props:{},init:function(t,n,e){const i=Math.abs,s=Math.floor,a=(Math.round,Math.sqrt,Math.sin),l=Math.cos,o=(Math.atan2,Math.asin,Math.PI),r=o/180,c=180/o,u=.043948*r,d=.617981/3600*r,b=360/32768*r,v=.0585;let h,p,f,m,k,g,M,y,_=0;function R(){P.update(p),A.setData({imu_angle:p})}function w(t,n,e){return t-(e-n)*s((t-n)/(e-n))}function E(t){let n=(t*c).toFixed(2);return n="000".substr(0,6-n.length)+n}function T(t){return t.toFixed(1)}function I(t){const n=s(t/3600),e=s(t/60)%60,i=t%60;return(n<10?"0"+n:n)+":"+(e<10?"0"+e:e)+":"+(i<10?"0"+i:i)}function L(t){return{"background-color":t?"#ffc200":"#888888"}}const A=$$.viewController(t,{data:{st:0,met:0,c:-1,sic:function(){return L(0==this.c)},sii:function(){return L(1==this.c)},sivb:function(){return L(2==this.c)},getSt:function(){return I(this.st)},getMet:function(){return I(this.met)},imu_angle:[0,0,0],euler:[0,0,0],imux:function(){return E(this.imu_angle[0])},imuy:function(){return E(this.imu_angle[1])},imuz:function(){return E(this.imu_angle[2])},roll:function(){return T(this.euler[0])},pitch:function(){return T(this.euler[1])},yaw:function(){return T(this.euler[2])}},events:{onData:function(t,n){A.setData({euler:n.fdai})},enableIMU:function(t){console.log("enableIMU"),e.writeIo(24,0,e.inputsMask.ISS_TURN_ON)},launch:function(n){n.stopPropagation(),t.trigger("launch")}}}),P=A.scope.fdai;function O(t){if(y)return;for(let n=0;n<3;n++)if(t[n]){p[n]=w(p[n]+t[n],0,2*o);const a=w(p[n]-m[n],-o,o);_+=i(a);const l=a>0?1:-1;let r=s(i(a)/b);m[n]=w(m[n]+l*b*r,0,2*o);let c=e.peek(26+n);c=16384&c?-(32767^c):c,c+=l*r,e.poke(26+n,c<0?32767^-c:c)}}this.rotate=function(t){const n=a(p[2]),e=l(p[2])*l(p[0]),i=a(p[0]),s=-l(p[2])*a(p[0]),r=l(p[0]),c=r*e-s*i;O([w(t[0]-(t[1]*r*n-t[2]*i*n)/c,-o,o),w((t[1]*r-t[2]*i)/c,-o,o),w((t[2]*e-t[1]*s)/c,-o,o)])},this.update=R,this.accelerate=function(t){const n=a(p[0]),i=a(p[1]),o=a(p[2]),r=l(p[0]),c=l(p[1]),u=l(p[2]),d=[u*c*t[0]+(-r*o*c+n*i)*t[1]+(n*o*c+r*i)*t[2],o*t[0]+r*u*t[1]-n*u*t[2],-u*i*t[0]+(r*o*i+n*c)*t[1]+(-n*o*i+r*c)*t[2]];for(let t=0;t<3;t++){M[t]+=d[t];const n=s((M[t]-g[t]*v)/v);g[t]+=n;let i=e.peek(31+t);i=16384&i?-(32767^i):i,i+=n,e.poke(31+t,i<0?32767^-i:i)}},this.gyro_coarse_align=function(t,n){const e=(16384&n?-1:1)*(16383&n);124===t?O([e*u,0,0]):125===t?O([0,e*u,0]):126===t&&O([0,0,e*u]),R()},this.zero=function(){console.log("zero"),h=[0,0,0],p=[0,0,0],f=[0,0,0],m=[0,0,0],k=[0,0,0],M=[0,0,0],g=[0,0,0],y=!1,_=1,R()},this.gyro_fine_align=function(t,n){const e=8192&n,i=4096&n,s=(16384&n?-1:1)*(2047&n);!e&&i&&O([s*d,0,0]),e&&!i&&O([0,s*d,0]),e&&i&&O([0,0,s*d]),R()},this.setSt=function(t){A.setData({st:t})},this.setMet=function(t){A.setData({met:t})},this.setReactor=function(t){A.setData({c:t})}}});