$$.control.registerControl("rootPage",{template:'<div class="toolbar">\n    <button bn-event="click: onSave" class="w3-btn w3-blue">Save</button>\n    <button bn-event="click: onGenerate" class="w3-btn w3-blue">Generate</button>\n\n</div>\n<div id="blocklyDiv"></div>\n<div class="logPanel" bn-html="getLogs"></div>\n\n<xml id="toolbox" style="display: none;">\n    <category name="Logic" categorystyle="logic_category">\n        <block type="controls_if"></block>\n        <block type="logic_compare"></block>\n        <block type="logic_operation"></block>\n        <block type="logic_negate"></block>\n        <block type="logic_boolean"></block>\n        <block type="logic_ternary"></block>\n    </category>\n    <category name="Loop" categorystyle="loop_category">\n        <block type="controls_repeat_ext">\n            <value name="TIMES">\n                <shadow type="math_number">\n                    <field name="NUM">10</field>\n                </shadow>\n            </value>\n        </block>\n        <block type="controls_whileUntil"></block>\n        <block type="controls_for">\n            <value name="FROM">\n                <shadow type="math_number">\n                    <field name="NUM">1</field>\n                </shadow>\n            </value>\n            <value name="TO">\n                <shadow type="math_number">\n                    <field name="NUM">10</field>\n                </shadow>\n            </value>\n            <value name="BY">\n                <shadow type="math_number">\n                    <field name="NUM">1</field>\n                </shadow>\n            </value>\n        </block>\n        <block type="controls_forEach"></block>\n        <block type="controls_flow_statements"></block>\n    </category>\n    <category name="Math" categorystyle="math_category">\n        <block type="math_number"></block>\n        <block type="math_arithmetic"></block>\n        <block type="math_random_int">\n            <value name="FROM">\n                <shadow type="math_number">\n                    <field name="NUM">1</field>\n                </shadow>\n            </value>\n            <value name="TO">\n                <shadow type="math_number">\n                    <field name="NUM">100</field>\n                </shadow>\n            </value>\n        </block>\n    </category>\n    <category name="Text" categorystyle="text_category">\n        <block type="text"></block>\n        <block type="text_print"></block>\n        <block type="text_length">\n            <value name="VALUE">\n                <shadow type="text">\n                    <field name="TEXT">abc</field>\n                </shadow>\n            </value>\n        </block>\n        <block type="text_changeCase">\n            <field name="CASE">UPPERCASE</field>\n            <value name="TEXT">\n                <shadow type="text">\n                    <field name="TEXT">abc</field>\n                </shadow>\n            </value>\n        </block>\n        <block type="text_append">\n            <field name="VAR" id="MHveE$^#X7/c|*RA!r{I">item</field>\n            <value name="TEXT">\n                <shadow type="text">\n                    <field name="TEXT" />\n                </shadow>\n            </value>\n        </block>\n        <block type="text_indexOf"></block>\n        <block type="text_charAt"></block>\n        <block type="text_getSubstring"></block>\n        <block type="text_prompt_ext">\n            <mutation type="TEXT" />\n            <field name="TYPE">TEXT</field>\n            <value name="TEXT">\n                <shadow type="text">\n                    <field name="TEXT">abc</field>\n                </shadow>\n            </value>\n        </block>\n    </category>\n    <category name="Lists" categorystyle="list_category">\n        <block type="lists_create_with">\n            <mutation items="0"></mutation>\n        </block>\n        <block type="lists_create_with"></block>\n        <block type="lists_repeat">\n            <value name="NUM">\n                <shadow type="math_number">\n                    <field name="NUM">5</field>\n                </shadow>\n            </value>\n        </block>\n        <block type="lists_length"></block>\n        <block type="lists_isEmpty"></block>\n        <block type="lists_indexOf">\n            <value name="VALUE">\n                <block type="variables_get">\n                    <field name="VAR">list</field>\n                </block>\n            </value>\n        </block>\n        <block type="lists_getIndex">\n            <value name="VALUE">\n                <block type="variables_get">\n                    <field name="VAR">list</field>\n                </block>\n            </value>\n        </block>\n        <block type="lists_setIndex">\n            <value name="LIST">\n                <block type="variables_get">\n                    <field name="VAR">list</field>\n                </block>\n            </value>\n        </block>\n        <block type="lists_getSublist">\n            <value name="LIST">\n                <block type="variables_get">\n                    <field name="VAR">list</field>\n                </block>\n            </value>\n        </block>\n        <block type="lists_split">\n            <value name="DELIM">\n                <shadow type="text">\n                    <field name="TEXT">,</field>\n                </shadow>\n            </value>\n        </block>\n        <block type="lists_sort"></block>\n        <block type="lists_reverse"></block>\n    </category>\n    <category name="Variables" custom="VARIABLE" categorystyle="variable_category"></category>\n    <category name="Functions" custom="PROCEDURE" categorystyle="procedure_category"></category>\n    <category name="Music" colour="355">\n        <block type="play_sound"></block>\n    </category>\n\n</xml>',deps:["breizbot.pager"],props:{},init:function(e,n){Blockly.Blocks.play_sound={init:function(){this.appendDummyInput().appendField("Play").appendField(new Blockly.FieldDropdown([["C4","sounds/c4.m4a"],["D4","sounds/d4.m4a"],["E4","sounds/e4.m4a"]]),"NAME"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(355),this.setTooltip(""),this.setHelpUrl("")}},javascript.javascriptGenerator.forBlock.play_sound=function(e,n){var t=e.getFieldValue("NAME");console.log("value",t);return"...\n"};Blockly.inject("blocklyDiv",{media:"../lib/blockly/media/",toolbox:document.getElementById("toolbox")});let t,o,l,a="";const s={math_number:async function(e){return e.fields.NUM},text:async function(e){return e.fields.TEXT},text_append:async function(e){const n=e.fields.VAR.id,o=await i(e.inputs.TEXT);t[n]+=o},text_length:async function(e){return await i(e.inputs.VALUE).length},variables_set:async function(e){const n=e.fields.VAR.id,o=await i(e.inputs.VALUE);console.log({varId:n,value:o}),t[n]=o},variables_get:async function(e){const n=e.fields.VAR.id;return t[n]},math_arithmetic:async function(e){const n=e.fields.OP,t=await i(e.inputs.A),o=await i(e.inputs.B);switch(console.log({operator:n,val1:t,val2:o}),n){case"ADD":return t+o;case"MINUS":return t-o;case"MULTIPLY":return t*o;case"DIVIDE":return t/o;case"POWER":return Math.pow(t,o);default:throw`Unknown operator '${n}'`}},controls_repeat_ext:async function(e){const n=await i(e.inputs.TIMES);console.log("TIMES",n);for(let t=0;t<n;t++){if(await i(e.inputs.DO),"BREAK"==a){a="";break}"CONTINUE"==a&&(a="")}},text_print:async function(e){var n;n=await i(e.inputs.TEXT),u.model.logs.push(n),u.update()},text_prompt_ext:async function(e){const n=e.fields.TYPE,t=await i(e.inputs.TEXT);return console.log({type:n,label:t}),await $$.ui.showPrompt({label:t,title:"Enter value",attrs:{type:n.toLowerCase()}})},text_changeCase:async function(e){const n=e.fields.CASE;console.log({charCase:n});const t=await i(e.inputs.TEXT);switch(n){case"UPPERCASE":return t.toUpperCase();case"LOWERCASE":return t.toLowerCase();case"TITLECASE":return t.replace(/\S+/g,function(e){return e[0].toUpperCase()+e.substring(1).toLowerCase()})}},logic_compare:async function(e){const n=e.fields.OP,t=await i(e.inputs.A),o=await i(e.inputs.B);switch(console.log({operator:n,val1:t,val2:o}),n){case"EQ":return t===o;case"NEQ":return t!==o;case"LT":return t<o;case"LTE":return t<=o;case"GT":return t>o;case"GTE":return t>=o;default:throw`Unknown operator '${n}'`}},logic_operation:async function(e){const n=e.fields.OP,t=await i(e.inputs.A),o=await i(e.inputs.B);switch(console.log({operator:n,val1:t,val2:o}),n){case"AND":return t&&o;case"OR":return t||o;default:throw`Unknown operator '${n}'`}},logic_boolean:async function(e){const n=e.fields.BOOL;return console.log("test",n),"TRUE"==n},logic_negate:async function(e){return!await i(e.inputs.BOOL)},logic_ternary:async function(e){return await i(e.inputs.IF)?await i(e.inputs.THEN):await i(e.inputs.ELSE)},controls_if:async function(e){let n=!1,t=1;const{extraState:o}=e;null!=o&&(null!=o.hasElse&&(n=o.hasElse),null!=o.elseIfCount&&(t+=o.elseIfCount)),console.log({hasElse:n,nbIf:t});let l=!1;for(let n=0;n<t;n++){const t=`IF${n}`,o=`DO${n}`;if(l=await i(e.inputs[t]),console.log(t,l),l){await i(e.inputs[o]);break}}n&&!l&&await i(e.inputs.ELSE)},controls_whileUntil:async function(e){const n=e.fields.MODE;if(console.log({mode:n}),"WHILE"==n){let n=await i(e.inputs.BOOL);for(;n;)await i(e.inputs.DO),n=await i(e.inputs.BOOL)}else{if("UNTIL"!=n)throw`Unknown mode '${n}'`;{let n=await i(e.inputs.BOOL);for(;!n;)await i(e.inputs.DO),n=await i(e.inputs.BOOL)}}},controls_for:async function(e){const n=e.fields.VAR.id,o=await i(e.inputs.FROM),l=await i(e.inputs.TO),s=await i(e.inputs.BY);console.log({from:o,to:l,by:s});for(let c=o;c<=l;c+=s){if(t[n]=c,await i(e.inputs.DO),"BREAK"==a){a="";break}"CONTINUE"==a&&(a="")}},procedures_callnoreturn:async function(e){const{extraState:n}=e,l=n.name;let a=0;null!=n.params&&(a=n.params.length);const s=[];for(let o=0;o<a;o++){const l=`ARG${o}`,a=await i(e.inputs[l]);s.push(a);const r=c(n.params[o]);t[r]=a}console.log({functionName:l,args:s});const{inputs:r}=o[l];if(null!=r&&(null!=r.STACK&&await i(r.STACK),null!=r.RETURN))return await i(r.RETURN)},procedures_callreturn:async function(e){return this.procedures_callnoreturn(e)},controls_flow_statements:async function(e){const n=e.fields.FLOW;console.log({flow:n}),a=n}};function c(e){return l.find(n=>n.name==e).id}async function i(e){if(null==e)return;if(null==e.type)if(null!=e.block)e=e.block;else{if(null==e.shadow)throw"Missig parameter block or shadow";e=e.shadow}console.log("evalCode",e.type);const n=s[e.type];if("function"!=typeof n)throw`function '${e.type}' not implemented yet`;const t=await n.call(s,e);return null==t&&""==a&&await i(e.next),t}async function r({blocks:e,variables:n}){console.log("startCode",e,n),u.setData({logs:[]}),t={},o={},l=n,a="";for(let n of e.blocks)if("procedures_defnoreturn"==n.type||"procedures_defreturn"==n.type){const e=n.fields.NAME;o[e]=n}console.log("procedures:");for(const e of Object.keys(o))console.log(e);for(let n of e.blocks)"procedures_defnoreturn"!=n.type&&"procedures_defreturn"!=n.type&&await i(n);!function(){if(console.log("dumpVariables:"),null!=l)for(const{id:e,name:n}of l){const o=t[e];console.log(`${n}=${o}`)}}()}const u=$$.viewController(e,{data:{logs:[],getLogs:function(){return this.logs.join("<br>")}},events:{onSave:function(){console.log("onSave"),r(Blockly.serialization.workspaces.save(Blockly.getMainWorkspace()))},onGenerate:function(){const e=Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace());console.log("code",e)}}})}});