var Chess=function(e){var r="b",t="w",n=-1,o="p",a="n",i="b",s="r",c="q",u="k",l="pnbrqkPNBRQK",f="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",p=["1-0","0-1","1/2-1/2","*"],d={b:[16,32,17,15],w:[-16,-32,-17,-15]},h={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},v=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],g=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],b={p:0,n:1,b:2,r:3,q:4,k:5},m={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},w={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},y=7,E=6,P=1,C=0,S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},T={w:[{square:S.a1,flag:w.QSIDE_CASTLE},{square:S.h1,flag:w.KSIDE_CASTLE}],b:[{square:S.a8,flag:w.QSIDE_CASTLE},{square:S.h8,flag:w.KSIDE_CASTLE}]},_=new Array(128),k={w:n,b:n},O=t,x={w:0,b:0},A=n,q=0,I=1,R=[],D={};function N(){_=new Array(128),k={w:n,b:n},O=t,x={w:0,b:0},A=n,q=0,I=1,R=[],D={},U(B())}function L(){$(f)}function $(e){var o=e.split(/\s+/),a=o[0],i=0;if(!Q(e).valid)return!1;N();for(var s=0;s<a.length;s++){var c=a.charAt(s);if("/"===c)i+=8;else if(-1!=="0123456789".indexOf(c))i+=parseInt(c,10);else{var u=c<"a"?t:r;M({type:c.toLowerCase(),color:u},ie(i)),i++}}return O=o[1],o[2].indexOf("K")>-1&&(x.w|=w.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(x.w|=w.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(x.b|=w.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(x.b|=w.QSIDE_CASTLE),A="-"===o[3]?n:S[o[3]],q=parseInt(o[4],10),I=parseInt(o[5],10),U(B()),!0}function Q(e){var r="No errors.",t="FEN string must contain six space-delimited fields.",n="6th field (move number) must be a positive integer.",o="5th field (half move counter) must be a non-negative integer.",a="4th field (en-passant square) is invalid.",i="3rd field (castling availability) is invalid.",s="2nd field (side to move) is invalid.",c="1st field (piece positions) does not contain 8 '/'-delimited rows.",u="1st field (piece positions) is invalid [consecutive numbers].",l="1st field (piece positions) is invalid [invalid piece].",f="1st field (piece positions) is invalid [row too large].",p="Illegal en-passant square",d=e.split(/\s+/);if(6!==d.length)return{valid:!1,error_number:1,error:t};if(isNaN(d[5])||parseInt(d[5],10)<=0)return{valid:!1,error_number:2,error:n};if(isNaN(d[4])||parseInt(d[4],10)<0)return{valid:!1,error_number:3,error:o};if(!/^(-|[abcdefgh][36])$/.test(d[3]))return{valid:!1,error_number:4,error:a};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(d[2]))return{valid:!1,error_number:5,error:i};if(!/^(w|b)$/.test(d[1]))return{valid:!1,error_number:6,error:s};var h=d[0].split("/");if(8!==h.length)return{valid:!1,error_number:7,error:c};for(var v=0;v<h.length;v++){for(var g=0,b=!1,m=0;m<h[v].length;m++)if(isNaN(h[v][m])){if(!/^[prnbqkPRNBQK]$/.test(h[v][m]))return{valid:!1,error_number:9,error:l};g+=1,b=!1}else{if(b)return{valid:!1,error_number:8,error:u};g+=parseInt(h[v][m],10),b=!0}if(8!==g)return{valid:!1,error_number:10,error:f}}return"3"==d[3][1]&&"w"==d[1]||"6"==d[3][1]&&"b"==d[1]?{valid:!1,error_number:11,error:p}:{valid:!0,error_number:0,error:r}}function B(){for(var e=0,o="",a=S.a8;a<=S.h1;a++){if(null==_[a])e++;else{e>0&&(o+=e,e=0);var i=_[a].color,s=_[a].type;o+=i===t?s.toUpperCase():s.toLowerCase()}a+1&136&&(e>0&&(o+=e),a!==S.h1&&(o+="/"),e=0,a+=8)}var c="";x[t]&w.KSIDE_CASTLE&&(c+="K"),x[t]&w.QSIDE_CASTLE&&(c+="Q"),x[r]&w.KSIDE_CASTLE&&(c+="k"),x[r]&w.QSIDE_CASTLE&&(c+="q"),c=c||"-";var u=A===n?"-":ie(A);return[o,O,c,u,q,I].join(" ")}function K(e){for(var r=0;r<e.length;r+=2)"string"==typeof e[r]&&"string"==typeof e[r+1]&&(D[e[r]]=e[r+1]);return D}function U(e){R.length>0||(e!==f?(D.SetUp="1",D.FEN=e):(delete D.SetUp,delete D.FEN))}function j(e){var r=_[S[e]];return r?{type:r.type,color:r.color}:null}function M(e,r){if(!("type"in e&&"color"in e))return!1;if(-1===l.indexOf(e.type.toLowerCase()))return!1;if(!(r in S))return!1;var t=S[r];return(e.type!=u||k[e.color]==n||k[e.color]==t)&&(_[t]={type:e.type,color:e.color},e.type===u&&(k[e.color]=t),U(B()),!0)}function z(e,r,t,n,a){var i={color:O,from:r,to:t,flags:n,piece:e[r].type};return a&&(i.flags|=w.PROMOTION,i.promotion=a),e[t]?i.captured=e[t].type:n&w.EP_CAPTURE&&(i.captured=o),i}function F(e){function r(e,r,t,n,u){if(e[t].type!==o||oe(n)!==C&&oe(n)!==y)r.push(z(e,t,n,u));else for(var l=[c,s,i,a],f=0,p=l.length;f<p;f++)r.push(z(e,t,n,u,l[f]))}var t=[],n=O,u=se(n),l={b:P,w:E},f=S.a8,p=S.h1,v=!1,g=!(void 0!==e&&"legal"in e)||e.legal;if(void 0!==e&&"square"in e){if(!(e.square in S))return[];f=p=S[e.square],v=!0}for(var b=f;b<=p;b++)if(136&b)b+=7;else{var m=_[b];if(null!=m&&m.color===n)if(m.type===o){var T=b+d[n][0];if(null==_[T]){r(_,t,b,T,w.NORMAL);T=b+d[n][1];l[n]===oe(b)&&null==_[T]&&r(_,t,b,T,w.BIG_PAWN)}for(q=2;q<4;q++){136&(T=b+d[n][q])||(null!=_[T]&&_[T].color===u?r(_,t,b,T,w.CAPTURE):T===A&&r(_,t,b,A,w.EP_CAPTURE))}}else for(var q=0,I=h[m.type].length;q<I;q++){var R=h[m.type][q];for(T=b;!(136&(T+=R));){if(null!=_[T]){if(_[T].color===n)break;r(_,t,b,T,w.CAPTURE);break}if(r(_,t,b,T,w.NORMAL),"n"===m.type||"k"===m.type)break}}}if(!v||p===k[n]){if(x[n]&w.KSIDE_CASTLE){var D=(N=k[n])+2;null!=_[N+1]||null!=_[D]||X(u,k[n])||X(u,N+1)||X(u,D)||r(_,t,k[n],D,w.KSIDE_CASTLE)}if(x[n]&w.QSIDE_CASTLE){var N;D=(N=k[n])-2;null!=_[N-1]||null!=_[N-2]||null!=_[N-3]||X(u,k[n])||X(u,N-1)||X(u,D)||r(_,t,k[n],D,w.QSIDE_CASTLE)}}if(!g)return t;var L=[];for(b=0,I=t.length;b<I;b++)re(t[b]),Y(n)||L.push(t[b]),te();return L}function G(e,r){var t="";if(e.flags&w.KSIDE_CASTLE)t="O-O";else if(e.flags&w.QSIDE_CASTLE)t="O-O-O";else{var n=function(e,r){for(var t=F({legal:!r}),n=e.from,o=e.to,a=e.piece,i=0,s=0,c=0,u=0,l=t.length;u<l;u++){var f=t[u].from,p=t[u].to,d=t[u].piece;a===d&&n!==f&&o===p&&(i++,oe(n)===oe(f)&&s++,ae(n)===ae(f)&&c++)}if(i>0)return s>0&&c>0?ie(n):c>0?ie(n).charAt(1):ie(n).charAt(0);return""}(e,r);e.piece!==o&&(t+=e.piece.toUpperCase()+n),e.flags&(w.CAPTURE|w.EP_CAPTURE)&&(e.piece===o&&(t+=ie(e.from)[0]),t+="x"),t+=ie(e.to),e.flags&w.PROMOTION&&(t+="="+e.promotion.toUpperCase())}return re(e),H()&&(J()?t+="#":t+="+"),te(),t}function W(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function X(e,n){for(var a=S.a8;a<=S.h1;a++)if(136&a)a+=7;else if(null!=_[a]&&_[a].color===e){var i=_[a],s=a-n,c=s+119;if(v[c]&1<<b[i.type]){if(i.type===o){if(s>0){if(i.color===t)return!0}else if(i.color===r)return!0;continue}if("n"===i.type||"k"===i.type)return!0;for(var u=g[c],l=a+u,f=!1;l!==n;){if(null!=_[l]){f=!0;break}l+=u}if(!f)return!0}}return!1}function Y(e){return X(se(e),k[e])}function H(){return Y(O)}function J(){return H()&&0===F().length}function Z(){return!H()&&0===F().length}function V(){for(var e={},r=[],t=0,n=0,o=S.a8;o<=S.h1;o++)if(n=(n+1)%2,136&o)o+=7;else{var s=_[o];s&&(e[s.type]=s.type in e?e[s.type]+1:1,s.type===i&&r.push(n),t++)}if(2===t)return!0;if(3===t&&(1===e[i]||1===e[a]))return!0;if(t===e[i]+2){var c=0,u=r.length;for(o=0;o<u;o++)c+=r[o];if(0===c||c===u)return!0}return!1}function ee(){for(var e=[],r={},t=!1;;){var n=te();if(!n)break;e.push(n)}for(;;){var o=B().split(" ").slice(0,4).join(" ");if(r[o]=o in r?r[o]+1:1,r[o]>=3&&(t=!0),!e.length)break;re(e.pop())}return t}function re(e){var t=O,a=se(t);if(function(e){R.push({move:e,kings:{b:k.b,w:k.w},turn:O,castling:{b:x.b,w:x.w},ep_square:A,half_moves:q,move_number:I})}(e),_[e.to]=_[e.from],_[e.from]=null,e.flags&w.EP_CAPTURE&&(O===r?_[e.to-16]=null:_[e.to+16]=null),e.flags&w.PROMOTION&&(_[e.to]={type:e.promotion,color:t}),_[e.to].type===u){if(k[_[e.to].color]=e.to,e.flags&w.KSIDE_CASTLE){var i=e.to-1,s=e.to+1;_[i]=_[s],_[s]=null}else if(e.flags&w.QSIDE_CASTLE){i=e.to+1,s=e.to-2;_[i]=_[s],_[s]=null}x[t]=""}if(x[t])for(var c=0,l=T[t].length;c<l;c++)if(e.from===T[t][c].square&&x[t]&T[t][c].flag){x[t]^=T[t][c].flag;break}if(x[a])for(c=0,l=T[a].length;c<l;c++)if(e.to===T[a][c].square&&x[a]&T[a][c].flag){x[a]^=T[a][c].flag;break}A=e.flags&w.BIG_PAWN?"b"===O?e.to-16:e.to+16:n,e.piece===o?q=0:e.flags&(w.CAPTURE|w.EP_CAPTURE)?q=0:q++,O===r&&I++,O=se(O)}function te(){var e=R.pop();if(null==e)return null;var t=e.move;k=e.kings,O=e.turn,x=e.castling,A=e.ep_square,q=e.half_moves,I=e.move_number;var n,a,i=O,s=se(O);if(_[t.from]=_[t.to],_[t.from].type=t.piece,_[t.to]=null,t.flags&w.CAPTURE)_[t.to]={type:t.captured,color:s};else if(t.flags&w.EP_CAPTURE){var c;c=i===r?t.to-16:t.to+16,_[c]={type:o,color:s}}t.flags&(w.KSIDE_CASTLE|w.QSIDE_CASTLE)&&(t.flags&w.KSIDE_CASTLE?(n=t.to+1,a=t.to-1):t.flags&w.QSIDE_CASTLE&&(n=t.to-2,a=t.to+1),_[n]=_[a],_[a]=null);return t}function ne(e,r){var t=W(e);if(r){var n=t.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(n)var o=n[1],a=n[2],i=n[3],s=n[4]}for(var c=F(),u=0,l=c.length;u<l;u++){if(t===W(G(c[u]))||r&&t===W(G(c[u],!0)))return c[u];if(n&&(!o||o.toLowerCase()==c[u].piece)&&S[a]==c[u].from&&S[i]==c[u].to&&(!s||s.toLowerCase()==c[u].promotion))return c[u]}return null}function oe(e){return e>>4}function ae(e){return 15&e}function ie(e){var r=ae(e),t=oe(e);return"abcdefgh".substring(r,r+1)+"87654321".substring(t,t+1)}function se(e){return e===t?r:t}function ce(e){var r=function e(r){var t=r instanceof Array?[]:{};for(var n in r)t[n]="object"==typeof n?e(r[n]):r[n];return t}(e);r.san=G(r,!1),r.to=ie(r.to),r.from=ie(r.from);var t="";for(var n in w)w[n]&r.flags&&(t+=m[n]);return r.flags=t,r}function ue(e){return e.replace(/^\s+|\s+$/g,"")}return $(void 0===e?f:e),{WHITE:t,BLACK:r,PAWN:o,KNIGHT:a,BISHOP:i,ROOK:s,QUEEN:c,KING:u,SQUARES:function(){for(var e=[],r=S.a8;r<=S.h1;r++)136&r?r+=7:e.push(ie(r));return e}(),FLAGS:m,load:function(e){return $(e)},reset:function(){return L()},moves:function(e){for(var r=F(e),t=[],n=0,o=r.length;n<o;n++)void 0!==e&&"verbose"in e&&e.verbose?t.push(ce(r[n])):t.push(G(r[n],!1));return t},in_check:function(){return H()},in_checkmate:function(){return J()},in_stalemate:function(){return Z()},in_draw:function(){return q>=100||Z()||V()||ee()},insufficient_material:function(){return V()},in_threefold_repetition:function(){return ee()},game_over:function(){return q>=100||J()||Z()||V()||ee()},validate_fen:function(e){return Q(e)},fen:function(){return B()},pgn:function(e){var r="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",t="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,n=[],o=!1;for(var a in D)n.push("["+a+' "'+D[a]+'"]'+r),o=!0;o&&R.length&&n.push(r);for(var i=[];R.length>0;)i.push(te());for(var s=[],c="";i.length>0;){var u=i.pop();R.length||"b"!==u.color?"w"===u.color&&(c.length&&s.push(c),c=I+"."):c=I+". ...",c=c+" "+G(u,!1),re(u)}if(c.length&&s.push(c),void 0!==D.Result&&s.push(D.Result),0===t)return n.join("")+s.join(" ");var l=0;for(a=0;a<s.length;a++)l+s[a].length>t&&0!==a?(" "===n[n.length-1]&&n.pop(),n.push(r),l=0):0!==a&&(n.push(" "),l++),n.push(s[a]),l+=s[a].length;return n.join("")},load_pgn:function(e,r){var t=void 0!==r&&"sloppy"in r&&r.sloppy;function n(e){return e.replace(/\\/g,"\\")}var o="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",a=new RegExp("^(\\[(.|"+n(o)+")*\\])("+n(o)+")*1.("+n(o)+"|.)*$","g"),i=e.replace(a,"$1");"["!==i[0]&&(i=""),L();var s=function(e,r){for(var t="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",o={},a=e.split(new RegExp(n(t))),i="",s="",c=0;c<a.length;c++)i=a[c].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),s=a[c].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),ue(i).length>0&&(o[i]=s);return o}(i,r);for(var c in s)K([c,s[c]]);if("1"===s.SetUp&&!("FEN"in s&&$(s.FEN)))return!1;var u=e.replace(i,"").replace(new RegExp(n(o),"g")," ");u=u.replace(/(\{[^}]+\})+?/g,"");for(var l=/(\([^\(\)]+\))+?/g;l.test(u);)u=u.replace(l,"");var f=ue(u=(u=(u=u.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));f=f.join(",").replace(/,,+/g,",").split(",");for(var d="",h=0;h<f.length-1;h++){if(null==(d=ne(f[h],t)))return!1;re(d)}if(d=f[f.length-1],p.indexOf(d)>-1)(function(e){for(var r in e)return!0;return!1})(D)&&void 0===D.Result&&K(["Result",d]);else{if(null==(d=ne(d,t)))return!1;re(d)}return!0},header:function(){return K(arguments)},ascii:function(){return function(){for(var e="   +------------------------+\n",r=S.a8;r<=S.h1;r++){if(0===ae(r)&&(e+=" "+"87654321"[oe(r)]+" |"),null==_[r])e+=" . ";else{var n=_[r].type;e+=" "+(_[r].color===t?n.toUpperCase():n.toLowerCase())+" "}r+1&136&&(e+="|\n",r+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h\n"}()},turn:function(){return O},move:function(e,r){var t=void 0!==r&&"sloppy"in r&&r.sloppy,n=null;if("string"==typeof e)n=ne(e,t);else if("object"==typeof e)for(var o=F(),a=0,i=o.length;a<i;a++)if(!(e.from!==ie(o[a].from)||e.to!==ie(o[a].to)||"promotion"in o[a]&&e.promotion!==o[a].promotion)){n=o[a];break}if(!n)return null;var s=ce(n);return re(n),s},undo:function(){var e=te();return e?ce(e):null},clear:function(){return N()},put:function(e,r){return M(e,r)},get:function(e){return j(e)},remove:function(e){return function(e){var r=j(e);return _[S[e]]=null,r&&r.type===u&&(k[r.color]=n),U(B()),r}(e)},perft:function(e){return function e(r){for(var t=F({legal:!1}),n=0,o=O,a=0,i=t.length;a<i;a++)re(t[a]),Y(o)||(r-1>0?n+=e(r-1):n++),te();return n}(e)},square_color:function(e){if(e in S){var r=S[e];return(oe(r)+ae(r))%2==0?"light":"dark"}return null},history:function(e){for(var r=[],t=[],n=(void 0!==e&&"verbose"in e&&e.verbose);R.length>0;)r.push(te());for(;r.length>0;){var o=r.pop();n?t.push(ce(o)):t.push(G(o)),re(o)}return t}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define(function(){return Chess}),function(){"use strict";var e=window.jQuery,r="abcdefgh".split(""),t=20,n="1.8.3",o=_("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"),a=200,i=200,s=60,c=30,u=100,l={};function f(e,r,t){function n(){o=0,a&&(a=!1,s())}var o=0,a=!1,i=[],s=function(){o=window.setTimeout(n,r),e.apply(t,i)};return function(e){i=arguments,o?a=!0:s()}}function p(){return"xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx".replace(/x/g,function(e){return(16*Math.random()|0).toString(16)})}function d(e){return JSON.parse(JSON.stringify(e))}function h(e){var r=e.split(".");return{major:parseInt(r[0],10),minor:parseInt(r[1],10),patch:parseInt(r[2],10)}}function v(e,r){for(var t in r)if(r.hasOwnProperty(t))for(var n="{"+t+"}",o=r[t];-1!==e.indexOf(n);)e=e.replace(n,o);return e}function g(e){return"string"==typeof e}function b(e){return"function"==typeof e}function m(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}function w(e){return"fast"===e||"slow"===e||!!m(e)&&0<=e}function y(e){if(!g(e))return!1;var r=e.split("-");return 2===r.length&&E(r[0])&&E(r[1])}function E(e){return g(e)&&-1!==e.search(/^[a-h][1-8]$/)}function P(e){return g(e)&&-1!==e.search(/^[bw][KQRNBP]$/)}function C(e){if(!g(e))return!1;var r=(e=function(e){return e.replace(/8/g,"11111111").replace(/7/g,"1111111").replace(/6/g,"111111").replace(/5/g,"11111").replace(/4/g,"1111").replace(/3/g,"111").replace(/2/g,"11")}(e=e.replace(/ .+$/,""))).split("/");if(8!==r.length)return!1;for(var t=0;t<8;t++)if(8!==r[t].length||-1!==r[t].search(/[^kqrnbpKQRNBP1]/))return!1;return!0}function S(r){if(!e.isPlainObject(r))return!1;for(var t in r)if(r.hasOwnProperty(t)&&(!E(t)||!P(r[t])))return!1;return!0}function T(){return typeof window.$&&e.fn&&e.fn.jquery&&function(e,r){e=h(e),r=h(r);var t=1e5*e.major*1e5+1e5*e.minor+e.patch;return 1e5*r.major*1e5+1e5*r.minor+r.patch<=t}(e.fn.jquery,n)}function _(e){if(!C(e))return!1;for(var t,n=(e=e.replace(/ .+$/,"")).split("/"),o={},a=8,i=0;i<8;i++){for(var s=n[i].split(""),c=0,u=0;u<s.length;u++)-1!==s[u].search(/[1-8]/)?c+=parseInt(s[u],10):(o[r[c]+a]=(t=s[u]).toLowerCase()===t?"b"+t.toUpperCase():"w"+t.toUpperCase(),c+=1);a-=1}return o}function k(e){if(!S(e))return!1;for(var t,n="",o=8,a=0;a<8;a++){for(var i=0;i<8;i++){var s=r[i]+o;e.hasOwnProperty(s)?n+=(t=void 0,"w"===(t=e[s].split(""))[0]?t[1].toUpperCase():t[1].toLowerCase()):n+="1"}7!==a&&(n+="/"),o-=1}return n.replace(/11111111/g,"8").replace(/1111111/g,"7").replace(/111111/g,"6").replace(/11111/g,"5").replace(/1111/g,"4").replace(/111/g,"3").replace(/11/g,"2")}function O(e,t,n){for(var o=function(e){for(var t=[],n=0;n<8;n++)for(var o=0;o<8;o++){var a=r[n]+(o+1);e!==a&&t.push({square:a,distance:(i=e,s=a,c=i.split(""),u=r.indexOf(c[0])+1,l=parseInt(c[1],10),f=s.split(""),p=r.indexOf(f[0])+1,d=parseInt(f[1],10),h=Math.abs(u-p),v=Math.abs(l-d),v<=h?h:v)})}var i,s,c,u,l,f,p,d,h,v;t.sort(function(e,r){return e.distance-r.distance});var g=[];for(n=0;n<t.length;n++)g.push(t[n].square);return g}(n),a=0;a<o.length;a++){var i=o[a];if(e.hasOwnProperty(i)&&e[i]===t)return i}return!1}function x(e){return"black"!==e.orientation&&(e.orientation="white"),!1!==e.showNotation&&(e.showNotation=!0),!0!==e.draggable&&(e.draggable=!1),"trash"!==e.dropOffBoard&&(e.dropOffBoard="snapback"),!0!==e.sparePieces&&(e.sparePieces=!1),e.sparePieces&&(e.draggable=!0),e.hasOwnProperty("pieceTheme")&&(g(e.pieceTheme)||b(e.pieceTheme))||(e.pieceTheme="img/chesspieces/wikipedia/{piece}.png"),w(e.appearSpeed)||(e.appearSpeed=a),w(e.moveSpeed)||(e.moveSpeed=i),w(e.snapbackSpeed)||(e.snapbackSpeed=s),w(e.snapSpeed)||(e.snapSpeed=c),w(e.trashSpeed)||(e.trashSpeed=u),function(e){return m(e)&&1<=e}(e.dragThrottleRate)||(e.dragThrottleRate=t),e}l.alpha="alpha-d2270",l.black="black-3c85d",l.board="board-b72b1",l.chessboard="chessboard-63f37",l.clearfix="clearfix-7da63",l.highlight1="highlight1-32417",l.highlight2="highlight2-9c5d2",l.notation="notation-322f9",l.numeric="numeric-fc462",l.piece="piece-417db",l.row="row-5277c",l.sparePieces="spare-pieces-7492f",l.sparePiecesBottom="spare-pieces-bottom-ae20f",l.sparePiecesTop="spare-pieces-top-4028b",l.square="square-55d63",l.white="white-1e1d7",window.Chessboard=function(t,a){if(!function(){if(T())return!0;var e="Chessboard Error 1005: Unable to find a valid version of jQuery. Please include jQuery "+n+" or higher on the page\n\nExiting…";return window.alert(e),!1}())return null;var i=function(r){if(""===r){return window.alert("Chessboard Error 1001: The first argument to Chessboard() cannot be an empty string.\n\nExiting…"),!1}g(r)&&"#"!==r.charAt(0)&&(r="#"+r);var t=e(r);if(1===t.length)return t;return window.alert("Chessboard Error 1003: The first argument to Chessboard() must be the ID of a DOM node, an ID query selector, or a single DOM node.\n\nExiting…"),!1}(t);if(!i)return null;a=x(a=function(r){return"start"===r?r={position:d(o)}:C(r)?r={position:_(r)}:S(r)&&(r={position:d(r)}),e.isPlainObject(r)||(r={}),r}(a));var s=null,c=null,u=null,h=null,m={},w=2,P="white",A={},q=null,I=null,R=null,D=!1,N={},L={},$={},Q=16;function B(e,r,t){if(!0===a.hasOwnProperty("showErrors")&&!1!==a.showErrors){var n="Chessboard Error "+e+": "+r;return"console"===a.showErrors&&"object"==typeof console&&"function"==typeof console.log?(console.log(n),void(2<=arguments.length&&console.log(t))):"alert"===a.showErrors?(t&&(n+="\n\n"+JSON.stringify(t)),void window.alert(n)):void(b(a.showErrors)&&a.showErrors(e,r,t))}}function K(e){return b(a.pieceTheme)?a.pieceTheme(e):g(a.pieceTheme)?v(a.pieceTheme,{piece:e}):(B(8272,"Unable to build image source for config.pieceTheme."),"")}function U(e,r,t){var n='<img src="'+K(e)+'" ';return g(t)&&""!==t&&(n+='id="'+t+'" '),n+='alt="" class="{piece}" data-piece="'+e+'" style="width:'+Q+"px;height:"+Q+"px;",r&&(n+="display:none;"),v(n+='" />',l)}function j(e){var r=["wK","wQ","wR","wB","wN","wP"];"black"===e&&(r=["bK","bQ","bR","bB","bN","bP"]);for(var t="",n=0;n<r.length;n++)t+=U(r[n],!1,N[r[n]]);return t}function M(r,t,n,o){var i=e("#"+L[r]),s=i.offset(),c=e("#"+L[t]),u=c.offset(),f=p();e("body").append(U(n,!0,f));var d=e("#"+f);d.css({display:"",position:"absolute",top:s.top,left:s.left}),i.find("."+l.piece).remove();var h={duration:a.moveSpeed,complete:function(){c.append(U(n)),d.remove(),b(o)&&o()}};d.animate(u,h)}function z(r,t,n){var o=e("#"+N[r]).offset(),i=e("#"+L[t]),s=i.offset(),c=p();e("body").append(U(r,!0,c));var u=e("#"+c);u.css({display:"",position:"absolute",left:o.left,top:o.top});var f={duration:a.moveSpeed,complete:function(){i.find("."+l.piece).remove(),i.append(U(r)),u.remove(),b(n)&&n()}};u.animate(s,f)}function F(){for(var r in s.find("."+l.piece).remove(),A)A.hasOwnProperty(r)&&e("#"+L[r]).append(U(A[r]))}function G(){s.html(function(e){"black"!==e&&(e="white");var t="",n=d(r),o=8;"black"===e&&(n.reverse(),o=1);for(var i="white",s=0;s<8;s++){t+='<div class="{row}">';for(var c=0;c<8;c++){var u=n[c]+o;t+='<div class="{square} '+l[i]+" square-"+u+'" style="width:'+Q+"px;height:"+Q+'px;" id="'+L[u]+'" data-square="'+u+'">',a.showNotation&&(("white"===e&&1===o||"black"===e&&8===o)&&(t+='<div class="{notation} {alpha}">'+n[c]+"</div>"),0===c&&(t+='<div class="{notation} {numeric}">'+o+"</div>")),t+="</div>",i="white"===i?"black":"white"}t+='<div class="{clearfix}"></div></div>',i="white"===i?"black":"white","white"===e?o-=1:o+=1}return v(t,l)}(P,a.showNotation)),F(),a.sparePieces&&("white"===P?(u.html(j("black")),h.html(j("white"))):(u.html(j("white")),h.html(j("black"))))}function W(e){var r=d(A),t=d(e);k(r)!==k(t)&&(b(a.onChange)&&a.onChange(r,t),A=e)}function X(e,r){for(var t in $)if($.hasOwnProperty(t)){var n=$[t];if(e>=n.left&&e<n.left+Q&&r>=n.top&&r<n.top+Q)return t}return"offboard"}function Y(){s.find("."+l.square).removeClass(l.highlight1+" "+l.highlight2)}function H(){Y();var e=d(A);delete e[R],W(e),F(),c.fadeOut(a.trashSpeed),D=!1}function J(r,t,n,o){b(a.onDragStart)&&!1===a.onDragStart(r,t,d(A),P)||(D=!0,q=t,I="spare"===(R=r)?"offboard":r,function(){for(var r in $={},L)L.hasOwnProperty(r)&&($[r]=e("#"+L[r]).offset())}(),c.attr("src",K(t)).css({display:"",position:"absolute",left:n-Q/2,top:o-Q/2}),"spare"!==r&&e("#"+L[r]).addClass(l.highlight1).find("."+l.piece).css("display","none"))}function Z(r,t){c.css({left:r-Q/2,top:t-Q/2});var n=X(r,t);n!==I&&(E(I)&&e("#"+L[I]).removeClass(l.highlight2),E(n)&&e("#"+L[n]).addClass(l.highlight2),b(a.onDragMove)&&a.onDragMove(n,I,R,q,d(A),P),I=n)}function V(r){var t="drop";if("offboard"===r&&"snapback"===a.dropOffBoard&&(t="snapback"),"offboard"===r&&"trash"===a.dropOffBoard&&(t="trash"),b(a.onDrop)){var n=d(A);"spare"===R&&E(r)&&(n[r]=q),E(R)&&"offboard"===r&&delete n[R],E(R)&&E(r)&&(delete n[R],n[r]=q);var o=d(A),i=a.onDrop(R,r,q,n,o,P);"snapback"!==i&&"trash"!==i||(t=i)}"snapback"===t?function(){if("spare"!==R){Y();var r=e("#"+L[R]).offset(),t={duration:a.snapbackSpeed,complete:function(){F(),c.css("display","none"),b(a.onSnapbackEnd)&&a.onSnapbackEnd(q,R,d(A),P)}};c.animate(r,t),D=!1}else H()}():"trash"===t?H():"drop"===t&&function(r){Y();var t=d(A);delete t[R],t[r]=q,W(t);var n=e("#"+L[r]).offset(),o={duration:a.snapSpeed,complete:function(){F(),c.css("display","none"),b(a.onSnapEnd)&&a.onSnapEnd(R,r,q)}};c.animate(n,o),D=!1}(r)}function ee(e){e.preventDefault()}function re(r){if(a.draggable){var t=e(this).attr("data-square");E(t)&&A.hasOwnProperty(t)&&J(t,A[t],r.pageX,r.pageY)}}function te(r){if(a.draggable){var t=e(this).attr("data-square");E(t)&&A.hasOwnProperty(t)&&(r=r.originalEvent,J(t,A[t],r.changedTouches[0].pageX,r.changedTouches[0].pageY))}}function ne(r){a.sparePieces&&J("spare",e(this).attr("data-piece"),r.pageX,r.pageY)}function oe(r){a.sparePieces&&J("spare",e(this).attr("data-piece"),(r=r.originalEvent).changedTouches[0].pageX,r.changedTouches[0].pageY)}m.clear=function(e){m.position({},e)},m.destroy=function(){i.html(""),c.remove(),i.unbind()},m.fen=function(){return m.position("fen")},m.flip=function(){return m.orientation("flip")},m.move=function(){if(0!==arguments.length){for(var e=!0,r={},t=0;t<arguments.length;t++)if(!1!==arguments[t])if(y(arguments[t])){var n=arguments[t].split("-");r[n[0]]=n[1]}else B(2826,"Invalid move passed to the move method.",arguments[t]);else e=!1;var o=function(e,r){var t=d(A);for(var n in r)if(r.hasOwnProperty(n)&&t.hasOwnProperty(n)){var o=t[n];delete t[n],t[r[n]]=o}return t}(0,r);return m.position(o,e),o}},m.orientation=function(e){return 0===arguments.length?P:"white"===e||"black"===e?(P=e,G(),P):"flip"===e?(P="white"===P?"black":"white",G(),P):void B(5482,"Invalid value passed to the orientation method.",e)},m.position=function(r,t){return 0===arguments.length?d(A):g(r)&&"fen"===r.toLowerCase()?k(A):(g(r)&&"start"===r.toLowerCase()&&(r=d(o)),C(r)&&(r=_(r)),void(S(r)?(!1!==t&&(t=!0),t?(function(r,t,n){if(0!==r.length)for(var o=0,i=0;i<r.length;i++){var s=r[i];"clear"===s.type?e("#"+L[s.square]+" ."+l.piece).fadeOut(a.trashSpeed,c):"add"!==s.type||a.sparePieces?"add"===s.type&&a.sparePieces?z(s.piece,s.square,c):"move"===s.type&&M(s.source,s.destination,s.piece,c):e("#"+L[s.square]).append(U(s.piece,!0)).find("."+l.piece).fadeIn(a.appearSpeed,c)}function c(){(o+=1)===r.length&&(F(),b(a.onMoveEnd)&&a.onMoveEnd(d(t),d(n)))}}(function(e,r){e=d(e),r=d(r);var t=[],n={};for(var o in r)r.hasOwnProperty(o)&&e.hasOwnProperty(o)&&e[o]===r[o]&&(delete e[o],delete r[o]);for(o in r)if(r.hasOwnProperty(o)){var a=O(e,r[o],o);a&&(t.push({type:"move",source:a,destination:o,piece:r[o]}),delete e[a],delete r[o],n[o]=!0)}for(o in r)r.hasOwnProperty(o)&&(t.push({type:"add",square:o,piece:r[o]}),delete r[o]);for(o in e)e.hasOwnProperty(o)&&(n.hasOwnProperty(o)||(t.push({type:"clear",square:o,piece:e[o]}),delete e[o]));return t}(A,r),A,r),W(r)):(W(r),F())):B(6482,"Invalid value passed to the position method.",r)))},m.resize=function(){Q=function(){var e=parseInt(i.width(),10);if(!e||e<=0)return 0;for(var r=e-1;r%8!=0&&0<r;)r-=1;return r/8}(),s.css("width",8*Q+"px"),c.css({height:Q,width:Q}),a.sparePieces&&i.find("."+l.sparePieces).css("paddingLeft",Q+w+"px"),G()},m.start=function(e){m.position("start",e)};var ae=f(function(e){D&&Z(e.pageX,e.pageY)},a.dragThrottleRate),ie=f(function(e){D&&(e.preventDefault(),Z(e.originalEvent.changedTouches[0].pageX,e.originalEvent.changedTouches[0].pageY))},a.dragThrottleRate);function se(e){D&&V(X(e.pageX,e.pageY))}function ce(e){D&&V(X(e.originalEvent.changedTouches[0].pageX,e.originalEvent.changedTouches[0].pageY))}function ue(r){if(!D&&b(a.onMouseoverSquare)){var t=e(r.currentTarget).attr("data-square");if(E(t)){var n=!1;A.hasOwnProperty(t)&&(n=A[t]),a.onMouseoverSquare(t,n,d(A),P)}}}function le(r){if(!D&&b(a.onMouseoutSquare)){var t=e(r.currentTarget).attr("data-square");if(E(t)){var n=!1;A.hasOwnProperty(t)&&(n=A[t]),a.onMouseoutSquare(t,n,d(A),P)}}}return P=a.orientation,a.hasOwnProperty("position")&&("start"===a.position?A=d(o):C(a.position)?A=_(a.position):S(a.position)?A=d(a.position):B(7263,"Invalid value passed to config.position.",a.position)),function(){!function(){for(var e=0;e<r.length;e++)for(var t=1;t<=8;t++){var n=r[e]+t;L[n]=n+"-"+p()}var o="KQRNBP".split("");for(e=0;e<o.length;e++){var a="w"+o[e],i="b"+o[e];N[a]=a+"-"+p(),N[i]=i+"-"+p()}}(),i.html(function(e){var r='<div class="{chessboard}">';return e&&(r+='<div class="{sparePieces} {sparePiecesTop}"></div>'),r+='<div class="{board}"></div>',e&&(r+='<div class="{sparePieces} {sparePiecesBottom}"></div>'),v(r+="</div>",l)}(a.sparePieces)),s=i.find("."+l.board),a.sparePieces&&(u=i.find("."+l.sparePiecesTop),h=i.find("."+l.sparePiecesBottom));var t=p();e("body").append(U("wP",!0,t)),c=e("#"+t),w=parseInt(s.css("borderLeftWidth"),10),m.resize()}(),function(){e("body").on("mousedown mousemove","."+l.piece,ee),s.on("mousedown","."+l.square,re),i.on("mousedown","."+l.sparePieces+" ."+l.piece,ne),s.on("mouseenter","."+l.square,ue).on("mouseleave","."+l.square,le);var r=e(window);r.on("mousemove",ae).on("mouseup",se),"ontouchstart"in document.documentElement&&(s.on("touchstart","."+l.square,te),i.on("touchstart","."+l.sparePieces+" ."+l.piece,oe),r.on("touchmove",ie).on("touchend",ce))}(),m},window.ChessBoard=window.Chessboard,window.Chessboard.fenToObj=_,window.Chessboard.objToFen=k}(),$$.control.registerControl("friendsPage",{template:'<div bn-control="breizbot.friends" \n\tdata-show-selection="true"\n\tbn-event="friendclick: onFriendSelect"\n\tbn-iface="friends"\n\t></div>',props:{$pager:null},buttons:[{name:"call",icon:"fa fa-check"}],init:function(e){const{$pager:r}=this.props,t=$$.viewController(e);this.onAction=function(e){console.log("onAction",e);const n=t.scope.friends.getSelection();if(null==n)return void $$.ui.showAlert({title:"Error",content:"Please select a friend"});const{friendUserName:o,isConnected:a}=n;console.log("userName",o),a?r.popPage(o):$$.ui.showAlert({title:"Error",content:`User <strong>${o}</strong> is not connected`})}}}),$$.control.registerControl("rootPage",{template:'<div class="toolbar">\n\n\t\t<div>\n\t\t\t<p>Status: <span bn-text="status"></span></p>\n\t\t\t<p>Distant: <strong bn-text="distant"></strong></p>\t\t\t\t\t\t\n\t\t</div>\t\t\n\n\t\t<div>\n\t\t\t<button \n\t\t\t\ttitle="Call a friend" \n\t\t\t\tbn-event="click: onCall"\n\t\t\t\tbn-show="[\'ready\', \'disconnected\', \'refused\', \'canceled\'].includes(status)"\n\t\t\t\tclass="w3-btn w3-green">Start</i></button>\n\n\t\t\t<button \n\t\t\t\tbn-event="click: onCancel"\n\t\t\t\tbn-show="status == \'calling\'"\n\t\t\t\tclass="w3-btn w3-blue">Cancel</button>\n\n\t\t\t<button \n\t\t\t\ttitle="Hangup" \n\t\t\t\tbn-event="click: onHangup"\n\t\t\t\tbn-show="status == \'connected\'"\n\t\t\t\tclass="w3-btn w3-red">Stop</button>\t\t\t\n\t\t</div>\n\n\n</div>\n\n<div class="message">\n\t<span bn-text="message" bn-show="status == \'connected\'"></span>\n</div>\n\n<div class="content">\n\t<div id="myBoard" bn-bind="board"></div>\t\n</div>\n\n',props:{$pager:null},deps:["breizbot.rtc","breizbot.broker","breizbot.params"],init:function(e,r,t,n){const{$pager:o}=this.props,a="#a9a9a9",i="#696969",s=new Chess,c=Chessboard("myBoard",{draggable:!0,pieceTheme:function(e){return`/webapps/chess/assets/img/chesspieces/wikipedia/${e}.png`},onDragStart:function(e,r,t,n){return!s.game_over()&&(!!l.model.yourTurn&&(!("white"===n&&-1===r.search(/^w/)||"black"===n&&-1===r.search(/^b/))&&void function(e){if(!l.model.yourTurn)return;const r=s.moves({square:e,verbose:!0});if(0===r.length)return;d(e);for(let e=0;e<r.length;e++)d(r[e].to)}(e)))},onDrop:function(e,t,n,o,a,i){if($("#myBoard .square-55d63").css("background",""),null===s.move({from:e,to:t,promotion:"q"}))return"snapback";e!=t&&(r.sendData("chess",{source:e,target:t}),l.setData({yourTurn:!1}),h(),p("white"),f.find(".square-"+e).addClass("highlight-white"),f.find(".square-"+t).addClass("highlight-white"))}});const u={status:"ready",distant:"",yourTurn:!1,message:""};null!=n.caller&&(u.status="connected",u.distant=n.caller,r.setRemoteClientId(n.clientId),c.orientation("black"),c.start());const l=$$.viewController(e,{data:u,events:{onCall:function(e){console.log("onCall"),o.pushPage("friendsPage",{title:"Select a friend to play with"})},onCancel:function(e){r.cancel(l.model.distant).then(()=>{l.setData({status:"canceled",distant:""})}).catch(e=>{$$.ui.showAlert({title:"Error",content:e.responseText})})},onHangup:function(e){r.bye(),l.setData({status:"ready",distant:"",messages:[]})}}}),f=l.scope.board;function p(e){const r="highlight-"+e;f.find("."+r).removeClass(r)}function d(e){var r=$("#myBoard .square-"+e),t=a;r.hasClass("black-3c85d")&&(t=i),r.css("background",t)}function h(){var e="",r="White";"b"===s.turn()&&(r="Black"),s.in_checkmate()?e="Game over, "+r+" is in checkmate.":s.in_draw()?e="Game over, drawn position":(e=r+" to move",s.in_check()&&(e+=", "+r+" is in check")),l.setData({message:e})}h(),this.onReturn=function(e){null!=e&&r.call(e,"chess","fa fa-chess").then(()=>{l.setData({status:"calling",distant:e})}).catch(e=>{$$.ui.showAlert({title:"Error",content:e.responseText})})},t.onTopic("breizbot.rtc.accept",function(e){!0!==e.hist&&(console.log("msg",e),r.cancel(l.model.distant),r.setRemoteClientId(e.srcId),l.setData({status:"connected",yourTurn:!0}),c.start())}),t.onTopic("breizbot.rtc.deny",function(e){!0!==e.hist&&(console.log("msg",e),l.setData({status:"refused"}),r.cancel(l.model.distant))}),t.onTopic("breizbot.rtc.chess",function(e){if(!0===e.hist)return;console.log("msg",e);const{source:r,target:t}=e.data;c.move(`${r}-${t}`),l.setData({yourTurn:!0}),s.move({from:r,to:t,promotion:"q"}),p("black"),f.find(".square-"+r).addClass("highlight-black"),f.find(".square-"+t).addClass("highlight-black"),h()}),t.onTopic("breizbot.rtc.bye",function(e){!0!==e.hist&&(console.log("msg",e),l.setData({status:"disconnected",distant:"",messages:[]}))}),t.on("ready",e=>{r.setLocalClientId(e.clientId),null!=n.caller&&r.accept()}),window.onbeforeunload=function(){"connected"==l.model.status&&r.bye()}}});