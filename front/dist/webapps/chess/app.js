$$.control.registerControl("rootPage",{template:'<div bn-control="breizbot.rtc" \n\tbn-data="{\n\t\tappName:\'chess\',\n\t\ticonCls: \'fa fa-chess\',\n\t\ttitle: \'Select a friend to play with\'\n\t}"\n\tbn-event="rtchangup: onHangup"\n>\n\t<div class="message">\n\t\t<span bn-text="message"></span>\n\t</div>\t\n\n</div>\n\n\n\n<div class="content">\n\t<div id="myBoard" bn-bind="board"></div>\t\n</div>\n\n',deps:["breizbot.rtc"],init:function(e,r){const n="#a9a9a9",t="#696969";let o=new Chess;const a=Chessboard("myBoard",{draggable:!0,pieceTheme:function(e){return`/webapps/chess/assets/img/chesspieces/wikipedia/${e}.png`},onDragStart:function(e,r,n,t){return!o.game_over()&&(!!i.model.yourTurn&&(!("white"===t&&-1===r.search(/^w/)||"black"===t&&-1===r.search(/^b/))&&void function(e){if(!i.model.yourTurn)return;const r=o.moves({square:e,verbose:!0});if(0===r.length)return;f(e);for(let e=0;e<r.length;e++)f(r[e].to)}(e)))},onDrop:function(e,n,t,a,f,l){if($("#myBoard .square-55d63").css("background",""),null===o.move({from:e,to:n,promotion:"q"}))return"snapback";e!=n&&(r.sendData("chess",{source:e,target:n}),i.setData({yourTurn:!1}),c(),u("white"),s.find(".square-"+e).addClass("highlight-white"),s.find(".square-"+n).addClass("highlight-white"))}});const i=$$.viewController(e,{data:{yourTurn:!1,message:""},events:{onHangup:function(e){a.clear(),o=new Chess,u("black"),u("white")}}}),s=i.scope.board;function u(e){const r="highlight-"+e;s.find("."+r).removeClass(r)}function f(e){var r=$("#myBoard .square-"+e),o=n;r.hasClass("black-3c85d")&&(o=t),r.css("background",o)}function c(){var e="",r="White";"b"===o.turn()&&(r="Black"),o.in_checkmate()?e="Game over, "+r+" is in checkmate.":o.in_draw()?e="Game over, drawn position":(e=r+" to move",o.in_check()&&(e+=", "+r+" is in check")),i.setData({message:e})}c(),r.on("accept",function(){a.orientation("white"),a.start(),i.setData({yourTurn:!0}),c()}),r.onData("chess",function(e){const{source:r,target:n}=e;a.move(`${r}-${n}`),i.setData({yourTurn:!0}),o.move({from:r,to:n,promotion:"q"}),u("black"),s.find(".square-"+r).addClass("highlight-black"),s.find(".square-"+n).addClass("highlight-black"),c()}),r.on("bye",function(e){o=new Chess,a.clear(),u("black"),u("white")}),r.on("ready",()=>{r.isCallee&&(a.orientation("black"),a.start(),r.accept())}),this.onAppExit=function(){return r.exit()}}});var Chess=function(e){var r="b",n="w",t=-1,o="p",a="n",i="b",s="r",u="q",f="k",c="pnbrqkPNBRQK",l="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",p=["1-0","0-1","1/2-1/2","*"],h={b:[16,32,17,15],w:[-16,-32,-17,-15]},d={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},v=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],g=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],b={p:0,n:1,b:2,r:3,q:4,k:5},m={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},w={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},y=7,E=6,P=1,C=0,S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},T={w:[{square:S.a1,flag:w.QSIDE_CASTLE},{square:S.h1,flag:w.KSIDE_CASTLE}],b:[{square:S.a8,flag:w.QSIDE_CASTLE},{square:S.h8,flag:w.KSIDE_CASTLE}]},_=new Array(128),k={w:t,b:t},O=n,q={w:0,b:0},x=t,A=0,I=1,R=[],N={};function D(){_=new Array(128),k={w:t,b:t},O=n,q={w:0,b:0},x=t,A=0,I=1,R=[],N={},$(K())}function L(){Q(l)}function Q(e){var o=e.split(/\s+/),a=o[0],i=0;if(!B(e).valid)return!1;D();for(var s=0;s<a.length;s++){var u=a.charAt(s);if("/"===u)i+=8;else if(-1!=="0123456789".indexOf(u))i+=parseInt(u,10);else{var f=u<"a"?n:r;M({type:u.toLowerCase(),color:f},ie(i)),i++}}return O=o[1],o[2].indexOf("K")>-1&&(q.w|=w.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(q.w|=w.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(q.b|=w.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(q.b|=w.QSIDE_CASTLE),x="-"===o[3]?t:S[o[3]],A=parseInt(o[4],10),I=parseInt(o[5],10),$(K()),!0}function B(e){var r="No errors.",n="FEN string must contain six space-delimited fields.",t="6th field (move number) must be a positive integer.",o="5th field (half move counter) must be a non-negative integer.",a="4th field (en-passant square) is invalid.",i="3rd field (castling availability) is invalid.",s="2nd field (side to move) is invalid.",u="1st field (piece positions) does not contain 8 '/'-delimited rows.",f="1st field (piece positions) is invalid [consecutive numbers].",c="1st field (piece positions) is invalid [invalid piece].",l="1st field (piece positions) is invalid [row too large].",p="Illegal en-passant square",h=e.split(/\s+/);if(6!==h.length)return{valid:!1,error_number:1,error:n};if(isNaN(h[5])||parseInt(h[5],10)<=0)return{valid:!1,error_number:2,error:t};if(isNaN(h[4])||parseInt(h[4],10)<0)return{valid:!1,error_number:3,error:o};if(!/^(-|[abcdefgh][36])$/.test(h[3]))return{valid:!1,error_number:4,error:a};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(h[2]))return{valid:!1,error_number:5,error:i};if(!/^(w|b)$/.test(h[1]))return{valid:!1,error_number:6,error:s};var d=h[0].split("/");if(8!==d.length)return{valid:!1,error_number:7,error:u};for(var v=0;v<d.length;v++){for(var g=0,b=!1,m=0;m<d[v].length;m++)if(isNaN(d[v][m])){if(!/^[prnbqkPRNBQK]$/.test(d[v][m]))return{valid:!1,error_number:9,error:c};g+=1,b=!1}else{if(b)return{valid:!1,error_number:8,error:f};g+=parseInt(d[v][m],10),b=!0}if(8!==g)return{valid:!1,error_number:10,error:l}}return"3"==h[3][1]&&"w"==h[1]||"6"==h[3][1]&&"b"==h[1]?{valid:!1,error_number:11,error:p}:{valid:!0,error_number:0,error:r}}function K(){for(var e=0,o="",a=S.a8;a<=S.h1;a++){if(null==_[a])e++;else{e>0&&(o+=e,e=0);var i=_[a].color,s=_[a].type;o+=i===n?s.toUpperCase():s.toLowerCase()}a+1&136&&(e>0&&(o+=e),a!==S.h1&&(o+="/"),e=0,a+=8)}var u="";q[n]&w.KSIDE_CASTLE&&(u+="K"),q[n]&w.QSIDE_CASTLE&&(u+="Q"),q[r]&w.KSIDE_CASTLE&&(u+="k"),q[r]&w.QSIDE_CASTLE&&(u+="q"),u=u||"-";var f=x===t?"-":ie(x);return[o,O,u,f,A,I].join(" ")}function U(e){for(var r=0;r<e.length;r+=2)"string"==typeof e[r]&&"string"==typeof e[r+1]&&(N[e[r]]=e[r+1]);return N}function $(e){R.length>0||(e!==l?(N.SetUp="1",N.FEN=e):(delete N.SetUp,delete N.FEN))}function j(e){var r=_[S[e]];return r?{type:r.type,color:r.color}:null}function M(e,r){if(!("type"in e&&"color"in e))return!1;if(-1===c.indexOf(e.type.toLowerCase()))return!1;if(!(r in S))return!1;var n=S[r];return(e.type!=f||k[e.color]==t||k[e.color]==n)&&(_[n]={type:e.type,color:e.color},e.type===f&&(k[e.color]=n),$(K()),!0)}function G(e,r,n,t,a){var i={color:O,from:r,to:n,flags:t,piece:e[r].type};return a&&(i.flags|=w.PROMOTION,i.promotion=a),e[n]?i.captured=e[n].type:t&w.EP_CAPTURE&&(i.captured=o),i}function F(e){function r(e,r,n,t,f){if(e[n].type!==o||oe(t)!==C&&oe(t)!==y)r.push(G(e,n,t,f));else for(var c=[u,s,i,a],l=0,p=c.length;l<p;l++)r.push(G(e,n,t,f,c[l]))}var n=[],t=O,f=se(t),c={b:P,w:E},l=S.a8,p=S.h1,v=!1,g=!(void 0!==e&&"legal"in e)||e.legal;if(void 0!==e&&"square"in e){if(!(e.square in S))return[];l=p=S[e.square],v=!0}for(var b=l;b<=p;b++)if(136&b)b+=7;else{var m=_[b];if(null!=m&&m.color===t)if(m.type===o){var T=b+h[t][0];if(null==_[T]){r(_,n,b,T,w.NORMAL);T=b+h[t][1];c[t]===oe(b)&&null==_[T]&&r(_,n,b,T,w.BIG_PAWN)}for(A=2;A<4;A++){136&(T=b+h[t][A])||(null!=_[T]&&_[T].color===f?r(_,n,b,T,w.CAPTURE):T===x&&r(_,n,b,x,w.EP_CAPTURE))}}else for(var A=0,I=d[m.type].length;A<I;A++){var R=d[m.type][A];for(T=b;!(136&(T+=R));){if(null!=_[T]){if(_[T].color===t)break;r(_,n,b,T,w.CAPTURE);break}if(r(_,n,b,T,w.NORMAL),"n"===m.type||"k"===m.type)break}}}if(!v||p===k[t]){if(q[t]&w.KSIDE_CASTLE){var N=(D=k[t])+2;null!=_[D+1]||null!=_[N]||Y(f,k[t])||Y(f,D+1)||Y(f,N)||r(_,n,k[t],N,w.KSIDE_CASTLE)}if(q[t]&w.QSIDE_CASTLE){var D;N=(D=k[t])-2;null!=_[D-1]||null!=_[D-2]||null!=_[D-3]||Y(f,k[t])||Y(f,D-1)||Y(f,N)||r(_,n,k[t],N,w.QSIDE_CASTLE)}}if(!g)return n;var L=[];for(b=0,I=n.length;b<I;b++)re(n[b]),z(t)||L.push(n[b]),ne();return L}function W(e,r){var n="";if(e.flags&w.KSIDE_CASTLE)n="O-O";else if(e.flags&w.QSIDE_CASTLE)n="O-O-O";else{var t=function(e,r){for(var n=F({legal:!r}),t=e.from,o=e.to,a=e.piece,i=0,s=0,u=0,f=0,c=n.length;f<c;f++){var l=n[f].from,p=n[f].to,h=n[f].piece;a===h&&t!==l&&o===p&&(i++,oe(t)===oe(l)&&s++,ae(t)===ae(l)&&u++)}if(i>0)return s>0&&u>0?ie(t):u>0?ie(t).charAt(1):ie(t).charAt(0);return""}(e,r);e.piece!==o&&(n+=e.piece.toUpperCase()+t),e.flags&(w.CAPTURE|w.EP_CAPTURE)&&(e.piece===o&&(n+=ie(e.from)[0]),n+="x"),n+=ie(e.to),e.flags&w.PROMOTION&&(n+="="+e.promotion.toUpperCase())}return re(e),H()&&(J()?n+="#":n+="+"),ne(),n}function X(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function Y(e,t){for(var a=S.a8;a<=S.h1;a++)if(136&a)a+=7;else if(null!=_[a]&&_[a].color===e){var i=_[a],s=a-t,u=s+119;if(v[u]&1<<b[i.type]){if(i.type===o){if(s>0){if(i.color===n)return!0}else if(i.color===r)return!0;continue}if("n"===i.type||"k"===i.type)return!0;for(var f=g[u],c=a+f,l=!1;c!==t;){if(null!=_[c]){l=!0;break}c+=f}if(!l)return!0}}return!1}function z(e){return Y(se(e),k[e])}function H(){return z(O)}function J(){return H()&&0===F().length}function Z(){return!H()&&0===F().length}function V(){for(var e={},r=[],n=0,t=0,o=S.a8;o<=S.h1;o++)if(t=(t+1)%2,136&o)o+=7;else{var s=_[o];s&&(e[s.type]=s.type in e?e[s.type]+1:1,s.type===i&&r.push(t),n++)}if(2===n)return!0;if(3===n&&(1===e[i]||1===e[a]))return!0;if(n===e[i]+2){var u=0,f=r.length;for(o=0;o<f;o++)u+=r[o];if(0===u||u===f)return!0}return!1}function ee(){for(var e=[],r={},n=!1;;){var t=ne();if(!t)break;e.push(t)}for(;;){var o=K().split(" ").slice(0,4).join(" ");if(r[o]=o in r?r[o]+1:1,r[o]>=3&&(n=!0),!e.length)break;re(e.pop())}return n}function re(e){var n=O,a=se(n);if(function(e){R.push({move:e,kings:{b:k.b,w:k.w},turn:O,castling:{b:q.b,w:q.w},ep_square:x,half_moves:A,move_number:I})}(e),_[e.to]=_[e.from],_[e.from]=null,e.flags&w.EP_CAPTURE&&(O===r?_[e.to-16]=null:_[e.to+16]=null),e.flags&w.PROMOTION&&(_[e.to]={type:e.promotion,color:n}),_[e.to].type===f){if(k[_[e.to].color]=e.to,e.flags&w.KSIDE_CASTLE){var i=e.to-1,s=e.to+1;_[i]=_[s],_[s]=null}else if(e.flags&w.QSIDE_CASTLE){i=e.to+1,s=e.to-2;_[i]=_[s],_[s]=null}q[n]=""}if(q[n])for(var u=0,c=T[n].length;u<c;u++)if(e.from===T[n][u].square&&q[n]&T[n][u].flag){q[n]^=T[n][u].flag;break}if(q[a])for(u=0,c=T[a].length;u<c;u++)if(e.to===T[a][u].square&&q[a]&T[a][u].flag){q[a]^=T[a][u].flag;break}x=e.flags&w.BIG_PAWN?"b"===O?e.to-16:e.to+16:t,e.piece===o?A=0:e.flags&(w.CAPTURE|w.EP_CAPTURE)?A=0:A++,O===r&&I++,O=se(O)}function ne(){var e=R.pop();if(null==e)return null;var n=e.move;k=e.kings,O=e.turn,q=e.castling,x=e.ep_square,A=e.half_moves,I=e.move_number;var t,a,i=O,s=se(O);if(_[n.from]=_[n.to],_[n.from].type=n.piece,_[n.to]=null,n.flags&w.CAPTURE)_[n.to]={type:n.captured,color:s};else if(n.flags&w.EP_CAPTURE){var u;u=i===r?n.to-16:n.to+16,_[u]={type:o,color:s}}n.flags&(w.KSIDE_CASTLE|w.QSIDE_CASTLE)&&(n.flags&w.KSIDE_CASTLE?(t=n.to+1,a=n.to-1):n.flags&w.QSIDE_CASTLE&&(t=n.to-2,a=n.to+1),_[t]=_[a],_[a]=null);return n}function te(e,r){var n=X(e);if(r){var t=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(t)var o=t[1],a=t[2],i=t[3],s=t[4]}for(var u=F(),f=0,c=u.length;f<c;f++){if(n===X(W(u[f]))||r&&n===X(W(u[f],!0)))return u[f];if(t&&(!o||o.toLowerCase()==u[f].piece)&&S[a]==u[f].from&&S[i]==u[f].to&&(!s||s.toLowerCase()==u[f].promotion))return u[f]}return null}function oe(e){return e>>4}function ae(e){return 15&e}function ie(e){var r=ae(e),n=oe(e);return"abcdefgh".substring(r,r+1)+"87654321".substring(n,n+1)}function se(e){return e===n?r:n}function ue(e){var r=function e(r){var n=r instanceof Array?[]:{};for(var t in r)n[t]="object"==typeof t?e(r[t]):r[t];return n}(e);r.san=W(r,!1),r.to=ie(r.to),r.from=ie(r.from);var n="";for(var t in w)w[t]&r.flags&&(n+=m[t]);return r.flags=n,r}function fe(e){return e.replace(/^\s+|\s+$/g,"")}return Q(void 0===e?l:e),{WHITE:n,BLACK:r,PAWN:o,KNIGHT:a,BISHOP:i,ROOK:s,QUEEN:u,KING:f,SQUARES:function(){for(var e=[],r=S.a8;r<=S.h1;r++)136&r?r+=7:e.push(ie(r));return e}(),FLAGS:m,load:function(e){return Q(e)},reset:function(){return L()},moves:function(e){for(var r=F(e),n=[],t=0,o=r.length;t<o;t++)void 0!==e&&"verbose"in e&&e.verbose?n.push(ue(r[t])):n.push(W(r[t],!1));return n},in_check:function(){return H()},in_checkmate:function(){return J()},in_stalemate:function(){return Z()},in_draw:function(){return A>=100||Z()||V()||ee()},insufficient_material:function(){return V()},in_threefold_repetition:function(){return ee()},game_over:function(){return A>=100||J()||Z()||V()||ee()},validate_fen:function(e){return B(e)},fen:function(){return K()},pgn:function(e){var r="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",n="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,t=[],o=!1;for(var a in N)t.push("["+a+' "'+N[a]+'"]'+r),o=!0;o&&R.length&&t.push(r);for(var i=[];R.length>0;)i.push(ne());for(var s=[],u="";i.length>0;){var f=i.pop();R.length||"b"!==f.color?"w"===f.color&&(u.length&&s.push(u),u=I+"."):u=I+". ...",u=u+" "+W(f,!1),re(f)}if(u.length&&s.push(u),void 0!==N.Result&&s.push(N.Result),0===n)return t.join("")+s.join(" ");var c=0;for(a=0;a<s.length;a++)c+s[a].length>n&&0!==a?(" "===t[t.length-1]&&t.pop(),t.push(r),c=0):0!==a&&(t.push(" "),c++),t.push(s[a]),c+=s[a].length;return t.join("")},load_pgn:function(e,r){var n=void 0!==r&&"sloppy"in r&&r.sloppy;function t(e){return e.replace(/\\/g,"\\")}var o="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",a=new RegExp("^(\\[(.|"+t(o)+")*\\])("+t(o)+")*1.("+t(o)+"|.)*$","g"),i=e.replace(a,"$1");"["!==i[0]&&(i=""),L();var s=function(e,r){for(var n="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",o={},a=e.split(new RegExp(t(n))),i="",s="",u=0;u<a.length;u++)i=a[u].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),s=a[u].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),fe(i).length>0&&(o[i]=s);return o}(i,r);for(var u in s)U([u,s[u]]);if("1"===s.SetUp&&!("FEN"in s&&Q(s.FEN)))return!1;var f=e.replace(i,"").replace(new RegExp(t(o),"g")," ");f=f.replace(/(\{[^}]+\})+?/g,"");for(var c=/(\([^\(\)]+\))+?/g;c.test(f);)f=f.replace(c,"");var l=fe(f=(f=(f=f.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));l=l.join(",").replace(/,,+/g,",").split(",");for(var h="",d=0;d<l.length-1;d++){if(null==(h=te(l[d],n)))return!1;re(h)}if(h=l[l.length-1],p.indexOf(h)>-1)(function(e){for(var r in e)return!0;return!1})(N)&&void 0===N.Result&&U(["Result",h]);else{if(null==(h=te(h,n)))return!1;re(h)}return!0},header:function(){return U(arguments)},ascii:function(){return function(){for(var e="   +------------------------+\n",r=S.a8;r<=S.h1;r++){if(0===ae(r)&&(e+=" "+"87654321"[oe(r)]+" |"),null==_[r])e+=" . ";else{var t=_[r].type;e+=" "+(_[r].color===n?t.toUpperCase():t.toLowerCase())+" "}r+1&136&&(e+="|\n",r+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h\n"}()},turn:function(){return O},move:function(e,r){var n=void 0!==r&&"sloppy"in r&&r.sloppy,t=null;if("string"==typeof e)t=te(e,n);else if("object"==typeof e)for(var o=F(),a=0,i=o.length;a<i;a++)if(!(e.from!==ie(o[a].from)||e.to!==ie(o[a].to)||"promotion"in o[a]&&e.promotion!==o[a].promotion)){t=o[a];break}if(!t)return null;var s=ue(t);return re(t),s},undo:function(){var e=ne();return e?ue(e):null},clear:function(){return D()},put:function(e,r){return M(e,r)},get:function(e){return j(e)},remove:function(e){return function(e){var r=j(e);return _[S[e]]=null,r&&r.type===f&&(k[r.color]=t),$(K()),r}(e)},perft:function(e){return function e(r){for(var n=F({legal:!1}),t=0,o=O,a=0,i=n.length;a<i;a++)re(n[a]),z(o)||(r-1>0?t+=e(r-1):t++),ne();return t}(e)},square_color:function(e){if(e in S){var r=S[e];return(oe(r)+ae(r))%2==0?"light":"dark"}return null},history:function(e){for(var r=[],n=[],t=(void 0!==e&&"verbose"in e&&e.verbose);R.length>0;)r.push(ne());for(;r.length>0;){var o=r.pop();t?n.push(ue(o)):n.push(W(o)),re(o)}return n}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define(function(){return Chess}),function(){"use strict";var e=window.jQuery,r="abcdefgh".split(""),n=20,t="1.8.3",o=_("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"),a=200,i=200,s=60,u=30,f=100,c={};function l(e,r,n){function t(){o=0,a&&(a=!1,s())}var o=0,a=!1,i=[],s=function(){o=window.setTimeout(t,r),e.apply(n,i)};return function(e){i=arguments,o?a=!0:s()}}function p(){return"xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx".replace(/x/g,function(e){return(16*Math.random()|0).toString(16)})}function h(e){return JSON.parse(JSON.stringify(e))}function d(e){var r=e.split(".");return{major:parseInt(r[0],10),minor:parseInt(r[1],10),patch:parseInt(r[2],10)}}function v(e,r){for(var n in r)if(r.hasOwnProperty(n))for(var t="{"+n+"}",o=r[n];-1!==e.indexOf(t);)e=e.replace(t,o);return e}function g(e){return"string"==typeof e}function b(e){return"function"==typeof e}function m(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}function w(e){return"fast"===e||"slow"===e||!!m(e)&&0<=e}function y(e){if(!g(e))return!1;var r=e.split("-");return 2===r.length&&E(r[0])&&E(r[1])}function E(e){return g(e)&&-1!==e.search(/^[a-h][1-8]$/)}function P(e){return g(e)&&-1!==e.search(/^[bw][KQRNBP]$/)}function C(e){if(!g(e))return!1;var r=(e=function(e){return e.replace(/8/g,"11111111").replace(/7/g,"1111111").replace(/6/g,"111111").replace(/5/g,"11111").replace(/4/g,"1111").replace(/3/g,"111").replace(/2/g,"11")}(e=e.replace(/ .+$/,""))).split("/");if(8!==r.length)return!1;for(var n=0;n<8;n++)if(8!==r[n].length||-1!==r[n].search(/[^kqrnbpKQRNBP1]/))return!1;return!0}function S(r){if(!e.isPlainObject(r))return!1;for(var n in r)if(r.hasOwnProperty(n)&&(!E(n)||!P(r[n])))return!1;return!0}function T(){return typeof window.$&&e.fn&&e.fn.jquery&&function(e,r){e=d(e),r=d(r);var n=1e5*e.major*1e5+1e5*e.minor+e.patch;return 1e5*r.major*1e5+1e5*r.minor+r.patch<=n}(e.fn.jquery,t)}function _(e){if(!C(e))return!1;for(var n,t=(e=e.replace(/ .+$/,"")).split("/"),o={},a=8,i=0;i<8;i++){for(var s=t[i].split(""),u=0,f=0;f<s.length;f++)-1!==s[f].search(/[1-8]/)?u+=parseInt(s[f],10):(o[r[u]+a]=(n=s[f]).toLowerCase()===n?"b"+n.toUpperCase():"w"+n.toUpperCase(),u+=1);a-=1}return o}function k(e){if(!S(e))return!1;for(var n,t="",o=8,a=0;a<8;a++){for(var i=0;i<8;i++){var s=r[i]+o;e.hasOwnProperty(s)?t+=(n=void 0,"w"===(n=e[s].split(""))[0]?n[1].toUpperCase():n[1].toLowerCase()):t+="1"}7!==a&&(t+="/"),o-=1}return t.replace(/11111111/g,"8").replace(/1111111/g,"7").replace(/111111/g,"6").replace(/11111/g,"5").replace(/1111/g,"4").replace(/111/g,"3").replace(/11/g,"2")}function O(e,n,t){for(var o=function(e){for(var n=[],t=0;t<8;t++)for(var o=0;o<8;o++){var a=r[t]+(o+1);e!==a&&n.push({square:a,distance:(i=e,s=a,u=i.split(""),f=r.indexOf(u[0])+1,c=parseInt(u[1],10),l=s.split(""),p=r.indexOf(l[0])+1,h=parseInt(l[1],10),d=Math.abs(f-p),v=Math.abs(c-h),v<=d?d:v)})}var i,s,u,f,c,l,p,h,d,v;n.sort(function(e,r){return e.distance-r.distance});var g=[];for(t=0;t<n.length;t++)g.push(n[t].square);return g}(t),a=0;a<o.length;a++){var i=o[a];if(e.hasOwnProperty(i)&&e[i]===n)return i}return!1}function q(e){return"black"!==e.orientation&&(e.orientation="white"),!1!==e.showNotation&&(e.showNotation=!0),!0!==e.draggable&&(e.draggable=!1),"trash"!==e.dropOffBoard&&(e.dropOffBoard="snapback"),!0!==e.sparePieces&&(e.sparePieces=!1),e.sparePieces&&(e.draggable=!0),e.hasOwnProperty("pieceTheme")&&(g(e.pieceTheme)||b(e.pieceTheme))||(e.pieceTheme="img/chesspieces/wikipedia/{piece}.png"),w(e.appearSpeed)||(e.appearSpeed=a),w(e.moveSpeed)||(e.moveSpeed=i),w(e.snapbackSpeed)||(e.snapbackSpeed=s),w(e.snapSpeed)||(e.snapSpeed=u),w(e.trashSpeed)||(e.trashSpeed=f),function(e){return m(e)&&1<=e}(e.dragThrottleRate)||(e.dragThrottleRate=n),e}c.alpha="alpha-d2270",c.black="black-3c85d",c.board="board-b72b1",c.chessboard="chessboard-63f37",c.clearfix="clearfix-7da63",c.highlight1="highlight1-32417",c.highlight2="highlight2-9c5d2",c.notation="notation-322f9",c.numeric="numeric-fc462",c.piece="piece-417db",c.row="row-5277c",c.sparePieces="spare-pieces-7492f",c.sparePiecesBottom="spare-pieces-bottom-ae20f",c.sparePiecesTop="spare-pieces-top-4028b",c.square="square-55d63",c.white="white-1e1d7",window.Chessboard=function(n,a){if(!function(){if(T())return!0;var e="Chessboard Error 1005: Unable to find a valid version of jQuery. Please include jQuery "+t+" or higher on the page\n\nExiting…";return window.alert(e),!1}())return null;var i=function(r){if(""===r){return window.alert("Chessboard Error 1001: The first argument to Chessboard() cannot be an empty string.\n\nExiting…"),!1}g(r)&&"#"!==r.charAt(0)&&(r="#"+r);var n=e(r);if(1===n.length)return n;return window.alert("Chessboard Error 1003: The first argument to Chessboard() must be the ID of a DOM node, an ID query selector, or a single DOM node.\n\nExiting…"),!1}(n);if(!i)return null;a=q(a=function(r){return"start"===r?r={position:h(o)}:C(r)?r={position:_(r)}:S(r)&&(r={position:h(r)}),e.isPlainObject(r)||(r={}),r}(a));var s=null,u=null,f=null,d=null,m={},w=2,P="white",x={},A=null,I=null,R=null,N=!1,D={},L={},Q={},B=16;function K(e,r,n){if(!0===a.hasOwnProperty("showErrors")&&!1!==a.showErrors){var t="Chessboard Error "+e+": "+r;return"console"===a.showErrors&&"object"==typeof console&&"function"==typeof console.log?(console.log(t),void(2<=arguments.length&&console.log(n))):"alert"===a.showErrors?(n&&(t+="\n\n"+JSON.stringify(n)),void window.alert(t)):void(b(a.showErrors)&&a.showErrors(e,r,n))}}function U(e){return b(a.pieceTheme)?a.pieceTheme(e):g(a.pieceTheme)?v(a.pieceTheme,{piece:e}):(K(8272,"Unable to build image source for config.pieceTheme."),"")}function $(e,r,n){var t='<img src="'+U(e)+'" ';return g(n)&&""!==n&&(t+='id="'+n+'" '),t+='alt="" class="{piece}" data-piece="'+e+'" style="width:'+B+"px;height:"+B+"px;",r&&(t+="display:none;"),v(t+='" />',c)}function j(e){var r=["wK","wQ","wR","wB","wN","wP"];"black"===e&&(r=["bK","bQ","bR","bB","bN","bP"]);for(var n="",t=0;t<r.length;t++)n+=$(r[t],!1,D[r[t]]);return n}function M(r,n,t,o){var i=e("#"+L[r]),s=i.offset(),u=e("#"+L[n]),f=u.offset(),l=p();e("body").append($(t,!0,l));var h=e("#"+l);h.css({display:"",position:"absolute",top:s.top,left:s.left}),i.find("."+c.piece).remove();var d={duration:a.moveSpeed,complete:function(){u.append($(t)),h.remove(),b(o)&&o()}};h.animate(f,d)}function G(r,n,t){var o=e("#"+D[r]).offset(),i=e("#"+L[n]),s=i.offset(),u=p();e("body").append($(r,!0,u));var f=e("#"+u);f.css({display:"",position:"absolute",left:o.left,top:o.top});var l={duration:a.moveSpeed,complete:function(){i.find("."+c.piece).remove(),i.append($(r)),f.remove(),b(t)&&t()}};f.animate(s,l)}function F(){for(var r in s.find("."+c.piece).remove(),x)x.hasOwnProperty(r)&&e("#"+L[r]).append($(x[r]))}function W(){s.html(function(e){"black"!==e&&(e="white");var n="",t=h(r),o=8;"black"===e&&(t.reverse(),o=1);for(var i="white",s=0;s<8;s++){n+='<div class="{row}">';for(var u=0;u<8;u++){var f=t[u]+o;n+='<div class="{square} '+c[i]+" square-"+f+'" style="width:'+B+"px;height:"+B+'px;" id="'+L[f]+'" data-square="'+f+'">',a.showNotation&&(("white"===e&&1===o||"black"===e&&8===o)&&(n+='<div class="{notation} {alpha}">'+t[u]+"</div>"),0===u&&(n+='<div class="{notation} {numeric}">'+o+"</div>")),n+="</div>",i="white"===i?"black":"white"}n+='<div class="{clearfix}"></div></div>',i="white"===i?"black":"white","white"===e?o-=1:o+=1}return v(n,c)}(P,a.showNotation)),F(),a.sparePieces&&("white"===P?(f.html(j("black")),d.html(j("white"))):(f.html(j("white")),d.html(j("black"))))}function X(e){var r=h(x),n=h(e);k(r)!==k(n)&&(b(a.onChange)&&a.onChange(r,n),x=e)}function Y(e,r){for(var n in Q)if(Q.hasOwnProperty(n)){var t=Q[n];if(e>=t.left&&e<t.left+B&&r>=t.top&&r<t.top+B)return n}return"offboard"}function z(){s.find("."+c.square).removeClass(c.highlight1+" "+c.highlight2)}function H(){z();var e=h(x);delete e[R],X(e),F(),u.fadeOut(a.trashSpeed),N=!1}function J(r,n,t,o){b(a.onDragStart)&&!1===a.onDragStart(r,n,h(x),P)||(N=!0,A=n,I="spare"===(R=r)?"offboard":r,function(){for(var r in Q={},L)L.hasOwnProperty(r)&&(Q[r]=e("#"+L[r]).offset())}(),u.attr("src",U(n)).css({display:"",position:"absolute",left:t-B/2,top:o-B/2}),"spare"!==r&&e("#"+L[r]).addClass(c.highlight1).find("."+c.piece).css("display","none"))}function Z(r,n){u.css({left:r-B/2,top:n-B/2});var t=Y(r,n);t!==I&&(E(I)&&e("#"+L[I]).removeClass(c.highlight2),E(t)&&e("#"+L[t]).addClass(c.highlight2),b(a.onDragMove)&&a.onDragMove(t,I,R,A,h(x),P),I=t)}function V(r){var n="drop";if("offboard"===r&&"snapback"===a.dropOffBoard&&(n="snapback"),"offboard"===r&&"trash"===a.dropOffBoard&&(n="trash"),b(a.onDrop)){var t=h(x);"spare"===R&&E(r)&&(t[r]=A),E(R)&&"offboard"===r&&delete t[R],E(R)&&E(r)&&(delete t[R],t[r]=A);var o=h(x),i=a.onDrop(R,r,A,t,o,P);"snapback"!==i&&"trash"!==i||(n=i)}"snapback"===n?function(){if("spare"!==R){z();var r=e("#"+L[R]).offset(),n={duration:a.snapbackSpeed,complete:function(){F(),u.css("display","none"),b(a.onSnapbackEnd)&&a.onSnapbackEnd(A,R,h(x),P)}};u.animate(r,n),N=!1}else H()}():"trash"===n?H():"drop"===n&&function(r){z();var n=h(x);delete n[R],n[r]=A,X(n);var t=e("#"+L[r]).offset(),o={duration:a.snapSpeed,complete:function(){F(),u.css("display","none"),b(a.onSnapEnd)&&a.onSnapEnd(R,r,A)}};u.animate(t,o),N=!1}(r)}function ee(e){e.preventDefault()}function re(r){if(a.draggable){var n=e(this).attr("data-square");E(n)&&x.hasOwnProperty(n)&&J(n,x[n],r.pageX,r.pageY)}}function ne(r){if(a.draggable){var n=e(this).attr("data-square");E(n)&&x.hasOwnProperty(n)&&(r=r.originalEvent,J(n,x[n],r.changedTouches[0].pageX,r.changedTouches[0].pageY))}}function te(r){a.sparePieces&&J("spare",e(this).attr("data-piece"),r.pageX,r.pageY)}function oe(r){a.sparePieces&&J("spare",e(this).attr("data-piece"),(r=r.originalEvent).changedTouches[0].pageX,r.changedTouches[0].pageY)}m.clear=function(e){m.position({},e)},m.destroy=function(){i.html(""),u.remove(),i.unbind()},m.fen=function(){return m.position("fen")},m.flip=function(){return m.orientation("flip")},m.move=function(){if(0!==arguments.length){for(var e=!0,r={},n=0;n<arguments.length;n++)if(!1!==arguments[n])if(y(arguments[n])){var t=arguments[n].split("-");r[t[0]]=t[1]}else K(2826,"Invalid move passed to the move method.",arguments[n]);else e=!1;var o=function(e,r){var n=h(x);for(var t in r)if(r.hasOwnProperty(t)&&n.hasOwnProperty(t)){var o=n[t];delete n[t],n[r[t]]=o}return n}(0,r);return m.position(o,e),o}},m.orientation=function(e){return 0===arguments.length?P:"white"===e||"black"===e?(P=e,W(),P):"flip"===e?(P="white"===P?"black":"white",W(),P):void K(5482,"Invalid value passed to the orientation method.",e)},m.position=function(r,n){return 0===arguments.length?h(x):g(r)&&"fen"===r.toLowerCase()?k(x):(g(r)&&"start"===r.toLowerCase()&&(r=h(o)),C(r)&&(r=_(r)),void(S(r)?(!1!==n&&(n=!0),n?(function(r,n,t){if(0!==r.length)for(var o=0,i=0;i<r.length;i++){var s=r[i];"clear"===s.type?e("#"+L[s.square]+" ."+c.piece).fadeOut(a.trashSpeed,u):"add"!==s.type||a.sparePieces?"add"===s.type&&a.sparePieces?G(s.piece,s.square,u):"move"===s.type&&M(s.source,s.destination,s.piece,u):e("#"+L[s.square]).append($(s.piece,!0)).find("."+c.piece).fadeIn(a.appearSpeed,u)}function u(){(o+=1)===r.length&&(F(),b(a.onMoveEnd)&&a.onMoveEnd(h(n),h(t)))}}(function(e,r){e=h(e),r=h(r);var n=[],t={};for(var o in r)r.hasOwnProperty(o)&&e.hasOwnProperty(o)&&e[o]===r[o]&&(delete e[o],delete r[o]);for(o in r)if(r.hasOwnProperty(o)){var a=O(e,r[o],o);a&&(n.push({type:"move",source:a,destination:o,piece:r[o]}),delete e[a],delete r[o],t[o]=!0)}for(o in r)r.hasOwnProperty(o)&&(n.push({type:"add",square:o,piece:r[o]}),delete r[o]);for(o in e)e.hasOwnProperty(o)&&(t.hasOwnProperty(o)||(n.push({type:"clear",square:o,piece:e[o]}),delete e[o]));return n}(x,r),x,r),X(r)):(X(r),F())):K(6482,"Invalid value passed to the position method.",r)))},m.resize=function(){B=function(){var e=parseInt(i.width(),10);if(!e||e<=0)return 0;for(var r=e-1;r%8!=0&&0<r;)r-=1;return r/8}(),s.css("width",8*B+"px"),u.css({height:B,width:B}),a.sparePieces&&i.find("."+c.sparePieces).css("paddingLeft",B+w+"px"),W()},m.start=function(e){m.position("start",e)};var ae=l(function(e){N&&Z(e.pageX,e.pageY)},a.dragThrottleRate),ie=l(function(e){N&&(e.preventDefault(),Z(e.originalEvent.changedTouches[0].pageX,e.originalEvent.changedTouches[0].pageY))},a.dragThrottleRate);function se(e){N&&V(Y(e.pageX,e.pageY))}function ue(e){N&&V(Y(e.originalEvent.changedTouches[0].pageX,e.originalEvent.changedTouches[0].pageY))}function fe(r){if(!N&&b(a.onMouseoverSquare)){var n=e(r.currentTarget).attr("data-square");if(E(n)){var t=!1;x.hasOwnProperty(n)&&(t=x[n]),a.onMouseoverSquare(n,t,h(x),P)}}}function ce(r){if(!N&&b(a.onMouseoutSquare)){var n=e(r.currentTarget).attr("data-square");if(E(n)){var t=!1;x.hasOwnProperty(n)&&(t=x[n]),a.onMouseoutSquare(n,t,h(x),P)}}}return P=a.orientation,a.hasOwnProperty("position")&&("start"===a.position?x=h(o):C(a.position)?x=_(a.position):S(a.position)?x=h(a.position):K(7263,"Invalid value passed to config.position.",a.position)),function(){!function(){for(var e=0;e<r.length;e++)for(var n=1;n<=8;n++){var t=r[e]+n;L[t]=t+"-"+p()}var o="KQRNBP".split("");for(e=0;e<o.length;e++){var a="w"+o[e],i="b"+o[e];D[a]=a+"-"+p(),D[i]=i+"-"+p()}}(),i.html(function(e){var r='<div class="{chessboard}">';return e&&(r+='<div class="{sparePieces} {sparePiecesTop}"></div>'),r+='<div class="{board}"></div>',e&&(r+='<div class="{sparePieces} {sparePiecesBottom}"></div>'),v(r+="</div>",c)}(a.sparePieces)),s=i.find("."+c.board),a.sparePieces&&(f=i.find("."+c.sparePiecesTop),d=i.find("."+c.sparePiecesBottom));var n=p();e("body").append($("wP",!0,n)),u=e("#"+n),w=parseInt(s.css("borderLeftWidth"),10),m.resize()}(),function(){e("body").on("mousedown mousemove","."+c.piece,ee),s.on("mousedown","."+c.square,re),i.on("mousedown","."+c.sparePieces+" ."+c.piece,te),s.on("mouseenter","."+c.square,fe).on("mouseleave","."+c.square,ce);var r=e(window);r.on("mousemove",ae).on("mouseup",se),"ontouchstart"in document.documentElement&&(s.on("touchstart","."+c.square,ne),i.on("touchstart","."+c.sparePieces+" ."+c.piece,oe),r.on("touchmove",ie).on("touchend",ue))}(),m},window.ChessBoard=window.Chessboard,window.Chessboard.fenToObj=_,window.Chessboard.objToFen=k}();