var Chess=function(e){var t="b",r="w",n=-1,o="p",a="n",i="b",s="r",c="q",l="k",u="pnbrqkPNBRQK",f="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",p=["1-0","0-1","1/2-1/2","*"],d={b:[16,32,17,15],w:[-16,-32,-17,-15]},h={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},v=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],g=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],b={p:0,n:1,b:2,r:3,q:4,k:5},m={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},w={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},y=7,E=6,P=1,C=0,S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},T={w:[{square:S.a1,flag:w.QSIDE_CASTLE},{square:S.h1,flag:w.KSIDE_CASTLE}],b:[{square:S.a8,flag:w.QSIDE_CASTLE},{square:S.h8,flag:w.KSIDE_CASTLE}]},_=new Array(128),k={w:n,b:n},O=r,x={w:0,b:0},A=n,q=0,I=1,R=[],D={};function N(){_=new Array(128),k={w:n,b:n},O=r,x={w:0,b:0},A=n,q=0,I=1,R=[],D={},U(B())}function L(){$(f)}function $(e){var o=e.split(/\s+/),a=o[0],i=0;if(!Q(e).valid)return!1;N();for(var s=0;s<a.length;s++){var c=a.charAt(s);if("/"===c)i+=8;else if(-1!=="0123456789".indexOf(c))i+=parseInt(c,10);else{var l=c<"a"?r:t;M({type:c.toLowerCase(),color:l},ie(i)),i++}}return O=o[1],o[2].indexOf("K")>-1&&(x.w|=w.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(x.w|=w.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(x.b|=w.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(x.b|=w.QSIDE_CASTLE),A="-"===o[3]?n:S[o[3]],q=parseInt(o[4],10),I=parseInt(o[5],10),U(B()),!0}function Q(e){var t="No errors.",r="FEN string must contain six space-delimited fields.",n="6th field (move number) must be a positive integer.",o="5th field (half move counter) must be a non-negative integer.",a="4th field (en-passant square) is invalid.",i="3rd field (castling availability) is invalid.",s="2nd field (side to move) is invalid.",c="1st field (piece positions) does not contain 8 '/'-delimited rows.",l="1st field (piece positions) is invalid [consecutive numbers].",u="1st field (piece positions) is invalid [invalid piece].",f="1st field (piece positions) is invalid [row too large].",p="Illegal en-passant square",d=e.split(/\s+/);if(6!==d.length)return{valid:!1,error_number:1,error:r};if(isNaN(d[5])||parseInt(d[5],10)<=0)return{valid:!1,error_number:2,error:n};if(isNaN(d[4])||parseInt(d[4],10)<0)return{valid:!1,error_number:3,error:o};if(!/^(-|[abcdefgh][36])$/.test(d[3]))return{valid:!1,error_number:4,error:a};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(d[2]))return{valid:!1,error_number:5,error:i};if(!/^(w|b)$/.test(d[1]))return{valid:!1,error_number:6,error:s};var h=d[0].split("/");if(8!==h.length)return{valid:!1,error_number:7,error:c};for(var v=0;v<h.length;v++){for(var g=0,b=!1,m=0;m<h[v].length;m++)if(isNaN(h[v][m])){if(!/^[prnbqkPRNBQK]$/.test(h[v][m]))return{valid:!1,error_number:9,error:u};g+=1,b=!1}else{if(b)return{valid:!1,error_number:8,error:l};g+=parseInt(h[v][m],10),b=!0}if(8!==g)return{valid:!1,error_number:10,error:f}}return"3"==d[3][1]&&"w"==d[1]||"6"==d[3][1]&&"b"==d[1]?{valid:!1,error_number:11,error:p}:{valid:!0,error_number:0,error:t}}function B(){for(var e=0,o="",a=S.a8;a<=S.h1;a++){if(null==_[a])e++;else{e>0&&(o+=e,e=0);var i=_[a].color,s=_[a].type;o+=i===r?s.toUpperCase():s.toLowerCase()}a+1&136&&(e>0&&(o+=e),a!==S.h1&&(o+="/"),e=0,a+=8)}var c="";x[r]&w.KSIDE_CASTLE&&(c+="K"),x[r]&w.QSIDE_CASTLE&&(c+="Q"),x[t]&w.KSIDE_CASTLE&&(c+="k"),x[t]&w.QSIDE_CASTLE&&(c+="q"),c=c||"-";var l=A===n?"-":ie(A);return[o,O,c,l,q,I].join(" ")}function K(e){for(var t=0;t<e.length;t+=2)"string"==typeof e[t]&&"string"==typeof e[t+1]&&(D[e[t]]=e[t+1]);return D}function U(e){R.length>0||(e!==f?(D.SetUp="1",D.FEN=e):(delete D.SetUp,delete D.FEN))}function j(e){var t=_[S[e]];return t?{type:t.type,color:t.color}:null}function M(e,t){if(!("type"in e&&"color"in e))return!1;if(-1===u.indexOf(e.type.toLowerCase()))return!1;if(!(t in S))return!1;var r=S[t];return(e.type!=l||k[e.color]==n||k[e.color]==r)&&(_[r]={type:e.type,color:e.color},e.type===l&&(k[e.color]=r),U(B()),!0)}function z(e,t,r,n,a){var i={color:O,from:t,to:r,flags:n,piece:e[t].type};return a&&(i.flags|=w.PROMOTION,i.promotion=a),e[r]?i.captured=e[r].type:n&w.EP_CAPTURE&&(i.captured=o),i}function G(e){function t(e,t,r,n,l){if(e[r].type!==o||oe(n)!==C&&oe(n)!==y)t.push(z(e,r,n,l));else for(var u=[c,s,i,a],f=0,p=u.length;f<p;f++)t.push(z(e,r,n,l,u[f]))}var r=[],n=O,l=se(n),u={b:P,w:E},f=S.a8,p=S.h1,v=!1,g=!(void 0!==e&&"legal"in e)||e.legal;if(void 0!==e&&"square"in e){if(!(e.square in S))return[];f=p=S[e.square],v=!0}for(var b=f;b<=p;b++)if(136&b)b+=7;else{var m=_[b];if(null!=m&&m.color===n)if(m.type===o){var T=b+d[n][0];if(null==_[T]){t(_,r,b,T,w.NORMAL);T=b+d[n][1];u[n]===oe(b)&&null==_[T]&&t(_,r,b,T,w.BIG_PAWN)}for(q=2;q<4;q++){136&(T=b+d[n][q])||(null!=_[T]&&_[T].color===l?t(_,r,b,T,w.CAPTURE):T===A&&t(_,r,b,A,w.EP_CAPTURE))}}else for(var q=0,I=h[m.type].length;q<I;q++){var R=h[m.type][q];for(T=b;!(136&(T+=R));){if(null!=_[T]){if(_[T].color===n)break;t(_,r,b,T,w.CAPTURE);break}if(t(_,r,b,T,w.NORMAL),"n"===m.type||"k"===m.type)break}}}if(!v||p===k[n]){if(x[n]&w.KSIDE_CASTLE){var D=(N=k[n])+2;null!=_[N+1]||null!=_[D]||X(l,k[n])||X(l,N+1)||X(l,D)||t(_,r,k[n],D,w.KSIDE_CASTLE)}if(x[n]&w.QSIDE_CASTLE){var N;D=(N=k[n])-2;null!=_[N-1]||null!=_[N-2]||null!=_[N-3]||X(l,k[n])||X(l,N-1)||X(l,D)||t(_,r,k[n],D,w.QSIDE_CASTLE)}}if(!g)return r;var L=[];for(b=0,I=r.length;b<I;b++)te(r[b]),Y(n)||L.push(r[b]),re();return L}function F(e,t){var r="";if(e.flags&w.KSIDE_CASTLE)r="O-O";else if(e.flags&w.QSIDE_CASTLE)r="O-O-O";else{var n=function(e,t){for(var r=G({legal:!t}),n=e.from,o=e.to,a=e.piece,i=0,s=0,c=0,l=0,u=r.length;l<u;l++){var f=r[l].from,p=r[l].to,d=r[l].piece;a===d&&n!==f&&o===p&&(i++,oe(n)===oe(f)&&s++,ae(n)===ae(f)&&c++)}if(i>0)return s>0&&c>0?ie(n):c>0?ie(n).charAt(1):ie(n).charAt(0);return""}(e,t);e.piece!==o&&(r+=e.piece.toUpperCase()+n),e.flags&(w.CAPTURE|w.EP_CAPTURE)&&(e.piece===o&&(r+=ie(e.from)[0]),r+="x"),r+=ie(e.to),e.flags&w.PROMOTION&&(r+="="+e.promotion.toUpperCase())}return te(e),H()&&(J()?r+="#":r+="+"),re(),r}function W(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function X(e,n){for(var a=S.a8;a<=S.h1;a++)if(136&a)a+=7;else if(null!=_[a]&&_[a].color===e){var i=_[a],s=a-n,c=s+119;if(v[c]&1<<b[i.type]){if(i.type===o){if(s>0){if(i.color===r)return!0}else if(i.color===t)return!0;continue}if("n"===i.type||"k"===i.type)return!0;for(var l=g[c],u=a+l,f=!1;u!==n;){if(null!=_[u]){f=!0;break}u+=l}if(!f)return!0}}return!1}function Y(e){return X(se(e),k[e])}function H(){return Y(O)}function J(){return H()&&0===G().length}function Z(){return!H()&&0===G().length}function V(){for(var e={},t=[],r=0,n=0,o=S.a8;o<=S.h1;o++)if(n=(n+1)%2,136&o)o+=7;else{var s=_[o];s&&(e[s.type]=s.type in e?e[s.type]+1:1,s.type===i&&t.push(n),r++)}if(2===r)return!0;if(3===r&&(1===e[i]||1===e[a]))return!0;if(r===e[i]+2){var c=0,l=t.length;for(o=0;o<l;o++)c+=t[o];if(0===c||c===l)return!0}return!1}function ee(){for(var e=[],t={},r=!1;;){var n=re();if(!n)break;e.push(n)}for(;;){var o=B().split(" ").slice(0,4).join(" ");if(t[o]=o in t?t[o]+1:1,t[o]>=3&&(r=!0),!e.length)break;te(e.pop())}return r}function te(e){var r=O,a=se(r);if(function(e){R.push({move:e,kings:{b:k.b,w:k.w},turn:O,castling:{b:x.b,w:x.w},ep_square:A,half_moves:q,move_number:I})}(e),_[e.to]=_[e.from],_[e.from]=null,e.flags&w.EP_CAPTURE&&(O===t?_[e.to-16]=null:_[e.to+16]=null),e.flags&w.PROMOTION&&(_[e.to]={type:e.promotion,color:r}),_[e.to].type===l){if(k[_[e.to].color]=e.to,e.flags&w.KSIDE_CASTLE){var i=e.to-1,s=e.to+1;_[i]=_[s],_[s]=null}else if(e.flags&w.QSIDE_CASTLE){i=e.to+1,s=e.to-2;_[i]=_[s],_[s]=null}x[r]=""}if(x[r])for(var c=0,u=T[r].length;c<u;c++)if(e.from===T[r][c].square&&x[r]&T[r][c].flag){x[r]^=T[r][c].flag;break}if(x[a])for(c=0,u=T[a].length;c<u;c++)if(e.to===T[a][c].square&&x[a]&T[a][c].flag){x[a]^=T[a][c].flag;break}A=e.flags&w.BIG_PAWN?"b"===O?e.to-16:e.to+16:n,e.piece===o?q=0:e.flags&(w.CAPTURE|w.EP_CAPTURE)?q=0:q++,O===t&&I++,O=se(O)}function re(){var e=R.pop();if(null==e)return null;var r=e.move;k=e.kings,O=e.turn,x=e.castling,A=e.ep_square,q=e.half_moves,I=e.move_number;var n,a,i=O,s=se(O);if(_[r.from]=_[r.to],_[r.from].type=r.piece,_[r.to]=null,r.flags&w.CAPTURE)_[r.to]={type:r.captured,color:s};else if(r.flags&w.EP_CAPTURE){var c;c=i===t?r.to-16:r.to+16,_[c]={type:o,color:s}}r.flags&(w.KSIDE_CASTLE|w.QSIDE_CASTLE)&&(r.flags&w.KSIDE_CASTLE?(n=r.to+1,a=r.to-1):r.flags&w.QSIDE_CASTLE&&(n=r.to-2,a=r.to+1),_[n]=_[a],_[a]=null);return r}function ne(e,t){var r=W(e);if(t){var n=r.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(n)var o=n[1],a=n[2],i=n[3],s=n[4]}for(var c=G(),l=0,u=c.length;l<u;l++){if(r===W(F(c[l]))||t&&r===W(F(c[l],!0)))return c[l];if(n&&(!o||o.toLowerCase()==c[l].piece)&&S[a]==c[l].from&&S[i]==c[l].to&&(!s||s.toLowerCase()==c[l].promotion))return c[l]}return null}function oe(e){return e>>4}function ae(e){return 15&e}function ie(e){var t=ae(e),r=oe(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(r,r+1)}function se(e){return e===r?t:r}function ce(e){var t=function e(t){var r=t instanceof Array?[]:{};for(var n in t)r[n]="object"==typeof n?e(t[n]):t[n];return r}(e);t.san=F(t,!1),t.to=ie(t.to),t.from=ie(t.from);var r="";for(var n in w)w[n]&t.flags&&(r+=m[n]);return t.flags=r,t}function le(e){return e.replace(/^\s+|\s+$/g,"")}return $(void 0===e?f:e),{WHITE:r,BLACK:t,PAWN:o,KNIGHT:a,BISHOP:i,ROOK:s,QUEEN:c,KING:l,SQUARES:function(){for(var e=[],t=S.a8;t<=S.h1;t++)136&t?t+=7:e.push(ie(t));return e}(),FLAGS:m,load:function(e){return $(e)},reset:function(){return L()},moves:function(e){for(var t=G(e),r=[],n=0,o=t.length;n<o;n++)void 0!==e&&"verbose"in e&&e.verbose?r.push(ce(t[n])):r.push(F(t[n],!1));return r},in_check:function(){return H()},in_checkmate:function(){return J()},in_stalemate:function(){return Z()},in_draw:function(){return q>=100||Z()||V()||ee()},insufficient_material:function(){return V()},in_threefold_repetition:function(){return ee()},game_over:function(){return q>=100||J()||Z()||V()||ee()},validate_fen:function(e){return Q(e)},fen:function(){return B()},pgn:function(e){var t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",r="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,n=[],o=!1;for(var a in D)n.push("["+a+' "'+D[a]+'"]'+t),o=!0;o&&R.length&&n.push(t);for(var i=[];R.length>0;)i.push(re());for(var s=[],c="";i.length>0;){var l=i.pop();R.length||"b"!==l.color?"w"===l.color&&(c.length&&s.push(c),c=I+"."):c=I+". ...",c=c+" "+F(l,!1),te(l)}if(c.length&&s.push(c),void 0!==D.Result&&s.push(D.Result),0===r)return n.join("")+s.join(" ");var u=0;for(a=0;a<s.length;a++)u+s[a].length>r&&0!==a?(" "===n[n.length-1]&&n.pop(),n.push(t),u=0):0!==a&&(n.push(" "),u++),n.push(s[a]),u+=s[a].length;return n.join("")},load_pgn:function(e,t){var r=void 0!==t&&"sloppy"in t&&t.sloppy;function n(e){return e.replace(/\\/g,"\\")}var o="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",a=new RegExp("^(\\[(.|"+n(o)+")*\\])("+n(o)+")*1.("+n(o)+"|.)*$","g"),i=e.replace(a,"$1");"["!==i[0]&&(i=""),L();var s=function(e,t){for(var r="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",o={},a=e.split(new RegExp(n(r))),i="",s="",c=0;c<a.length;c++)i=a[c].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),s=a[c].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),le(i).length>0&&(o[i]=s);return o}(i,t);for(var c in s)K([c,s[c]]);if("1"===s.SetUp&&!("FEN"in s&&$(s.FEN)))return!1;var l=e.replace(i,"").replace(new RegExp(n(o),"g")," ");l=l.replace(/(\{[^}]+\})+?/g,"");for(var u=/(\([^\(\)]+\))+?/g;u.test(l);)l=l.replace(u,"");var f=le(l=(l=(l=l.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));f=f.join(",").replace(/,,+/g,",").split(",");for(var d="",h=0;h<f.length-1;h++){if(null==(d=ne(f[h],r)))return!1;te(d)}if(d=f[f.length-1],p.indexOf(d)>-1)(function(e){for(var t in e)return!0;return!1})(D)&&void 0===D.Result&&K(["Result",d]);else{if(null==(d=ne(d,r)))return!1;te(d)}return!0},header:function(){return K(arguments)},ascii:function(){return function(){for(var e="   +------------------------+\n",t=S.a8;t<=S.h1;t++){if(0===ae(t)&&(e+=" "+"87654321"[oe(t)]+" |"),null==_[t])e+=" . ";else{var n=_[t].type;e+=" "+(_[t].color===r?n.toUpperCase():n.toLowerCase())+" "}t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h\n"}()},turn:function(){return O},move:function(e,t){var r=void 0!==t&&"sloppy"in t&&t.sloppy,n=null;if("string"==typeof e)n=ne(e,r);else if("object"==typeof e)for(var o=G(),a=0,i=o.length;a<i;a++)if(!(e.from!==ie(o[a].from)||e.to!==ie(o[a].to)||"promotion"in o[a]&&e.promotion!==o[a].promotion)){n=o[a];break}if(!n)return null;var s=ce(n);return te(n),s},undo:function(){var e=re();return e?ce(e):null},clear:function(){return N()},put:function(e,t){return M(e,t)},get:function(e){return j(e)},remove:function(e){return function(e){var t=j(e);return _[S[e]]=null,t&&t.type===l&&(k[t.color]=n),U(B()),t}(e)},perft:function(e){return function e(t){for(var r=G({legal:!1}),n=0,o=O,a=0,i=r.length;a<i;a++)te(r[a]),Y(o)||(t-1>0?n+=e(t-1):n++),re();return n}(e)},square_color:function(e){if(e in S){var t=S[e];return(oe(t)+ae(t))%2==0?"light":"dark"}return null},history:function(e){for(var t=[],r=[],n=(void 0!==e&&"verbose"in e&&e.verbose);R.length>0;)t.push(re());for(;t.length>0;){var o=t.pop();n?r.push(ce(o)):r.push(F(o)),te(o)}return r}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define(function(){return Chess}),function(){"use strict";var e=window.jQuery,t="abcdefgh".split(""),r=20,n="1.8.3",o=_("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"),a=200,i=200,s=60,c=30,l=100,u={};function f(e,t,r){function n(){o=0,a&&(a=!1,s())}var o=0,a=!1,i=[],s=function(){o=window.setTimeout(n,t),e.apply(r,i)};return function(e){i=arguments,o?a=!0:s()}}function p(){return"xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx-xxxx".replace(/x/g,function(e){return(16*Math.random()|0).toString(16)})}function d(e){return JSON.parse(JSON.stringify(e))}function h(e){var t=e.split(".");return{major:parseInt(t[0],10),minor:parseInt(t[1],10),patch:parseInt(t[2],10)}}function v(e,t){for(var r in t)if(t.hasOwnProperty(r))for(var n="{"+r+"}",o=t[r];-1!==e.indexOf(n);)e=e.replace(n,o);return e}function g(e){return"string"==typeof e}function b(e){return"function"==typeof e}function m(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}function w(e){return"fast"===e||"slow"===e||!!m(e)&&0<=e}function y(e){if(!g(e))return!1;var t=e.split("-");return 2===t.length&&E(t[0])&&E(t[1])}function E(e){return g(e)&&-1!==e.search(/^[a-h][1-8]$/)}function P(e){return g(e)&&-1!==e.search(/^[bw][KQRNBP]$/)}function C(e){if(!g(e))return!1;var t=(e=function(e){return e.replace(/8/g,"11111111").replace(/7/g,"1111111").replace(/6/g,"111111").replace(/5/g,"11111").replace(/4/g,"1111").replace(/3/g,"111").replace(/2/g,"11")}(e=e.replace(/ .+$/,""))).split("/");if(8!==t.length)return!1;for(var r=0;r<8;r++)if(8!==t[r].length||-1!==t[r].search(/[^kqrnbpKQRNBP1]/))return!1;return!0}function S(t){if(!e.isPlainObject(t))return!1;for(var r in t)if(t.hasOwnProperty(r)&&(!E(r)||!P(t[r])))return!1;return!0}function T(){return typeof window.$&&e.fn&&e.fn.jquery&&function(e,t){e=h(e),t=h(t);var r=1e5*e.major*1e5+1e5*e.minor+e.patch;return 1e5*t.major*1e5+1e5*t.minor+t.patch<=r}(e.fn.jquery,n)}function _(e){if(!C(e))return!1;for(var r,n=(e=e.replace(/ .+$/,"")).split("/"),o={},a=8,i=0;i<8;i++){for(var s=n[i].split(""),c=0,l=0;l<s.length;l++)-1!==s[l].search(/[1-8]/)?c+=parseInt(s[l],10):(o[t[c]+a]=(r=s[l]).toLowerCase()===r?"b"+r.toUpperCase():"w"+r.toUpperCase(),c+=1);a-=1}return o}function k(e){if(!S(e))return!1;for(var r,n="",o=8,a=0;a<8;a++){for(var i=0;i<8;i++){var s=t[i]+o;e.hasOwnProperty(s)?n+=(r=void 0,"w"===(r=e[s].split(""))[0]?r[1].toUpperCase():r[1].toLowerCase()):n+="1"}7!==a&&(n+="/"),o-=1}return n.replace(/11111111/g,"8").replace(/1111111/g,"7").replace(/111111/g,"6").replace(/11111/g,"5").replace(/1111/g,"4").replace(/111/g,"3").replace(/11/g,"2")}function O(e,r,n){for(var o=function(e){for(var r=[],n=0;n<8;n++)for(var o=0;o<8;o++){var a=t[n]+(o+1);e!==a&&r.push({square:a,distance:(i=e,s=a,c=i.split(""),l=t.indexOf(c[0])+1,u=parseInt(c[1],10),f=s.split(""),p=t.indexOf(f[0])+1,d=parseInt(f[1],10),h=Math.abs(l-p),v=Math.abs(u-d),v<=h?h:v)})}var i,s,c,l,u,f,p,d,h,v;r.sort(function(e,t){return e.distance-t.distance});var g=[];for(n=0;n<r.length;n++)g.push(r[n].square);return g}(n),a=0;a<o.length;a++){var i=o[a];if(e.hasOwnProperty(i)&&e[i]===r)return i}return!1}function x(e){return"black"!==e.orientation&&(e.orientation="white"),!1!==e.showNotation&&(e.showNotation=!0),!0!==e.draggable&&(e.draggable=!1),"trash"!==e.dropOffBoard&&(e.dropOffBoard="snapback"),!0!==e.sparePieces&&(e.sparePieces=!1),e.sparePieces&&(e.draggable=!0),e.hasOwnProperty("pieceTheme")&&(g(e.pieceTheme)||b(e.pieceTheme))||(e.pieceTheme="img/chesspieces/wikipedia/{piece}.png"),w(e.appearSpeed)||(e.appearSpeed=a),w(e.moveSpeed)||(e.moveSpeed=i),w(e.snapbackSpeed)||(e.snapbackSpeed=s),w(e.snapSpeed)||(e.snapSpeed=c),w(e.trashSpeed)||(e.trashSpeed=l),function(e){return m(e)&&1<=e}(e.dragThrottleRate)||(e.dragThrottleRate=r),e}u.alpha="alpha-d2270",u.black="black-3c85d",u.board="board-b72b1",u.chessboard="chessboard-63f37",u.clearfix="clearfix-7da63",u.highlight1="highlight1-32417",u.highlight2="highlight2-9c5d2",u.notation="notation-322f9",u.numeric="numeric-fc462",u.piece="piece-417db",u.row="row-5277c",u.sparePieces="spare-pieces-7492f",u.sparePiecesBottom="spare-pieces-bottom-ae20f",u.sparePiecesTop="spare-pieces-top-4028b",u.square="square-55d63",u.white="white-1e1d7",window.Chessboard=function(r,a){if(!function(){if(T())return!0;var e="Chessboard Error 1005: Unable to find a valid version of jQuery. Please include jQuery "+n+" or higher on the page\n\nExiting…";return window.alert(e),!1}())return null;var i=function(t){if(""===t){return window.alert("Chessboard Error 1001: The first argument to Chessboard() cannot be an empty string.\n\nExiting…"),!1}g(t)&&"#"!==t.charAt(0)&&(t="#"+t);var r=e(t);if(1===r.length)return r;return window.alert("Chessboard Error 1003: The first argument to Chessboard() must be the ID of a DOM node, an ID query selector, or a single DOM node.\n\nExiting…"),!1}(r);if(!i)return null;a=x(a=function(t){return"start"===t?t={position:d(o)}:C(t)?t={position:_(t)}:S(t)&&(t={position:d(t)}),e.isPlainObject(t)||(t={}),t}(a));var s=null,c=null,l=null,h=null,m={},w=2,P="white",A={},q=null,I=null,R=null,D=!1,N={},L={},$={},Q=16;function B(e,t,r){if(!0===a.hasOwnProperty("showErrors")&&!1!==a.showErrors){var n="Chessboard Error "+e+": "+t;return"console"===a.showErrors&&"object"==typeof console&&"function"==typeof console.log?(console.log(n),void(2<=arguments.length&&console.log(r))):"alert"===a.showErrors?(r&&(n+="\n\n"+JSON.stringify(r)),void window.alert(n)):void(b(a.showErrors)&&a.showErrors(e,t,r))}}function K(e){return b(a.pieceTheme)?a.pieceTheme(e):g(a.pieceTheme)?v(a.pieceTheme,{piece:e}):(B(8272,"Unable to build image source for config.pieceTheme."),"")}function U(e,t,r){var n='<img src="'+K(e)+'" ';return g(r)&&""!==r&&(n+='id="'+r+'" '),n+='alt="" class="{piece}" data-piece="'+e+'" style="width:'+Q+"px;height:"+Q+"px;",t&&(n+="display:none;"),v(n+='" />',u)}function j(e){var t=["wK","wQ","wR","wB","wN","wP"];"black"===e&&(t=["bK","bQ","bR","bB","bN","bP"]);for(var r="",n=0;n<t.length;n++)r+=U(t[n],!1,N[t[n]]);return r}function M(t,r,n,o){var i=e("#"+L[t]),s=i.offset(),c=e("#"+L[r]),l=c.offset(),f=p();e("body").append(U(n,!0,f));var d=e("#"+f);d.css({display:"",position:"absolute",top:s.top,left:s.left}),i.find("."+u.piece).remove();var h={duration:a.moveSpeed,complete:function(){c.append(U(n)),d.remove(),b(o)&&o()}};d.animate(l,h)}function z(t,r,n){var o=e("#"+N[t]).offset(),i=e("#"+L[r]),s=i.offset(),c=p();e("body").append(U(t,!0,c));var l=e("#"+c);l.css({display:"",position:"absolute",left:o.left,top:o.top});var f={duration:a.moveSpeed,complete:function(){i.find("."+u.piece).remove(),i.append(U(t)),l.remove(),b(n)&&n()}};l.animate(s,f)}function G(){for(var t in s.find("."+u.piece).remove(),A)A.hasOwnProperty(t)&&e("#"+L[t]).append(U(A[t]))}function F(){s.html(function(e){"black"!==e&&(e="white");var r="",n=d(t),o=8;"black"===e&&(n.reverse(),o=1);for(var i="white",s=0;s<8;s++){r+='<div class="{row}">';for(var c=0;c<8;c++){var l=n[c]+o;r+='<div class="{square} '+u[i]+" square-"+l+'" style="width:'+Q+"px;height:"+Q+'px;" id="'+L[l]+'" data-square="'+l+'">',a.showNotation&&(("white"===e&&1===o||"black"===e&&8===o)&&(r+='<div class="{notation} {alpha}">'+n[c]+"</div>"),0===c&&(r+='<div class="{notation} {numeric}">'+o+"</div>")),r+="</div>",i="white"===i?"black":"white"}r+='<div class="{clearfix}"></div></div>',i="white"===i?"black":"white","white"===e?o-=1:o+=1}return v(r,u)}(P,a.showNotation)),G(),a.sparePieces&&("white"===P?(l.html(j("black")),h.html(j("white"))):(l.html(j("white")),h.html(j("black"))))}function W(e){var t=d(A),r=d(e);k(t)!==k(r)&&(b(a.onChange)&&a.onChange(t,r),A=e)}function X(e,t){for(var r in $)if($.hasOwnProperty(r)){var n=$[r];if(e>=n.left&&e<n.left+Q&&t>=n.top&&t<n.top+Q)return r}return"offboard"}function Y(){s.find("."+u.square).removeClass(u.highlight1+" "+u.highlight2)}function H(){Y();var e=d(A);delete e[R],W(e),G(),c.fadeOut(a.trashSpeed),D=!1}function J(t,r,n,o){b(a.onDragStart)&&!1===a.onDragStart(t,r,d(A),P)||(D=!0,q=r,I="spare"===(R=t)?"offboard":t,function(){for(var t in $={},L)L.hasOwnProperty(t)&&($[t]=e("#"+L[t]).offset())}(),c.attr("src",K(r)).css({display:"",position:"absolute",left:n-Q/2,top:o-Q/2}),"spare"!==t&&e("#"+L[t]).addClass(u.highlight1).find("."+u.piece).css("display","none"))}function Z(t,r){c.css({left:t-Q/2,top:r-Q/2});var n=X(t,r);n!==I&&(E(I)&&e("#"+L[I]).removeClass(u.highlight2),E(n)&&e("#"+L[n]).addClass(u.highlight2),b(a.onDragMove)&&a.onDragMove(n,I,R,q,d(A),P),I=n)}function V(t){var r="drop";if("offboard"===t&&"snapback"===a.dropOffBoard&&(r="snapback"),"offboard"===t&&"trash"===a.dropOffBoard&&(r="trash"),b(a.onDrop)){var n=d(A);"spare"===R&&E(t)&&(n[t]=q),E(R)&&"offboard"===t&&delete n[R],E(R)&&E(t)&&(delete n[R],n[t]=q);var o=d(A),i=a.onDrop(R,t,q,n,o,P);"snapback"!==i&&"trash"!==i||(r=i)}"snapback"===r?function(){if("spare"!==R){Y();var t=e("#"+L[R]).offset(),r={duration:a.snapbackSpeed,complete:function(){G(),c.css("display","none"),b(a.onSnapbackEnd)&&a.onSnapbackEnd(q,R,d(A),P)}};c.animate(t,r),D=!1}else H()}():"trash"===r?H():"drop"===r&&function(t){Y();var r=d(A);delete r[R],r[t]=q,W(r);var n=e("#"+L[t]).offset(),o={duration:a.snapSpeed,complete:function(){G(),c.css("display","none"),b(a.onSnapEnd)&&a.onSnapEnd(R,t,q)}};c.animate(n,o),D=!1}(t)}function ee(e){e.preventDefault()}function te(t){if(a.draggable){var r=e(this).attr("data-square");E(r)&&A.hasOwnProperty(r)&&J(r,A[r],t.pageX,t.pageY)}}function re(t){if(a.draggable){var r=e(this).attr("data-square");E(r)&&A.hasOwnProperty(r)&&(t=t.originalEvent,J(r,A[r],t.changedTouches[0].pageX,t.changedTouches[0].pageY))}}function ne(t){a.sparePieces&&J("spare",e(this).attr("data-piece"),t.pageX,t.pageY)}function oe(t){a.sparePieces&&J("spare",e(this).attr("data-piece"),(t=t.originalEvent).changedTouches[0].pageX,t.changedTouches[0].pageY)}m.clear=function(e){m.position({},e)},m.destroy=function(){i.html(""),c.remove(),i.unbind()},m.fen=function(){return m.position("fen")},m.flip=function(){return m.orientation("flip")},m.move=function(){if(0!==arguments.length){for(var e=!0,t={},r=0;r<arguments.length;r++)if(!1!==arguments[r])if(y(arguments[r])){var n=arguments[r].split("-");t[n[0]]=n[1]}else B(2826,"Invalid move passed to the move method.",arguments[r]);else e=!1;var o=function(e,t){var r=d(A);for(var n in t)if(t.hasOwnProperty(n)&&r.hasOwnProperty(n)){var o=r[n];delete r[n],r[t[n]]=o}return r}(0,t);return m.position(o,e),o}},m.orientation=function(e){return 0===arguments.length?P:"white"===e||"black"===e?(P=e,F(),P):"flip"===e?(P="white"===P?"black":"white",F(),P):void B(5482,"Invalid value passed to the orientation method.",e)},m.position=function(t,r){return 0===arguments.length?d(A):g(t)&&"fen"===t.toLowerCase()?k(A):(g(t)&&"start"===t.toLowerCase()&&(t=d(o)),C(t)&&(t=_(t)),void(S(t)?(!1!==r&&(r=!0),r?(function(t,r,n){if(0!==t.length)for(var o=0,i=0;i<t.length;i++){var s=t[i];"clear"===s.type?e("#"+L[s.square]+" ."+u.piece).fadeOut(a.trashSpeed,c):"add"!==s.type||a.sparePieces?"add"===s.type&&a.sparePieces?z(s.piece,s.square,c):"move"===s.type&&M(s.source,s.destination,s.piece,c):e("#"+L[s.square]).append(U(s.piece,!0)).find("."+u.piece).fadeIn(a.appearSpeed,c)}function c(){(o+=1)===t.length&&(G(),b(a.onMoveEnd)&&a.onMoveEnd(d(r),d(n)))}}(function(e,t){e=d(e),t=d(t);var r=[],n={};for(var o in t)t.hasOwnProperty(o)&&e.hasOwnProperty(o)&&e[o]===t[o]&&(delete e[o],delete t[o]);for(o in t)if(t.hasOwnProperty(o)){var a=O(e,t[o],o);a&&(r.push({type:"move",source:a,destination:o,piece:t[o]}),delete e[a],delete t[o],n[o]=!0)}for(o in t)t.hasOwnProperty(o)&&(r.push({type:"add",square:o,piece:t[o]}),delete t[o]);for(o in e)e.hasOwnProperty(o)&&(n.hasOwnProperty(o)||(r.push({type:"clear",square:o,piece:e[o]}),delete e[o]));return r}(A,t),A,t),W(t)):(W(t),G())):B(6482,"Invalid value passed to the position method.",t)))},m.resize=function(){Q=function(){var e=parseInt(i.width(),10);if(!e||e<=0)return 0;for(var t=e-1;t%8!=0&&0<t;)t-=1;return t/8}(),s.css("width",8*Q+"px"),c.css({height:Q,width:Q}),a.sparePieces&&i.find("."+u.sparePieces).css("paddingLeft",Q+w+"px"),F()},m.start=function(e){m.position("start",e)};var ae=f(function(e){D&&Z(e.pageX,e.pageY)},a.dragThrottleRate),ie=f(function(e){D&&(e.preventDefault(),Z(e.originalEvent.changedTouches[0].pageX,e.originalEvent.changedTouches[0].pageY))},a.dragThrottleRate);function se(e){D&&V(X(e.pageX,e.pageY))}function ce(e){D&&V(X(e.originalEvent.changedTouches[0].pageX,e.originalEvent.changedTouches[0].pageY))}function le(t){if(!D&&b(a.onMouseoverSquare)){var r=e(t.currentTarget).attr("data-square");if(E(r)){var n=!1;A.hasOwnProperty(r)&&(n=A[r]),a.onMouseoverSquare(r,n,d(A),P)}}}function ue(t){if(!D&&b(a.onMouseoutSquare)){var r=e(t.currentTarget).attr("data-square");if(E(r)){var n=!1;A.hasOwnProperty(r)&&(n=A[r]),a.onMouseoutSquare(r,n,d(A),P)}}}return P=a.orientation,a.hasOwnProperty("position")&&("start"===a.position?A=d(o):C(a.position)?A=_(a.position):S(a.position)?A=d(a.position):B(7263,"Invalid value passed to config.position.",a.position)),function(){!function(){for(var e=0;e<t.length;e++)for(var r=1;r<=8;r++){var n=t[e]+r;L[n]=n+"-"+p()}var o="KQRNBP".split("");for(e=0;e<o.length;e++){var a="w"+o[e],i="b"+o[e];N[a]=a+"-"+p(),N[i]=i+"-"+p()}}(),i.html(function(e){var t='<div class="{chessboard}">';return e&&(t+='<div class="{sparePieces} {sparePiecesTop}"></div>'),t+='<div class="{board}"></div>',e&&(t+='<div class="{sparePieces} {sparePiecesBottom}"></div>'),v(t+="</div>",u)}(a.sparePieces)),s=i.find("."+u.board),a.sparePieces&&(l=i.find("."+u.sparePiecesTop),h=i.find("."+u.sparePiecesBottom));var r=p();e("body").append(U("wP",!0,r)),c=e("#"+r),w=parseInt(s.css("borderLeftWidth"),10),m.resize()}(),function(){e("body").on("mousedown mousemove","."+u.piece,ee),s.on("mousedown","."+u.square,te),i.on("mousedown","."+u.sparePieces+" ."+u.piece,ne),s.on("mouseenter","."+u.square,le).on("mouseleave","."+u.square,ue);var t=e(window);t.on("mousemove",ae).on("mouseup",se),"ontouchstart"in document.documentElement&&(s.on("touchstart","."+u.square,re),i.on("touchstart","."+u.sparePieces+" ."+u.piece,oe),t.on("touchmove",ie).on("touchend",ce))}(),m},window.ChessBoard=window.Chessboard,window.Chessboard.fenToObj=_,window.Chessboard.objToFen=k}(),$$.control.registerControl("friendsPage",{template:'<div bn-control="breizbot.friends" \n\tdata-show-selection="true"\n\tbn-iface="friends"\n\t></div>',props:{$pager:null},buttons:[{name:"call",icon:"fa fa-check"}],init:function(e){const{$pager:t}=this.props,r=$$.viewController(e);this.onAction=function(e){console.log("onAction",e);const n=r.scope.friends.getSelection();if(null==n)return void $$.ui.showAlert({title:"Error",content:"Please select a friend"});const{friendUserName:o,isConnected:a}=n;console.log("userName",o),a?t.popPage(o):$$.ui.showAlert({title:"Error",content:`User <strong>${o}</strong> is not connected`})}}}),$$.control.registerControl("rootPage",{template:'<div class="toolbar">\n\n\t\t<div>\n\t\t\t<p>Status: <span bn-text="status"></span></p>\n\t\t\t<p>Distant: <strong bn-text="distant"></strong></p>\t\t\t\t\t\t\n\t\t</div>\t\t\n\n\t\t<div>\n\t\t\t<button \n\t\t\t\ttitle="Call a friend" \n\t\t\t\tbn-event="click: onCall"\n\t\t\t\tbn-show="[\'ready\', \'disconnected\', \'refused\', \'canceled\'].includes(status)"\n\t\t\t\tclass="w3-btn w3-green">Start</i></button>\n\n\t\t\t<button \n\t\t\t\tbn-event="click: onCancel"\n\t\t\t\tbn-show="status == \'calling\'"\n\t\t\t\tclass="w3-btn w3-blue">Cancel</button>\n\n\t\t\t<button \n\t\t\t\ttitle="Hangup" \n\t\t\t\tbn-event="click: onHangup"\n\t\t\t\tbn-show="status == \'connected\'"\n\t\t\t\tclass="w3-btn w3-red">Stop</button>\t\t\t\n\t\t</div>\n\n\n</div>\n\n<div class="message">\n\t<span bn-text="message" bn-show="status == \'connected\'"></span>\n</div>\n\n<div class="content">\n\t<div id="myBoard" bn-bind="board"></div>\t\n</div>\n\n',props:{$pager:null},deps:["breizbot.rtc","breizbot.broker","breizbot.params"],init:function(e,t,r,n){const{$pager:o}=this.props,a="#a9a9a9",i="#696969";let s=new Chess;const c=Chessboard("myBoard",{draggable:!0,pieceTheme:function(e){return`/webapps/chess/assets/img/chesspieces/wikipedia/${e}.png`},onDragStart:function(e,t,r,n){return!s.game_over()&&(!!u.model.yourTurn&&(!("white"===n&&-1===t.search(/^w/)||"black"===n&&-1===t.search(/^b/))&&void function(e){if(!u.model.yourTurn)return;const t=s.moves({square:e,verbose:!0});if(0===t.length)return;d(e);for(let e=0;e<t.length;e++)d(t[e].to)}(e)))},onDrop:function(e,r,n,o,a,i){if($("#myBoard .square-55d63").css("background",""),null===s.move({from:e,to:r,promotion:"q"}))return"snapback";e!=r&&(t.sendData("chess",{source:e,target:r}),u.setData({yourTurn:!1}),h(),p("white"),f.find(".square-"+e).addClass("highlight-white"),f.find(".square-"+r).addClass("highlight-white"))}});const l={status:"ready",distant:"",yourTurn:!1,message:""};null!=n.caller&&(l.status="connected",l.distant=n.caller,t.setRemoteClientId(n.clientId),c.orientation("black"),c.start());const u=$$.viewController(e,{data:l,events:{onCall:function(e){console.log("onCall"),o.pushPage("friendsPage",{title:"Select a friend to play with"})},onCancel:function(e){t.cancel(u.model.distant).then(()=>{u.setData({status:"canceled",distant:""})}).catch(e=>{$$.ui.showAlert({title:"Error",content:e.responseText})})},onHangup:function(e){t.bye(),u.setData({status:"ready",distant:"",messages:[]}),c.clear(),s=new Chess,p("black"),p("white")}}}),f=u.scope.board;function p(e){const t="highlight-"+e;f.find("."+t).removeClass(t)}function d(e){var t=$("#myBoard .square-"+e),r=a;t.hasClass("black-3c85d")&&(r=i),t.css("background",r)}function h(){var e="",t="White";"b"===s.turn()&&(t="Black"),s.in_checkmate()?e="Game over, "+t+" is in checkmate.":s.in_draw()?e="Game over, drawn position":(e=t+" to move",s.in_check()&&(e+=", "+t+" is in check")),u.setData({message:e})}h(),this.onReturn=function(e){null!=e&&t.call(e,"chess","fa fa-chess").then(()=>{u.setData({status:"calling",distant:e})}).catch(e=>{$$.ui.showAlert({title:"Error",content:e.responseText})})},r.onTopic("breizbot.rtc.accept",function(e){!0!==e.hist&&(console.log("msg",e),t.cancel(u.model.distant),t.setRemoteClientId(e.srcId),u.setData({status:"connected",yourTurn:!0}),c.start(),h())}),r.onTopic("breizbot.rtc.deny",function(e){!0!==e.hist&&(console.log("msg",e),u.setData({status:"refused"}),t.cancel(u.model.distant))}),r.onTopic("breizbot.rtc.chess",function(e){if(!0===e.hist)return;console.log("msg",e);const{source:t,target:r}=e.data;c.move(`${t}-${r}`),u.setData({yourTurn:!0}),s.move({from:t,to:r,promotion:"q"}),p("black"),f.find(".square-"+t).addClass("highlight-black"),f.find(".square-"+r).addClass("highlight-black"),h()}),r.onTopic("breizbot.rtc.bye",function(e){!0!==e.hist&&(console.log("msg",e),u.setData({status:"disconnected",distant:"",messages:[]}),s=new Chess,c.clear(),p("black"),p("white"))}),r.on("ready",e=>{t.setLocalClientId(e.clientId),null!=n.caller&&t.accept()}),window.onbeforeunload=function(){"connected"==u.model.status&&t.bye()}}});