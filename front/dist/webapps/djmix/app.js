$$.control.registerControl("rootPage",{template:'<div class="top">\n    <div class="midi">\n        <div>MIDI Device</div>\n        <div bn-control="brainjs.combobox" bn-data="{items: midiInputs}" bn-event="comboboxchange: onMidiInputChange">\n        </div>\n\n    </div>\n    <div class="balance">\n        <label>Left</label>\n        <div bn-control="brainjs.slider" bn-data="{min: 0, max: 1, step: 0.01}" bn-event="input: onCrossFaderChange"\n            bn-val="crossFader"></div>\n        <label>Right</label>\n    </div>\n    <div>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="1">LOAD 1\n            <i class="fa fa-spinner fa-pulse" bn-show="audio1"></i>\n        </button>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="2">LOAD 2\n            <i class="fa fa-spinner fa-pulse" bn-show="audio2"></i>\n        </button>\n\n    </div>\n\n</div>\n<div class="visualizer">\n    <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n        <div class="runningBuffer" bn-bind="runningBuffer1"></div>\n        <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n        <div class="hotcueContainer" bn-style="hotcueContainerStyle" bn-bind="hotcueContainer1"></div>\n    </div>\n</div>\n<div class="visualizer">\n    <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n        <div class="runningBuffer" bn-bind="runningBuffer2"></div>\n        <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n        <div class="hotcueContainer" bn-bind="hotcueContainer2"></div>\n    </div>\n</div>\n\n<div class="center">\n    <div bn-control="audioplayer" bn-iface="audio1" data-audio="1" bn-event="pause: onPause, playing: onPlay"></div>\n    <div class="masterPanel">\n        <span>Master</span>\n        <div class="toolbar2">\n            <i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n            <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                bn-event="input: onMasterVolumeChange" bn-val="masterVolume" class="volulmeSlider"></div>\n        </div>        \n    </div>\n    <div class="masterPanel">\n        <span>PFL</span>\n        <div class="toolbar2">\n            <i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n            <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                bn-event="input: onCueVolumeChange" bn-val="cueVolume" class="volulmeSlider"></div>\n        </div>        \n    </div>\n    <div bn-control="audioplayer" bn-iface="audio2" data-audio="2" bn-event="pause: onPause, playing: onPlay"></div>\n</div>\n\n\n<div bn-control="breizbot.filelist" bn-data="{selectionEnabled: true, filterExtension: \'mp3\', getMP3Info: true}"\n    bn-iface="filelist"></div>',deps:["breizbot.pager","MIDICtrl","AudioTools"],props:{},init:async function(e,n,t,o){const i=$$.util.mapRange(0,127,0,1),c=1200,a=80,s=4,l=32e3,d=[{},{}],u=$$.viewController(e,{data:{audio1:!1,audio2:!1,curPFL:1,midiInputs:[],midiOutputs:[],crossFader:.5,masterVolume:.5,cueVolume:.5,runningBufferContainerStyle:{width:c+"px",height:a+"px"},zeroTimeStyle:{left:c/2,height:a},hotcueContainerStyle:{}},events:{onMasterVolumeChange:function(e,n){O.setMasterLevel(n)},onCueVolumeChange:function(e,n){O.setMasterLevel(n)},onPause:function(){const e=$(this).data("audio");t.setButtonIntensity("PLAY",1,e)},onPlay:function(){const e=$(this).data("audio");t.setButtonIntensity("PLAY",127,e)},onCrossFaderChange:function(e,n){O.setFaderLevel(n)},onLoad:function(){f($(this).data("audio"))},onMidiInputChange:function(e){const n=$(this).getValue();t.selectMIDIDevice(n),t.clearAllButtons(),t.setButtonIntensity("PFL",1,2)}}}),r=["red","green"];async function f(e){console.log("loadTrack",e);const n="audio"+e;if(1==u.model[n])return void console.log("A track is already loading");const t=p.getSelFile();if(t){const o=k[e-1];o.innerHTML="";const i=h[e-1];i.innerHTML="",u.model[n]=!0,u.update();const d=await u.scope[n].setInfo(t),f=c/2*d.duration;i.style.width=f+"px",i.style.height=a+"px",function(e,n,t){console.log("bufferLength",e.length);const o=Math.ceil(c*e.duration/s);console.log("width",o);const i=e.getChannelData(0),d=Math.ceil(s*e.sampleRate/c);console.log("step",d);const u=a/2;let r=L(n,t);for(let e=0,c=0;e<o;e++,c++){c==l&&(r=L(n,t),c=0);let o=1,a=-1;for(let n=0;n<d;n++){const t=i[e*d+n];t<o&&(o=t),t>a&&(a=t)}r.fillRect(c,(1+o)*u,1,Math.max(1,(a-o)*u))}}(d,o,r[e-1]),u.model[n]=!1,m(0,e),u.update()}}function m(e,n){const t=k[n-1],o=h[n-1],i=c/s*(s/2-e);t.style.left=i+"px",o.style.left=i+"px"}const v=["red","green","blue","orange"];function y(e){return u.scope["audio"+e]}t.on("PLAY",({deck:e})=>{const n=y(e);t.setButtonIntensity("PLAY",n.isPlaying()?1:127,e),n.togglePlay()}),t.on("LOAD",async({deck:e})=>{f(e)}),t.on("CROSS_FADER",async({velocity:e})=>{const n=i(e);u.setData({crossFader:n}),O.setFaderLevel(n)}),t.on("LEVEL",async({deck:e,velocity:n})=>{const t=i(n);y(e).setVolume(t)}),t.on("BROWSE_WHEEL",async({velocity:e})=>{1==e?p.selDown():p.selUp()}),t.on("ENTER",async()=>{p.enterSelFolder()}),t.on("JOG_WHEEL",({deck:e,velocity:n})=>{y(e).seek(1==n?1:-1)}),t.on("CUE",({deck:e})=>{y(e).reset()}),t.on("HOT_CUE",({deck:e,key:n})=>{const o=y(e),i=o.getCurrentTime(),s=d[e-1][n-1];null==s?(!function(e,n,t){console.log("createHotCue",{deck:e,hotcue:n,time:t});const o=h[e-1],i=document.createElement("div");i.classList.add("hotcue");const s=c/2*t;i.style.left=s+"px",i.style.backgroundColor=v[n-1],i.style.height=a+"px",o.appendChild(i),d[e-1][n-1]=t}(e,n,i),t.setButtonIntensity("HOT_CUE",127,e,n)):o.reset(s,!0)}),t.on("PFL",({deck:e})=>{1==e?(B.setFaderLevel(0),t.setButtonIntensity("PFL",1,1),t.setButtonIntensity("PFL",0,2)):(B.setFaderLevel(1),t.setButtonIntensity("PFL",0,1),t.setButtonIntensity("PFL",1,2))}),t.on("MASTER_LEVEL",({velocity:e})=>{const n=i(e);O.setMasterLevel(n),u.setData({masterVolume:n})}),t.on("CUE_LEVEL",({velocity:e})=>{const n=i(e);B.setMasterLevel(n),u.setData({cueVolume:n})});const p=u.scope.filelist,g=u.scope.audio1,b=u.scope.audio2,k=[u.scope.runningBuffer1.get(0),u.scope.runningBuffer2.get(0)],h=[u.scope.hotcueContainer1.get(0),u.scope.hotcueContainer2.get(0)];function L(e,n){console.log("createCanvas");const t=document.createElement("canvas");t.width=l,t.height=a,e.appendChild(t);const o=t.getContext("2d");return o.clearRect(0,0,l,a),o.fillStyle=n,o}!function e(){g.isLoaded()&&m(g.getCurrentTime(),1),b.isLoaded()&&m(b.getCurrentTime(),2),requestAnimationFrame(e)}();const T=g.getOutputNode(),C=b.getOutputNode(),O=o.createCrossFaderWithMasterLevel(T,C),B=o.createCrossFaderWithMasterLevel(T,C);B.setFaderLevel(1);const P=o.createStereoMerger(O.getOutputNode(),B.getOutputNode());o.createDestination(4,P),async function(){console.log("init");const e=await t.requestMIDIAccess();u.setData(e)}()}}),function(){$$.control.registerControl("audioplayer",{template:'<div class="info">\n\t<div class="toolbar">\n\t\t<strong bn-text="name"></strong>\n\n\t\t<button bn-show="showPlay" bn-event="click: onPlay" class="w3-btn w3-blue" title="Play" bn-icon="fa fa-play">\n\t\t</button>\n\n\t\t<button bn-show="playing" bn-event="click: onPause" class="w3-btn w3-blue" title="Pause" bn-icon="fa fa-pause">\n\t\t</button>\n\n\n\n\t</div>\n\n\t<div class="toolbar2">\n\t\t<i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n\t\t<div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n\t\t\tbn-event="input: onVolumeChange" bn-val="volume" class="volulmeSlider"></div>\n\t</div>\n</div>\n\n<div class="bufferContainer" bn-show="showBuffer">\n\t<canvas bn-bind="bufferCanvas" class="bufferCanvas" width="470" height="100">\n</div>\n\n<div class="slider">\n\t<span bn-text="getTimeInfo"></span>\n\t<div bn-control="brainjs.slider" bn-data="{max: duration}" bn-event="input: onSliderChange" bn-val="curTime">\n\t</div>\n\n</div>\n\n',deps:["breizbot.pager","AudioTools"],props:{showBuffer:!1},init:function(e,n,t){const{showBuffer:o}=this.props,i=$$.media.getFormatedTime;let c=null,a=0,s=0,l=null;const d=t.getAudioContext(),u=d.createGain();u.gain.value=.5;const r=$$.viewController(e,{data:{name:"No Track loaded",volume:.5,duration:0,curTime:0,playing:!1,loaded:!1,showBuffer:o,getTimeInfo:function(){return`${i(this.curTime)} / ${i(this.duration)}`},showPlay:function(){return this.loaded&&!this.playing}},events:{onVolumeChange:function(e,n){u.gain.value=n},onPlay:function(){f()},onPause:function(){m()},onSliderChange:function(e,n){v(n,!0)}}});!function(e,n){const{width:t,height:o}=e;console.log({width:t,height:o});const i=e.getContext("2d");"function"==typeof n&&(e.onclick=function(e){console.log("onclick",e.offsetX);const o=e.offsetX/t*s.duration;n(o)});const c=document.createElement("canvas");c.width=t,c.height=o;const a=c.getContext("2d");let s=null;function l(e){if(s){i.clearRect(0,0,t,o),i.drawImage(c,0,5);const n=t*e/s.duration;i.fillStyle="rgba(255, 255, 255, 0.33)",i.fillRect(0,0,n,o)}}}(r.scope.bufferCanvas.get(0),e=>{console.log({time:e})});function f(){(l=d.createBufferSource()).buffer=c,l.connect(u),a=d.currentTime,l.start(0,s),r.setData({playing:!0}),e.trigger("playing")}function m(){s+=d.currentTime-a,l.stop(),r.setData({playing:!1}),e.trigger("pause")}function v(e=0,n=!1){const{playing:t}=r.model;t&&m(),s=e,n&&t&&f()}this.seek=function(e){!r.model.playing&&r.model.loaded&&(s+=11*e/360)},this.reset=v,this.setInfo=async function(e){let{mp3:n,name:t,url:o}=e,{artist:i,title:a}=n;null!=a&&(t=`${i} - ${a}`),console.log("name",t),r.setData({name:"Loading..."});const s=(c=await $$.media.getAudioBuffer(o)).duration;return r.setData({name:t,duration:s,loaded:!0}),c},this.getCurrentTime=function(){let e=s;return r.model.playing&&(e+=d.currentTime-a),r.setData({curTime:e}),e},this.getOutputNode=function(){return u},this.isPlaying=function(){return r.model.playing},this.setVolume=function(e){u.gain.value=e,r.setData({volume:e})},this.isLoaded=function(){return r.model.loaded},this.togglePlay=function(){r.model.playing?m():f()},this.getAudioBuffer=function(){return c}}})}(),$$.service.registerService("AudioTools",{init:function(){const e=new AudioContext;return{createStereoMerger:function(n,t){const o=e.createChannelSplitter(2);n.connect(o);const i=e.createChannelSplitter(2);t.connect(i);const c=e.createChannelMerger(4);return o.connect(c,0,0),o.connect(c,1,1),i.connect(c,0,2),i.connect(c,1,3),c},createDestination:function(n,t){const o=e.createMediaStreamDestination();o.channelCount=n;const i=new Audio;i.srcObject=o.stream,t.connect(o),i.play()},createCrossFaderWithMasterLevel:function(n,t){const o=e.createGain();o.gain.value=.5,n.connect(o);const i=e.createGain();i.gain.value=.5,t.connect(i);const c=e.createGain();return c.gain.value=.5,o.connect(c),i.connect(c),{setFaderLevel:function(e){i.gain.value=Math.cos(.5*(1-e)*Math.PI),o.gain.value=Math.cos(.5*e*Math.PI)},setMasterLevel:function(e){c.gain.value=e},getOutputNode:function(){return c}}},getAudioContext:function(){return e},getCurrentTime:function(){return e.currentTime}}}}),$$.service.registerService("MIDICtrl",{init:function(e){const n={MAX:127,MIN:1,OFF:0,ON:1},t=[{action:"MASTER_LEVEL",cmd:191,note:10},{action:"CUE_LEVEL",cmd:191,note:12},{action:"CROSS_FADER",cmd:191,note:8},{action:"LEVEL",cmd:176,note:22,deck:1},{action:"PITCH",cmd:176,note:25,deck:1},{action:"LEVEL",cmd:177,note:22,deck:2},{action:"PITCH",cmd:177,note:25,deck:2},{action:"SYNC",cmd:144,note:2,deck:1,type:"BTN"},{action:"CUE",cmd:144,note:1,deck:1,type:"BTN"},{action:"PLAY",cmd:144,note:0,deck:1,type:"BTN"},{action:"PFL",cmd:144,note:27,deck:1,type:"BTN2"},{action:"JOGTOUCH",cmd:144,note:6,deck:1},{action:"SYNC",cmd:145,note:2,deck:2,type:"BTN"},{action:"CUE",cmd:145,note:1,deck:2,type:"BTN"},{action:"PLAY",cmd:145,note:0,deck:2,type:"BTN"},{action:"PFL",cmd:145,note:27,deck:2,type:"BTN2"},{action:"JOGTOUCH",cmd:145,note:6,deck:2},{action:"LOAD",cmd:159,note:2,deck:1},{action:"LOAD",cmd:159,note:3,deck:2},{action:"ENTER",cmd:159,note:6},{action:"JOG_WHEEL",cmd:176,note:6,deck:1},{action:"JOG_WHEEL",cmd:177,note:6,deck:2},{action:"BROWSE_WHEEL",cmd:191,note:0},{action:"HOT_CUE",cmd:148,note:1,deck:1,key:1,type:"BTN"},{action:"HOT_CUE",cmd:148,note:2,deck:1,key:2,type:"BTN"},{action:"HOT_CUE",cmd:148,note:3,deck:1,key:3,type:"BTN"},{action:"HOT_CUE",cmd:148,note:4,deck:1,key:4,type:"BTN"},{action:"HOT_CUE",cmd:149,note:1,deck:2,key:1,type:"BTN"},{action:"HOT_CUE",cmd:149,note:2,deck:2,key:2,type:"BTN"},{action:"HOT_CUE",cmd:149,note:3,deck:2,key:3,type:"BTN"},{action:"HOT_CUE",cmd:149,note:4,deck:2,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:17,deck:1,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:18,deck:1,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:19,deck:1,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:20,deck:1,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:17,deck:2,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:18,deck:2,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:19,deck:2,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:20,deck:2,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:33,deck:1,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:34,deck:1,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:35,deck:1,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:36,deck:1,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:33,deck:2,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:34,deck:2,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:35,deck:2,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:36,deck:2,key:4,type:"BTN"},{action:"SAMPLER",cmd:148,note:49,deck:1,key:1,type:"BTN"},{action:"SAMPLER",cmd:148,note:50,deck:1,key:2,type:"BTN"},{action:"SAMPLER",cmd:148,note:51,deck:1,key:3,type:"BTN"},{action:"SAMPLER",cmd:148,note:52,deck:1,key:4,type:"BTN"},{action:"SAMPLER",cmd:149,note:49,deck:2,key:1,type:"BTN"},{action:"SAMPLER",cmd:149,note:50,deck:2,key:2,type:"BTN"},{action:"SAMPLER",cmd:149,note:51,deck:2,key:3,type:"BTN"},{action:"SAMPLER",cmd:149,note:52,deck:2,key:4,type:"BTN"}];const o=new EventEmitter2;let i=null,c=null,a=null;function s(e){const[n,i,c]=e.data,a=function(e){const[n,o]=e;for(const e of t)if(e.cmd==n&&e.note==o)return e;return null}(e.data);if(null!=a){const{action:e,deck:n,key:t}=a;o.emit(e,{deck:n,key:t,velocity:c})}}return{selectMIDIInput:function(e){c&&(c.onmidimessage=null);for(const n of i.inputs.values())if(n.id==e)return void((c=n).onmidimessage=s)},selectMIDIOutput:function(e){for(const n of i.outputs.values())if(n.id==e){a=n;break}},selectMIDIDevice:function(e){c&&(c.onmidimessage=null);for(const n of i.inputs.values())if(n.id==e){(c=n).onmidimessage=s;for(const e of i.outputs.values())if(e.name==n.name){a=e;break}break}},clearAllButtons:function(){if(null!=a)for(const{cmd:e,note:o,type:i}of t)"BTN"!=i&&"BTN2"!=i||a.send([e,o,"BTN"==i?n.MIN:n.OFF])},setButtonIntensity:function(e,n,o,i){if(null!=a)for(const c of t){let t=c.action==e;null!=o&&(t&=c.deck==o),null!=i&&(t&=c.key==i),t&&a.send([c.cmd,c.note,n])}},requestMIDIAccess:async function(){i=await navigator.requestMIDIAccess();const e=[];for(const{name:n,id:t}of i.inputs.values())e.push({label:n,value:t});const n=[];for(const{name:e,id:t}of i.outputs.values())n.push({label:e,value:t});return{midiInputs:e,midiOutputs:n}},on:o.on.bind(o),BtnIntensity:n}}});