$$.control.registerControl("rootPage",{template:'<div class="top">\n    <div class="midi">\n        <div>MIDI Device</div>\n        <div bn-control="brainjs.combobox" bn-data="{items: midiInputs}" bn-val="selectedInput"\n            bn-event="comboboxchange: onMidiInputChange">\n        </div>\n\n    </div>\n    <div class="balance">\n        <label>Left</label>\n        <div bn-control="brainjs.slider" bn-data="{min: 0, max: 1, step: 0.01, showRange: false}"\n            bn-event="input: onCrossFaderChange" bn-val="crossFader"></div>\n        <label>Right</label>\n    </div>\n    <div>\n        <button class="w3-button w3-blue" bn-icon="fas fa-chart-bar" title="Toggle Analyser" bn-event="click: onToggleAnalyser"></button>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="1">LOAD 1\n            <i class="fa fa-spinner fa-pulse" bn-show="audio1"></i>\n        </button>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="2">LOAD 2\n            <i class="fa fa-spinner fa-pulse" bn-show="audio2"></i>\n        </button>\n        <button class="w3-button w3-blue" bn-icon="fas fa-cog" title="Settings" bn-event="click: onSettings"></button>\n\n    </div>\n\n</div>\n<div class="area2">\n    <div bn-control="brainjs.audiopeakmeter" bn-data="{audioCtx, sourceNode: source1}"></div>\n    <div class="visualizers">\n        <div class="visualizer">\n            <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n                <div class="runningBuffer" bn-bind="runningBuffer1"></div>\n                <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n                <div class="hotcueContainer" bn-style="hotcueContainerStyle" bn-bind="hotcueContainer1"></div>\n            </div>\n        </div>\n        <div class="visualizer">\n            <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n                <div class="runningBuffer" bn-bind="runningBuffer2"></div>\n                <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n                <div class="hotcueContainer" bn-bind="hotcueContainer2"></div>\n            </div>\n        </div>\n        \n    </div>\n    <div bn-control="brainjs.audiopeakmeter" bn-data="{audioCtx, sourceNode: source2}"></div>\n\n</div>\n\n<div class="samplers">\n    <span>Samplers</span>\n    <button class="w3-button w3-blue w3-padding-small" bn-icon="fa fa-stop" title="Stop sample" bn-event="click: onStopSample"></button>\n\n    <div bn-each="sampleInfo"  bn-event="contextmenu.sample: onSampleChoice, click.sample: onPlaySample">\n        <button class="w3-button w3-blue w3-padding-small sample" bn-icon="fa fa-play" bn-attr="{title: getSampleTitle}"></button>\n    </div>\n</div>\n\n<div class="center">\n    <div bn-control="audioplayer" bn-iface="audio1" data-deck="1"></div>\n    <div class="mixer">\n        <div class="toolbar2">\n            <span>MASTER</span>\n            <div bn-control="brainjs.knob" bn-data="{max: 1, fgColor: \'#3ff\', bgColor: \'#111\', resetValue: 0.5}" bn-val="masterVolume" bn-event="turn: onMasterVolumeChange"></div>\n\n            \x3c!-- <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                bn-event="input: onMasterVolumeChange" bn-val="masterVolume" class="volulmeSlider"></div> --\x3e\n        </div>\n        <div class="toolbar2">\n            <span>CUE</span>\n            <div bn-control="brainjs.knob" bn-data="{max: 1, fgColor: \'#3ff\', bgColor: \'#111\', resetValue: 0.5}" bn-val="cueVolume" bn-event="turn: onCueVolumeChange"></div>\n\n            \x3c!-- <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                bn-event="input: onCueVolumeChange" bn-val="cueVolume" class="volulmeSlider"></div> --\x3e\n        </div>\n    </div>\n\n    <div bn-control="audioplayer" bn-iface="audio2" data-deck="2"></div>\n</div>\n\n<div class="bottom">\n    <div class="left">\n        <div class="search">\n            <input type="text" placeholder="Search..." bn-val="searchFilter" bn-update="change">\n            <button bn-icon="fas fa-times" bn-event="click: onClearSearch" ></button>\n        </div>\n        <div class="genre">\n            <button bn-icon="fas fa-stop" bn-event="click: onStopPreview" title="Stop preview"></button>\n            <div bn-control="brainjs.combobox" bn-data="{items: genres}" bn-val="selGenre" bn-update="comboboxchange"></div>\n        </div>\n        <div bn-control="tree" bn-event="filechange: onFileChange, loading: onLoadingSongs"></div>\n    </div>\n    <div class="laodingPanel" bn-show="loadingSongs">\n        <i class="fa fa-spinner fa-pulse" ></i>\n        <span>Loading...</span>\n    </div>\n    <div bn-control="filelist" bn-data="{files: getFiles}" bn-iface="filelist" bn-show="!loadingSongs" bn-event="preview: onPreview"></div>\n</div>\n\n',deps:["breizbot.pager","MIDICtrl","AudioTools","breizbot.appData","breizbot.files","breizbot.friends","breizbot.playlists"],props:{},init:async function(e,t,n,o,i,a,s,l){const c=$$.util.mapRange(0,127,0,1),r=$$.util.mapRange(0,127,.92,1.08),d=$$.ui.waitDialog("Loading samplers..."),u=1200,f=80,p=10,m=32e3;let g=i.getData();console.log("settings",g);const b=o.getAudioContext();let v=[],y=null,h=null,k=null;const C=$$.viewController(e,{data:{genres:["All"],selGenre:"All",sampleInfo:new Array(4).fill(null),loadingSongs:!1,samplers:[0,1,2,3],files:[],getFiles:function(){let e=this.files;if("All"!=this.selGenre&&(e=e.filter(e=>e.genre==this.selGenre)),""!=this.searchFilter){const t=new RegExp(`w*${this.searchFilter}w*`,"i");e=e.filter(e=>t.test(e.artist)||t.test(e.title))}return e},searchFilter:"",audioCtx:b,source1:null,selectedInput:"default",audio1:!1,audio2:!1,curPFL:1,midiInputs:[],midiOutputs:[],crossFader:.5,masterVolume:.5,cueVolume:.5,runningBufferContainerStyle:{width:u+"px",height:f+"px"},zeroTimeStyle:{left:u/2,height:f},hotcueContainerStyle:{},getSampleTitle:function(e){const t=e.$i;return null!=t?t.label:"No selection"}},events:{onToggleAnalyser:function(){x(1).toggleAnayser(),x(2).toggleAnayser()},onStopSample:function(){null!=k&&(k.stop(),k=null)},onPlaySample:function(){T($(this).index())},onSampleChoice:async function(e){e.preventDefault();const t=$(this).index(),n=await y.show();C.model.sampleInfo[t]=v[n.value],C.update()},onStopPreview:function(){G.pause()},onPreview:function(e,t){console.log("preview",t),G.src=t.url,G.play()},onClearSearch:function(){C.setData({searchFilter:""})},onLoadingSongs:function(){C.setData({loadingSongs:!0,files:[]})},onFileChange:function(e,t){console.log("onFileChange",t);let n={};for(const e of t.files)e.genre&&(n[e.genre]=1);(n=Object.keys(n)).unshift("All"),C.setData({files:t.files,loadingSongs:!1,genres:n,selGenre:"All"})},onSettings:function(){t.pushPage("settings",{title:"Settings",props:{data:g},onReturn:async function(e){console.log("settings",e),g=e,await i.saveData(g),L()}})},onMasterVolumeChange:function(e,t){h.setMasterLevel(t)},onCueVolumeChange:function(e,t){h.setMasterLevel(t)},onCrossFaderChange:function(e,t){h.setFaderLevel(t)},onLoad:function(){O($(this).data("audio"))},onMidiInputChange:function(e){w($(this).getValue())}}});function T(e){const t=C.model.sampleInfo[e];null!=t?(null!=k&&k.stop(),(k=b.createBufferSource()).buffer=t.audioBuffer,k.connect(h.getOutputNode()),k.start()):$.notify("No sample selected","error")}async function L(){if(g.samplersFolder){d.show();const e=await a.list(g.samplersFolder,{filterExtension:"mp3",filesOnly:!0});v=[];for(const t of e){const e=a.fileUrl(g.samplersFolder+t.name),n=await $$.media.getAudioBuffer(e);v.push({audioBuffer:n,value:v.length,label:t.name.replace(".mp3","")})}y=$$.formDialogController({title:"Samples",template:'<div bn-control="brainjs.combobox" bn-data="{items: samplersInfo}" name="value"></div>',data:{samplersInfo:v}}),d.hide()}}function w(e){n.selectMIDIDevice(e),n.clearAllButtons(),n.setButtonIntensity("PFL",1,2)}const S=["red","green"];async function O(e){console.log("loadTrack",e);const t="audio"+e;if(1==C.model[t])return void $.notify("A track is already loading","error");if(C.scope[t].isPlaying())return void $.notify("Please stop playback before loading a track","error");const n=F.getSelFile();if(n){R[e-1].innerHTML="";const o=_[e-1];o.innerHTML="",C.model[t]=!0,C.update();const{audioBuffer:i,tempo:a}=await C.scope[t].setInfo(n),s=u/2*i.duration;o.style.width=s+"px",o.style.height=f+"px",I(e,1,0),function(e,t,n){console.log("bufferLength",e.length);const o=Math.trunc(P(60/n.bpm));console.log("beatInterval",o);const i=Math.trunc(P(n.offset));console.log("beatOffset",i),console.log("duration",e.duration);const a=R[t-1],s=S[t-1],l=Math.floor(u*e.duration/p);console.log("width",l);const c=e.getChannelData(0),r=Math.floor(p*e.sampleRate/u);console.log("step",r);const d=f/2;let g=V(a);for(let e=0,t=0;e<l;e++,t++){t==m&&(g=V(a),t=0);let n=1,l=-1;for(let t=0;t<r;t++){const o=c[e*r+t];o<n&&(n=o),o>l&&(l=o)}g.fillStyle=s,g.fillRect(t,(1+n)*d,1,Math.max(1,(l-n)*d)),Math.abs(e-i)%o==0&&(g.fillStyle="black",g.fillRect(t,0,1,f))}}(i,e,a),C.model[t]=!1,A(0,e),C.update()}}function A(e,t){const n=R[t-1],o=_[t-1],i=u/p*(p/2-e);n.style.left=i+"px",o.style.left=i+"px"}const B=["red","green","blue","orange"];function P(e){return u/p*e}function I(e,t,n){console.log("createHotCue",{deck:e,hotcue:t,time:n}),E(e,t);const o=_[e-1],i=document.createElement("div");i.classList.add("hotcue");const a=P(n);i.style.left=a+"px",i.style.backgroundColor=B[t-1],i.style.height=f+"px",o.appendChild(i),x(e).addHotcue(t,n,i)}function E(e,t){const n=x(e),o=n.getHotcue(t);o&&(n.deleteHotcue(t),_[e-1].removeChild(o.div))}function N(e){const t=_[e-1];$(t).find(".loop").remove()}function M(e,t,n){console.log("createLoop",{deck:e,startTime:t,duration:n});const o=_[e-1];$(o).find(".loop").remove();const i=document.createElement("div");i.classList.add("loop");const a=P(t);i.style.left=a+"px",i.style.width=0==n?"2px":P(n)+"px",i.style.height=f+"px",o.appendChild(i)}function x(e){return C.scope["audio"+e]}function D(e,t){const n=R[e-1],o=`scale(${1/t}, 1)`;for(const e of n.querySelectorAll("canvas"))e.style.transform=o;_[e-1].style.transform=o}n.on("MIDI_STATECHANGE",e=>{console.log("midiStateChange",e),C.setData({midiInputs:n.getMIDIInputs()})}),n.on("PLAY",({deck:e})=>{x(e).togglePlay()}),n.on("LOAD",async({deck:e})=>{O(e)}),n.on("CROSS_FADER",async({velocity:e})=>{const t=c(e);C.setData({crossFader:t}),h.setFaderLevel(t)}),n.on("SYNC",({deck:e})=>{const t=1==e?2:1,o=x(e),i=x(t),a=i.getBpm()*i.getPlaybackRate()/o.getBpm();o.setPlaybackRate(a),D(e,a),n.setButtonIntensity("SYNC",127,e),n.setButtonIntensity("SYNC",1,t)}),n.on("PITCH",({deck:e,velocity:t})=>{const o=r(t);n.setButtonIntensity("SYNC",1,1),n.setButtonIntensity("SYNC",1,2),D(e,o),x(e).setPlaybackRate(o)}),n.on("LEVEL",async({deck:e,velocity:t})=>{const n=c(t);x(e).setVolume(n)}),n.on("BROWSE_WHEEL",async({velocity:e})=>{1==e?F.selDown():F.selUp()}),n.on("JOG_WHEEL",({deck:e,velocity:t})=>{let n=p/u;127==t&&(n*=-1),x(e).seek(n)}),n.on("JOGTOUCH_RELEASE",({deck:e})=>{x(e).jogTouch(!1)}),n.on("JOGTOUCH_PRESS",({deck:e})=>{x(e).jogTouch(!0)}),n.on("CUE",({deck:e})=>{const t=x(e);if(t.isPlaying())t.jumpToHotcue(1,!1);else{I(e,1,t.getCurrentTime())}}),n.on("LOOP_AUTO",({deck:e,key:t})=>{const n=x(e);let o=n.getCurrentTime();const i=60/n.getBpm()*(1<<t-1);0==(o=n.autoLoopActivate(t,o,i))?N(e):M(e,o,i)}),n.on("SAMPLER",({deck:e,key:t})=>{T(t-1)}),n.on("LOOP_MANUAL",({deck:e,key:t})=>{const n=x(e);if(1==t){const t=n.getCurrentTime();n.setStartLoopTime(t),M(e,t,0)}else if(2==t){const t=n.getStartLoopTime(),o=n.getCurrentTime();n.setEndLoopTime(o),M(e,t,o-t)}else 3==t&&(n.clearLoop(),N(e))}),n.on("HOT_CUE",({deck:e,key:t})=>{const n=x(e);if(1==t)n.toggleHotcueDeleteMode();else if(n.isHotcueDeleteMode())E(e,t);else{if(null==n.getHotcue(t)){I(e,t,n.getCurrentTime())}else n.jumpToHotcue(t,!0)}}),n.on("PFL",({deck:e})=>{1==e?(W.setFaderLevel(0),n.setButtonIntensity("PFL",1,1),n.setButtonIntensity("PFL",0,2)):(W.setFaderLevel(1),n.setButtonIntensity("PFL",0,1),n.setButtonIntensity("PFL",1,2))}),n.on("MASTER_LEVEL",({velocity:e})=>{const t=c(e);h.setMasterLevel(t),C.setData({masterVolume:t})}),n.on("CUE_LEVEL",({velocity:e})=>{const t=c(e);W.setMasterLevel(t),C.setData({cueVolume:t})});const F=C.scope.filelist,U=C.scope.audio1,H=C.scope.audio2,R=[C.scope.runningBuffer1.get(0),C.scope.runningBuffer2.get(0)],_=[C.scope.hotcueContainer1.get(0),C.scope.hotcueContainer2.get(0)];function V(e){console.log("createCanvas");const t=document.createElement("canvas");t.width=m,t.height=f,e.appendChild(t);const n=t.getContext("2d");return n.clearRect(0,0,m,f),n}!function e(){U.isLoaded()&&A(U.getRealTime(),1),H.isLoaded()&&A(H.getRealTime(),2),requestAnimationFrame(e)}();const j=U.getOutputNode(),z=H.getOutputNode(),G=new Audio,q=b.createMediaElementSource(G);C.setData({source1:j,source2:z}),h=o.createCrossFaderWithMasterLevel(j,z);const W=o.createCrossFaderWithMasterLevel(j,z);W.setFaderLevel(1),q.connect(W.getOutputNode());const Y=o.createStereoMerger(h.getOutputNode(),W.getOutputNode());o.createDestination(4,Y),async function(){console.log("init");const e=await n.requestMIDIAccess();if(C.setData(e),e.midiInputs.length>1){const t=e.midiInputs[1].value;C.setData({selectedInput:t}),w(t)}L()}()}}),function(){$$.control.registerControl("filelist",{deps:["breizbot.files"],props:{files:[]},template:'<div class="scrollPanel">\n\t<table class="w3-table-all w3-hoverable w3-small">\n\t\t<thead>\n\t\t\t<tr>\n\t\t\t\t<th></th>\n\t\t\t\t<th class="sortedCol" bn-event="click: onSortArtist">\n\t\t\t\t\t<i class="fas fa-sort-down" bn-show="isSortedByArtist"></i>\n\t\t\t\t\t<span>Artist</span>\n\t\t\t\t</th>\n\t\t\t\t<th>Title</th>\n\t\t\t\t<th class="sortedCol" bn-event="click: onSortGenre">\n\t\t\t\t\t<i class="fas fa-sort-down" bn-show="isSortedByGenre"></i>\n\t\t\t\t\t<span>Genre</span>\n\t\t\t\t</th>\n\t\t\t\t<th>Duration</th>\n\t\t\t\t<th>BPM</th>\n\t\t\t</tr>\n\t\t</thead>\n\t\t<tbody bn-each="files" bn-iter="f" bn-lazzy="10" bn-bind="files" bn-event="click.item: onItemClick, click.preview: onItemPreview">\n\t\t\t<tr class="item">\n\t\t\t\t<td><button class="preview" bn-icon="fa fa-play" title="Preview"></button></td>\n\t\t\t\t<td bn-text="$scope.f.artist"></td>\n\t\t\t\t<td bn-text="$scope.f.title"></td>\n\t\t\t\t<td bn-text="$scope.f.genre"></td>\n\t\t\t\t<td bn-text="getDuration"></td>\n\t\t\t\t<td bn-text="$scope.f.bpm"></td>\n\t\t\t</tr>\n\t\t</tbody>\n\t</table>\n\n</div>',init:function(e,t){let{files:n}=this.props;const o=$$.viewController(e,{data:{files:n,sortField:"",isSortedByArtist:function(){return"artist"==this.sortField},isSortedByGenre:function(){return"genre"==this.sortField},getDuration:function(e){const{length:t}=e.f;return t?$$.media.getFormatedTime(t):""}},events:{onSortArtist:function(){o.model.files.sort((e,t)=>e.artist.localeCompare(t.artist)),o.model.sortField="artist",o.update()},onSortGenre:function(){o.model.files.sort((e,t)=>{const n=e.genre||"WWWW",o=t.genre||"WWWW";let i=n.localeCompare(o);return 0==i&&(i=e.artist.localeCompare(t.artist)),i}),o.model.sortField="genre",o.update()},onItemPreview:function(){const t=$(this).closest("tr").index(),n=o.model.files[t];console.log("onItemPreview",t,n),e.trigger("preview",{url:n.url})},onItemClick:function(t){t.stopPropagation();const n=$(this).index(),i=o.model.files[n];$(this).closest("tbody").find(".active").removeClass("active"),$(this).addClass("active");const a={fileName:i.name,rootDir:o.model.rootDir,isImage:i.isImage,mp3:i.mp3};e.trigger("fileclick",a)}}}),i=o.scope.files;this.setData=function(e){e.files&&(o.setData({files:e.files,sortField:""}),i.find(".item").eq(0).addClass("active"))},this.selUp=function(){const e=i.find(".active"),t=e.index();if(t>0){e.removeClass("active");const n=i.find(".item");n.eq(t-1).addClass("active"),t-1>0?n.eq(t-2).get(0).scrollIntoViewIfNeeded():n.eq(t-1).get(0).scrollIntoViewIfNeeded()}},this.selDown=function(){const e=i.find(".active"),t=e.index();t<o.model.files.length-1&&(e.removeClass("active"),i.find(".item").eq(t+1).addClass("active").get(0).scrollIntoViewIfNeeded(!1))},this.getSelFile=function(){const e=i.find(".active").index();return e<0?null:o.model.files[e]}}})}(),function(){$$.control.registerControl("audioplayer",{template:'<div class="toolbar">\n\n\t<strong bn-text="name"></strong>\n\t<div bn-show="loaded">BPM: <strong bn-text="getBpm"></strong></div>\n\n\n\t<div>\n\t\t<button bn-show="showPlay" bn-event="click: onPlay" class="w3-btn w3-blue w3-padding-small" title="Play" bn-icon="fa fa-play">\n\t\t</button>\n\n\t\t<button bn-show="playing" bn-event="click: onPause" class="w3-btn w3-blue w3-padding-small" title="Pause" bn-icon="fa fa-pause">\n\t\t</button>\n\n\t</div>\n\n</div>\n\n\n</div>\n\n<div class="bufferContainer" bn-show="showBuffer">\n\t<canvas bn-bind="bufferCanvas" class="bufferCanvas" width="470" height="100">\n</div>\n\n<div class="content">\n\n\t<div class="toolbar2">\n\t\t<span>LOW</span>\n\t\t<div bn-control="brainjs.knob" bn-data="{min:-40, max:40, fgColor: \'#3ff\', bgColor: \'#111\', resetValue: 0, type: \'pan\', round:true}" bn-val="pitch" bn-event="turn: onLowTurn"></div>\n\t</div>\n\n\t<div class="toolbar2">\n\t\t<span>MID</span>\n\t\t<div bn-control="brainjs.knob" bn-data="{min:-40, max:40, fgColor: \'#3ff\', bgColor: \'#111\', resetValue: 0, type: \'pan\', round:true}" bn-val="pitch" bn-event="turn: onMidTurn"></div>\n\t</div>\n\n\t<div class="toolbar2">\n\t\t<span>HIGH</span>\n\t\t<div bn-control="brainjs.knob" bn-data="{min:-40, max:40, fgColor: \'#3ff\', bgColor: \'#111\', resetValue: 0, type: \'pan\', round:true}" bn-val="pitch" bn-event="turn: onHighTurn"></div>\n\t</div>\n\n\t<div class="toolbar2">\n\t\t<span>PITCH &#177 8%</span>\n\t\t<div bn-control="brainjs.knob" bn-data="{min:0.92, max:1.08, fgColor: \'#3ff\', bgColor: \'#111\', resetValue: 0, type: \'pan\'}" bn-val="pitch" bn-event="turn: onKnobTurn"></div>\n\t</div>\n\n\t<div class="toolbar2">\n\t\t<span>LEVEL</span>\n\t\t<div bn-control="brainjs.knob" bn-data="{max: 1, fgColor: \'#3ff\', bgColor: \'#111\', resetValue: 0.5}" bn-val="volume" bn-event="turn: onVolumeChange"></div>\n\t</div>\n</div>\n\n<div class="slider">\n\t<span bn-text="getTimeInfo"></span>\n\t<div bn-control="brainjs.slider" bn-data="{max: duration}" bn-event="input: onSliderChange" bn-val="curTime">\n\t</div>\n\n</div>\n\n<canvas class="analyser" width="500" height="100" bn-show="showAnalyser"></canvas>',deps:["breizbot.pager","AudioTools","MIDICtrl","breizbot.beatdetector"],props:{showBuffer:!1,deck:1},init:function(e,t,n,o,i){console.log("props",this.props);const{showBuffer:a,deck:s}=this.props,l=$$.media.getFormatedTime;let c=null;const r=e.find(".analyser").get(0),d=r.width,u=r.height,f=r.getContext("2d"),p=n.getAudioContext(),m=p.createGain(),g=p.createBiquadFilter();g.type="lowshelf",g.frequency.value=320,g.gain.value=0;const b=p.createBiquadFilter();b.type="peaking",b.frequency.value=1e3,b.Q.value=.5,b.gain.value=0;const v=p.createBiquadFilter();v.type="highshelf",v.frequency.value=3200,v.gain.value=0,m.connect(v),v.connect(b),b.connect(g);const y=p.createAnalyser();y.fftSize=256,y.minDecibels=-90,y.maxDecibels=-10,y.smoothingTimeConstant=.85,g.connect(y);const h=y.frequencyBinCount;console.log("bufferLength",h);const k=new Uint8Array(h),C=$$.util.mapRange(.92,1.08,1.08,.92);let T={},L=!1,w=0,S=0,O=0,A=!1,B=0;function P(){B=requestAnimationFrame(P),y.getByteFrequencyData(k),f.fillStyle="rgb(0, 0, 0)",f.fillRect(0,0,d,u);const e=d/h*2.5;let t=0;for(let n=0;n<h;n++){const o=k[n];f.fillStyle=`rgb(${o+100}, 50, 50)`,f.fillRect(t,u-o/2,e,o/2),t+=e+1}}const I=$$.viewController(e,{data:{showAnalyser:!1,samplers:[],tempo:0,name:"No Track loaded",volume:.5,getVolume:function(){return 100*this.volume},rate:1,pitch:function(){return C(this.rate)},duration:0,curTime:0,playing:!1,loaded:!1,showBuffer:a,bpm:0,getBpm:function(){return(this.bpm*this.rate).toFixed(1)},getTimeInfo:function(){return`${l(this.curTime,!0)} / ${l(this.duration)}`},showPlay:function(){return this.loaded&&!this.playing}},events:{onLowTurn:function(e,t){console.log("onLowTurn",t),g.gain.value=t},onMidTurn:function(e,t){console.log("onMidTurn",t),b.gain.value=t},onHighTurn:function(e,t){console.log("onHighTurn",t),v.gain.value=t},onPlaySampler:function(){const e=$(this).closest(".samplerPlayer").find(".brainjs-combobox").getValue();console.log("onPlaySampler",e),E(e)},onVolumeChange:function(e,t){m.gain.value=t},onPlay:function(){N()},onPause:function(){M()},onSliderChange:function(e,t){c.seek(t,c.isPlaying())}}});m.gain.value=I.model.volume;!function(e,t){const{width:n,height:o}=e,i=e.getContext("2d");"function"==typeof t&&(e.onclick=function(e){console.log("onclick",e.offsetX);const o=e.offsetX/n*l.duration;t(o)});const a=document.createElement("canvas");a.width=n,a.height=o;const s=a.getContext("2d");let l=null;function c(e){if(l){i.clearRect(0,0,n,o),i.drawImage(a,0,5);const t=n*e/l.duration;i.fillStyle="rgba(255, 255, 255, 0.33)",i.fillRect(0,0,t,o)}}}(I.scope.bufferCanvas.get(0),e=>{console.log({time:e})});function E(e){const{samplers:t}=I.model;if(e<t.length){const n=p.createBufferSource();n.buffer=t[e].audioBuffer,n.connect(m),n.start()}}function N(){I.model.loaded&&c.play()}function M(){c.pause()}async function x(e=0,t=!1){c.seek(e,t)}this.playSample=function(t){E(e.find(".samplerPlayer").eq(t-1).find(".brainjs-combobox").getValue())},this.toggleAnayser=function(){I.model.showAnalyser=!I.model.showAnalyser,I.update(),I.model.showAnalyser?P():cancelAnimationFrame(B)},this.seek=function(e){c&&A&&c.seekOffset(e)},this.jogTouch=function(e){!e&&c&&c.seekEnd(),A=e},this.reset=x,this.setInfo=async function(e){const{artist:t,title:n,url:a}=e,l=`${t} - ${n}`;console.log("name",l),I.setData({name:"Loading..."});const r=await $$.media.getAudioBuffer(a,e=>{const t=Math.trunc(100*e.percentComplete);I.setData({name:`Loading (${t} %)`})});(c=$$.media.createAudioPlayer(p,r,m)).setPlaybackRate(I.model.rate),c.on("playing",function(){o.setButtonIntensity("PLAY",127,s),I.setData({playing:!0})}),c.on("pause",function(){o.setButtonIntensity("PLAY",1,s),I.setData({playing:!1})}),c.on("ended",function(){console.log("ended",{deck:s}),o.setButtonIntensity("PLAY",1,s),I.setData({playing:!1})}),I.setData({name:"Analysing..."});const d=await i.computeBeatDetection(r);console.log("tempo",d),T={};const u=r.duration;return I.setData({name:l,duration:u,loaded:!0,bpm:parseFloat(d.tempo.toFixed(1))}),{audioBuffer:r,tempo:d}},this.getCurrentTime=function(){return c.getCurrentTime()},this.getRealTime=function(){let e=c.getCurrentTime();return 0!=w&&e>=O&&(e=S,c.seek(e,!0)),I.setData({curTime:e}),e/c.getPlaybackRate()},this.setStartLoopTime=function(e){S=e},this.setEndLoopTime=function(e){O=e,w=5,x(S,!0),o.setButtonIntensity("LOOP_MANUAL",127,s,3)},this.clearLoop=function(){w=0,o.setButtonIntensity("LOOP_MANUAL",1,s,3)},this.getStartLoopTime=function(){return S},this.getOutputNode=function(){return g},this.isPlaying=function(){return I.model.playing},this.setVolume=function(e){m.gain.value=e,I.setData({volume:e})},this.isLoaded=function(){return I.model.loaded},this.togglePlay=function(){I.model.playing?M():N()},this.getHotcue=function(e){return T[e]},this.addHotcue=function(e,t,n){console.log("addHotcue",e),T[e]={time:t,div:n},1!=e&&o.setButtonIntensity("HOT_CUE",127,s,e)},this.jumpToHotcue=function(e,t=!0){console.log("jumpToHotcue",e);const{time:n}=T[e];x(n,t)},this.toggleHotcueDeleteMode=function(){L=!L,console.log("isHotcueDeleteMode",L),o.setButtonIntensity("HOT_CUE",L?127:1,s,1)},this.isHotcueDeleteMode=function(){return L},this.deleteHotcue=function(e){console.log("deleteHotcue",e),delete T[e],o.setButtonIntensity("HOT_CUE",1,s,e)},this.getBpm=function(){return I.model.bpm},this.autoLoopActivate=function(e,t,n){return e==w?(o.setButtonIntensity("LOOP_AUTO",1,s,e),w=0,0):(0!=w?(o.setButtonIntensity("LOOP_AUTO",1,s,w),O=S+n):(S=t,O=t+n),o.setButtonIntensity("LOOP_AUTO",127,s,e),w=e,S)},this.getPlaybackRate=function(){return I.model.rate},this.setPlaybackRate=function(e){c&&c.setPlaybackRate(e),I.setData({rate:e})}}})}(),$$.control.registerControl("tree",{template:'<div \n    bn-control="brainjs.tree" \n    bn-data="{source: treeInfo, options: treeOptions}"\n    bn-event="treeclick: onTreeItemSelected"\n></div>        \n',deps:["breizbot.files","breizbot.friends","breizbot.playlists"],props:{},init:function(e,t,n,o){function i(e,t){let n=e;return e.endsWith("/")||(n+="/"),n+=t}const a={lazyLoad:function(e,n){const o=n.node;n.result=new Promise(async e=>{const{path:n,friendUser:a}=o.data;e((await t.list(n,{filterExtension:"mp3",folderOnly:!0},a)).map(e=>({title:e.name,data:{path:i(n,e.name),friendUser:a},lazy:!0,folder:!0})))})}},s=$$.viewController(e,{data:{treeInfo:[{title:"Home Files",icon:"fa fa-home w3-text-blue",lazy:!0,data:{path:"/"}},{title:"Files Shared",folder:!0,children:[],icon:"fa fa-share-alt w3-text-blue"},{title:"Playlists",folder:!0,children:[],icon:"fas fa-compact-disc w3-text-blue"}],treeOptions:a},events:{onTreeItemSelected:async function(n,a){const{path:s,friendUser:l,playlistName:c}=a.data;if(0!=Object.keys(a.data).length)if(c){e.trigger("loading");const n=await o.getPlaylistSongs(c);console.log("files",n);const a=n.filter(e=>e.mp3&&e.mp3.artist).map(e=>{const{artist:n,bpm:o,title:a,length:s,genre:l}=e.mp3,{fileName:c,friendUser:r,rootDir:d}=e.fileInfo;return{url:t.fileUrl(i(d,c),r),artist:n,bpm:o,title:a,length:s,genre:l}});e.trigger("filechange",{files:a})}else{e.trigger("loading");const n=(await t.list(s,{filterExtension:"mp3",filesOnly:!0,getMP3Info:!0},l)).filter(e=>e.mp3&&e.mp3.artist).map(e=>{const{artist:n,bpm:o,title:a,length:c,genre:r}=e.mp3;return{url:t.fileUrl(i(s,e.name),l),artist:n,bpm:o,title:a,length:c,genre:r}});e.trigger("filechange",{files:n})}else e.trigger("filechange",{files:[]})}}});!async function(){const e=await n.getFriends();for(const{friendUserName:t}of e)s.model.treeInfo[1].children.push({title:t,icon:"fa fa-user w3-text-blue",data:{friendUser:t,path:"/"},lazy:!0});const t=await o.getPlaylist();for(const e of t)s.model.treeInfo[2].children.push({title:e,icon:"fa fa-music w3-text-blue",data:{playlistName:e}});s.update()}()}}),$$.control.registerControl("settings",{template:'<div>\n    <form bn-event="submit: onSubmit" bn-form="data">\n        <label>Samplers Folder</label>\n        <div>\n            <input type="text" required name="samplersFolder">\n            <button type="button" class="w3-button w3-blue" bn-icon="fa fa-folder-open" bn-event="click: onChooseFolder"></button>    \n        </div>\n        \n        <input type="submit" hidden bn-bind="submit">\n    </form>\n</div>\n',deps:["breizbot.pager"],props:{data:{}},init:function(e,t){const{data:n}=this.props,o=$$.viewController(e,{data:{data:n},events:{onChooseFolder:function(){t.pushPage("breizbot.files",{title:"Choose Folder",props:{filterExtension:"mp3"},onReturn:function(e){console.log("onReturn",e),o.model.data.samplersFolder=e,o.update()},buttons:{apply:{icon:"fas fa-check",title:"Apply",onClick:function(){console.log("onClick",this),t.popPage(this.getRootDir())}}}})},onSubmit:function(e){e.preventDefault(),t.popPage($(this).getFormData())}}});this.getButtons=function(){return{apply:{title:"Apply",icon:"fas fa-check",onClick:function(){o.scope.submit.click()}}}}}}),$$.service.registerService("AudioTools",{init:function(){const e=new AudioContext;return{createStereoMerger:function(t,n){const o=e.createChannelSplitter(2);t.connect(o);const i=e.createChannelSplitter(2);n.connect(i);const a=e.createChannelMerger(4);return o.connect(a,0,0),o.connect(a,1,1),i.connect(a,0,2),i.connect(a,1,3),a},createDestination:function(t,n){const o=e.createMediaStreamDestination();o.channelCount=t;const i=new Audio;i.srcObject=o.stream,n.connect(o),i.play()},createCrossFaderWithMasterLevel:function(t,n){const o=e.createGain();o.gain.value=.5,t.connect(o);const i=e.createGain();i.gain.value=.5,n.connect(i);const a=e.createGain();return a.gain.value=.5,o.connect(a),i.connect(a),{setFaderLevel:function(e){i.gain.value=Math.cos(.5*(1-e)*Math.PI),o.gain.value=Math.cos(.5*e*Math.PI)},setMasterLevel:function(e){a.gain.value=e},getOutputNode:function(){return a}}},getAudioContext:function(){return e},getCurrentTime:function(){return e.currentTime}}}}),$$.service.registerService("MIDICtrl",{init:function(e){const t={MAX:127,MIN:1,OFF:0,ON:1},n=[{action:"MASTER_LEVEL",cmd:191,note:10},{action:"CUE_LEVEL",cmd:191,note:12},{action:"CROSS_FADER",cmd:191,note:8},{action:"LEVEL",cmd:176,note:22,deck:1},{action:"PITCH",cmd:176,note:9,deck:1},{action:"LEVEL",cmd:177,note:22,deck:2},{action:"PITCH",cmd:177,note:9,deck:2},{action:"SYNC",cmd:144,note:2,deck:1,type:"BTN"},{action:"CUE",cmd:144,note:1,deck:1,type:"BTN"},{action:"PLAY",cmd:144,note:0,deck:1,type:"BTN"},{action:"PFL",cmd:144,note:27,deck:1,type:"BTN2"},{action:"JOGTOUCH_RELEASE",cmd:128,note:6,deck:1},{action:"JOGTOUCH_PRESS",cmd:144,note:6,deck:1},{action:"SYNC",cmd:145,note:2,deck:2,type:"BTN"},{action:"CUE",cmd:145,note:1,deck:2,type:"BTN"},{action:"PLAY",cmd:145,note:0,deck:2,type:"BTN"},{action:"PFL",cmd:145,note:27,deck:2,type:"BTN2"},{action:"JOGTOUCH_RELEASE",cmd:129,note:6,deck:2},{action:"JOGTOUCH_PRESS",cmd:145,note:6,deck:2},{action:"LOAD",cmd:159,note:2,deck:1},{action:"LOAD",cmd:159,note:3,deck:2},{action:"ENTER",cmd:159,note:6},{action:"JOG_WHEEL",cmd:176,note:6,deck:1},{action:"JOG_WHEEL",cmd:177,note:6,deck:2},{action:"BROWSE_WHEEL",cmd:191,note:0},{action:"HOT_CUE",cmd:148,note:1,deck:1,key:1,type:"BTN"},{action:"HOT_CUE",cmd:148,note:2,deck:1,key:2,type:"BTN"},{action:"HOT_CUE",cmd:148,note:3,deck:1,key:3,type:"BTN"},{action:"HOT_CUE",cmd:148,note:4,deck:1,key:4,type:"BTN"},{action:"HOT_CUE",cmd:149,note:1,deck:2,key:1,type:"BTN"},{action:"HOT_CUE",cmd:149,note:2,deck:2,key:2,type:"BTN"},{action:"HOT_CUE",cmd:149,note:3,deck:2,key:3,type:"BTN"},{action:"HOT_CUE",cmd:149,note:4,deck:2,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:17,deck:1,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:18,deck:1,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:19,deck:1,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:20,deck:1,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:17,deck:2,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:18,deck:2,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:19,deck:2,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:20,deck:2,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:33,deck:1,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:34,deck:1,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:35,deck:1,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:36,deck:1,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:33,deck:2,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:34,deck:2,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:35,deck:2,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:36,deck:2,key:4,type:"BTN"},{action:"SAMPLER",cmd:148,note:49,deck:1,key:1,type:"BTN"},{action:"SAMPLER",cmd:148,note:50,deck:1,key:2,type:"BTN"},{action:"SAMPLER",cmd:148,note:51,deck:1,key:3,type:"BTN"},{action:"SAMPLER",cmd:148,note:52,deck:1,key:4,type:"BTN"},{action:"SAMPLER",cmd:149,note:49,deck:2,key:1,type:"BTN"},{action:"SAMPLER",cmd:149,note:50,deck:2,key:2,type:"BTN"},{action:"SAMPLER",cmd:149,note:51,deck:2,key:3,type:"BTN"},{action:"SAMPLER",cmd:149,note:52,deck:2,key:4,type:"BTN"}];const o=new EventEmitter2;let i=null,a=null,s=null;function l(e){const[t,i,a]=e.data,s=function(e,t){for(const o of n)if(o.cmd==e&&o.note==t)return o;return null}(t,i);if(null!=s){const{action:e,deck:t,key:n,event:i}=s;"UP"!=i&&o.emit(e,{deck:t,key:n,velocity:a})}}return{selectMIDIInput:function(e){a&&(a.onmidimessage=null);for(const t of i.inputs.values())if(t.id==e)return void((a=t).onmidimessage=l)},selectMIDIOutput:function(e){for(const t of i.outputs.values())if(t.id==e){s=t;break}},selectMIDIDevice:function(e){a&&(a.onmidimessage=null);for(const t of i.inputs.values())if(t.id==e){(a=t).onmidimessage=l;for(const e of i.outputs.values())if(e.name==t.name){s=e;break}break}},clearAllButtons:function(){if(null!=s)for(const{cmd:e,note:o,type:i}of n)"BTN"!=i&&"BTN2"!=i||s.send([e,o,"BTN"==i?t.MIN:t.OFF])},setButtonIntensity:function(e,t,o,i){if(null!=s)for(const a of n){let n=a.action==e;null!=o&&(n&=a.deck==o),null!=i&&(n&=a.key==i),n&&s.send([a.cmd,a.note,t])}},requestMIDIAccess:async function(){(i=await navigator.requestMIDIAccess()).onstatechange=function(e){"input"==e.port.type&&o.emit("MIDI_STATECHANGE",e.port)};const e=[];for(const{name:t,id:n}of i.inputs.values())e.push({label:t,value:n});const t=[];for(const{name:e,id:n}of i.outputs.values())t.push({label:e,value:n});return{midiInputs:e,midiOutputs:t}},getMIDIInputs:function(){const e=[];for(const{name:t,id:n}of i.inputs.values())e.push({label:t,value:n});return e},on:o.on.bind(o),BtnIntensity:t}}});