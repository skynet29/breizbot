$$.control.registerControl("rootPage",{template:'<div class="midi">\n    <div class="midiIO">\n        <div>MIDI Inputs</div>\n        <div bn-control="brainjs.combobox" bn-data="{items: midiInputs}" bn-event="comboboxchange: onMidiInputChange"></div>\n    </div>\n    <div class="midiIO">\n        <div>MIDI Outputs</div>\n        <div bn-control="brainjs.combobox" bn-data="{items: midiOutputs}"  bn-event="comboboxchange: onMidiOutputChange"></div>\n    </div>\n</div>\n<div class="top">\n    <div>\n        <div class="loadLeft">\n            <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="audio1">LOAD 1\n                <i class="fa fa-spinner fa-pulse" bn-show="audio1"></i>\n            </button>\n        </div>\n        <div bn-control="audioplayer" bn-iface="audio1"></div>\n    </div>\n    <div>\n        <div>\n            <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="audio2">LOAD 2\n                <i class="fa fa-spinner fa-pulse" bn-show="audio2"></i>\n            </button>\n        </div>\n        <div bn-control="audioplayer" bn-iface="audio2"></div>\n    </div>\n</div>\n<div class="bottom">\n    <div class="balance">\n        <label>Left</label>\n        <div bn-control="brainjs.slider" bn-data="{min: 0, max: 1, step: 0.01}" bn-event="input: onSliderChange" bn-val="crossFader"></div>\n        <label>Right</label>\n    </div>\n    \n</div>\n<div bn-control="breizbot.filelist" bn-data="{selectionEnabled: true, filterExtension: \'mp3\', getMP3Info: true}" bn-iface="filelist"></div>\n',deps:["breizbot.pager","MIDICtrl","AudioTools"],props:{},init:async function(t,e,n,o){const i=$$.util.mapRange(0,127,0,1),c=$$.viewController(t,{data:{audio1:!1,audio2:!1,curPFL:1,midiInputs:[],midiOutputs:[],crossFader:.5},events:{onSliderChange:function(){const t=$(this).getValue();m.setFaderLevel(t)},onLoad:async function(){const t=$(this).data("audio"),e=d.getSelFile();e&&(c.model[t]=!0,c.update(),await c.scope[t].setInfo(e),c.model[t]=!1,c.update())},onMidiInputChange:function(t){const e=$(this).getValue();n.selectMIDIInput(e)},onMidiOutputChange:function(t){const e=$(this).getValue();n.selectMIDIOutput(e),n.clearAllButtons(),n.setButtonIntensity("PFL",1,1)}}});function a(t){return c.scope["audio"+t]}n.on("PLAY",({deck:t})=>{const e=a(t);n.setButtonIntensity("PLAY",e.isPlaying()?1:127,t),e.togglePlay()}),n.on("LOAD",async({deck:t})=>{const e=d.getSelFile(),n="audio"+t;e&&(c.model[n]=!0,c.update(),await a(t).setInfo(e),c.model[n]=!1,c.update())}),n.on("CROSS_FADER",async({velocity:t})=>{const e=i(t);c.setData({crossFader:e}),m.setFaderLevel(e)}),n.on("LEVEL",async({deck:t,velocity:e})=>{const n=i(e);a(t).setVolume(n)}),n.on("BROWSE_WHEEL",async({velocity:t})=>{1==t?d.selDown():d.selUp()}),n.on("ENTER",async()=>{d.enterSelFolder()}),n.on("PFL",({deck:t})=>{1==t?(p.setFaderLevel(0),n.setButtonIntensity("PFL",1,1),n.setButtonIntensity("PFL",0,2)):(p.setFaderLevel(1),n.setButtonIntensity("PFL",0,1),n.setButtonIntensity("PFL",1,2))}),n.on("MASTER_LEVEL",({velocity:t})=>{m.setMasterLevel(i(t))}),n.on("CUE_LEVEL",({velocity:t})=>{p.setMasterLevel(i(t))});const d=c.scope.filelist,s=c.scope.audio1,l=c.scope.audio2,u=o.createMediaSource(s.getAudioElement()),r=o.createMediaSource(l.getAudioElement()),m=o.createCrossFaderWithMasterLevel(u,r),p=o.createCrossFaderWithMasterLevel(u,r);p.setFaderLevel(0);const v=o.createStereoMerger(m.getOutputNode(),p.getOutputNode());o.createDestination(4,v),async function(){console.log("init");const t=await n.requestMIDIAccess();c.setData(t)}()}}),function(){function t(t){const e=new Date(1e3*t);return e.getMinutes().toString()+":"+e.getSeconds().toString().padStart(2,"0")}$$.control.registerControl("audioplayer",{template:'<div class="info">\n\t<div class="title" bn-show="!title">\n\t\t<strong>FileName:</strong>\n\t\t<span bn-text="name"></span>\n\t</div>\n\t<div class="title" bn-show="title">\n\t\t<strong>Title:</strong>\n\t\t<span bn-text="title"></span>\n\t</div>\n\t<div class="title" bn-show="artist">\n\t\t<strong>Artist:</strong>\n\t\t<span bn-text="artist"></span>\n\t</div>\n</div>\n<div class="toolbar">\n\t<div></div>\n\n\t<button bn-show="!playing" bn-event="click: onPlay" class="w3-btn w3-blue" title="Play" bn-icon="fa fa-lg fa-play">\n\t</button>\n\n\t<button bn-show="playing" bn-event="click: onPause" class="w3-btn w3-blue" title="Pause"\n\t\tbn-icon="fa fa-lg fa-pause">\n\t</button>\n\n\t<div class="toolbar2">\n\t\t<i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n\t\t<div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n\t\t\tbn-event="input: onVolumeChange" bn-val="volume" class="volulmeSlider"></div>\n\t</div>\n\n</div>\n\n<div class="bufferContainer">\n\t<canvas bn-bind="bufferCanvas" class="bufferCanvas" width="470" height="100">\n</div>\n\n<div class="slider">\n\t<span bn-text="getTimeInfo"></span>\n\t<div bn-control="brainjs.slider" bn-data="{max: duration}" bn-event="input: onSliderChange" bn-val="curTime">\n\t</div>\n\n</div>\n\n<audio bn-attr="{src: url}" bn-bind="audio"\n\tbn-event="canplay: onLoad, timeupdate: onTimeUpdate, playing: onPlaying, pause: onPaused, ended: onEnded">\n</audio>',deps:["breizbot.pager"],props:{},init:function(e,n){const o=$$.viewController(e,{data:{url:"#",name:"",title:"",artist:"",volume:.5,duration:0,curTime:0,playing:!1,getTimeInfo:function(){return`${t(this.curTime)} / ${t(this.duration)}`}},events:{onVolumeChange:function(t,e){i.volume=e},onLoad:function(){i.volume=.5,o.setData({duration:Math.floor(i.duration),volume:i.volume})},onTimeUpdate:function(){o.setData({curTime:this.currentTime}),c.update(this.currentTime)},onPlaying:function(){o.setData({playing:!0})},onPaused:function(){o.setData({playing:!1})},onPlay:function(){i.play()},onPause:function(){i.pause()},onSliderChange:function(t,e){i.currentTime=e}}}),i=o.scope.audio.get(0),c=function(t,e){const{width:n,height:o}=t;console.log({width:n,height:o});const i=t.getContext("2d");"function"==typeof e&&(t.onclick=function(t){console.log("onclick",t.offsetX);const o=t.offsetX/n*d.duration;e(o)});const c=document.createElement("canvas");c.width=n,c.height=o;const a=c.getContext("2d");let d=null;function s(t){if(d){i.clearRect(0,0,n,o),i.drawImage(c,0,5);const e=n*t/d.duration;i.fillStyle="rgba(255, 255, 255, 0.33)",i.fillRect(0,0,e,o)}}return{load:async function(t){d=await $$.media.getAudioBuffer(t),console.log("duration",d.duration),$$.media.drawAudioBuffer(n,o-10,a,d,"black"),s(0)},update:s}}(o.scope.bufferCanvas.get(0),t=>{console.log({time:t}),i.currentTime=t});this.setInfo=async function(t){const{mp3:e,name:n,url:i}=t,{artist:a,title:d}=e;o.setData({name:n,url:i,artist:a,title:d}),await c.load(i)},this.getAudioElement=function(){return i},this.isPlaying=function(){return o.model.playing},this.setVolume=function(t){i.volume=t,o.setData({volume:t})},this.togglePlay=function(){o.model.playing?i.pause():i.play()}}})}(),$$.service.registerService("AudioTools",{init:function(){const t=new AudioContext;return{createStereoMerger:function(e,n){const o=t.createChannelSplitter(2);e.connect(o);const i=t.createChannelSplitter(2);n.connect(i);const c=t.createChannelMerger(4);return o.connect(c,0,0),o.connect(c,1,1),i.connect(c,0,2),i.connect(c,1,3),c},createDestination:function(e,n){const o=t.createMediaStreamDestination();o.channelCount=e;const i=new Audio;i.srcObject=o.stream,n.connect(o),i.play()},createMediaSource:function(e){return t.createMediaElementSource(e)},createCrossFaderWithMasterLevel:function(e,n){const o=t.createGain();o.gain.value=.5,e.connect(o);const i=t.createGain();i.gain.value=.5,n.connect(i);const c=t.createGain();return c.gain.value=.5,o.connect(c),i.connect(c),{setFaderLevel:function(t){i.gain.value=Math.cos(.5*(1-t)*Math.PI),o.gain.value=Math.cos(.5*t*Math.PI)},setMasterLevel:function(t){c.gain.value=t},getOutputNode:function(){return c}}}}}}),$$.service.registerService("MIDICtrl",{init:function(t){const e={MAX:127,MIN:1,OFF:0,ON:1},n=[{action:"MASTER_LEVEL",cmd:191,note:10},{action:"CUE_LEVEL",cmd:191,note:12},{action:"CROSS_FADER",cmd:191,note:8},{action:"LEVEL",cmd:176,note:22,deck:1},{action:"PITCH",cmd:176,note:25,deck:1},{action:"LEVEL",cmd:177,note:22,deck:2},{action:"PITCH",cmd:177,note:25,deck:2},{action:"SYNC",cmd:144,note:2,deck:1,type:"BTN"},{action:"CUE",cmd:144,note:1,deck:1,type:"BTN"},{action:"PLAY",cmd:144,note:0,deck:1,type:"BTN"},{action:"PFL",cmd:144,note:27,deck:1,type:"BTN2"},{action:"JOGTOUCH",cmd:144,note:6,deck:1},{action:"SYNC",cmd:145,note:2,deck:2,type:"BTN"},{action:"CUE",cmd:145,note:1,deck:2,type:"BTN"},{action:"PLAY",cmd:145,note:0,deck:2,type:"BTN"},{action:"PFL",cmd:145,note:27,deck:2,type:"BTN2"},{action:"JOGTOUCH",cmd:145,note:6,deck:2},{action:"LOAD",cmd:159,note:2,deck:1},{action:"LOAD",cmd:159,note:3,deck:2},{action:"ENTER",cmd:159,note:6},{action:"JOG_WHEEL",cmd:176,note:6,deck:1},{action:"JOG_WHEEL",cmd:177,note:6,deck:2},{action:"BROWSE_WHEEL",cmd:191,note:0},{action:"HOT_CUE",cmd:148,note:1,deck:1,key:1,type:"BTN"},{action:"HOT_CUE",cmd:148,note:2,deck:1,key:2,type:"BTN"},{action:"HOT_CUE",cmd:148,note:3,deck:1,key:3,type:"BTN"},{action:"HOT_CUE",cmd:148,note:4,deck:1,key:4,type:"BTN"},{action:"HOT_CUE",cmd:149,note:1,deck:2,key:1,type:"BTN"},{action:"HOT_CUE",cmd:149,note:2,deck:2,key:2,type:"BTN"},{action:"HOT_CUE",cmd:149,note:3,deck:2,key:3,type:"BTN"},{action:"HOT_CUE",cmd:149,note:4,deck:2,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:17,deck:1,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:18,deck:1,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:19,deck:1,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:20,deck:1,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:17,deck:2,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:18,deck:2,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:19,deck:2,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:20,deck:2,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:33,deck:1,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:34,deck:1,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:35,deck:1,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:36,deck:1,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:33,deck:2,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:34,deck:2,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:35,deck:2,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:36,deck:2,key:4,type:"BTN"},{action:"SAMPLER",cmd:148,note:49,deck:1,key:1,type:"BTN"},{action:"SAMPLER",cmd:148,note:50,deck:1,key:2,type:"BTN"},{action:"SAMPLER",cmd:148,note:51,deck:1,key:3,type:"BTN"},{action:"SAMPLER",cmd:148,note:52,deck:1,key:4,type:"BTN"},{action:"SAMPLER",cmd:149,note:49,deck:2,key:1,type:"BTN"},{action:"SAMPLER",cmd:149,note:50,deck:2,key:2,type:"BTN"},{action:"SAMPLER",cmd:149,note:51,deck:2,key:3,type:"BTN"},{action:"SAMPLER",cmd:149,note:52,deck:2,key:4,type:"BTN"}];const o=new EventEmitter2;let i=null,c=null,a=null;function d(t){const[e,i,c]=t.data,a=function(t){const[e,o]=t;for(const t of n)if(t.cmd==e&&t.note==o)return t;return null}(t.data);if(null!=a){const{action:t,deck:e,key:n}=a;o.emit(t,{deck:e,key:n,velocity:c})}}return{selectMIDIInput:function(t){c&&(c.onmidimessage=null);for(const e of i.inputs.values())if(e.id==t)return void((c=e).onmidimessage=d)},selectMIDIOutput:function(t){for(const e of i.outputs.values())if(e.id==t){a=e;break}},clearAllButtons:function(){for(const{cmd:t,note:o,type:i}of n)"BTN"!=i&&"BTN2"!=i||a.send([t,o,"BTN"==i?e.MIN:e.OFF])},setButtonIntensity:function(t,e,o,i){for(const c of n){let n=c.action==t;null!=o&&(n&=c.deck==o),null!=i&&(n&=c.key==i),n&&a.send([c.cmd,c.note,e])}},requestMIDIAccess:async function(){i=await navigator.requestMIDIAccess();const t=[];for(const{name:e,id:n}of i.inputs.values())t.push({label:e,value:n});const e=[];for(const{name:t,id:n}of i.outputs.values())e.push({label:t,value:n});return{midiInputs:t,midiOutputs:e}},on:o.on.bind(o),BtnIntensity:e}}});