$$.control.registerControl("rootPage",{template:'<div class="top">\n    <div class="midi">\n        <div>MIDI Device</div>\n        <div bn-control="brainjs.combobox" bn-data="{items: midiInputs}" bn-val="selectedInput" bn-event="comboboxchange: onMidiInputChange">\n        </div>\n\n    </div>\n    <div class="balance">\n        <label>Left</label>\n        <div bn-control="brainjs.slider" bn-data="{min: 0, max: 1, step: 0.01}" bn-event="input: onCrossFaderChange"\n            bn-val="crossFader"></div>\n        <label>Right</label>\n    </div>\n    <div>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="1">LOAD 1\n            <i class="fa fa-spinner fa-pulse" bn-show="audio1"></i>\n        </button>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="2">LOAD 2\n            <i class="fa fa-spinner fa-pulse" bn-show="audio2"></i>\n        </button>\n\n    </div>\n\n</div>\n<div class="visualizer">\n    <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n        <div class="runningBuffer" bn-bind="runningBuffer1"></div>\n        <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n        <div class="hotcueContainer" bn-style="hotcueContainerStyle" bn-bind="hotcueContainer1"></div>\n    </div>\n</div>\n<div class="visualizer">\n    <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n        <div class="runningBuffer" bn-bind="runningBuffer2"></div>\n        <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n        <div class="hotcueContainer" bn-bind="hotcueContainer2"></div>\n    </div>\n</div>\n\n<div class="center">\n    <div bn-control="audioplayer" bn-iface="audio1" data-deck="1"></div>\n    <div class="masterPanel">\n        <span>Master</span>\n        <div class="toolbar2">\n            <i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n            <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                bn-event="input: onMasterVolumeChange" bn-val="masterVolume" class="volulmeSlider"></div>\n        </div>        \n    </div>\n    <div class="masterPanel">\n        <span>PFL</span>\n        <div class="toolbar2">\n            <i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n            <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                bn-event="input: onCueVolumeChange" bn-val="cueVolume" class="volulmeSlider"></div>\n        </div>        \n    </div>\n    <div bn-control="audioplayer" bn-iface="audio2" data-deck="2"></div>\n</div>\n\n\n<div bn-control="breizbot.filelist" bn-data="{selectionEnabled: true, filterExtension: \'mp3\', getMP3Info: true}"\n    bn-iface="filelist"></div>',deps:["breizbot.pager","MIDICtrl","AudioTools"],props:{},init:async function(e,t,n,o){const i=$$.util.mapRange(0,127,0,1),c=1200,a=80,s=10,l=32e3,d=$$.viewController(e,{data:{selectedInput:"default",audio1:!1,audio2:!1,curPFL:1,midiInputs:[],midiOutputs:[],crossFader:.5,masterVolume:.5,cueVolume:.5,runningBufferContainerStyle:{width:c+"px",height:a+"px"},zeroTimeStyle:{left:c/2,height:a},hotcueContainerStyle:{}},events:{onMasterVolumeChange:function(e,t){A.setMasterLevel(t)},onCueVolumeChange:function(e,t){A.setMasterLevel(t)},onCrossFaderChange:function(e,t){A.setFaderLevel(t)},onLoad:function(){r($(this).data("audio"))},onMidiInputChange:function(e){$(this).getValue()}}});const u=["red","green"];async function r(e){console.log("loadTrack",e);const t="audio"+e;if(1==d.model[t])return void console.log("A track is already loading");const n=b.getSelFile();if(n){k[e-1].innerHTML="";const o=L[e-1];o.innerHTML="",d.model[t]=!0,d.update();const{audioBuffer:i,tempo:r}=await d.scope[t].setInfo(n),f=c/2*i.duration;o.style.width=f+"px",o.style.height=a+"px",function(e,t,n){console.log("bufferLength",e.length);const o=Math.trunc(p(60/n.bpm));console.log("beatInterval",o);const i=Math.trunc(p(n.offset));console.log("beatOffset",i);const d=k[t-1],r=u[t-1],m=Math.ceil(c*e.duration/s);console.log("width",m);const f=e.getChannelData(0),v=Math.ceil(s*e.sampleRate/c);console.log("step",v);const y=a/2;let g=O(d);for(let e=0,t=0;e<m;e++,t++){t==l&&(g=O(d),t=0);let n=1,c=-1;for(let t=0;t<v;t++){const o=f[e*v+t];o<n&&(n=o),o>c&&(c=o)}g.fillStyle=r,g.fillRect(t,(1+n)*y,1,Math.max(1,(c-n)*y)),Math.abs(e-i)%o==0&&(g.fillStyle="black",g.fillRect(t,0,1,a))}}(i,e,r),d.model[t]=!1,m(0,e),d.update()}}function m(e,t){const n=k[t-1],o=L[t-1],i=c/s*(s/2-e);n.style.left=i+"px",o.style.left=i+"px"}const f=["red","green","blue","orange"];function p(e){return c/s*e}function v(e){const t=L[e-1];$(t).find(".loop").remove()}function y(e,t,n){console.log("createLoop",{deck:e,startTime:t,duration:n});const o=L[e-1];$(o).find(".loop").remove();const i=document.createElement("div");i.classList.add("loop");const c=p(t);i.style.left=c+"px",i.style.width=0==n?"1px":p(n)+"px",i.style.height=a+"px",o.appendChild(i)}function g(e){return d.scope["audio"+e]}n.on("MIDI_STATECHANGE",e=>{console.log("midiStateChange",e),d.setData({midiInputs:n.getMIDIInputs()})}),n.on("PLAY",({deck:e})=>{g(e).togglePlay()}),n.on("LOAD",async({deck:e})=>{r(e)}),n.on("CROSS_FADER",async({velocity:e})=>{const t=i(e);d.setData({crossFader:t}),A.setFaderLevel(t)}),n.on("LEVEL",async({deck:e,velocity:t})=>{const n=i(t);g(e).setVolume(n)}),n.on("BROWSE_WHEEL",async({velocity:e})=>{1==e?b.selDown():b.selUp()}),n.on("ENTER",async()=>{b.enterSelFolder()}),n.on("JOG_WHEEL",({deck:e,velocity:t})=>{g(e).seek(1==t?1:-1)}),n.on("CUE",({deck:e})=>{g(e).reset()}),n.on("LOOP_AUTO",({deck:e,key:t})=>{const n=g(e);let o=n.getCurrentTime();const i=60/n.getBpm()*(1<<t-1);0==(o=n.autoLoopActivate(t,o,i))?v(e):y(e,o,i)}),n.on("LOOP_MANUAL",({deck:e,key:t})=>{const n=g(e);if(1==t){const t=n.getCurrentTime();n.setStartLoopTime(t),y(e,t,0)}else if(2==t){const t=n.getStartLoopTime(),o=n.getCurrentTime();n.setEndLoopTime(o),y(e,t,o-t)}else 3==t&&(n.clearLoop(),v(e))}),n.on("HOT_CUE",({deck:e,key:t})=>{const n=g(e);if(1==t)n.toggleHotcueDeleteMode();else{const o=n.getHotcue(t);if(n.isHotcueDeleteMode())o&&(n.deleteHotcue(t),L[e-1].removeChild(o.div));else{const i=n.getCurrentTime();if(null==o){const o=function(e,t,n){console.log("createHotCue",{deck:e,hotcue:t,time:n});const o=L[e-1],i=document.createElement("div");i.classList.add("hotcue");const c=p(n);return i.style.left=c+"px",i.style.backgroundColor=f[t-1],i.style.height=a+"px",o.appendChild(i),i}(e,t,i);n.addHotcue(t,i,o)}else n.jumpToHotcue(t)}}}),n.on("PFL",({deck:e})=>{1==e?(M.setFaderLevel(0),n.setButtonIntensity("PFL",1,1),n.setButtonIntensity("PFL",0,2)):(M.setFaderLevel(1),n.setButtonIntensity("PFL",0,1),n.setButtonIntensity("PFL",1,2))}),n.on("MASTER_LEVEL",({velocity:e})=>{const t=i(e);A.setMasterLevel(t),d.setData({masterVolume:t})}),n.on("CUE_LEVEL",({velocity:e})=>{const t=i(e);M.setMasterLevel(t),d.setData({cueVolume:t})});const b=d.scope.filelist,h=d.scope.audio1,T=d.scope.audio2,k=[d.scope.runningBuffer1.get(0),d.scope.runningBuffer2.get(0)],L=[d.scope.hotcueContainer1.get(0),d.scope.hotcueContainer2.get(0)];function O(e){console.log("createCanvas");const t=document.createElement("canvas");t.width=l,t.height=a,e.appendChild(t);const n=t.getContext("2d");return n.clearRect(0,0,l,a),n}!function e(){h.isLoaded()&&m(h.getCurrentTime(),1),T.isLoaded()&&m(T.getCurrentTime(),2),requestAnimationFrame(e)}();const C=h.getOutputNode(),B=T.getOutputNode(),A=o.createCrossFaderWithMasterLevel(C,B),M=o.createCrossFaderWithMasterLevel(C,B);M.setFaderLevel(1);const I=o.createStereoMerger(A.getOutputNode(),M.getOutputNode());o.createDestination(4,I),async function(){console.log("init");const e=await n.requestMIDIAccess();if(d.setData(e),e.midiInputs.length>1){const o=e.midiInputs[1].value;d.setData({selectedInput:o}),t=o,n.selectMIDIDevice(t),n.clearAllButtons(),n.setButtonIntensity("PFL",1,2)}var t}()}}),function(){$$.control.registerControl("audioplayer",{template:'<div class="info">\n\t<div class="toolbar">\n\t\t<strong bn-text="name"></strong>\n\t\t<div bn-show="loaded">BPM: <span bn-text="bpm"></span></div>\n\n\t\t<button bn-show="showPlay" bn-event="click: onPlay" class="w3-btn w3-blue" title="Play" bn-icon="fa fa-play">\n\t\t</button>\n\n\t\t<button bn-show="playing" bn-event="click: onPause" class="w3-btn w3-blue" title="Pause" bn-icon="fa fa-pause">\n\t\t</button>\n\n\n\n\t</div>\n\n\t<div class="toolbar2">\n\t\t<i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n\t\t<div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n\t\t\tbn-event="input: onVolumeChange" bn-val="volume" class="volulmeSlider"></div>\n\t</div>\n</div>\n\n<div class="bufferContainer" bn-show="showBuffer">\n\t<canvas bn-bind="bufferCanvas" class="bufferCanvas" width="470" height="100">\n</div>\n\n<div class="slider">\n\t<span bn-text="getTimeInfo"></span>\n\t<div bn-control="brainjs.slider" bn-data="{max: duration}" bn-event="input: onSliderChange" bn-val="curTime">\n\t</div>\n\n</div>\n\n',deps:["breizbot.pager","AudioTools","MIDICtrl","breizbot.beatdetector"],props:{showBuffer:!1,deck:1},init:function(e,t,n,o,i){console.log("props",this.props);const{showBuffer:c,deck:a}=this.props,s=$$.media.getFormatedTime;let l=null;const d={};let u=!1,r=0,m=0,f=0,p=0,v=0,y=null;const g=n.getAudioContext(),b=g.createGain();b.gain.value=.5;const h=$$.viewController(e,{data:{tempo:0,name:"No Track loaded",volume:.5,duration:0,curTime:0,playing:!1,loaded:!1,showBuffer:c,getTimeInfo:function(){return`${s(this.curTime,!0)} / ${s(this.duration)}`},showPlay:function(){return this.loaded&&!this.playing}},events:{onVolumeChange:function(e,t){b.gain.value=t},onPlay:function(){k()},onPause:function(){L()},onSliderChange:function(e,t){O(t,!0)}}});!function(e,t){const{width:n,height:o}=e;console.log({width:n,height:o});const i=e.getContext("2d");"function"==typeof t&&(e.onclick=function(e){console.log("onclick",e.offsetX);const o=e.offsetX/n*s.duration;t(o)});const c=document.createElement("canvas");c.width=n,c.height=o;const a=c.getContext("2d");let s=null;function l(e){if(s){i.clearRect(0,0,n,o),i.drawImage(c,0,5);const t=n*e/s.duration;i.fillStyle="rgba(255, 255, 255, 0.33)",i.fillRect(0,0,t,o)}}}(h.scope.bufferCanvas.get(0),e=>{console.log({time:e})});let T=null;function k(){o.setButtonIntensity("PLAY",127,a),b.gain.value=h.model.volume,(y=g.createBufferSource()).buffer=l,y.onended=function(){h.model.playing&&(h.setData({playing:!1}),v=l.duration,e.trigger("pause")),null!=T&&(T(),T=null)},y.connect(b),p=g.currentTime,y.start(0,v),h.setData({playing:!0}),e.trigger("playing")}function L(){return o.setButtonIntensity("PLAY",1,a),new Promise(t=>{h.setData({playing:!1}),v+=g.currentTime-p,y.stop(),y=null,e.trigger("pause"),T=t})}async function O(e=0,t=!1){const{playing:n}=h.model;n&&await L(),v=e,t&&n&&k()}this.seek=function(e){!h.model.playing&&h.model.loaded&&(v+=11*e/360,v=Math.max(0,v))},this.reset=O,this.setInfo=async function(e){let{mp3:t,name:n,url:o}=e,{artist:c,title:a}=t;null!=a&&(n=`${c} - ${a}`),console.log("name",n),h.setData({name:"Loading..."}),l=await $$.media.getAudioBuffer(o);const s=await i.computeBeatDetection(l);console.log("tempo",s);const d=l.duration;return h.setData({name:n,duration:d,loaded:!0,bpm:s.bpm}),{audioBuffer:l,tempo:s}},this.getCurrentTime=function(){let e=v;return h.model.playing&&(e+=g.currentTime-p),0!=r&&e>=f&&(O(m,!0),e=g.currentTime-m),h.setData({curTime:e}),e},this.setStartLoopTime=function(e){m=e},this.setEndLoopTime=function(e){f=e,r=5,O(m,!0),o.setButtonIntensity("LOOP_MANUAL",127,a,3)},this.clearLoop=function(){r=0,o.setButtonIntensity("LOOP_MANUAL",1,a,3)},this.getStartLoopTime=function(){return m},this.getOutputNode=function(){return b},this.isPlaying=function(){return h.model.playing},this.setVolume=function(e){b.gain.value=e,h.setData({volume:e})},this.isLoaded=function(){return h.model.loaded},this.togglePlay=function(){h.model.playing?L():k()},this.getAudioBuffer=function(){return l},this.getHotcue=function(e){return d[e]},this.addHotcue=function(e,t,n){console.log("addHotcue",e),d[e]={time:t,div:n},o.setButtonIntensity("HOT_CUE",127,a,e)},this.jumpToHotcue=function(e){console.log("jumpToHotcue",e);const{time:t}=d[e];O(t,!0)},this.toggleHotcueDeleteMode=function(){u=!u,console.log("isHotcueDeleteMode",u),o.setButtonIntensity("HOT_CUE",u?127:1,a,1)},this.isHotcueDeleteMode=function(){return u},this.deleteHotcue=function(e){console.log("deleteHotcue",e),delete d[e],o.setButtonIntensity("HOT_CUE",1,a,e)},this.getBpm=function(){return h.model.bpm},this.autoLoopActivate=function(e,t,n){return e==r?(o.setButtonIntensity("LOOP_AUTO",1,a,e),r=0,0):(0!=r?(o.setButtonIntensity("LOOP_AUTO",1,a,r),f=m+n):(m=t,f=t+n),o.setButtonIntensity("LOOP_AUTO",127,a,e),r=e,m)}}})}(),$$.service.registerService("AudioTools",{init:function(){const e=new AudioContext;return{createStereoMerger:function(t,n){const o=e.createChannelSplitter(2);t.connect(o);const i=e.createChannelSplitter(2);n.connect(i);const c=e.createChannelMerger(4);return o.connect(c,0,0),o.connect(c,1,1),i.connect(c,0,2),i.connect(c,1,3),c},createDestination:function(t,n){const o=e.createMediaStreamDestination();o.channelCount=t;const i=new Audio;i.srcObject=o.stream,n.connect(o),i.play()},createCrossFaderWithMasterLevel:function(t,n){const o=e.createGain();o.gain.value=.5,t.connect(o);const i=e.createGain();i.gain.value=.5,n.connect(i);const c=e.createGain();return c.gain.value=.5,o.connect(c),i.connect(c),{setFaderLevel:function(e){i.gain.value=Math.cos(.5*(1-e)*Math.PI),o.gain.value=Math.cos(.5*e*Math.PI)},setMasterLevel:function(e){c.gain.value=e},getOutputNode:function(){return c}}},getAudioContext:function(){return e},getCurrentTime:function(){return e.currentTime}}}}),$$.service.registerService("MIDICtrl",{init:function(e){const t={MAX:127,MIN:1,OFF:0,ON:1},n=[{action:"MASTER_LEVEL",cmd:191,note:10},{action:"CUE_LEVEL",cmd:191,note:12},{action:"CROSS_FADER",cmd:191,note:8},{action:"LEVEL",cmd:176,note:22,deck:1},{action:"PITCH",cmd:176,note:25,deck:1},{action:"LEVEL",cmd:177,note:22,deck:2},{action:"PITCH",cmd:177,note:25,deck:2},{action:"SYNC",cmd:144,note:2,deck:1,type:"BTN"},{action:"CUE",cmd:144,note:1,deck:1,type:"BTN"},{action:"PLAY",cmd:144,note:0,deck:1,type:"BTN"},{action:"PFL",cmd:144,note:27,deck:1,type:"BTN2"},{action:"JOGTOUCH",cmd:144,note:6,deck:1},{action:"SYNC",cmd:145,note:2,deck:2,type:"BTN"},{action:"CUE",cmd:145,note:1,deck:2,type:"BTN"},{action:"PLAY",cmd:145,note:0,deck:2,type:"BTN"},{action:"PFL",cmd:145,note:27,deck:2,type:"BTN2"},{action:"JOGTOUCH",cmd:145,note:6,deck:2},{action:"LOAD",cmd:159,note:2,deck:1},{action:"LOAD",cmd:159,note:3,deck:2},{action:"ENTER",cmd:159,note:6},{action:"JOG_WHEEL",cmd:176,note:6,deck:1},{action:"JOG_WHEEL",cmd:177,note:6,deck:2},{action:"BROWSE_WHEEL",cmd:191,note:0},{action:"HOT_CUE",cmd:148,note:1,deck:1,key:1,type:"BTN"},{action:"HOT_CUE",cmd:148,note:2,deck:1,key:2,type:"BTN"},{action:"HOT_CUE",cmd:148,note:3,deck:1,key:3,type:"BTN"},{action:"HOT_CUE",cmd:148,note:4,deck:1,key:4,type:"BTN"},{action:"HOT_CUE",cmd:149,note:1,deck:2,key:1,type:"BTN"},{action:"HOT_CUE",cmd:149,note:2,deck:2,key:2,type:"BTN"},{action:"HOT_CUE",cmd:149,note:3,deck:2,key:3,type:"BTN"},{action:"HOT_CUE",cmd:149,note:4,deck:2,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:17,deck:1,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:18,deck:1,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:19,deck:1,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:20,deck:1,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:17,deck:2,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:18,deck:2,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:19,deck:2,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:20,deck:2,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:33,deck:1,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:34,deck:1,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:35,deck:1,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:36,deck:1,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:33,deck:2,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:34,deck:2,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:35,deck:2,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:36,deck:2,key:4,type:"BTN"},{action:"SAMPLER",cmd:148,note:49,deck:1,key:1,type:"BTN"},{action:"SAMPLER",cmd:148,note:50,deck:1,key:2,type:"BTN"},{action:"SAMPLER",cmd:148,note:51,deck:1,key:3,type:"BTN"},{action:"SAMPLER",cmd:148,note:52,deck:1,key:4,type:"BTN"},{action:"SAMPLER",cmd:149,note:49,deck:2,key:1,type:"BTN"},{action:"SAMPLER",cmd:149,note:50,deck:2,key:2,type:"BTN"},{action:"SAMPLER",cmd:149,note:51,deck:2,key:3,type:"BTN"},{action:"SAMPLER",cmd:149,note:52,deck:2,key:4,type:"BTN"}];const o=new EventEmitter2;let i=null,c=null,a=null;function s(e){const[t,i,c]=e.data,a=function(e,t){for(const o of n){if(o.cmd==e&&o.note==t)return"BTN"==o.type&&(o.event="DOWN"),o;if(o.cmd-16==e&&o.note==t&&"BTN"==o.type)return o.event="UP",o}return null}(t,i);if(null!=a){const{action:e,deck:t,key:n,event:i}=a;"UP"!=i&&o.emit(e,{deck:t,key:n,velocity:c})}}return{selectMIDIInput:function(e){c&&(c.onmidimessage=null);for(const t of i.inputs.values())if(t.id==e)return void((c=t).onmidimessage=s)},selectMIDIOutput:function(e){for(const t of i.outputs.values())if(t.id==e){a=t;break}},selectMIDIDevice:function(e){c&&(c.onmidimessage=null);for(const t of i.inputs.values())if(t.id==e){(c=t).onmidimessage=s;for(const e of i.outputs.values())if(e.name==t.name){a=e;break}break}},clearAllButtons:function(){if(null!=a)for(const{cmd:e,note:o,type:i}of n)"BTN"!=i&&"BTN2"!=i||a.send([e,o,"BTN"==i?t.MIN:t.OFF])},setButtonIntensity:function(e,t,o,i){if(null!=a)for(const c of n){let n=c.action==e;null!=o&&(n&=c.deck==o),null!=i&&(n&=c.key==i),n&&a.send([c.cmd,c.note,t])}},requestMIDIAccess:async function(){(i=await navigator.requestMIDIAccess()).onstatechange=function(e){"input"==e.port.type&&o.emit("MIDI_STATECHANGE",e.port)};const e=[];for(const{name:t,id:n}of i.inputs.values())e.push({label:t,value:n});const t=[];for(const{name:e,id:n}of i.outputs.values())t.push({label:e,value:n});return{midiInputs:e,midiOutputs:t}},getMIDIInputs:function(){const e=[];for(const{name:t,id:n}of i.inputs.values())e.push({label:t,value:n});return e},on:o.on.bind(o),BtnIntensity:t}}});