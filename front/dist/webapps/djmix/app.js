$$.control.registerControl("rootPage",{template:'<div class="top">\n    <div class="midi">\n        <div>MIDI Device</div>\n        <div bn-control="brainjs.combobox" bn-data="{items: midiInputs}" bn-val="selectedInput" bn-event="comboboxchange: onMidiInputChange">\n        </div>\n\n    </div>\n    <div class="balance">\n        <label>Left</label>\n        <div bn-control="brainjs.slider" bn-data="{min: 0, max: 1, step: 0.01, showRange: false}" bn-event="input: onCrossFaderChange"\n            bn-val="crossFader"></div>\n        <label>Right</label>\n    </div>\n    <div>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="1">LOAD 1\n            <i class="fa fa-spinner fa-pulse" bn-show="audio1"></i>\n        </button>\n        <button class="w3-button w3-blue" bn-event="click: onLoad" data-audio="2">LOAD 2\n            <i class="fa fa-spinner fa-pulse" bn-show="audio2"></i>\n        </button>\n        <button class="w3-button w3-blue" bn-icon="fas fa-cog" title="Settings" bn-event="click: onSettings"></button>\n\n    </div>\n\n</div>\n<div class="visualizer">\n    <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n        <div class="runningBuffer" bn-bind="runningBuffer1"></div>\n        <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n        <div class="hotcueContainer" bn-style="hotcueContainerStyle" bn-bind="hotcueContainer1"></div>\n    </div>\n</div>\n<div class="visualizer">\n    <div class="runningBufferContainer" bn-style="runningBufferContainerStyle">\n        <div class="runningBuffer" bn-bind="runningBuffer2"></div>\n        <div class="zeroTime" bn-style="zeroTimeStyle"></div>\n        <div class="hotcueContainer" bn-bind="hotcueContainer2"></div>\n    </div>\n</div>\n\n<div class="center">\n    <div bn-control="audioplayer" bn-iface="audio1" data-deck="1"></div>\n    <div class="mixer">\n        <div class="masterPanel">\n            <span>Master</span>\n            <div class="toolbar2">\n                <i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n                <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                    bn-event="input: onMasterVolumeChange" bn-val="masterVolume" class="volulmeSlider"></div>\n            </div>        \n        </div>\n        <div class="masterPanel">\n            <span>PFL</span>\n            <div class="toolbar2">\n                <i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n                <div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n                    bn-event="input: onCueVolumeChange" bn-val="cueVolume" class="volulmeSlider"></div>\n            </div>        \n        </div>\n    </div>\n \n    <div bn-control="audioplayer" bn-iface="audio2" data-deck="2"></div>\n</div>\n\n\n<div bn-control="breizbot.filelist" bn-data="{selectionEnabled: true, filterExtension: \'mp3\', getMP3Info: true}"\n    bn-iface="filelist"></div>',deps:["breizbot.pager","MIDICtrl","AudioTools","breizbot.appData","breizbot.files"],props:{},init:async function(t,e,n,o,i,a){const c=$$.util.mapRange(0,127,0,1),s=1300,l=80,d=10,u=32e3;let r=i.getData();console.log("settings",r);const m=$$.ui.waitDialog("Loading samplers..."),p=$$.viewController(t,{data:{selectedInput:"default",audio1:!1,audio2:!1,curPFL:1,midiInputs:[],midiOutputs:[],crossFader:.5,masterVolume:.5,cueVolume:.5,runningBufferContainerStyle:{width:s+"px",height:l+"px"},zeroTimeStyle:{left:s/2,height:l},hotcueContainerStyle:{}},events:{onSettings:function(){e.pushPage("settings",{title:"Settings",props:{data:r},onReturn:async function(t){console.log("settings",t),r=t,await i.saveData(r),f()}})},onMasterVolumeChange:function(t,e){I.setMasterLevel(e)},onCueVolumeChange:function(t,e){I.setMasterLevel(e)},onCrossFaderChange:function(t,e){I.setFaderLevel(e)},onLoad:function(){v($(this).data("audio"))},onMidiInputChange:function(t){$(this).getValue()}}});async function f(){if(r.samplersFolder){m.show();const t=await a.list(r.samplersFolder,{filterExtension:"mp3",filesOnly:!0});console.log("files",t);const e=[];for(const n of t){const t=a.fileUrl(r.samplersFolder+n.name),o=await $$.media.getAudioBuffer(t);e.push({audioBuffer:o,value:e.length,label:n.name.replace(".mp3","")})}L(1).setSamplers(e),L(2).setSamplers(e),m.hide()}}const b=["red","green"];async function v(t){console.log("loadTrack",t);const e="audio"+t;if(1==p.model[e])return void console.log("A track is already loading");const n=C.getSelFile();if(n){P[t-1].innerHTML="";const o=A[t-1];o.innerHTML="",p.model[e]=!0,p.update();const{audioBuffer:i,tempo:a}=await p.scope[e].setInfo(n),c=s/2*i.duration;o.style.width=c+"px",o.style.height=l+"px",function(t,e,n){console.log("bufferLength",t.length);const o=Math.trunc(h(60/n.bpm));console.log("beatInterval",o);const i=Math.trunc(h(n.offset));console.log("beatOffset",i);const a=P[e-1],c=b[e-1],r=Math.ceil(s*t.duration/d);console.log("width",r);const m=t.getChannelData(0),p=Math.ceil(d*t.sampleRate/s);console.log("step",p);const f=l/2;let v=M(a);for(let t=0,e=0;t<r;t++,e++){e==u&&(v=M(a),e=0);let n=1,s=-1;for(let e=0;e<p;e++){const o=m[t*p+e];o<n&&(n=o),o>s&&(s=o)}v.fillStyle=c,v.fillRect(e,(1+n)*f,1,Math.max(1,(s-n)*f)),Math.abs(t-i)%o==0&&(v.fillStyle="black",v.fillRect(e,0,1,l))}}(i,t,a),p.model[e]=!1,g(0,t),p.update()}}function g(t,e){const n=P[e-1],o=A[e-1],i=s/d*(d/2-t);n.style.left=i+"px",o.style.left=i+"px"}const y=["red","green","blue","orange"];function h(t){return s/d*t}function k(t){const e=A[t-1];$(e).find(".loop").remove()}function T(t,e,n){console.log("createLoop",{deck:t,startTime:e,duration:n});const o=A[t-1];$(o).find(".loop").remove();const i=document.createElement("div");i.classList.add("loop");const a=h(e);i.style.left=a+"px",i.style.width=0==n?"1px":h(n)+"px",i.style.height=l+"px",o.appendChild(i)}function L(t){return p.scope["audio"+t]}n.on("MIDI_STATECHANGE",t=>{console.log("midiStateChange",t),p.setData({midiInputs:n.getMIDIInputs()})}),n.on("PLAY",({deck:t})=>{L(t).togglePlay()}),n.on("LOAD",async({deck:t})=>{v(t)}),n.on("CROSS_FADER",async({velocity:t})=>{const e=c(t);p.setData({crossFader:e}),I.setFaderLevel(e)}),n.on("LEVEL",async({deck:t,velocity:e})=>{const n=c(e);L(t).setVolume(n)}),n.on("BROWSE_WHEEL",async({velocity:t})=>{1==t?C.selDown():C.selUp()}),n.on("ENTER",async()=>{C.enterSelFolder()}),n.on("JOG_WHEEL",({deck:t,velocity:e})=>{L(t).seek(1==e?1:-1)}),n.on("CUE",({deck:t})=>{L(t).reset()}),n.on("LOOP_AUTO",({deck:t,key:e})=>{const n=L(t);let o=n.getCurrentTime();const i=60/n.getBpm()*(1<<e-1);0==(o=n.autoLoopActivate(e,o,i))?k(t):T(t,o,i)}),n.on("SAMPLER",({deck:t,key:e})=>{L(t).playSample(e)}),n.on("LOOP_MANUAL",({deck:t,key:e})=>{const n=L(t);if(1==e){const e=n.getCurrentTime();n.setStartLoopTime(e),T(t,e,0)}else if(2==e){const e=n.getStartLoopTime(),o=n.getCurrentTime();n.setEndLoopTime(o),T(t,e,o-e)}else 3==e&&(n.clearLoop(),k(t))}),n.on("HOT_CUE",({deck:t,key:e})=>{const n=L(t);if(1==e)n.toggleHotcueDeleteMode();else{const o=n.getHotcue(e);if(n.isHotcueDeleteMode())o&&(n.deleteHotcue(e),A[t-1].removeChild(o.div));else{const i=n.getCurrentTime();if(null==o){const o=function(t,e,n){console.log("createHotCue",{deck:t,hotcue:e,time:n});const o=A[t-1],i=document.createElement("div");i.classList.add("hotcue");const a=h(n);return i.style.left=a+"px",i.style.backgroundColor=y[e-1],i.style.height=l+"px",o.appendChild(i),i}(t,e,i);n.addHotcue(e,i,o)}else n.jumpToHotcue(e)}}}),n.on("PFL",({deck:t})=>{1==t?(N.setFaderLevel(0),n.setButtonIntensity("PFL",1,1),n.setButtonIntensity("PFL",0,2)):(N.setFaderLevel(1),n.setButtonIntensity("PFL",0,1),n.setButtonIntensity("PFL",1,2))}),n.on("MASTER_LEVEL",({velocity:t})=>{const e=c(t);I.setMasterLevel(e),p.setData({masterVolume:e})}),n.on("CUE_LEVEL",({velocity:t})=>{const e=c(t);N.setMasterLevel(e),p.setData({cueVolume:e})});const C=p.scope.filelist,O=p.scope.audio1,B=p.scope.audio2,P=[p.scope.runningBuffer1.get(0),p.scope.runningBuffer2.get(0)],A=[p.scope.hotcueContainer1.get(0),p.scope.hotcueContainer2.get(0)];function M(t){console.log("createCanvas");const e=document.createElement("canvas");e.width=u,e.height=l,t.appendChild(e);const n=e.getContext("2d");return n.clearRect(0,0,u,l),n}!function t(){O.isLoaded()&&g(O.getCurrentTime(),1),B.isLoaded()&&g(B.getCurrentTime(),2),requestAnimationFrame(t)}();const E=O.getOutputNode(),w=B.getOutputNode(),I=o.createCrossFaderWithMasterLevel(E,w),N=o.createCrossFaderWithMasterLevel(E,w);N.setFaderLevel(1);const S=o.createStereoMerger(I.getOutputNode(),N.getOutputNode());o.createDestination(4,S),async function(){console.log("init");const t=await n.requestMIDIAccess();if(p.setData(t),t.midiInputs.length>1){const o=t.midiInputs[1].value;p.setData({selectedInput:o}),e=o,n.selectMIDIDevice(e),n.clearAllButtons(),n.setButtonIntensity("PFL",1,2)}var e;f()}()}}),function(){$$.control.registerControl("audioplayer",{template:'<div class="toolbar">\n\n\t<strong bn-text="name"></strong>\n\t<div bn-show="loaded">BPM: <strong bn-text="bpm"></strong></div>\n\n\n\t<div>\n\t\t<button bn-show="showPlay" bn-event="click: onPlay" class="w3-btn w3-blue w3-padding-small" title="Play" bn-icon="fa fa-play">\n\t\t</button>\n\n\t\t<button bn-show="playing" bn-event="click: onPause" class="w3-btn w3-blue w3-padding-small" title="Pause" bn-icon="fa fa-pause">\n\t\t</button>\n\n\t</div>\n\n</div>\n\n\n</div>\n\n<div class="bufferContainer" bn-show="showBuffer">\n\t<canvas bn-bind="bufferCanvas" class="bufferCanvas" width="470" height="100">\n</div>\n\n<div class="content">\n\t<div class="samplers">\n\t\t<div class="samplerPlayer">\n\t\t\t<button class="w3-button w3-blue w3-padding-small" bn-icon="fa fa-play"\n\t\t\t\tbn-event="click: onPlaySampler"></button>\n\t\t\t<div bn-control="brainjs.combobox" bn-data="{items: samplers}"></div>\n\t\t</div>\n\t\t<div class="samplerPlayer">\n\t\t\t<button class="w3-button w3-blue w3-padding-small" bn-icon="fa fa-play"\n\t\t\t\tbn-event="click: onPlaySampler"></button>\n\t\t\t<div bn-control="brainjs.combobox" bn-data="{items: samplers}"></div>\n\t\t</div>\n\t\t<div class="samplerPlayer">\n\t\t\t<button class="w3-button w3-blue w3-padding-small" bn-icon="fa fa-play"\n\t\t\t\tbn-event="click: onPlaySampler"></button>\n\t\t\t<div bn-control="brainjs.combobox" bn-data="{items: samplers}"></div>\n\t\t</div>\n\t\t<div class="samplerPlayer">\n\t\t\t<button class="w3-button w3-blue w3-padding-small" bn-icon="fa fa-play"\n\t\t\t\tbn-event="click: onPlaySampler"></button>\n\t\t\t<div bn-control="brainjs.combobox" bn-data="{items: samplers}"></div>\n\t\t</div>\n\t</div>\n\n\t<div class="toolbar2">\n\t\t<i class="fas fa-lg fa-volume-down w3-text-blue volume"></i>\n\t\t<div bn-control="brainjs.slider" bn-data="{min: 0, max:1, step: 0.01, orientation: \'vertical\'}"\n\t\t\tbn-event="input: onVolumeChange" bn-val="volume" class="volulmeSlider"></div>\n\t</div>\n</div>\n\n<div class="slider">\n\t<span bn-text="getTimeInfo"></span>\n\t<div bn-control="brainjs.slider" bn-data="{max: duration}" bn-event="input: onSliderChange" bn-val="curTime">\n\t</div>\n\n</div>',deps:["breizbot.pager","AudioTools","MIDICtrl","breizbot.beatdetector"],props:{showBuffer:!1,deck:1},init:function(t,e,n,o,i){console.log("props",this.props);const{showBuffer:a,deck:c}=this.props,s=$$.media.getFormatedTime;let l=null;const d={};let u=!1,r=0,m=0,p=0,f=0,b=0,v=null;const g=n.getAudioContext(),y=g.createGain();y.gain.value=.5;const h=$$.viewController(t,{data:{samplers:[],tempo:0,name:"No Track loaded",volume:.5,duration:0,curTime:0,playing:!1,loaded:!1,showBuffer:a,getTimeInfo:function(){return`${s(this.curTime,!0)} / ${s(this.duration)}`},showPlay:function(){return this.loaded&&!this.playing}},events:{onPlaySampler:function(){const t=$(this).closest(".samplerPlayer").find(".brainjs-combobox").getValue();console.log("onPlaySampler",t),T(t)},onVolumeChange:function(t,e){y.gain.value=e},onPlay:function(){L()},onPause:function(){C()},onSliderChange:function(t,e){O(e,!0)}}});!function(t,e){const{width:n,height:o}=t;console.log({width:n,height:o});const i=t.getContext("2d");"function"==typeof e&&(t.onclick=function(t){console.log("onclick",t.offsetX);const o=t.offsetX/n*s.duration;e(o)});const a=document.createElement("canvas");a.width=n,a.height=o;const c=a.getContext("2d");let s=null;function l(t){if(s){i.clearRect(0,0,n,o),i.drawImage(a,0,5);const e=n*t/s.duration;i.fillStyle="rgba(255, 255, 255, 0.33)",i.fillRect(0,0,e,o)}}}(h.scope.bufferCanvas.get(0),t=>{console.log({time:t})});let k=null;function T(t){const{samplers:e}=h.model;if(t<e.length){const n=g.createBufferSource();n.buffer=e[t].audioBuffer,n.connect(y),n.start()}}function L(){o.setButtonIntensity("PLAY",127,c),y.gain.value=h.model.volume,(v=g.createBufferSource()).buffer=l,v.onended=function(){h.model.playing&&(h.setData({playing:!1}),b=l.duration,t.trigger("pause")),null!=k&&(k(),k=null)},v.connect(y),f=g.currentTime,v.start(0,b),h.setData({playing:!0}),t.trigger("playing")}this.playSample=function(e){T(t.find(".samplerPlayer").eq(e-1).find(".brainjs-combobox").getValue())};function C(){return o.setButtonIntensity("PLAY",1,c),new Promise(e=>{h.setData({playing:!1}),b+=g.currentTime-f,v.stop(),v=null,t.trigger("pause"),k=e})}async function O(t=0,e=!1){const{playing:n}=h.model;n&&await C(),b=t,e&&n&&L()}this.setSamplers=function(t){h.setData({samplers:t})},this.seek=function(t){!h.model.playing&&h.model.loaded&&(b+=11*t/360,b=Math.max(0,b))},this.reset=O,this.setInfo=async function(t){let{mp3:e,name:n,url:o}=t,{artist:a,title:c}=e;null!=c&&(n=`${a} - ${c}`),console.log("name",n),h.setData({name:"Loading..."}),l=await $$.media.getAudioBuffer(o);const s=await i.computeBeatDetection(l);console.log("tempo",s);const d=l.duration;return h.setData({name:n,duration:d,loaded:!0,bpm:s.bpm}),{audioBuffer:l,tempo:s}},this.getCurrentTime=function(){let t=b;return h.model.playing&&(t+=g.currentTime-f),0!=r&&t>=p&&(O(m,!0),t=g.currentTime-m),h.setData({curTime:t}),t},this.setStartLoopTime=function(t){m=t},this.setEndLoopTime=function(t){p=t,r=5,O(m,!0),o.setButtonIntensity("LOOP_MANUAL",127,c,3)},this.clearLoop=function(){r=0,o.setButtonIntensity("LOOP_MANUAL",1,c,3)},this.getStartLoopTime=function(){return m},this.getOutputNode=function(){return y},this.isPlaying=function(){return h.model.playing},this.setVolume=function(t){y.gain.value=t,h.setData({volume:t})},this.isLoaded=function(){return h.model.loaded},this.togglePlay=function(){h.model.playing?C():L()},this.getAudioBuffer=function(){return l},this.getHotcue=function(t){return d[t]},this.addHotcue=function(t,e,n){console.log("addHotcue",t),d[t]={time:e,div:n},o.setButtonIntensity("HOT_CUE",127,c,t)},this.jumpToHotcue=function(t){console.log("jumpToHotcue",t);const{time:e}=d[t];O(e,!0)},this.toggleHotcueDeleteMode=function(){u=!u,console.log("isHotcueDeleteMode",u),o.setButtonIntensity("HOT_CUE",u?127:1,c,1)},this.isHotcueDeleteMode=function(){return u},this.deleteHotcue=function(t){console.log("deleteHotcue",t),delete d[t],o.setButtonIntensity("HOT_CUE",1,c,t)},this.getBpm=function(){return h.model.bpm},this.autoLoopActivate=function(t,e,n){return t==r?(o.setButtonIntensity("LOOP_AUTO",1,c,t),r=0,0):(0!=r?(o.setButtonIntensity("LOOP_AUTO",1,c,r),p=m+n):(m=e,p=e+n),o.setButtonIntensity("LOOP_AUTO",127,c,t),r=t,m)}}})}(),$$.control.registerControl("settings",{template:'<div>\n    <form bn-event="submit: onSubmit" bn-form="data">\n        <label>Samplers Folder</label>\n        <div>\n            <input type="text" required name="samplersFolder">\n            <button type="button" class="w3-button w3-blue" bn-icon="fa fa-folder-open" bn-event="click: onChooseFolder"></button>    \n        </div>\n        \n        <input type="submit" hidden bn-bind="submit">\n    </form>\n</div>\n',deps:["breizbot.pager"],props:{data:{}},init:function(t,e){const{data:n}=this.props,o=$$.viewController(t,{data:{data:n},events:{onChooseFolder:function(){e.pushPage("breizbot.files",{title:"Choose Folder",props:{filterExtension:"mp3"},onReturn:function(t){console.log("onReturn",t),o.model.data.samplersFolder=t,o.update()},buttons:{apply:{icon:"fas fa-check",title:"Apply",onClick:function(){console.log("onClick",this),e.popPage(this.getRootDir())}}}})},onSubmit:function(t){t.preventDefault(),e.popPage($(this).getFormData())}}});this.getButtons=function(){return{apply:{title:"Apply",icon:"fas fa-check",onClick:function(){o.scope.submit.click()}}}}}}),$$.service.registerService("AudioTools",{init:function(){const t=new AudioContext;return{createStereoMerger:function(e,n){const o=t.createChannelSplitter(2);e.connect(o);const i=t.createChannelSplitter(2);n.connect(i);const a=t.createChannelMerger(4);return o.connect(a,0,0),o.connect(a,1,1),i.connect(a,0,2),i.connect(a,1,3),a},createDestination:function(e,n){const o=t.createMediaStreamDestination();o.channelCount=e;const i=new Audio;i.srcObject=o.stream,n.connect(o),i.play()},createCrossFaderWithMasterLevel:function(e,n){const o=t.createGain();o.gain.value=.5,e.connect(o);const i=t.createGain();i.gain.value=.5,n.connect(i);const a=t.createGain();return a.gain.value=.5,o.connect(a),i.connect(a),{setFaderLevel:function(t){i.gain.value=Math.cos(.5*(1-t)*Math.PI),o.gain.value=Math.cos(.5*t*Math.PI)},setMasterLevel:function(t){a.gain.value=t},getOutputNode:function(){return a}}},getAudioContext:function(){return t},getCurrentTime:function(){return t.currentTime}}}}),$$.service.registerService("MIDICtrl",{init:function(t){const e={MAX:127,MIN:1,OFF:0,ON:1},n=[{action:"MASTER_LEVEL",cmd:191,note:10},{action:"CUE_LEVEL",cmd:191,note:12},{action:"CROSS_FADER",cmd:191,note:8},{action:"LEVEL",cmd:176,note:22,deck:1},{action:"PITCH",cmd:176,note:25,deck:1},{action:"LEVEL",cmd:177,note:22,deck:2},{action:"PITCH",cmd:177,note:25,deck:2},{action:"SYNC",cmd:144,note:2,deck:1,type:"BTN"},{action:"CUE",cmd:144,note:1,deck:1,type:"BTN"},{action:"PLAY",cmd:144,note:0,deck:1,type:"BTN"},{action:"PFL",cmd:144,note:27,deck:1,type:"BTN2"},{action:"JOGTOUCH",cmd:144,note:6,deck:1},{action:"SYNC",cmd:145,note:2,deck:2,type:"BTN"},{action:"CUE",cmd:145,note:1,deck:2,type:"BTN"},{action:"PLAY",cmd:145,note:0,deck:2,type:"BTN"},{action:"PFL",cmd:145,note:27,deck:2,type:"BTN2"},{action:"JOGTOUCH",cmd:145,note:6,deck:2},{action:"LOAD",cmd:159,note:2,deck:1},{action:"LOAD",cmd:159,note:3,deck:2},{action:"ENTER",cmd:159,note:6},{action:"JOG_WHEEL",cmd:176,note:6,deck:1},{action:"JOG_WHEEL",cmd:177,note:6,deck:2},{action:"BROWSE_WHEEL",cmd:191,note:0},{action:"HOT_CUE",cmd:148,note:1,deck:1,key:1,type:"BTN"},{action:"HOT_CUE",cmd:148,note:2,deck:1,key:2,type:"BTN"},{action:"HOT_CUE",cmd:148,note:3,deck:1,key:3,type:"BTN"},{action:"HOT_CUE",cmd:148,note:4,deck:1,key:4,type:"BTN"},{action:"HOT_CUE",cmd:149,note:1,deck:2,key:1,type:"BTN"},{action:"HOT_CUE",cmd:149,note:2,deck:2,key:2,type:"BTN"},{action:"HOT_CUE",cmd:149,note:3,deck:2,key:3,type:"BTN"},{action:"HOT_CUE",cmd:149,note:4,deck:2,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:17,deck:1,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:18,deck:1,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:19,deck:1,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:148,note:20,deck:1,key:4,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:17,deck:2,key:1,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:18,deck:2,key:2,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:19,deck:2,key:3,type:"BTN"},{action:"LOOP_AUTO",cmd:149,note:20,deck:2,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:33,deck:1,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:34,deck:1,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:35,deck:1,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:148,note:36,deck:1,key:4,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:33,deck:2,key:1,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:34,deck:2,key:2,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:35,deck:2,key:3,type:"BTN"},{action:"LOOP_MANUAL",cmd:149,note:36,deck:2,key:4,type:"BTN"},{action:"SAMPLER",cmd:148,note:49,deck:1,key:1,type:"BTN"},{action:"SAMPLER",cmd:148,note:50,deck:1,key:2,type:"BTN"},{action:"SAMPLER",cmd:148,note:51,deck:1,key:3,type:"BTN"},{action:"SAMPLER",cmd:148,note:52,deck:1,key:4,type:"BTN"},{action:"SAMPLER",cmd:149,note:49,deck:2,key:1,type:"BTN"},{action:"SAMPLER",cmd:149,note:50,deck:2,key:2,type:"BTN"},{action:"SAMPLER",cmd:149,note:51,deck:2,key:3,type:"BTN"},{action:"SAMPLER",cmd:149,note:52,deck:2,key:4,type:"BTN"}];const o=new EventEmitter2;let i=null,a=null,c=null;function s(t){const[e,i,a]=t.data,c=function(t,e){for(const o of n){if(o.cmd==t&&o.note==e)return"BTN"==o.type&&(o.event="DOWN"),o;if(o.cmd-16==t&&o.note==e&&"BTN"==o.type)return o.event="UP",o}return null}(e,i);if(null!=c){const{action:t,deck:e,key:n,event:i}=c;"UP"!=i&&o.emit(t,{deck:e,key:n,velocity:a})}}return{selectMIDIInput:function(t){a&&(a.onmidimessage=null);for(const e of i.inputs.values())if(e.id==t)return void((a=e).onmidimessage=s)},selectMIDIOutput:function(t){for(const e of i.outputs.values())if(e.id==t){c=e;break}},selectMIDIDevice:function(t){a&&(a.onmidimessage=null);for(const e of i.inputs.values())if(e.id==t){(a=e).onmidimessage=s;for(const t of i.outputs.values())if(t.name==e.name){c=t;break}break}},clearAllButtons:function(){if(null!=c)for(const{cmd:t,note:o,type:i}of n)"BTN"!=i&&"BTN2"!=i||c.send([t,o,"BTN"==i?e.MIN:e.OFF])},setButtonIntensity:function(t,e,o,i){if(null!=c)for(const a of n){let n=a.action==t;null!=o&&(n&=a.deck==o),null!=i&&(n&=a.key==i),n&&c.send([a.cmd,a.note,e])}},requestMIDIAccess:async function(){(i=await navigator.requestMIDIAccess()).onstatechange=function(t){"input"==t.port.type&&o.emit("MIDI_STATECHANGE",t.port)};const t=[];for(const{name:e,id:n}of i.inputs.values())t.push({label:e,value:n});const e=[];for(const{name:t,id:n}of i.outputs.values())e.push({label:t,value:n});return{midiInputs:t,midiOutputs:e}},getMIDIInputs:function(){const t=[];for(const{name:e,id:n}of i.inputs.values())t.push({label:e,value:n});return t},on:o.on.bind(o),BtnIntensity:e}}});