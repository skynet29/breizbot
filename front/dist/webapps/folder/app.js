$$.control.registerControl("rootPage",{template:'<div class="toolbar" bn-bind="toolbar">\n\t<div class="left">\n\t\t<div class="group" bn-show="!isMobileDevice">\n\t\t\t<button \n\t\t\t\tclass="w3-button" \n\t\t\t\ttitle="New folder" \n\t\t\t\tbn-event="click: onCreateFolder" \n\t\t\t\tdata-cmd="newFolder">\n\t\t\t\t\t<i class="fas fa-folder-plus"></i>\n\t\t\t\t</button>\n\t\n\t\t\t<button \n\t\t\t\tclass="w3-button" \n\t\t\t\ttitle="Import file" \n\t\t\t\tdata-cmd="importFile"\n\t\t\t\tbn-event="click: onImportFile">\n\t\t\t\t\t<i class="fa fa-download"></i>\n\t\t\t\t</button>\n\n\t\t\t\t<button \n\t\t\t\tclass="w3-button" \n\t\t\t\ttitle="Import url" \n\t\t\t\tdata-cmd="importUrl"\n\t\t\t\tbn-event="click: onImportUrl">\n\t\t\t\t\t<i class="fa fa-cloud-download-alt"></i>\n\t\t\t\t</button>\n\n\t\t\t<button \n\t\t\t\tclass="w3-button" \n\t\t\t\ttitle="Reload" \n\t\t\t\tdata-cmd="reload"\n\t\t\t\tbn-event="click: onReload">\n\t\t\t\t\t<i class="fa fa-sync-alt"></i>\n\t\t\t\t</button>\n\n\t\t\t<span class="separator"></span>\n\t\n\t\n\t\t</div>\n\t\n\t\t<div class="group">\n\t\t\t<button class="w3-button" title="Toggle Selection" bn-event="click: onToggleSelection"><i class="fa fa-check"></i></button>\n\t\t\t<span class="separator"></span>\n\t\n\t\n\t\t</div>\n\t\n\t\t<div class="group">\n\t\t\t<button class="w3-button" title="Delete" bn-event="click: onDeleteFiles" bn-prop="prop1"><i class="fa fa-trash"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Cut" bn-prop="prop1" bn-event="click: onCutFiles"><i class="fa fa-cut"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Copy" bn-prop="prop1" bn-event="click: onCopyFiles"><i class="fa fa-copy"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Share" \n\t\t\t\tbn-prop="canShare" \n\t\t\t\tbn-control="brainjs.contextmenu"\n\t\t\t\tbn-data="{items: getShareGroups, trigger: \'left\'}"\n\t\t\t\tbn-event="contextmenuchange: onShareSelected"\n\t\t\t><i class="fa fa-share-alt"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Paste" bn-prop="canPaste" bn-event="click: onPasteFiles"><i class="fa fa-paste"></i></button>\n\t\t</div>\n\t\n\t\n\t</div>\n\t<div bn-show="isMobileDevice">\n\t\t<button class="w3-button" title="More actions" \n\t\t\tbn-control="brainjs.contextmenu"\n\t\t\tbn-event="contextmenuchange: onToolbarContextMenu"\n\t\t\tbn-data="{\n\t\t\t\ttrigger: \'left\',\n\t\t\t\titems: {\n\t\t\t\t \tnewFolder: {name: \'New folder\', icon: \'fas fa-folder-plus\'},\n\t\t\t\t \timportFile: {name: \'Import file\', icon: \'fas fa-download\'},\n\t\t\t\t \treload: {name: \'Reload\', icon: \'fas fa-sync-alt\'}\n\t\t\t\t}\n\t\t\t}">\n\t\t\t<i class="fa fa-ellipsis-v"></i></button>\n\n\t</div>\n</div>\n\n<div class="download" bn-show="hasDownloads" bn-bind="downloads">\n\t<strong bn-event="click: onToggleDownload"><i class="fa fa-caret-down fa-fw"></i>\n\t\t\tUploads</strong>\n\t<div bn-each="downloads" class="downloadItems">\n\t\t<div class="w3-card w3-padding-small">\n\t\t\t<div bn-text="$scope.$i.fileName"></div>\n\t\t\t<progress max="1" bn-val="$scope.$i.percentage"></progress>\n\t\t</div>\n\t</div>\n</div>\n\n<div bn-control="breizbot.files" \n\tbn-event="fileclick: onFileClick, dirchange: onDirChange, selchange: onSelChange, contextmenuItem: onContextMenu"\n\tbn-iface="files"\n\tdata-selection-enabled="true"\n\tbn-data="{menuItems: getItems}"\n\t></div>',deps:["breizbot.pager","breizbot.files","app.folder","breizbot.broker","breizbot.scheduler"],init:function(t,e,n,o,i,l){const s=$$.ui.progressDialog();let a=[];function r(t){let e=$$.file.getFileType(t);return t.endsWith(".hdoc")&&(e="hdoc"),e}const c=$$.viewController(t,{data:{operation:"none",nbSelection:0,isShareSelected:!1,isMobileDevice:!1,selectedFiles:[],rootDir:"/",prop1:function(){return{disabled:0==this.nbSelection}},canShare:function(){return{disabled:0==this.nbSelection||this.rootDir.startsWith("/share/")||this.isShareSelected}},getShareGroups:function(){return function(){const t={$add:{name:"add to new folder"}};return 0!=a.length&&(t.sep="----",a.forEach(e=>{t[e]={name:e}})),t}},downloads:[],hasDownloads:function(){return this.downloads.length>0},canPaste:function(){return{disabled:0==this.selectedFiles.length}},getItems:function(){return function(t){const{name:e,folder:n,isImage:o}=t,i={delete:{name:"Delete",icon:"fas fa-trash"},rename:{name:"Rename",icon:"fas fa-i-cursor"}};return o&&(i.makeResizedCopy={name:"Make resized copy",icon:"fas fa-compress-arrows-alt"}),n?i.zipFolder={name:"Zip Folder",icon:"fas fa-compress"}:(r(e)&&(i.open={name:"Open in viewer",icon:"fas fa-search"}),i.download={name:"Download",icon:"fas fa-upload"},e.endsWith(".zip")?i.unzipFile={name:"Unzip File",icon:"fas fa-expand-alt"}:e.toLowerCase().endsWith(".mp4")&&(i.convertToMP3={name:"Convert to MP3"})),i}}},events:{onImportUrl:async function(){const t=await $$.ui.showPrompt({title:"Inport URL",label:"URL",attrs:{type:"url"}});if(null!=t){s.setPercentage(0),s.show("Downloading...");const e=await o.importUrl(c.model.rootDir,t);i.onTopic("breizbot.importUrl.progress",async function t(o){if(1==o.hist)return;const{percent:l}=o.data;if(s.setPercentage(l/100),100==Math.floor(l)){await $$.util.wait(500),s.hide();const o=await n.fileInfo(e.outFileName);d.insertFile(o),i.offTopic("breizbot.importUrl.progress",t)}})}},onContextMenu:async function(t,e){const{rootDir:a,name:c,idx:p,cmd:u}=e;switch(u){case"rename":!async function(t){const{rootDir:e,name:n,idx:i}=t,l=n,s=await $$.ui.showPrompt({label:"New name",title:"Rename",value:l});if(console.log("newFileName",s),null!=s&&s!=l)try{const t=await o.renameFile(e,l,s);d.updateFile(i,t)}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}}(e);break;case"makeResizedCopy":!async function(t){const{rootDir:e,name:n,idx:i}=t,l=await $$.ui.showPrompt({label:"Rescale percentage:",title:"Make resized copy",attrs:{min:10,max:90,type:"number"},value:50});if(null!=l)try{const t=await o.resizeImage(e,n,l+"%");d.insertFile(t,i)}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}}(e);break;case"convertToMP3":!async function(t){const{rootDir:e,name:l,idx:a}=t;try{s.setPercentage(0),s.show("Converting...");const t=await o.convertToMP3(e,l);i.onTopic("breizbot.mp3.progress",async function e(o){if(1==o.hist)return;console.log("progress",o.data);const{percent:l,finish:r,error:c}=o.data;if(c)s.hide(),i.offTopic("breizbot.mp3.progress",e),$$.ui.showAlert({title:"Error",content:c});else if(!0===r){await $$.util.wait(500),s.hide();const o=await n.fileInfo(t.outFileName);d.insertFile(o,a),i.offTopic("breizbot.mp3.progress",e)}else s.setPercentage(l/100)})}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}}(e);break;case"zipFolder":!async function(t){const{rootDir:e,name:l,idx:a}=t;try{s.setPercentage(0),s.show("Zipping...");const t=await o.zipFolder(e,l);i.onTopic("breizbot.zip.progress",async function e(o){if(1==o.hist)return;const{percent:l}=o.data;s.setPercentage(l/100);if(100==Math.floor(l)){await $$.util.wait(500),s.hide();const o=await n.fileInfo(t.outFileName);d.insertFile(o,a),i.offTopic("breizbot.zip.progress",e)}})}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}}(e);break;case"unzipFile":!async function(t){const{rootDir:e,name:n,idx:l}=t;try{s.setPercentage(0),s.show("Unzipping...");await o.unzipFile(e,n);i.onTopic("breizbot.unzip.progress",async function t(e){if(1==e.hist)return;const{percent:n}=e.data;s.setPercentage(n/100);100==Math.floor(n)&&(await $$.util.wait(500),s.hide(),i.offTopic("breizbot.unzip.progress",t),d.reload())})}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}}(e);break;case"delete":m([{fileName:a+c,idx:p}]);break;case"download":!function(t){const{rootDir:e,name:o}=t,i=n.fileUrl(e+o);$$.url.downloadUrl(i,o)}(e);break;case"open":l.openApp("viewer",{type:r(c),url:n.fileUrl(a+c)},c)}},onDirChange:function(t,e){c.setData({rootDir:e.newDir,nbSelection:0})},onFileClick:function(t,o){const{fileName:i,rootDir:l}=o,s=l+i,a=r(i);null!=a&&e.pushPage("breizbot.viewer",{title:i,props:{type:a,url:n.fileUrl(s)}})},onToggleSelection:function(){d.toggleSelection(),c.setData({nbSelection:d.getNbSelFiles()})},onSelChange:function(t,e){const{isShareSelected:n}=e;c.setData({nbSelection:d.getNbSelFiles(),isShareSelected:n})},onToolbarContextMenu:function(e,n){t.find(`button[data-cmd=${n.cmd}]`).click()},onToggleDownload:function(){console.log("onToggleDownload");const t=$(this).find("i"),e=$(this).siblings(".downloadItems");t.hasClass("fa-caret-right")?(t.removeClass("fa-caret-right").addClass("fa-caret-down"),e.slideDown()):(t.removeClass("fa-caret-down").addClass("fa-caret-right"),e.slideUp())},onCreateFolder:async function(){const t=d.getRootDir();console.log("onCreateFolder",t);const e=await $$.ui.showPrompt({label:"Folder name:",title:"New Folder"});if(console.log("folderName",e),null!=e)try{const n=await o.mkdir(t+e);console.log("resp",n),d.insertFile(n)}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}},onCopyFiles:function(t){const e=d.getSelFileNames();c.setData({selectedFiles:e,operation:"copy"})},onDeleteFiles:function(t){const e=d.getSelFiles();0!=e.length?m(e):$$.ui.showAlert({title:"Delete files",content:"No files selected"})},onCutFiles:function(t){const e=d.getSelFileNames();c.setData({selectedFiles:e,operation:"cut"})},onPasteFiles:async function(t){const{rootDir:e,selectedFiles:n,operation:i}=c.model;try{"copy"==i?await o.copyFiles(n,e):await o.moveFiles(n,e),p()}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}},onReload:function(t){p()},onImportFile:function(t){$$.ui.openFileDialog(t=>{console.log("files",t);for(const e of t)f(e)},!0)},onShareSelected:async function(t,e){console.log("onShareSelected",e);let n=e.cmd;try{if("$add"==n){if(null==(n=await $$.ui.showPrompt({title:"Add Group",label:"Name"})))return;await u()}const t=d.getSelFileNames();await o.shareFiles(t,n),p()}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}}}}),d=c.scope.files;function p(){c.setData({selectedFiles:[],operation:"none",nbSelection:0}),d.reload()}async function u(){a=(a=await n.list("/share",{folderOnly:!0})).map(t=>t.name)}async function f(t){try{const e={fileName:t.name,percentage:0},{downloads:o,rootDir:i}=c.model;o.push(e),c.updateNodeTree("downloads"),console.log("uploadFile",i,t.name),await n.uploadFile(t,t.name,i,!1,function(t){e.percentage=t,c.updateNodeTree("downloads")}),console.log("Download Finished: ",e.fileName);const l=o.indexOf(e);o.splice(l,1),c.updateNodeTree("downloads");const s=await n.fileInfo(i+e.fileName);d.insertFile(s)}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}}function m(t){$$.ui.showConfirm({content:"Are you sure ?",title:"Delete files"},async function(){try{const e=await o.removeFiles(t.map(t=>t.fileName));console.log("resp",e),d.removeFiles(t.map(t=>t.idx))}catch(t){console.log("resp",t),$$.ui.showAlert({content:t.responseText,title:"Error"})}})}u(),new ResizeObserver(t=>{c.model.isMobileDevice=$$.util.isMobileDevice(),c.updateNodeTree("toolbar")}).observe(t.get(0))}}),$$.service.registerService("app.folder",{deps:["breizbot.http","breizbot.broker"],init:function(t,e,n){let o;return n.on("ready",t=>{o=t.clientId}),{removeFiles:function(t){return console.log("[FileService] removeFiles",t),e.post("/delete",t)},mkdir:function(t){return console.log("[FileService] mkdir",t),e.post("/mkdir",{fileName:t})},moveFiles:function(t,n){return console.log("[FileService] moveFiles",t,n),e.post("/move",{fileNames:t,destPath:n})},shareFiles:function(t,n){return console.log("[FileService] shareFiles",t),e.post("/move",{fileNames:t,destPath:`/share/${n}`})},copyFiles:function(t,n){return console.log("[FileService] copyFiles",t,n),e.post("/copy",{fileNames:t,destPath:n})},renameFile:function(t,n,o){return console.log("[FileService] renameFile",t,n,o),e.post("/rename",{filePath:t,oldFileName:n,newFileName:o})},resizeImage:function(t,n,o){return console.log("[FileService] resizeImage",t,n,o),e.post("/resizeImage",{filePath:t,fileName:n,resizeFormat:o})},convertToMP3:function(t,n){return console.log("[FileService] convertToMP3",t,n),e.post("/convertToMP3",{filePath:t,fileName:n,srcId:o})},zipFolder:function(t,n){return console.log("[FileService] zipFolder",t,n),e.post("/zipFolder",{folderPath:t,folderName:n,srcId:o})},unzipFile:function(t,n){return console.log("[FileService] unzipFile",t,n),e.post("/unzipFile",{folderPath:t,fileName:n,srcId:o})},importUrl:function(t,n){return console.log("[FileService] importUrl",t,n),e.post("/importUrl",{folderPath:t,srcId:o,url:n})}}}});