$$.control.registerControl("rootPage",{template:'<div class="toolbar" bn-bind="toolbar">\n\t<div class="left">\n\t\t<div class="group" bn-show="!isMobileDevice">\n\t\t\t<button \n\t\t\t\tclass="w3-button" \n\t\t\t\ttitle="New folder" \n\t\t\t\tbn-event="click: onCreateFolder" \n\t\t\t\tdata-cmd="newFolder">\n\t\t\t\t\t<i class="fas fa-folder-plus"></i>\n\t\t\t\t</button>\n\t\n\t\t\t<button \n\t\t\t\tclass="w3-button" \n\t\t\t\ttitle="Import file" \n\t\t\t\tdata-cmd="importFile"\n\t\t\t\tbn-event="click: onImportFile">\n\t\t\t\t\t<i class="fa fa-upload"></i>\n\t\t\t\t</button>\n\n\t\t\t<button \n\t\t\t\tclass="w3-button" \n\t\t\t\ttitle="Reload" \n\t\t\t\tdata-cmd="reload"\n\t\t\t\tbn-event="click: onReload">\n\t\t\t\t\t<i class="fa fa-sync-alt"></i>\n\t\t\t\t</button>\n\n\t\t\t<span class="separator"></span>\n\t\n\t\n\t\t</div>\n\t\n\t\t<div class="group">\n\t\t\t<button class="w3-button" title="Toggle Selection" bn-event="click: onToggleSelection"><i class="fa fa-check"></i></button>\n\t\t\t<span class="separator"></span>\n\t\n\t\n\t\t</div>\n\t\n\t\t<div class="group">\n\t\t\t<button class="w3-button" title="Delete" bn-event="click: onDeleteFiles" bn-prop="prop1"><i class="fa fa-trash"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Cut" bn-prop="prop1" bn-event="click: onCutFiles"><i class="fa fa-cut"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Copy" bn-prop="prop1" bn-event="click: onCopyFiles"><i class="fa fa-copy"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Share" \n\t\t\t\tbn-prop="canShare" \n\t\t\t\tbn-control="brainjs.contextmenu"\n\t\t\t\tbn-data="{items: getShareGroups, trigger: \'left\'}"\n\t\t\t\tbn-event="contextmenuchange: onShareSelected"\n\t\t\t><i class="fa fa-share-alt"></i></button>\n\t\n\t\t\t<button class="w3-button" title="Paste" bn-prop="canPaste" bn-event="click: onPasteFiles"><i class="fa fa-paste"></i></button>\n\t\t</div>\n\t\n\t\n\t</div>\n\t<div bn-show="isMobileDevice">\n\t\t<button class="w3-button" title="More actions" \n\t\t\tbn-control="brainjs.contextmenu"\n\t\t\tbn-event="contextmenuchange: onToolbarContextMenu"\n\t\t\tbn-data="{\n\t\t\t\ttrigger: \'left\',\n\t\t\t\titems: {\n\t\t\t\t \tnewFolder: {name: \'New folder\', icon: \'fas fa-folder-plus\'},\n\t\t\t\t \timportFile: {name: \'Import file\', icon: \'fas fa-upload\'},\n\t\t\t\t \treload: {name: \'Reload\', icon: \'fas fa-sync-alt\'}\n\t\t\t\t}\n\t\t\t}">\n\t\t\t<i class="fa fa-ellipsis-v"></i></button>\n\n\t</div>\n</div>\n\n<div class="download" bn-show="hasDownloads" bn-bind="downloads">\n\t<strong bn-event="click: onToggleDownload"><i class="fa fa-caret-down fa-fw"></i>\n\t\t\tUploads</strong>\n\t<div bn-each="downloads" class="downloadItems">\n\t\t<div class="w3-card w3-padding-small">\n\t\t\t<div bn-text="$scope.$i.fileName"></div>\n\t\t\t<progress max="1" bn-val="$scope.$i.percentage"></progress>\n\t\t</div>\n\t</div>\n</div>\n\n<div bn-control="breizbot.files" \n\tbn-event="fileclick: onFileClick, dirchange: onDirChange, selchange: onSelChange, contextmenuItem: onContextMenu"\n\tbn-iface="files"\n\tdata-selection-enabled="true"\n\tbn-data="{menuItems: getItems}"\n\t></div>',deps:["breizbot.pager","breizbot.files","breizbot.users","app.folder","breizbot.broker"],init:function(e,t,n,o,i,l){const s=$$.ui.progressDialog();let a=[];const r=$$.viewController(e,{data:{operation:"none",nbSelection:0,isShareSelected:!1,isMobileDevice:!1,selectedFiles:[],rootDir:"/",prop1:function(){return{disabled:0==this.nbSelection}},canShare:function(){return{disabled:0==this.nbSelection||this.rootDir.startsWith("/share/")||this.isShareSelected}},getShareGroups:function(){return function(){const e={$add:{name:"add to new group"}};return 0!=a.length&&(e.sep="----",a.forEach(t=>{e[t]={name:t}})),e}},downloads:[],hasDownloads:function(){return this.downloads.length>0},canPaste:function(){return{disabled:0==this.selectedFiles.length}},getItems:function(){return function(e){const{name:t,folder:n,isImage:o}=e,i={};return".."!=t&&(i.delete={name:"Delete",icon:"fas fa-trash"},i.rename={name:"Rename",icon:"fas fa-i-cursor"},o&&(i.makeResizedCopy={name:"Make resized copy",icon:"fas fa-compress-arrows-alt"}),n||(i.download={name:"Download",icon:"fas fa-download"}),t.toLowerCase().endsWith(".mp4")&&(i.convertToMP3={name:"Convert to MP3"}),n&&(i.zipFolder={name:"Zip Folder",icon:"fas fa-compress"}),!n&&t.endsWith(".zip")&&(i.unzipFile={name:"Unzip File",icon:"fas fa-expand-alt"})),i}}},events:{onContextMenu:async function(e,t){const{rootDir:o,name:a,idx:c,cmd:d}=t;if("download"==d){const e=n.fileUrl(o+a);$$.util.downloadUrl(e,a)}if("rename"==d){const e=a,t=await $$.ui.showPrompt({label:"New name",title:"Rename",value:e});if(console.log("newFileName",t),null!=t&&t!=e)try{const n=await i.renameFile(o,e,t);r.scope.files.updateFile(c,n)}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}}if("makeResizedCopy"==d){const e=await $$.ui.showPrompt({label:"Rescale percentage:",title:"Make resized copy",attrs:{min:10,max:90,type:"number"},value:50});if(null!=e)try{const t=await i.resizeImage(o,a,e+"%");r.scope.files.insertFile(t,c)}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}}if("convertToMP3"==d)try{s.setPercentage(0),s.show("Converting...");const e=await i.convertToMP3(o,a);l.onTopic("breizbot.mp3.progress",async t=>{if(1==t.hist)return;const{percent:o}=t.data;if(s.setPercentage(o/100),100==Math.floor(o)){await $$.util.wait(500),s.hide();const t=await n.fileInfo(e.outFileName);r.scope.files.insertFile(t,c)}})}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}if("zipFolder"==d)try{s.setPercentage(0),s.show("Zipping...");const e=await i.zipFolder(o,a);l.onTopic("breizbot.zip.progress",async t=>{if(1==t.hist)return;const{percent:o}=t.data;if(s.setPercentage(o/100),100==Math.floor(o)){await $$.util.wait(500),s.hide();const t=await n.fileInfo(e.outFileName);r.scope.files.insertFile(t,c)}})}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}if("unzipFile"==d)try{s.setPercentage(0),s.show("Unzipping...");await i.unzipFile(o,a);l.onTopic("breizbot.unzip.progress",async e=>{if(1==e.hist)return;const{percent:t}=e.data;s.setPercentage(t/100),100==Math.floor(t)&&(await $$.util.wait(500),s.hide(),r.scope.files.reload())})}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}"delete"==d&&f([{fileName:o+a,idx:c}])},onDirChange:function(e,t){r.setData({rootDir:t.newDir,nbSelection:0})},onFileClick:function(e,o){const{fileName:i,rootDir:l}=o,s=l+i;let a=$$.util.getFileType(i);i.endsWith(".hdoc")&&(a="hdoc"),null!=a&&t.pushPage("breizbot.viewer",{title:i,props:{type:a,url:n.fileUrl(s)}})},onToggleSelection:function(){r.scope.files.toggleSelection(),r.setData({nbSelection:r.scope.files.getNbSelFiles()})},onSelChange:function(e,t){const{isShareSelected:n}=t;r.setData({nbSelection:r.scope.files.getNbSelFiles(),isShareSelected:n})},onToolbarContextMenu:function(t,n){e.find(`button[data-cmd=${n.cmd}]`).click()},onToggleDownload:function(){console.log("onToggleDownload");const e=$(this).find("i"),t=$(this).siblings(".downloadItems");e.hasClass("fa-caret-right")?(e.removeClass("fa-caret-right").addClass("fa-caret-down"),t.slideDown()):(e.removeClass("fa-caret-down").addClass("fa-caret-right"),t.slideUp())},onCreateFolder:async function(){var e=r.scope.files.getRootDir();console.log("onCreateFolder",e);const t=await $$.ui.showPrompt({label:"Folder name:",title:"New Folder"});if(console.log("folderName",t),null!=t)try{const n=await i.mkdir(e+t);console.log("resp",n),r.scope.files.insertFile(n)}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}},onCopyFiles:function(e){const t=r.scope.files.getSelFileNames();r.setData({selectedFiles:t,operation:"copy"})},onDeleteFiles:function(e){const t=r.scope.files.getSelFiles();0!=t.length?f(t):$$.ui.showAlert({title:"Delete files",content:"No files selected"})},onCutFiles:function(e){const t=r.scope.files.getSelFileNames();r.setData({selectedFiles:t,operation:"cut"})},onPasteFiles:async function(e){const{rootDir:t,selectedFiles:n,operation:o}=r.model;try{"copy"==o?await i.copyFiles(n,t):await i.moveFiles(n,t),c()}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}},onReload:function(e){c()},onImportFile:function(e){$$.util.openFileDialog(e=>{console.log("files",e);for(const t of e)p(t)},!0)},onShareSelected:async function(e,t){console.log("onShareSelected",t);let n=t.cmd;try{if("$add"==n){if(null==(n=await $$.ui.showPrompt({title:"Add Group",label:"Name"})))return;await o.addSharingGroup(n),await d()}const e=r.scope.files.getSelFileNames();await i.shareFiles(e,n),c()}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}}}});function c(){r.setData({selectedFiles:[],operation:"none",nbSelection:0}),r.scope.files.reload()}async function d(){a=await o.getSharingGroups()}async function p(e){try{const t={fileName:e.name,percentage:0},{downloads:o,rootDir:i}=r.model;o.push(t),r.updateNodeTree("downloads"),console.log("uploadFile",i,e.name),await n.uploadFile(e,e.name,i,function(e){t.percentage=e,r.updateNodeTree("downloads")}),console.log("Download Finished: ",t.fileName);const l=o.indexOf(t);o.splice(l,1),r.updateNodeTree("downloads");const s=await n.fileInfo(i+t.fileName);r.scope.files.insertFile(s)}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}}function f(e){$$.ui.showConfirm({content:"Are you sure ?",title:"Delete files"},async function(){try{const t=await i.removeFiles(e.map(e=>e.fileName));console.log("resp",t),r.scope.files.removeFiles(e.map(e=>e.idx))}catch(e){console.log("resp",e),$$.ui.showAlert({content:e.responseText,title:"Error"})}})}d(),new ResizeObserver(e=>{r.model.isMobileDevice=$$.util.isMobileDevice(),r.updateNodeTree("toolbar")}).observe(e.get(0))}}),$$.service.registerService("app.folder",{deps:["breizbot.http","breizbot.broker"],init:function(e,t,n){let o;return n.on("ready",e=>{o=e.clientId}),{removeFiles:function(e){return console.log("[FileService] removeFiles",e),t.post("/delete",e)},mkdir:function(e){return console.log("[FileService] mkdir",e),t.post("/mkdir",{fileName:e})},moveFiles:function(e,n){return console.log("[FileService] moveFiles",e,n),t.post("/move",{fileNames:e,destPath:n})},shareFiles:function(e,n){return console.log("[FileService] shareFiles",e),t.post("/move",{fileNames:e,destPath:`/share/${n}`})},copyFiles:function(e,n){return console.log("[FileService] copyFiles",e,n),t.post("/copy",{fileNames:e,destPath:n})},renameFile:function(e,n,o){return console.log("[FileService] renameFile",e,n,o),t.post("/rename",{filePath:e,oldFileName:n,newFileName:o})},resizeImage:function(e,n,o){return console.log("[FileService] resizeImage",e,n,o),t.post("/resizeImage",{filePath:e,fileName:n,resizeFormat:o})},convertToMP3:function(e,n){return console.log("[FileService] convertToMP3",e,n),t.post("/convertToMP3",{filePath:e,fileName:n,srcId:o})},zipFolder:function(e,n){return console.log("[FileService] zipFolder",e,n),t.post("/zipFolder",{folderPath:e,folderName:n,srcId:o})},unzipFile:function(e,n){return console.log("[FileService] unzipFile",e,n),t.post("/unzipFile",{folderPath:e,fileName:n,srcId:o})}}}});