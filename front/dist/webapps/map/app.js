$$.control.registerControl("rootPage",{deps:["breizbot.broker","breizbot.appData","breizbot.pager","breizbot.radar","breizbot.files"],template:'<div class="toolbar">\n\t<div class="location">\n\t\t<label>Geolocation</label>\n\t\t<div \n\t\t\tbn-control="brainjs.flipswitch"\n\t\t\tbn-event="flipswitchchange: onLocationChange"\n\t\t\t>\n\t\t\t\n\t\t</div>\t\t\n\t</div>\n\n\t<div bn-style="{visibility: show1}">\n\t\t<button class="w3-button" bn-event="click: onSearch" title="Search city">\n\t\t\t<i class="fa fa-search-location"></i>\n\t\t</button>\t\t\n\t</div>\n\n</div>\n\n\n<div bn-control="brainjs.map" \n\tstyle="height: 100%"\n\tbn-iface="map"\n\tclass="map" \n\tbn-data="{\n\t\tcenter, \n\t\tzoom, \n\t\tscale: true, \n\t\tcoordinates: true,\n\t\tcontextMenu: {\n\t\t\taddMarker: {\n\t\t\t\tname: \'Add Marker\'\n\t\t\t}\n\t\t},\n\t\tlayers: {\n\t\t\tfriends: {label: \'Friends\', visible: true},\n\t\t\tmarkers: {label: \'Markers\', visible: true},\n\t\t\tradar: {label: \'Radar\', visible: false, cluster: true}\n\t\t}\n\t}"\n\tbn-event="mapcontextmenu: onMapContextMenu, mapshapecontextmenu: onShapeContextMenu"\n\t></div>\t\n',init:function(t,n,e,o,a,r){let{zoom:i,center:s,markers:c}=e.getData();console.log("appData",e.getData()),c=c||{};const l=$$.viewController(t,{data:{center:s||{lat:48.39,lng:-4.486},zoom:i||13,watchID:null,show1:function(){return null==this.watchID?"visible":"hidden"}},events:{onShapeContextMenu:function(t,n){const{id:e,cmd:o}=n;if("remove"==o&&(u.removeShape(e),delete c[e]),"zoom"==o){const t=u.getShapeInfo(e);u.flyTo(t.latlng,13)}},onMapContextMenu:async function(t,n){const{latlng:e}=n,o=await $$.ui.showPrompt({title:"Add Marker",label:"Tooltip"});if(o){const t="ID"+Date.now();d(t,e,o),c[t]={latlng:e,tooltip:o}}},onSearch:function(){o.pushPage("searchPage",{title:"Search City",onReturn:function(t){const n={lat:t.lat,lng:t.lon};try{u.updateShape("marker",{latlng:n})}catch(t){u.addShape("marker",{type:"marker",latlng:n})}u.flyTo(n,13)}})},onLocationChange:function(t,n){if(n){navigator.geolocation.getCurrentPosition(h);const t=navigator.geolocation.watchPosition(h,b,{enableHighAccuracy:!0});l.setData({watchID:t})}else navigator.geolocation.clearWatch(l.model.watchID),l.setData({watchID:null}),u.removeShape("location")}}}),u=l.scope.map,p={"Radar fixe":r.assetsUrl("radar_fixe.png"),"Radar feu rouge":r.assetsUrl("radar_feu_rouge.png"),"Radar discriminant":r.assetsUrl("radar_discriminant.png"),"Radar Vitesse Moyenne":r.assetsUrl("radar_vitesse_moyenne.png")};function d(t,n,e){const o={type:"marker",layer:"markers",latlng:n,icon:{type:"font",className:"far fa-dot-circle",color:"green",fontSize:20},popup:{content:e,className:"myToolTip",closeButton:!1},contextMenu:{remove:{name:"Remove",iconCls:"fas fa-trash-alt w3-text-blue"},zoom:{name:"Zoom",iconCls:"fas fa-search-plus w3-text-blue"}}};u.addShape(t,o)}function b(){console.log("geolocation error")}function h(t){const n={lat:t.coords.latitude,lng:t.coords.longitude};try{u.updateShape("location",{latlng:n})}catch(t){u.addShape("location",{type:"marker",icon:{type:"font",className:"far fa-dot-circle",color:"red",fontSize:20},latlng:n})}u.panTo(n)}!async function(){for(let[t,n]of Object.entries(c))d(t,n.latlng,n.tooltip);const t=await a.getRadar();console.log({radars:t}),u.addGeoData(t,"radar",{pointToLayer:(t,n)=>{const e=p[t.properties.type];if(null!=e){const t={iconSize:[91,99],iconAnchor:[40,99],popupAnchor:[20,-85],iconUrl:e};return u.createMarkerIcon(n,t)}},onPopup:t=>{let n=[];t.properties.route&&n.push(t.properties.route),n.push(t.properties.type);const{speed:e}=t.properties;if("number"==typeof e){const t=r.assetsUrl(`vitesse-${e}.png`);n.push(`<img src="${t}" style="margin-top: 10px">`)}return`<b>${n.join("<br>")}</b>`}})}(),n.register("breizbot.friendPosition",t=>{if(t.hist)return;const n=t.data,e=new Date(t.time).toLocaleTimeString("fr-FR"),o="friends."+n.userName,a=n.userName+"<br>"+e;try{u.updateShape(o,{latlng:n.coords,popupContent:a})}catch(t){u.addShape(o,{type:"marker",layer:"friends",latlng:n.coords,icon:{type:"font",className:"far fa-user",color:"blue",fontSize:20},popup:{content:a,className:"myToolTip",closeButton:!1}})}}),n.register("homebox.map.updateShape.*",t=>{const n=t.topic.split(".").pop(),e=t.data;if(null!=e)try{u.updateShape(n,e)}catch(t){u.addShape(n,e)}else u.removeShape(n)}),this.onAppExit=function(){return e.saveData({zoom:u.getZoom(),center:u.getCenter(),markers:c})}}}),$$.control.registerControl("searchPage",{template:'<form bn-event="submit: onSubmit" bn-show="show1">\n\t<div class="inputgroup">\n\t\t<label>Country:</label>\n\t\t<span \n\t\t\tbn-control="brainjs.combobox"\n\t\t\tbn-data="{items: countries}"\n\t\t\tbn-val="currentCountry"\n\t\t\tbn-update="comboboxchange"\n\t\t></span>\t\t\t\n\t</div>\n\t<div bn-control="brainjs.inputgroup" class="inputgroup">\n\t\t<label>City</label>\n\t\t<input type="text" name="search" required="">\n\t</div>\n\t<div>\n\t\t<button class="w3-button w3-blue" type="submit">\n\t\t\t<i class="fa fa-search"></i>\n\t\t</button>\n\t</div>\n\n</form>\n\n<div>\n\t<strong bn-text="message"></strong>\n</div>\n\n<div bn-show="running">\n\t<i class="fa fa-spinner fa-pulse"></i> Running...\n</div>\n\n<div class="scrollPanel" bn-show="show2">\n\t<ul class="w3-ul w3-border w3-white" \n\t\tbn-event="click.w3-bar: onItemClick"\n\t\tbn-each="cities"\n\t\tbn-show="show3"\n\t\t>\n\t\t<li class="w3-bar">\n\n\t\t\t<div class="w3-bar-item">\n\t\t\t\t<span bn-text="$scope.$i.name"></span>\n\t\t\t</div>\n\t\t</li>\n\t</ul>\t\n</div>\n\t',deps:["breizbot.cities","breizbot.pager"],init:function(t,n,e){const o=$$.viewController(t,{data:{countries:[],currentCountry:"",cities:[],message:"",running:!1,show1:function(){return this.countries.length>0},show2:function(){return this.countries.length>0&&this.cities.length>0},show3:function(){return this.cities.length>0}},events:{onSubmit:async function(t){t.preventDefault(),console.log("onSubmit");const{search:e}=$(this).getFormData();o.setData({message:"",running:!0});const a=await n.getCities(o.model.currentCountry,e);console.log("cities",a);const r=a.length;o.setData({running:!1,cities:a,message:0==r?"No result":`${r} match`})},onItemClick:function(t){const n=$(this).index(),a=o.model.cities[n];console.log("onItemClick",a),e.popPage(a.coord)}}});!async function(){const t=await n.getCountries();o.setData({countries:t,currentCountry:"FR"})}()}});