$$.control.registerControl("rootPage",{template:'<div class="toolbar">\n    <div>Accounts</div>\n\t<button \n\t\tclass="w3-button" \n\t\ttitle="Add Account"\n        bn-event="click: onAddAccount"\n        bn-icon="fa fa-plus"\n\n\t></button>\t\n</div>\n\n<p bn-show="!hasAccounts">You have no account</p>\n<div class="scrollPanel">\n\t<ul class="w3-ul w3-border w3-white" \n        bn-each="accounts"\n        bn-event="contextmenuchange.w3-bar: onContextMenu, click.w3-bar: onItemClick"\n\t\tbn-show="hasAccounts"\n\t\t>\n\t\t<li class="w3-bar" bn-control="brainjs.contextmenu" bn-data="{items: contextMenu}">\n\n\n\t\t\t<div class="w3-bar-item">\n\t\t\t\t<div class="info">\n\t\t\t\t\t<strong bn-text="$scope.$i.name"></strong><br>\n\t\t\t\t\t<span class="w3-right" bn-text="formatAmount"></span>\t\n\t\t\t\t</div>\n\t\t\t\t<div class="synthesis">\n\t\t\t\t\t<div class="w3-text-grey">Current Month Synthesis</div>\n\t\t\t\t\t<div class="w3-text-green">\n\t\t\t\t\t\t<label>Income</label>\n\t\t\t\t\t\t<span bn-text="formatIncome"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="w3-text-red">\n\t\t\t\t\t\t<label>Expenses</label>\n\t\t\t\t\t\t<span bn-text="formatExpenses"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label>Difference</label>\n\t\t\t\t\t\t<span bn-text="getDifference"></span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</li>\n\t</ul>\t\t\n\n</div>',deps:["breizbot.pager","breizbot.http"],init:function(t,n,e){const a=$$.viewController(t,{data:{accounts:[],formatAmount:function(t){return t.$i.finalBalance.toFixed(2)},hasAccounts:function(){return this.accounts.length>0},contextMenu:function(){return{edit:{name:"Edit",icon:"fas fa-edit"},delete:{name:"Delete",icon:"fas fa-trash-alt"}}},getDifference:function(t){const{income:n,expenses:e}=t.$i.synthesis;return(n-e).toFixed(2)},formatIncome:function(t){return t.$i.synthesis.income.toFixed(2)},formatExpenses:function(t){return t.$i.synthesis.expenses.toFixed(2)}},events:{onAddAccount:function(){console.log("onAddAccount"),n.pushPage("addAccount",{title:"Add Account",onReturn:async function(t){await e.post("/account",t),o()}})},onContextMenu:function(t,i){const s=$(this).index(),c=a.model.accounts[s],r=c._id.toString(),{cmd:l}=i;"delete"==l?$$.ui.showConfirm({title:"Delete Account",content:"Are you sure ?"},async()=>{await e.delete(`/account/${r}`),o()}):"edit"==l&&n.pushPage("addAccount",{title:"Edit Account",props:{formData:c},onReturn:async function(t){const n=$.extend(c,t);delete n._id,delete n.synthesis,await e.put(`/account/${r}`,n),o()}})},onItemClick:function(t){const e=$(this).index(),i=a.model.accounts[e];n.pushPage("transactions",{title:`${i.name} Transactions`,props:{accountInfo:i},onBack:function(){o()}})}}});async function o(){const t=await e.get("/account",{synthesis:1});a.setData({accounts:t})}o()}}),$$.control.registerControl("addAccount",{template:'<div>\n    <form bn-event="submit: onSubmit" bn-form="formData">\n        <label>Account Name</label>\n        <input type="text" name="name" required>\n    \n        <label>Currency</label>\n        <div bn-control="brainjs.combobox" bn-data="{\n            items: [\'euro\', \'dollar\']\n        }" name="currency"></div>\n    \n        <label>Initial Balance</label>\n        <input type="number" required name="initialBalance" step="0.01">\n\n        <label>Held at</label>\n        <input type="text" name="heldAt">\n        \n    \n    \n        <input type="submit" bn-bind="submit" hidden>\n    </form>\n</div>\n',deps:["breizbot.pager"],props:{formData:{currency:"euro"}},init:function(t,n){const{formData:e}=this.props,a=$$.viewController(t,{data:{formData:e},events:{onSubmit:function(t){t.preventDefault();const e=$(this).getFormData();n.popPage(e)}}});this.getButtons=function(){return{apply:{icon:"fa fa-check",title:"Apply",onClick:function(){a.scope.submit.click()}}}}}}),$$.control.registerControl("addTransaction",{template:'<div class="scrollPanel">\n    <form bn-form="formData" bn-event="submit: onSubmit">\n\n        <div class="group">\n            <label>Date</label>\n            <div>\n                <input bn-control="brainjs.datepicker" name="date">    \n            </div>\n    \n        </div>\n\n        <div class="group">\n            <label>Transaction Type</label>\n            <div bn-control="brainjs.radiogroup" bn-update="radiogroupchange" bn-val="type">\n                <div bn-control="brainjs.inputgroup">\n                    <input type="radio" value="debit"><label>Debit</label>\n                </div>\n                <div bn-control="brainjs.inputgroup">\n                    <input type="radio" value="credit"><label>Credit</label>\n                </div>\n                <div bn-control="brainjs.inputgroup" bn-show="isAdd">\n                    <input type="radio" value="transfer"><label>Transfer</label>\n                </div>\n            </div>    \n        </div>\n\n        <div class="group">\n            <label>Amount</label>\n            <div>\n                <input type="number" required name="amount" step=0.01>\n            </div>\n        </div>\n\n        <div class="group" bn-show="isTransfer">\n            <label>To Account</label>\n            <div>\n                <div bn-control="brainjs.combobox" bn-data="{items: accounts}" bn-iface="toAccount"></div>\n            </div>\n        </div>      \n\n        <div class="group" bn-show="!isTransfer">\n            <label>Payee</label>\n            <div>\n                <input type="text" bn-prop="{required: !isTransfer}" name="payee" bn-control="brainjs.autocomplete" bn-data="{source: payees}">\n            </div>\n        </div>\n\n        <div class="group" bn-show="!isTransfer">\n            <label>Number</label>\n            <div>\n                <input type="number" name="number" step="1" bn-bind="number">\n                <button type="button" class="w3-btn w3-blue" bn-event="click: onFindNextNumber">Next</button>\n            </div>\n        </div>\n\n        <div class="group" bn-show="!isTransfer">\n            <label>Category</label>\n            <div>\n                <input type="text" bn-prop="{required: !isTransfer}" name="category" bn-control="brainjs.autocomplete" bn-data="{source: categories}" bn-event="autocompleteselect: onCategoryChange">\n            </div>\n        </div>\n\n        <div class="group" bn-show="!isTransfer">\n            <label>Subcategory</label>\n            <div>\n                <input type="text" name="subcategory" bn-control="brainjs.autocomplete" bn-data="{source: subcategories}">\n            </div>\n        </div>\n\n        <div class="group">\n            <label>Note</label>\n            <div>\n                \x3c!-- <i class="fa fa-clipboard"></i> --\x3e\n                <input type="text" name="memo">\n            </div>\n        </div>\n\n        <input type="submit" hidden bn-bind="submit">\n    </form>\n</div>',deps:["breizbot.pager","breizbot.http"],props:{accountId:null,isAdd:!1,formData:{type:"debit"}},init:function(t,n,e){const{accountId:a,formData:o,isAdd:i}=this.props,{type:s}=o;delete o.type;const c=$$.viewController(t,{data:{formData:o,categories:[],payees:[],subcategories:[],type:s,isAdd:i,isTransfer:function(){return"transfer"===this.type}},events:{onSubmit:function(t){t.preventDefault();const e=$(this).getFormData();e.type=c.model.type,e.toAccount=c.scope.toAccount.getSelItem(),n.popPage(e)},onCategoryChange:async function(t,n){const o=await e.get(`/account/${a}/subcategories`,{category:n.item.value});c.setData({subcategories:o})},onFindNextNumber:async function(){const{number:t}=await e.get(`/account/${a}/lastNumber`);c.scope.number.val(t+1)}}});!async function(){const t=await e.get(`/account/${a}/categories`),n=await e.get(`/account/${a}/payees`);let o=await e.get("/account");o=o.filter(t=>t._id.toString()!=a).map(t=>({label:t.name,value:t._id.toString()})),c.setData({payees:n,categories:t,accounts:o})}(),this.getButtons=function(){return{apply:{title:"Appply",icon:"fa fa-check",onClick:function(){c.scope.submit.click()}}}}}}),$$.control.registerControl("transactions",{template:'<div class="scrollPanelTable">\n\t<table class="w3-table-all w3-hoverable w3-small">\n\t\t<thead>\n\t\t\t<tr>\n                <th>Payee</th>\n                <th>Category</th>\n\t\t\t\t<th>Date</th>\n\t\t\t\t<th>S</th>\n\t\t\t\t<th>Number</th>\n                <th>Amount</th>\n\t\t\t</tr>\n\t\t</thead>\n\t\t<tbody bn-each="transactions" bn-lazzy="getItems" bn-bind="transactions" bn-event="contextmenuchange.item: onItemContextMenu">\n\t\t\t<tr class="item" bn-control="brainjs.contextmenu" bn-data="{items: {\n\t\t\t\tdel: {\n\t\t\t\t\tname: \'Delete\',\n\t\t\t\t\ticon: \'fas fa-trash-alt\'\n\t\t\t\t},\n\t\t\t\tedit: {\n\t\t\t\t\tname: \'Edit\',\n\t\t\t\t\ticon: \'fas fa-edit\'\n\t\t\t\t}\n\t\t\t}}">\n                <td bn-text="$scope.$i.payee"></td>\n                <td>\n\t\t\t\t\t<span bn-text="$scope.$i.category"></span><br>\n\t\t\t\t\t<span bn-text="$scope.$i.subcategory"></span>\n\t\t\t\t</td>\n\t\t\t\t<td bn-text="formatDate" class="date"></td>\n\t\t\t\t<td bn-text="$scope.$i.clearedStatus"></td>\n\t\t\t\t<td bn-text="$scope.$i.number"></td>\n\t\t\t\t<td bn-text="formatAmount" class="amount" bn-style="{color: getAmountColor}"></td>\n\t\t\t</tr>\n\t\t</tbody>\n\t</table>\n</div>',deps:["breizbot.pager","breizbot.http"],props:{accountInfo:null},init:function(t,n,e){const{accountInfo:a}=this.props,o=a._id.toString(),i=$$.viewController(t,{data:{transactions:[],formatAmount:function(t){return t.$i.amount.toFixed(2)},formatDate:function(t){return new Date(t.$i.date).toLocaleDateString()},getItems:async function(t){return c(t)},getAmountColor:function(t){return t.$i.amount<0?"red":"black"}},events:{onItemContextMenu:function(t,a){const c=$(this).index(),{cmd:r}=a,l=i.model.transactions[c];if("del"==r)$$.ui.showConfirm({title:"Delete Transaction",content:"Are you sure ?"},async()=>{await e.delete("/transaction/",l),i.removeArrayItem("transactions",c,"transactions")});else if("edit"==r){l.amount<0?(l.type="debit",l.amount*=-1):l.type="credit";const t=l._id.toString();n.pushPage("addTransaction",{title:"Edit Transaction",props:{formData:l},onReturn:async function(n){await s(n),await e.put(`/account/${o}/transaction/${t}`,n),i.updateArrayItem("transactions",c,n,"transactions")}})}}}});async function s(t){let{date:n,toAccount:o}=t;if(n=`${n.getFullYear()}-${n.getMonth()+1}-${n.getDate()}T00:00:00`,t.date=n,"transfer"==t.type){const i={date:n,category:"virement",payee:a.name,amount:t.amount};await e.post(`/account/${o.value}/transaction`,i);t.category="virement",t.amount*=-1,t.payee=o.label,delete t.toAccount}else"debit"==t.type&&(t.amount*=-1);delete t.type,isNaN(t.number)&&delete t.number}async function c(t){t=t||0;const n=await e.get(`/account/${o}/transactions?offset=${t}`);if(0!=t)return i.model.transactions=i.model.transactions.concat(n),n;i.setData({transactions:n})}function r(){n.pushPage("breizbot.files",{title:"Import transactions from QIF file",props:{filterExtension:"qif"},events:{fileclick:function(t,e){n.popPage(e)}},onReturn:async function(t){const n=t.rootDir+t.fileName;await e.post(`/account/${o}/importTransactions`,{fileName:n}),c()}})}c(),this.getButtons=function(){return{import:{title:"import from QIF file",icon:"fa fa-download",onClick:function(){$$.ui.showConfirm({title:"Import Transactions",content:"This operation will remove all your current transactions<br><br>Are you sure ?"},r)}},add:{title:"Add Transaction",icon:"fa fa-plus",onClick:function(){n.pushPage("addTransaction",{title:"Add Transaction",props:{accountId:o,isAdd:!0},onReturn:async function(t){await s(t);const{insertedId:n}=await e.post(`/account/${o}/transaction`,t);t._id=n,i.insertArrayItemAfter("transactions",0,t,"transactions")}})}}}}}});