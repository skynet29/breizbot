$$.service.registerService("actionSrv",{deps:["hub"],init:function(e,t){let n={};const o=new EventEmitter2;async function i(e,n,o){if("SLEEP"==n.type)return void await $$.util.wait(n.time);const i=e.find(e=>e.hubId==n.hub);if(!i)return`Hub ${n.hub} is not connected`;{const{hubDevice:e}=i;if("POWER"==n.type){const i=e.getMotor(t.PortMap[n.port]);await i.setPower(n.power*o)}else if("SPEED"==n.type){const i=e.getMotor(t.PortMap[n.port]);await i.setSpeed(n.speed*o)}else if("SPEEDTIME"==n.type){const o=e.getMotor(t.PortMap[n.port]);await o.setSpeedForTime(n.speed,n.time,n.waitFeedback,n.brakeStyle)}else if("ROTATE"==n.type){const i=e.getMotor(t.PortMap[n.port]);await i.rotateDegrees(n.angle*o,n.speed,n.waitFeedback)}else if("POSITION"==n.type){const i=e.getMotor(t.PortMap[n.port]),a=e.calibration[t.PortMap[n.port]]||1;console.log({calibFactor:a}),await i.gotoAngle(n.angle*o*a,n.speed,n.waitFeedback)}else if("ZERO"==n.type){const o=e.getMotor(t.PortMap[n.port]);await o.resetZero()}else if("COLOR"==n.type){const o=e.getLed(t.PortMap.HUB_LED);await o.setColor(n.color)}else if("RGB"==n.type){const o=e.getLed(t.PortMap.HUB_LED);await o.setRGBColor(n.red,n.green,n.blue)}else if("CALIBRATE"==n.type){const o=e.getMotor(t.PortMap[n.port]);await o.calibrate()}else if("DBLSPEED"==n.type){const i=t.PortMap[n.port1],a=t.PortMap[n.port2],s=await e.getDblMotor(i,a);await s.setSpeed(n.speed1*o,n.speed2*o)}else if("DBLSPEEDTIME"==n.type){const o=t.PortMap[n.port1],i=t.PortMap[n.port2],a=await e.getDblMotor(o,i);await a.setSpeedForTime(n.speed1,n.speed2,n.time,n.waitFeedback,n.brakeStyle)}else if("DBLROTATE"==n.type){const i=t.PortMap[n.port1],a=t.PortMap[n.port2],s=await e.getDblMotor(i,a);await s.rotateDegrees(n.angle,n.speed1*o,n.speed2*o,n.waitFeedback,n.brakeStyle)}else{if("DBLPOSITION"!=n.type)return`type ${n.type} not implemented`;{const i=t.PortMap[n.port1],a=t.PortMap[n.port2],s=await e.getDblMotor(i,a);await s.gotoAngle(n.angle1,n.angle2,n.speed*o,n.waitFeedback,n.brakeStyle)}}}return null}return{execAction:async function e(t,a,s,r){const l=a.find(e=>e.name==s);let{steps:c}=l;Array.isArray(c)||(c=[l]);for(const s of c)if("SETVAR"==s.type){const{varName:e,varValue:t}=s;n[e]=t,o.emit("varChange",{varName:e,varValue:t})}else if("TESTVAR"==s.type){const{varName:o}=s,i=n[o];i==s.varValue&&"None"!=s.eqAction&&e(t,a,s.eqAction,1),i!=s.varValue&&"None"!=s.neqAction&&e(t,a,s.neqAction,1)}else{const e=await i(t,s,r);if(null!=e){$.notify(e,"error");break}}},on:o.on.bind(o),getVariables:function(){return Object.entries(n).map(([e,t])=>({name:e,value:t}))},resetVariables:function(){n={},o.emit("varChange")}}}}),function(){const e=function(...e){0},{getEnumName:t}=$$.util,n="00001623-1212-efde-1623-785feabcd123",o="00001624-1212-efde-1623-785feabcd123",i={DETACHED_IO:0,ATTACHED_IO:1,ATTACHED_VIRTUAL_IO:2},a=t(i),s={HUB_PROPERTIES:1,HUB_ACTIONS:2,HUB_ALERTS:3,HUB_ATTACHED_IO:4,GENERIC_ERROR_MESSAGES:5,HW_NETWORK_COMMANDS:8,FW_UPDATE_GO_INTO_BOOT_MODE:16,FW_UPDATE_LOCK_MEMORY:17,FW_UPDATE_LOCK_STATUS_REQUEST:18,FW_LOCK_STATUS:19,PORT_INFORMATION_REQUEST:33,PORT_MODE_INFORMATION_REQUEST:34,PORT_INPUT_FORMAT_SETUP_SINGLE:65,PORT_INPUT_FORMAT_SETUP_COMBINEDMODE:66,PORT_INFORMATION:67,PORT_MODE_INFORMATION:68,PORT_VALUE_SINGLE:69,PORT_VALUE_COMBINEDMODE:70,PORT_INPUT_FORMAT_SINGLE:71,PORT_INPUT_FORMAT_COMBINEDMODE:72,VIRTUAL_PORT_SETUP:97,PORT_OUTPUT_COMMAND:129,PORT_OUTPUT_COMMAND_FEEDBACK:130},r=t(s),l={UNKNOWN:0,SIMPLE_MEDIUM_LINEAR_MOTOR:1,TRAIN_MOTOR:2,LIGHT:8,VOLTAGE_SENSOR:20,CURRENT_SENSOR:21,PIEZO_BUZZER:22,HUB_LED:23,TILT_SENSOR:34,MOTION_SENSOR:35,COLOR_DISTANCE_SENSOR:37,MEDIUM_LINEAR_MOTOR:38,MOVE_HUB_MEDIUM_LINEAR_MOTOR:39,MOVE_HUB_TILT_SENSOR:40,DUPLO_TRAIN_BASE_MOTOR:41,DUPLO_TRAIN_BASE_SPEAKER:42,DUPLO_TRAIN_BASE_COLOR_SENSOR:43,DUPLO_TRAIN_BASE_SPEEDOMETER:44,TECHNIC_LARGE_LINEAR_MOTOR:46,TECHNIC_XLARGE_LINEAR_MOTOR:47,TECHNIC_MEDIUM_ANGULAR_MOTOR:48,TECHNIC_LARGE_ANGULAR_MOTOR:49,TECHNIC_MEDIUM_HUB_GEST_SENSOR:54,REMOTE_CONTROL_BUTTON:55,REMOTE_CONTROL_RSSI:56,TECHNIC_MEDIUM_HUB_ACCELEROMETER:57,TECHNIC_MEDIUM_HUB_GYRO_SENSOR:58,TECHNIC_MEDIUM_HUB_TILT_SENSOR:59,TECHNIC_MEDIUM_HUB_TEMPERATURE_SENSOR:60,TECHNIC_COLOR_SENSOR:61,TECHNIC_DISTANCE_SENSOR:62,TECHNIC_FORCE_SENSOR:63,TECHNIC_3X3_COLOR_LIGHT_MATRIX:64,TECHNIC_SMALL_ANGULAR_MOTOR:65,MARIO_ACCELEROMETER:71,MARIO_BARCODE_SENSOR:73,MARIO_PANTS_SENSOR:74,TECHNIC_MEDIUM_ANGULAR_MOTOR_GREY:75,TECHNIC_LARGE_ANGULAR_MOTOR_GREY:76,VIRTUAL_DEVICE:100},c=t(l),d=t({ACK:1,MACK:2,BUFFER_OVERFLOW:3,TIMEOUT:4,COMMAND_NOT_RECOGNIZED:5,INVALID_USE:6,OVERCURRENT:7,INTERNAL_ERROR:8}),b={ADVERTISING_NAME:1,BUTTON_STATE:2,FW_VERSION:3,HW_VERSION:4,RSSI:5,BATTERY_VOLTAGE:6,BATTERY_TYPE:7,MANUFACTURER_NAME:8,RADIO_FIRMWARE_VERSION:9,LWP_PROTOCOL_VERSION:10,SYSTEM_TYPE_ID:11,HW_NETWORK_ID:12,PRIMARY_MAC_ADDRESS:13,SECONDARY_MAC_ADDRESS:14,HW_NETWORK_FAMILY:15},p=t(b),u={NAME:0,RAW:1,PCT:2,SI:3,SYMBOL:4,MAPPING:5,USED_INTERNALLY:6,MOTOR_BIAS:7,CAPABILITY_BITS:8,VALUE_FORMAT:128},m=t(u),h={BLACK:0,PINK:1,PURPLE:2,BLUE:3,LIGHT_BLUE:4,CYAN:5,GREEN:6,YELLOW:7,ORANGE:8,RED:9,WHITE:10,NONE:255},v={A:0,B:1,C:2,D:3,HUB_LED:50,CURRENT_SENSOR:59,VOLTAGE_SENSOR:60,ACCELEROMETER:97,GYRO_SENSOR:98,TILT_SENSOR:99},g={POWER:0,SPEED:1,ROTATION:2,ABSOLUTE:3,COLOR:0,RGB:1,TILT_POS:0},f={FLOAT:0,HOLD:126,BRAKE:127},E=t(v);function T(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength&&0!=t[e];e++)n+=String.fromCharCode(t[e]);return n}function I(e){const t=new Uint8Array(2);return new DataView(t.buffer).setInt16(0,e,!0),Array.from(t)}function A(e){const t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),Array.from(t)}function R(e,...t){const n=t.flat(2),o=n.length+3,i=new ArrayBuffer(o),a=new Uint8Array(i);return a[0]=o,a[1]=0,a[2]=e,a.set(n,3),i}const O=100;class C{constructor(e,t){this.hubDevice=e,this.portId=t}async setColor(e){return console.log("setColor",this.portId,{color:e}),await this.hubDevice.setPortFormat(this.portId,g.COLOR),this.hubDevice.writeDirect(this.portId,g.COLOR,!1,e)}async setRGBColor(e,t,n){return console.log("setColor",this.portId,{r:e,g:t,b:n}),await this.hubDevice.setPortFormat(this.portId,g.RGB),this.hubDevice.writeDirect(this.portId,g.RGB,!1,e,t,n)}}class S{constructor(e,t){this.hubDevice=e,this.portId=t}setPower(e){return console.log("setPower",this.portId,{power:e}),this.hubDevice.writeDirect(this.portId,g.POWER,!1,e)}setSpeed(e){return console.log("setSpeed",this.portId,{speed:e}),this.hubDevice.writePortCommand(this.portId,!1,7,e,O,0)}rotateDegrees(e,t,n,o=f.BRAKE){return console.log("rotateDegrees",this.portId,{degrees:e,speed:t,waitFeedback:n,brakingStyle:o}),this.hubDevice.writePortCommand(this.portId,n,11,A(e),t,O,o)}gotoAngle(e,t,n,o=f.BRAKE){console.log("gotoAngle",this.portId,{angle:e,speed:t,waitFeedback:n,brakingStyle:o});const i=this.hubDevice.portValue[this.portId];return this.hubDevice.portValue[this.portId]=e,console.log({portValue:i}),null==i?this.hubDevice.writePortCommand(this.portId,n,13,A(e),t,O,o):Math.abs(e-i)>1?this.hubDevice.writePortCommand(this.portId,n,13,A(e),t,O,o):Promise.resolve()}setSpeedForTime(e,t,n=!1,o=f.BRAKE){return console.log("setSpeedForTime",this.portId,{speed:e,time:t,waitFeedback:n,brakingStyle:o}),this.hubDevice.writePortCommand(this.portId,n,9,I(t),e,O,o)}resetZero(){return console.log("resetZero",this.portId),this.hubDevice.writeDirect(this.portId,g.ROTATION,!0,0,0,0,0)}waitAlert(){return new Promise(e=>{this.hubDevice.once("hubAlerts",async t=>{console.log("hubAlerts",t),e()})})}async calibrate(){console.log("calibrate",this.portId),this.setPower(50),await this.hubDevice.waitTestValue(this.portId,g.SPEED,e=>e>10),await this.hubDevice.waitTestValue(this.portId,g.SPEED,e=>0==e),this.setPower(0),await $$.util.wait(1e3),await this.resetZero(),this.setPower(-50),await this.hubDevice.waitTestValue(this.portId,g.SPEED,e=>Math.abs(e)>10),await this.hubDevice.waitTestValue(this.portId,g.SPEED,e=>0==e),this.setPower(0);const e=await this.hubDevice.getPortValue(this.portId,g.ROTATION);console.log(e);const t=Math.floor(e/2);console.log({offset:t}),await this.gotoAngle(t,10,!0),await this.resetZero(),this.hubDevice.calibration[this.portId]=Math.abs(t)}}class _{constructor(e,t,n){this.hubDevice=e,this.portId1=t,this.portId2=n}async create(){const e=await this.hubDevice.createVirtualPort(this.portId1,this.portId2);await $$.util.wait(100),this.portId=this.hubDevice.getPortIdFromName(e),console.log("portId",this.portId)}setSpeed(e,t){this.hubDevice;return this.hubDevice.writePortCommand(this.portId,!1,8,e,t,O,0)}setSpeedForTime(e,t,n,o=!1,i=f.BRAKE){return console.log("setSpeedForTime",this.portId,{speed1:e,speed2:t,time:n,waitFeedback:o,brakingStyle:i}),this.hubDevice.writePortCommand(this.portId,o,10,I(n),e,t,O,i)}rotateDegrees(e,t,n,o,i=f.BRAKE){return console.log("rotateDegrees",this.portId,{degrees:e,speed1:t,speed2:n,waitFeedback:o,brakingStyle:i}),this.hubDevice.writePortCommand(this.portId,o,12,A(e),t,n,O,i)}gotoAngle(e,t,n,o,i=f.BRAKE){console.log("gotoAngle",this.portId,{angle1:e,angle2:t,speed:n,waitFeedback:o,brakingStyle:i});this.hubDevice.portValue[this.portId];return this.hubDevice.writePortCommand(this.portId,o,14,A(e),A(t),n,O,i)}}function w(e,t){return`${E[e]}_${E[t]}`}class P extends EventEmitter2{constructor(){super(),this.charac=null,this.deviceModes={},this.portCmdQueue={},this.portCmdCallback={},this.calibration={},this.hubDevices={},this.portValue={},this.busy=!1,this.cmdQueue=[]}async init(t){const i=await t.gatt.connect();e("Connected");const a=await i.getPrimaryService(n);this.charac=await a.getCharacteristic(o);const s=e=>{this.decodeMsg(e.target.value)};t.addEventListener("gattserverdisconnected",()=>{console.log("onGattServerDisconnected",this),this.charac.removeEventListener("characteristicvaluechanged",s),this.charac=null,this.emit("disconnected")}),this.charac.addEventListener("characteristicvaluechanged",s),await this.charac.startNotifications(),await $$.util.wait(100)}async startNotification(){await this.sendMsg(s.HUB_PROPERTIES,b.BATTERY_VOLTAGE,2),await this.sendMsg(s.HUB_PROPERTIES,b.SYSTEM_TYPE_ID,5),await this.sendMsg(s.HUB_PROPERTIES,b.PRIMARY_MAC_ADDRESS,5),await this.sendMsg(s.HUB_ALERTS,1,1)}getMotor(e){return new S(this,e)}getLed(e){return new C(this,e)}async getDblMotor(e,t){const n=new _(this,e,t);return await n.create(),n}async sendBuffer(t){e("sendBuffer",t),this.busy?(e("busy push in queue"),this.cmdQueue.push(t)):(this.busy=!0,await this.charac.writeValueWithoutResponse(t),this.busy=!1,this.cmdQueue.length>0&&await this.sendBuffer(this.cmdQueue.shift()))}sendMsg(t,...n){return e("sendMsg",r[t],n),this.sendBuffer(R(t,n))}writeDirect(t,n,o,...i){return e("writeDirect",{portId:t,mode:n,waitFeedback:o}),this.writePortCommand(t,o,81,n,i)}setPortFormat(t,n,o=null,i=1){const a="function"==typeof o;return e("setPortFormat",{portId:t,mode:n,notificationEnabled:a}),this.deviceModes[t]={mode:n,cbk:o},this.sendMsg(s.PORT_INPUT_FORMAT_SETUP_SINGLE,t,n,function(e){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),Array.from(t)}(i),a?1:0)}getPortIdFromName(e){for(const[t,n]of Object.entries(this.hubDevices))if(n.portName==e)return parseInt(t)}async createVirtualPort(e,t){const n=w(e,t);console.log("createVirtualPort",e,t);for(const e of Object.values(this.hubDevices))if(e.portName==n)return console.log(`virtual port ${n} already created !`),n;return await this.sendMsg(s.VIRTUAL_PORT_SETUP,1,e,t),n}shutdown(){return this.sendMsg(s.HUB_ACTIONS,1)}async writePortCommand(t,n,...o){if(e("writePortCommand",{portId:t,waitFeedback:n,data:o}),n)return new Promise(async e=>{const n=R(s.PORT_OUTPUT_COMMAND,t,17,o);await this.sendBuffer(n),this.portCmdCallback[t]=e});{const e=R(s.PORT_OUTPUT_COMMAND,t,16,o);return this.sendBuffer(e)}}getHubDevices(){return Object.values(this.hubDevices)}getDeviceType(e){return c[this.hubDevices[e].type]}async getPortInformation(e){const t=await this.getPortInformationRequest(e),{capabilities:n,count:o,output:i,input:a}=t,s=Math.max(a,i),r=[];for(let t=0;t<o;t++){const n={};if(s>>t){let o;o=await this.getPortModeInformationRequest(e,t,u.NAME),n.name=o.name,n[(o=await this.getPortModeInformationRequest(e,t,u.RAW)).type]={min:o.min,max:o.max},n[(o=await this.getPortModeInformationRequest(e,t,u.PCT)).type]={min:o.min,max:o.max},n[(o=await this.getPortModeInformationRequest(e,t,u.SI)).type]={min:o.min,max:o.max},o=await this.getPortModeInformationRequest(e,t,u.SYMBOL),n.unit=o.symbol,o=await this.getPortModeInformationRequest(e,t,u.VALUE_FORMAT);const{numValues:i,dataType:a,totalFigures:s,decimals:r}=o;n[o.type]={numValues:i,dataType:a,totalFigures:s,decimals:r}}r.push(n)}return{modes:r,capabilities:n}}getPortInformationRequest(e){return new Promise(async t=>{await this.sendMsg(s.PORT_INFORMATION_REQUEST,e,1),this.portCmdCallback[e]=t})}async getPortValue(e,t){return console.log("getPortValue",{portId:e,mode:t}),await this.setPortFormat(e,t),new Promise(async t=>{await this.sendMsg(s.PORT_INFORMATION_REQUEST,e,0),this.portCmdCallback[e]=t})}getPortModeInformationRequest(e,t,n){return new Promise(async o=>{await this.sendMsg(s.PORT_MODE_INFORMATION_REQUEST,e,t,n),this.portCmdCallback[e]=o})}decodeMsg(t){t.byteLength,t.getUint8(0);const n=t.getUint8(2);switch(e("decodeMsg",{msgType:r[n]}),n){case s.HUB_ATTACHED_IO:this.handlePortMsg(t);break;case s.GENERIC_ERROR_MESSAGES:this.handleGenericErrorMsg(t);break;case s.HUB_PROPERTIES:this.handleHubPropertyResponse(t);break;case s.HUB_ALERTS:this.handleHubAlerts(t);break;case s.PORT_OUTPUT_COMMAND_FEEDBACK:this.handlePortCommandFeedback(t);break;case s.PORT_MODE_INFORMATION:this.handlePortModeInformation(t);break;case s.PORT_INFORMATION:this.handlePortInformation(t);break;case s.PORT_VALUE_SINGLE:this.handlePortValueSingle(t)}}handleTiltSensorValue(e,t){let n;switch(e){case g.TILT_POS:n={yaw:t.getInt16(4,!0),pitch:t.getInt16(6,!0),roll:t.getInt16(8,!0)}}return n}handleMotorValue(e,t){let n;switch(e){case g.ABSOLUTE:n=t.getInt16(4,!0);break;case g.ROTATION:n=t.getInt32(4,!0);break;case g.SPEED:n=t.getInt8(4)}return n}async waitTestValue(t,n,o){return new Promise(async i=>{await this.setPortFormat(t,n,async a=>{e("waitTestValue",a),o(a)&&(e("waitTestValue OK"),delete this.deviceModes[t],await this.setPortFormat(t,n,null),i())})})}handlePortValueSingle(t){const n=t.getUint8(3),o=t.getUint8(0),i=this.hubDevices[n];if(e("handlePortValueSingle",{msgLen:o,portId:n,device:i}),null!=this.deviceModes[n]){const{mode:o,cbk:a}=this.deviceModes[n];e({mode:o,cbk:"function"==typeof a});let s=null;switch(i.type){case l.TECHNIC_LARGE_LINEAR_MOTOR:case l.TECHNIC_LARGE_ANGULAR_MOTOR_GREY:case l.TECHNIC_XLARGE_LINEAR_MOTOR:s=this.handleMotorValue(o,t);break;case l.TECHNIC_MEDIUM_HUB_TILT_SENSOR:s=this.handleTiltSensorValue(o,t)}e({value:s});const r=this.portCmdCallback[n];null!=s&&("function"==typeof a?a(s):"function"==typeof r&&(e("getPortValue OK",s),r(s),delete this.portCmdCallback[n]))}}handlePortModeInformation(t){const n=t.getUint8(3),o=t.getUint8(4),i=t.getUint8(5),a={portId:n,mode:o,type:m[i]};switch(i){case u.NAME:a.name=T(t.buffer.slice(6,t.byteLength));break;case u.RAW:case u.PCT:case u.SI:a.min=t.getFloat32(6,!0),a.max=t.getFloat32(10,!0);break;case u.SYMBOL:a.symbol=T(t.buffer.slice(6,t.byteLength));break;case u.VALUE_FORMAT:a.numValues=t.getUint8(6),a.dataType=["8bit","16bit","32bit","float"][t.getUint8(7)],a.totalFigures=t.getUint8(8),a.decimals=t.getUint8(9)}e("portModeInformation",a);const s=this.portCmdCallback[n];"function"==typeof s&&(s(a),delete this.portCmdCallback[n])}handlePortInformation(t){const n=t.getUint8(3);let o=t.getUint8(5);const i=t.getUint8(6),a=t.getUint16(7,!0),s=t.getUint16(9,!0);e(`Port ${n}, capabilities ${o}, total modes ${i}, \n                    input modes ${a}, output modes ${s}`);const r="output,input,logical combinable, logical synchronisable".split(",");let l=[];for(let e=0;e<4;e++)o>>e&1&&l.push(r[e]);const c={portId:n,capabilities:l.join(", "),count:i,input:a,output:s},d=this.portCmdCallback[n];"function"==typeof d&&d(c)}handleHubPropertyResponse(t){const n=t.getUint8(3);if(e({property:p[n]}),n==b.BATTERY_VOLTAGE){const n=t.getUint8(5);e({batteryLevel:n}),this.emit("batteryLevel",{batteryLevel:n})}else if(n==b.BUTTON_STATE){const n=t.getUint8(5);e({buttonState:n}),this.emit("buttonState",{buttonState:n})}else if(n==b.SYSTEM_TYPE_ID){const n=t.getUint8(5);e({systemType:n})}else if(n==b.PRIMARY_MAC_ADDRESS){const n=[];for(let e=0;e<6;e++)n.push(t.getUint8(5+e).toString(16).toLocaleUpperCase().padStart(2,"0"));e({bytes:n}),this.emit("address",{address:n.join(":")})}}handleGenericErrorMsg(t){const n=t.getUint8(3),o=t.getUint8(4);e({cmdType:n,errorCode:d[o]}),this.emit("error",{cmdType:n,errorCode:d[o]})}handleHubAlerts(t){const n=t.byteLength,o=t.getUint8(0),i=t.getUint8(3),a=t.getUint8(4),s=t.getUint8(5);e("handleHubAlerts",{bufferLen:n,msgLen:o,type:i,operation:a,payload:s}),this.emit("hubAlerts",{type:i,payload:s})}handlePortCommandFeedback(t){for(let n=3;n<t.byteLength;n+=2){const o=t.getUint8(n),i=t.getUint8(n+1);if(e("handlePortCommandFeedback",{portId:o,feedback:i}),10==i){const e=this.portCmdCallback[o];"function"==typeof e&&e()}}}handlePortMsg(e){const t=e.getUint8(3),n=e.getUint8(4),o=n?e.getUint16(5,!0):0,s=c[o]||"Unknown",r=a[n];if(console.log("handlePortMsg",{portId:t,eventName:r,deviceTypeName:s}),n==i.ATTACHED_IO){const e={type:o,deviceTypeName:s,portName:E[t],portId:t};this.hubDevices[t]=e,this.emit("attach",e)}else if(n==i.DETACHED_IO)delete this.hubDevices[t],this.emit("detach",{portId:t});else if(n==i.ATTACHED_VIRTUAL_IO){const n={deviceTypeName:"Virtual Port",portName:w(e.getUint8(7),e.getUint8(8)),portId:t};this.hubDevices[t]=n,this.emit("attach",n)}}}$$.service.registerService("hub",{init:function(){return{connect:async function(){e("connect");const t=await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[n]}),o=new P;return await o.init(t),o},Color:h,PortMap:v,PortMapNames:E,DeviceMode:g,BrakingStyle:f,DeviceTypeNames:c}}})}(),$$.control.registerControl("rootPage",{template:'<div class="toolbar">\n    <div class="left">\n        \n        <button bn-event="click: onNewConfig" bn-icon="fa fa-file" title="Reset Config"></button>\n\n        <button bn-event="click: onConfig" bn-icon="fa fa-folder-open" title="Open Config"></button>\n\n        <button bn-event="click: onSaveConfig" bn-icon="fa fa-save" title="Save current config"></button>\n\n        <div bn-show="currentConfig">\n            <label>Current Config:</label>\n            <span bn-text="currentConfig"></span>\n        </div>\n\n    </div>\n\n    <div></div>\n</div>\n\n<div class="toolbar">\n\n    <div class="left">\n        <button bn-event="click: onConnect">Connect to HUB</button>\n        \n        <button bn-event="click: onActions">Actions</button>\n\n        <button bn-event="click: onGamePad" bn-show="gamepadConnected">Gamepad</button>\n\n\n    </div>\n</div>\n\n<div bn-show="hasVariables" class="variables">\n    <table class="w3-table-all">\n        <thead>\n            <th>Variable Name</th>\n            <th>Value</th>\n        </thead>\n        <tbody bn-each="variables">\n            <tr>\n                <td bn-text="$scope.$i.name"></td>\n                <td bn-text="$scope.$i.value"></td>\n            </tr>\n        </tbody>\n    </table>\n</div>\n\n<div>\n    <table class="w3-table-all">\n        <thead>\n            <tr>\n                <th>Hub</th>\n                <th>Actions</th>\n                <th>Battery Level</th>\n                <th>Address</th>\n            </tr>\n        </thead>\n        <tbody bn-each="hubDevices" bn-event="click.btnShutdown: onShutDown, click.btnInfo: onInfo, comboboxchange.combo: onHubChange">\n            <tr>\n                <td>\n                    <div bn-control="brainjs.combobox" bn-data="{items: hubs}" bn-val="$scope.$i.hubId" class="combo"></div>\n                </td>\n                <td>\n                    <button class="btnShutdown">Shutdown</button>\n                    <button class="btnInfo">Info</button>\n                </td>\n                <td bn-text="$scope.$i.batteryLevel"></td>\n                <td bn-text="$scope.$i.address"></td>\n            </tr>\n        </tbody>\n    </table>\n\n</div>',deps:["breizbot.pager","hub","breizbot.gamepad","actionSrv","breizbot.http"],props:{},init:async function(e,t,n,o,i,a){let s={actions:[],mappings:{}};e.find("button").addClass("w3-btn w3-blue");let r=null,l="";i.on("varChange",e=>{console.log("onVarChange",e);const t=i.getVariables();console.log("variables",t),c.setData({variables:t})});const c=$$.viewController(e,{data:{currentConfig:"",gamepadConnected:!1,hubDevices:[],hubs:["HUB1","HUB2"],variables:[],hasVariables:function(){return this.variables.length>0}},events:{onNewConfig:function(){s={actions:[],mappings:{}},r=null,c.setData({currentConfig:""}),i.resetVariables()},onSaveConfig:async function(){if(""==c.model.currentConfig){const e=await $$.ui.showPrompt({title:"Save Config",label:"Config Name:"});e&&(await a.post("/add",{name:e,actions:s.actions,mappings:s.mappings}),c.setData({currentConfig:e}))}else await a.post("/update",s),$.notify(`Config '${s.name}' updated`,"success")},onConfig:function(){t.pushPage("configCtrl",{title:"Configurations",props:{currentConfig:c.model.currentConfig},onReturn:function(e){s=e,c.setData({currentConfig:e.name}),r=s.mappings[l],i.resetVariables()}})},onHubChange:function(){const e=$(this).closest("tr").index();c.model.hubDevices[e].hubId=$(this).getValue()},onShutDown:function(){const e=$(this).closest("tr").index();c.model.hubDevices[e].hubDevice.shutdown()},onInfo:function(){const e=$(this).closest("tr").index(),n=c.model.hubDevices[e];t.pushPage("hubinfo",{title:n.hubId,props:{hubDevice:n.hubDevice}})},onActions:function(){t.pushPage("actionsCtrl",{title:"Actions",props:{actions:s.actions,hubDevices:c.model.hubDevices},onReturn:async function(e){console.log("onReturn",e),s.actions=e}})},onGamePad:function(){o.off("buttonUp",p),o.off("buttonDown",b),o.off("axe",u),t.pushPage("gamepad",{title:"Gamepad",props:{mapping:r,actions:s.actions},onBack:m,onReturn:async e=>{r=e,console.log("onReturn",r),console.log("config",s),s.mappings[e.id]=r,m()}})},onConnect:async function(){const e=await n.connect();e.on("error",e=>{console.log(e)});const t=c.model.hubDevices.length;c.model.hubDevices.push({hubDevice:e,hubId:`HUB${t+1}`,batteryLevel:0,address:"Unknown"}),c.update(),e.on("batteryLevel",t=>{c.model.hubDevices.find(t=>t.hubDevice==e).batteryLevel=t.batteryLevel,c.update()}),e.on("address",t=>{console.log("address",t),c.model.hubDevices.find(t=>t.hubDevice==e).address=t.address,c.update()}),e.startNotification(),e.on("disconnected",()=>{console.log("disconnected");const t=c.model.hubDevices.findIndex(t=>t.hubDevice==e);c.model.hubDevices.splice(t,1),c.update()})}}});function d(e,t){i.execAction(c.model.hubDevices,s.actions,e,t)}function b(e){if(r){const{down:t}=r.buttons[e.id];"None"!=t&&d(t,1)}}function p(e){if(r){const{up:t,down:n}=r.buttons[e.id];"Zero"==t?"None"!=n&&d(n,0):"None"!=t&&d(t,1)}}function u(e){if(r){const{action:t}=r.axes[e.id];"None"!=t&&d(t,e.value)}}function m(){console.log("initCbk"),o.on("buttonUp",p),o.on("buttonDown",b),o.on("axe",u)}o.on("connected",e=>{console.log("gamepad connnected",e),l=e.id,r=s.mappings[l],console.log({gamepadMapping:r}),c.setData({gamepadConnected:!0}),o.checkGamePadStatus(),m()}),o.on("disconnected",e=>{console.log("gamepad disconnected"),c.setData({gamepadConnected:!1}),r=null})}}),$$.control.registerControl("stepCtrl",{template:'<form bn-event="submit: onSubmit">\n    <div class="group">\n\n        <label>Type</label>\n        <div bn-control="brainjs.combobox" bn-data="{items: actionTypes}" name="type" bn-update="comboboxchange"\n            bn-val="type"></div>\n    </div>\n    \n    <div bn-if="isSleep">\n    \n        <div class="group">\n            <label>Time (ms)</label>\n            <input type="number" required name="time" min="0">\n        </div>\n    \n    </div>\n    \n    \n    <div bn-if="isSpeed">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port" bn-val="port"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed</label>\n            <input type="number" required name="speed" min="-100" max="100">\n        </div>\n    </div>\n    \n    <div bn-if="isSpeedtime">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port" bn-val="port"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed</label>\n            <input type="number" required name="speed" min="-100" max="100">\n        </div>\n        <div class="group">\n            <label>Time (ms)</label>\n            <input type="number" required name="time" min="0">\n        </div>\n        <div class="group">\n            <label>Wait End</label>\n            <input type="checkbox" name="waitFeedback">\n        </div>\n        <div class="group">\n            <label>Braking Style</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: brakeStyles}" name="brakeStyle" bn-val="brakeStyle"></div>\n        </div>\n    </div>\n    \n    <div bn-if="isDblspeedtime">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port1</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port1" bn-val="port1"></div>\n        </div>\n    \n        <div class="group">\n            <label>Port2</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port2" bn-val="port2"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed1</label>\n            <input type="number" required name="speed1" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Speed2</label>\n            <input type="number" required name="speed2" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Time (ms)</label>\n            <input type="number" required name="time" min="0">\n        </div>\n        <div class="group">\n            <label>Wait End</label>\n            <input type="checkbox" name="waitFeedback">\n        </div>\n        <div class="group">\n            <label>Braking Style</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: brakeStyles}" name="brakeStyle" bn-val="brakeStyle"></div>\n        </div>\n    </div>\n    \n    <div bn-if="isPower">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port" bn-val="port"></div>\n        </div>\n    \n        <div class="group">\n            <label>Power</label>\n            <input type="number" required name="power" min="-100" max="100">\n        </div>\n    </div>\n    \n    <div bn-if="isRotate">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port" bn-val="port"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed</label>\n            <input type="number" required name="speed" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Angle (°)</label>\n            <input type="number" required name="angle" step="1">\n        </div>\n    \n        <div class="group">\n            <label>Wait End</label>\n            <input type="checkbox" name="waitFeedback">\n        </div>\n    \n        <div class="group">\n            <label>Braking Style</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: brakeStyles}" name="brakeStyle" bn-val="brakeStyle"></div>\n        </div>\n    </div>\n    \n    <div bn-if="isDblrotate">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port1</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port1" bn-val="port1"></div>\n        </div>\n    \n        <div class="group">\n            <label>Port2</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port2" bn-val="port2"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed1</label>\n            <input type="number" required name="speed1" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Speed2</label>\n            <input type="number" required name="speed2" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Angle (°)</label>\n            <input type="number" required name="angle" step="1">\n        </div>\n    \n        <div class="group">\n            <label>Wait End</label>\n            <input type="checkbox" name="waitFeedback">\n        </div>\n    \n        <div class="group">\n            <label>Braking Style</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: brakeStyles}" name="brakeStyle" bn-val="brakeStyle"></div>\n        </div>\n    </div>\n    \n    <div bn-if="isPosition">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port" bn-val="port"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed</label>\n            <input type="number" required name="speed" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Angle (°)</label>\n            <input type="number" required name="angle" step="1">\n        </div>\n    \n        <div class="group">\n            <label>Wait End</label>\n            <input type="checkbox" name="waitFeedback">\n        </div>\n    \n        <div class="group">\n            <label>Braking Style</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: brakeStyles}" name="brakeStyle" bn-val="brakeStyle"></div>\n        </div>\n    </div>\n    \n    <div bn-if="isDblposition">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port1</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port1" bn-val="port1"></div>\n        </div>\n    \n        <div class="group">\n            <label>Port2</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port2" bn-val="port2"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed</label>\n            <input type="number" required name="speed" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Angle1 (°)</label>\n            <input type="number" required name="angle1" step="1">\n        </div>\n    \n        <div class="group">\n            <label>Angle2 (°)</label>\n            <input type="number" required name="angle2" step="1">\n        </div>\n    \n        <div class="group">\n            <label>Wait End</label>\n            <input type="checkbox" name="waitFeedback">\n        </div>\n    \n        <div class="group">\n            <label>Braking Style</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: brakeStyles}" name="brakeStyle" bn-val="brakeStyle"></div>\n        </div>\n    </div>\n    \n    <div bn-if="isCalibrate">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port" bn-val="port"></div>\n        </div>\n    \n    </div>\n    \n    \n    <div bn-if="isZero">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port" bn-val="port"></div>\n        </div>\n    \n    </div>\n    \n    <div bn-if="isColor">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Color</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ledColors}" name="color"></div>\n        </div>\n    \n    </div>\n    \n    <div bn-if="isRgb">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Red</label>\n            <input type="number" min="0" max="255" name="red">\n        </div>\n        <div class="group">\n            <label>Green</label>\n            <input type="number" min="0" max="255" name="green">\n        </div>\n        <div class="group">\n            <label>Blue</label>\n            <input type="number" min="0" max="255" name="blue">\n        </div>\n    </div>\n    \n    <div bn-if="isDblspeed">\n        <div class="group">\n            <label>HUB</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: hubs}" name="hub"  bn-val="hub">\n            </div>\n        </div>\n        <div class="group">\n            <label>Port1</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port1" bn-val="port1"></div>\n        </div>\n    \n        <div class="group">\n            <label>Port2</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: ports}" name="port2" bn-val="port2"></div>\n        </div>\n    \n        <div class="group">\n            <label>Speed1</label>\n            <input type="number" required name="speed1" min="-100" max="100">\n        </div>\n    \n        <div class="group">\n            <label>Speed2</label>\n            <input type="number" required name="speed2" min="-100" max="100">\n        </div>\n    </div>\n\n    <div bn-if="isTestvar">\n        <div class="group">\n            <label>Variable Name</label>\n            <input type="text" name="varName" required>\n        </div>\n        <div class="group">\n            <label>If variable =</label>\n            <input type="text" name="varValue" required>\n        </div>\n        <div class="group">\n            <label>Action</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: availableActions}" name="eqAction" bn-val="eqAction"></div>\n        </div>\n        <div class="group">\n            <label>Else Action</label>\n            <div bn-control="brainjs.combobox" bn-data="{items: availableActions}" name="neqAction" bn-val="neqAction"></div>\n        </div>\n    </div>\n\n    <div bn-if="isSetvar">\n        <div class="group">\n            <label>Variable Name</label>\n            <input type="text" name="varName" required>\n        </div>\n        <div class="group">\n            <label>Value</label>\n            <input type="text" name="varValue" required>\n        </div>\n    </div>\n</form>',deps:["breizbot.pager","hub"],props:{data:null},init:function(e,t,n){let{data:o,availableActions:i}=this.props;o=o||{},i.unshift("None");const a=["SLEEP","POWER","SPEED","DBLSPEED","SPEEDTIME","DBLSPEEDTIME","ROTATE","DBLROTATE","POSITION","DBLPOSITION","CALIBRATE","ZERO","COLOR","RGB","TESTVAR","SETVAR"],s="ABCD".split(""),r=Object.entries(n.Color).map(([e,t])=>Object.assign({label:e,value:t})),l=Object.entries(n.BrakingStyle).map(([e,t])=>Object.assign({label:e,value:t})),c={port:o.port||"A",port1:o.port1||"A",port2:o.port2||"B",type:o.type||"SPEED",hub:o.hub||"HUB1",brakeStyle:o.brakeStyle||n.BrakingStyle.BRAKE,actionTypes:a,brakeStyles:l,ledColors:r,ports:s,states:["STATE1","STATE2","STATE3"],hubs:["HUB1","HUB2"],availableActions:i,eqAction:o.eqAction||"None",neqAction:o.neqAction||"None",state:o.state||"STATE1"};for(const e of a){c["is"+(e.charAt(0)+e.slice(1).toLowerCase())]=function(){return this.type==e}}$$.viewController(e,{data:c,events:{onSubmit:function(e){console.log("onSubmit"),e.preventDefault()}}});e.setFormData(o)}}),$$.control.registerControl("actionCtrl",{template:'<div class="scrollPanel">\n\n    <div bn-each="steps" bn-index="idx" \n        bn-event="click.removeBtn: onRemoveStep, click.upBtn: onMoveUp, click.downBtn: onMoveDown">\n\n        <div class="stepItem">\n            <div class="menubar" >\n                <div>\n                    <button bn-icon="fas fa-level-up-alt" class="upBtn" title="MoveUp"\n                        bn-show="canMoveUp"></button>\n                    <button bn-icon="fas fa-level-down-alt" class="downBtn" title="MoveDown"\n                        bn-show="canMoveDown"></button>\n                    <button bn-icon="fa fa-trash-alt" class="removeBtn" title="Remove" \n                    bn-show="showMenubar"></button>\n\n                </div>\n            </div>\n            <div bn-control="stepCtrl" bn-data="{data: $scope.$i, availableActions}"></div>\n        </div>\n\n    </div>\n</div>',deps:["breizbot.pager"],props:{steps:[],availableActions:[]},init:function(e,t){console.log("actionCtrl props",this.props);const{steps:n,availableActions:o}=this.props,i=$$.viewController(e,{data:{steps:n,availableActions:o,showMenubar:function(e){return e.idx>0},canMoveUp:function(e){return e.idx>0},canMoveDown:function(e){return e.idx<this.steps.length-1}},events:{onMoveUp:function(){const e=$(this).closest(".stepItem").index();i.model.steps=a();const t=i.model.steps[e];i.model.steps[e]=i.model.steps[e-1],i.model.steps[e-1]=t,i.update()},onMoveDown:function(){const e=$(this).closest(".stepItem").index();i.model.steps=a();const t=i.model.steps[e];i.model.steps[e]=i.model.steps[e+1],i.model.steps[e+1]=t,i.update()},onRemoveStep:function(){const e=$(this).closest(".stepItem").index();console.log("onRemoveStep",e),i.model.steps.splice(e,1),i.update()}}});function a(){const t=[];return e.find("form").each(function(){t.push($(this).getFormData())}),t}this.getButtons=function(){return{addStep:{title:"Add Step",icon:"fa fa-plus",onClick:function(){i.model.steps=a(),i.model.steps.push({}),i.update()}},apply:{title:"Apply",icon:"fas fa-check",onClick:function(){let n=!0;e.find("form").each(function(){const e=$(this).get(0);n=n&&e.reportValidity()}),n&&t.popPage(a())}}}}}}),$$.control.registerControl("actionsCtrl",{template:'<div bn-show="!hasActions" class="message">\n    No actions defined\n</div>\n\n<div class="scrollPanel" bn-show="hasActions">\n    <div bn-each="actions" class="items" bn-event="click.item: onItemClick, contextmenuchange.item:onItemContextMenu">\n        <div class="w3-card-2 item" bn-control="brainjs.contextmenu" bn-data="{\n                    items: {\n                        edit: {name: \'Edit\', icon: \'fas fa-edit\'},\n                        delete: {name: \'Remove\', icon: \'fas fa-trash-alt\'},\n                        duplicate: {name: \'Duplicate\', icon: \'fas fa-clone\'}\n                    }\n                }">\n            <div>\n                <strong bn-text="$scope.$i.name"></strong>\n            </div>\n        </div>\n    </div>\n</div>',deps:["breizbot.pager","actionSrv"],props:{actions:null,isEdition:!0,hubDevices:null},init:function(e,t,n){const{isEdition:o,hubDevices:i}=this.props,a=Array.from(this.props.actions||[]);o||(a.unshift({name:"Zero"}),a.unshift({name:"None"}));const s=$$.viewController(e,{data:{actions:a,hasActions:function(){return this.actions.length>0}},events:{onItemContextMenu:async function(e,n){const o=$(this).closest(".item").index(),i=s.model.actions[o];if("delete"==n.cmd&&(s.model.actions.splice(o,1),s.update()),"duplicate"==n.cmd){const e=await $$.ui.showPrompt({label:"New Name",title:"Add action"});if(null==e)return;const t=Object.assign({},i,{name:e});s.model.actions.push(t),s.update()}if("edit"==n.cmd){let{steps:e}=i;Array.isArray(e)||(e=[i]);const n=s.model.actions.map(e=>e.name);t.pushPage("actionCtrl",{title:i.name,props:{steps:e,availableActions:n},onReturn:function(e){s.model.actions[o]={name:i.name,steps:e}}})}},onItemClick:function(e){const a=$(this).closest(".item").index(),r=s.model.actions[a];o?n.execAction(i,s.model.actions,r.name,1):t.popPage(r.name)}}});o&&(this.getButtons=function(){return{addAction:{title:"Add Action",icon:"fa fa-plus",onClick:async function(){const e=await $$.ui.showPrompt({label:"Name",title:"Add action"});if(null==e)return;const n=s.model.actions.map(e=>e.name);t.pushPage("actionCtrl",{title:e,props:{steps:[{}],availableActions:n},onReturn:function(t){s.model.actions.push({name:e,steps:t}),s.update()}})}},save:{title:"Save",icon:"fa fa-check",onClick:function(){t.popPage(s.model.actions)}}}})}}),$$.control.registerControl("configCtrl",{template:'<div bn-show="!hasConfigs" class="message">\n    No configurations defined\n</div>\n\n<div class="scrollPanel" bn-show="hasConfigs">\n    <div bn-each="configs" class="items" bn-event="click.item: onItemClick, contextmenuchange.item:onItemContextMenu">\n        <div class="w3-card-2 item" bn-control="brainjs.contextmenu" bn-data="{\n                    items: {\n                        delete: {name: \'Remove\', icon: \'fas fa-trash-alt\'}\n                    }\n                }">\n            <div>\n                <strong bn-text="$scope.$i.name"></strong>\n            </div>\n        </div>\n    </div>\n</div>',deps:["breizbot.pager","breizbot.http"],props:{currentConfig:""},init:function(e,t,n){const{currentConfig:o}=this.props,i=$$.viewController(e,{data:{configs:[],hasConfigs:function(){return this.configs.length>0}},events:{onItemContextMenu:async function(e,t){const s=$(this).closest(".item").index(),r=i.model.configs[s];"delete"==t.cmd&&(r.name==o?$$.ui.showAlert({content:"Cannot delete active config",title:"Warning"}):(await n.post("/delete",r),a()))},onItemClick:function(e){const n=$(this).closest(".item").index();console.log("onItemClick",n);const o=i.model.configs[n];t.popPage(o)}}});async function a(){const e=await n.get("/");console.log({configs:e}),i.setData({configs:e})}a()}}),$$.control.registerControl("gamepad",{template:'<div>\n    <h2 bn-text="id"></h2>\n</div>\n\n<h3>Axes</h3>\n<div>\n    <table class="w3-table-all axeTable">\n        <thead>\n            <tr>\n                <th>Axe</th>\n                <th>Action</th>\n            </tr>\n        </thead>\n        <tbody bn-each="axes" bn-bind="axes" bn-index="idx" bn-event="click.item: onAxeClick">\n            <tr>\n                <td bn-text="getAxeLabel"></td>\n                <td>\n                    <div bn-text="$scope.$i.action" class="item"></div>\n                </td>                \n            </tr>\n        </tbody>\n    </table>\n</div>\n\n<h3>Buttons</h3>\n<div class="commandTable">\n    <table class="w3-table-all">\n        <thead>\n            <tr>\n                <th>Button</th>\n                <th>Down</th>\n                <th>Up</th>\n            </tr>\n        </thead>\n        <tbody bn-each="buttons" bn-bind="buttons" bn-index="idx" bn-event="click.item: onButtonClick">\n            <tr>\n                <td bn-text="getButtonLabel"></td>\n                <td>\n                    <div bn-text="$scope.$i.down" class="item" data-cmd="down">\n                    </div>\n                </td>\n                <td>\n                    <div bn-text="$scope.$i.up" class="item" data-cmd="up">\n                    </div>\n                </td>\n\n            </tr>\n        </tbody>\n    </table>\n</div>',deps:["breizbot.pager","breizbot.gamepad"],props:{mapping:null,actions:null},init:function(e,t,n){const{mapping:o,actions:i}=this.props;console.log(this.props);let a=[],s=[];const r=n.getGamepads()[0];if(null!=o&&(a=o.axes,s=o.buttons),0==a.length)for(let e=0;e<r.axes.length;e++)a.push({action:"None"});if(0==s.length)for(let e=0;e<r.buttons.length;e++)s.push({up:"None",down:"None"});function l(e){const{value:t,id:n}=e;0!=t?p.find("tr").eq(n).find("td").eq(0).addClass("pressed"):p.find("tr").eq(n).find("td").eq(0).removeClass("pressed")}function c(e){u.find("tr").eq(e.id).find("td").eq(0).addClass("pressed")}function d(e){u.find("tr").eq(e.id).find("td").eq(0).removeClass("pressed")}n.on("axe",l),n.on("buttonDown",c),n.on("buttonUp",d),this.dispose=function(){console.log("dispose"),n.off("axe",l),n.off("buttonDown",c),n.off("buttonUp",d)};const b=$$.viewController(e,{data:{id:r.id,axes:a,buttons:s,getButtonLabel:function(e){return`Button ${e.idx+1}`},getAxeLabel:function(e){return`Axe ${e.idx+1}`}},events:{onButtonClick:function(){const e=$(this).closest("tr").index(),n=$(this).data("cmd");t.pushPage("actionsCtrl",{title:"Select an action",props:{isEdition:!1,actions:i},onReturn:function(t){b.model.buttons[e][n]=t,b.update()}})},onAxeClick:function(){const e=$(this).closest("tr").index();console.log("onAxeClick",e),t.pushPage("actionsCtrl",{title:"Select an action",props:{isEdition:!1,actions:i},onReturn:function(t){b.model.axes[e].action=t,b.update()}})}}}),p=b.scope.axes,u=b.scope.buttons;this.getButtons=function(){return{check:{icon:"fa fa-check",title:"Apply",onClick:function(){t.popPage(function(){const e={id:r.id,axes:[],buttons:[]};return p.find("tr").each(function(t){const n=$(this).find(".item").text();e.axes.push({action:n})}),u.find("tr").each(function(t){const n=$(this).find('[data-cmd="up"]').text(),o=$(this).find('[data-cmd="down"]').text();e.buttons.push({up:n,down:o})}),console.log({ret:e}),e}())}}}}}}),$$.control.registerControl("hubinfo",{template:'<div class="scrollBar">\n    <h1>External Devices</h1>\n    <table class="w3-table-all">\n        <thead>\n            <tr>\n                <th>Port</th>\n                <th>Device Type</th>\n                <th>Action</th>\n            </tr>\n        </thead>\n        <tbody bn-each="externalDevices" bn-event="mousedown.action: onMouseUp, mouseup.action:onMouseDown, click.portInfo: onInfo2, click.calibrate:onCalibrate">\n            <tr>\n                <td bn-text="$scope.$i.portName"></td>\n                <td bn-text="$scope.$i.deviceTypeName"></td>\n                <td>\n                    <button class="w3-btn w3-green action" data-action="forward">FWD</button>\n                    <button class="w3-btn w3-green action" data-action="backward">BKWD</button>\n                    <button class="w3-btn w3-green calibrate">CALIBRATE</button>\n\n                    <button class="w3-btn w3-blue portInfo">MODE</button>\n                </td>\n            </tr>\n\n        </tbody>\n    </table>\n    <h1>Internal Devices</h1>\n    <table class="w3-table-all">\n        <thead>\n            <tr>\n                <th>Device Type</th>\n                <th>Action</th>\n            </tr>\n        </thead>\n        <tbody bn-each="internalDevices" bn-event="click.w3-btn: onInfo">\n            <tr>\n                <td bn-text="$scope.$i.deviceTypeName"></td>\n                <td>\n                    <button class="w3-btn w3-blue">MODE</button>\n                </td>\n            </tr>\n\n        </tbody>\n    </table></div>',deps:["breizbot.pager","hub"],props:{hubDevice:null},init:function(e,t,n){const o=this.props.hubDevice,i=o.getHubDevices();console.log("devices",i);const a=[],s=[];for(const e of i){const{portId:t,deviceTypeName:n,portName:o}=e;t<50?s.push({portName:o,portId:t,deviceTypeName:n}):a.push({portId:t,deviceTypeName:n})}function r(e,n){t.pushPage("info",{title:n,props:{portId:e,hubDevice:o}})}function l(e){const t=e.closest("tr").index();return b.model.externalDevices[t].portId}function c(e){console.log("attach",e);const{portId:t,deviceTypeName:n}=e;i[t]=n}function d(e){console.log("detach",e),delete i[e.portId]}o.on("attach",c),o.on("detach",d),this.dispose=function(){console.log("hubInfo dispose"),o.off("attach",c),o.off("detach",d)};const b=$$.viewController(e,{data:{internalDevices:a,externalDevices:s},events:{onCalibrate:async function(){const e=l($(this));console.log("onCalibrate",e),await o.getMotor(e).calibrate()},onMouseUp:function(){const e=$(this).data("action"),t=l($(this));switch(e){case"forward":o.getMotor(t).setPower(100);break;case"backward":o.getMotor(t).setPower(-100)}},onMouseDown:function(){const e=l($(this));o.getMotor(e).setPower(0)},onInfo:function(){const e=$(this).closest("tr").index(),{portId:t,deviceTypeName:n}=b.model.internalDevices[e];r(t,n)},onInfo2:function(){const e=$(this).closest("tr").index(),{portId:t,deviceTypeName:n}=b.model.externalDevices[e];r(t,n)}}})}}),$$.control.registerControl("info",{template:'<div>\n    <div>\n        Capabilities: <span bn-text="capabilities"></span>\n    </div>\n    <table class="w3-table-all">\n        <thead>\n            <tr>\n                <th>MODE</th>\n                <th>UNIT</th>\n                <th>RAW</th>\n                <th>PCT</th>\n                <th>SI</th>\n                <th>VALUE FORMAT</th>\n            </tr>\n        </thead>\n        <tbody bn-each="modes">\n            <tr>\n                <td bn-text="$scope.$i.name"></td>\n                <td bn-text="$scope.$i.unit"></td>\n                <td>\n                    <span bn-text="$scope.$i.RAW.min"></span><br>\n                    <span bn-text="$scope.$i.RAW.max"></span>\n                </td>\n                <td>\n                    <span bn-text="$scope.$i.PCT.min"></span><br>\n                    <span bn-text="$scope.$i.PCT.max"></span>\n                </td>\n                <td>\n                    <span bn-text="$scope.$i.SI.min"></span><br>\n                    <span bn-text="$scope.$i.SI.max"></span>\n                </td>\n                <td>\n                    dataType: <span bn-text="$scope.$i.VALUE_FORMAT.dataType"></span><br>\n                    numValues: <span bn-text="$scope.$i.VALUE_FORMAT.numValues"></span>\n                </td>\n            </tr>\n        </tbody>\n    </table>\n</div>',deps:["breizbot.pager","hub"],props:{},init:function(e,t,n){const{portId:o}=this.props,i=this.props.hubDevice,a=$$.viewController(e,{data:{modes:[],capabilities:""},events:{}});!async function(){const e=await i.getPortInformation(o);console.log("portInfo",e);const{modes:t,capabilities:n}=e;a.setData({modes:t,capabilities:n})}()}});