!function(){return function t(e,s,o){function i(n,r){if(!s[n]){if(!e[n]){var c="function"==typeof require&&require;if(!r&&c)return c(n,!0);if(a)return a(n,!0);var l=new Error("Cannot find module '"+n+"'");throw l.code="MODULE_NOT_FOUND",l}var h=s[n]={exports:{}};e[n][0].call(h.exports,function(t){return i(e[n][1][t]||t)},h,h.exports,t,e,s,o)}return s[n].exports}for(var a="function"==typeof require&&require,n=0;n<o.length;n++)i(o[n]);return i}}()({1:[function(t,e,s){e.exports=class{constructor(){this.callbacks=[]}on(t){this.callbacks.push(t)}emit(t){console.log("emit",t);let e=this.callbacks.length;for(;e--;)(0,this.callbacks[e])(t)&&this.callbacks.splice(e,1)}}},{}],2:[function(t,e,s){const o=t("./Device");e.exports=class extends o{constructor(t,e,s){super(t,e,s)}async setBrightness(t,e,s){return await this.setMode(3,!1),this.writeDirectMode(3,t,e,s)}}},{"./Device":4}],3:[function(t,e,s){const{getEnumName:o}=$$.util,i={DETACHED_IO:0,ATTACHED_IO:1,ATTACHED_VIRTUAL_IO:2},a=o(i),n={HUB_PROPERTIES:1,HUB_ACTIONS:2,HUB_ALERTS:3,HUB_ATTACHED_IO:4,GENERIC_ERROR_MESSAGES:5,HW_NETWORK_COMMANDS:8,FW_UPDATE_GO_INTO_BOOT_MODE:16,FW_UPDATE_LOCK_MEMORY:17,FW_UPDATE_LOCK_STATUS_REQUEST:18,FW_LOCK_STATUS:19,PORT_INFORMATION_REQUEST:33,PORT_MODE_INFORMATION_REQUEST:34,PORT_INPUT_FORMAT_SETUP_SINGLE:65,PORT_INPUT_FORMAT_SETUP_COMBINEDMODE:66,PORT_INFORMATION:67,PORT_MODE_INFORMATION:68,PORT_VALUE_SINGLE:69,PORT_VALUE_COMBINEDMODE:70,PORT_INPUT_FORMAT_SINGLE:71,PORT_INPUT_FORMAT_COMBINEDMODE:72,VIRTUAL_PORT_SETUP:97,PORT_OUTPUT_COMMAND:129,PORT_OUTPUT_COMMAND_FEEDBACK:130},r=o(n),c={UNKNOWN:0,SIMPLE_MEDIUM_LINEAR_MOTOR:1,TRAIN_MOTOR:2,LIGHT:8,VOLTAGE_SENSOR:20,CURRENT_SENSOR:21,PIEZO_BUZZER:22,HUB_LED:23,TILT_SENSOR:34,MOTION_SENSOR:35,COLOR_DISTANCE_SENSOR:37,MEDIUM_LINEAR_MOTOR:38,MOVE_HUB_MEDIUM_LINEAR_MOTOR:39,MOVE_HUB_TILT_SENSOR:40,DUPLO_TRAIN_BASE_MOTOR:41,DUPLO_TRAIN_BASE_SPEAKER:42,DUPLO_TRAIN_BASE_COLOR_SENSOR:43,DUPLO_TRAIN_BASE_SPEEDOMETER:44,TECHNIC_LARGE_LINEAR_MOTOR:46,TECHNIC_XLARGE_LINEAR_MOTOR:47,TECHNIC_MEDIUM_ANGULAR_MOTOR:48,TECHNIC_LARGE_ANGULAR_MOTOR:49,TECHNIC_MEDIUM_HUB_GEST_SENSOR:54,REMOTE_CONTROL_BUTTON:55,REMOTE_CONTROL_RSSI:56,TECHNIC_MEDIUM_HUB_ACCELEROMETER:57,TECHNIC_MEDIUM_HUB_GYRO_SENSOR:58,TECHNIC_MEDIUM_HUB_TILT_SENSOR:59,TECHNIC_MEDIUM_HUB_TEMPERATURE_SENSOR:60,TECHNIC_COLOR_SENSOR:61,TECHNIC_DISTANCE_SENSOR:62,TECHNIC_FORCE_SENSOR:63,TECHNIC_3X3_COLOR_LIGHT_MATRIX:64,TECHNIC_SMALL_ANGULAR_MOTOR:65,MARIO_ACCELEROMETER:71,MARIO_BARCODE_SENSOR:73,MARIO_PANTS_SENSOR:74,TECHNIC_MEDIUM_ANGULAR_MOTOR_GREY:75,TECHNIC_LARGE_ANGULAR_MOTOR_GREY:76,VIRTUAL_DEVICE:100},l=o(c),h=o({ACK:1,MACK:2,BUFFER_OVERFLOW:3,TIMEOUT:4,COMMAND_NOT_RECOGNIZED:5,INVALID_USE:6,OVERCURRENT:7,INTERNAL_ERROR:8}),E={ADVERTISING_NAME:1,BUTTON_STATE:2,FW_VERSION:3,HW_VERSION:4,RSSI:5,BATTERY_VOLTAGE:6,BATTERY_TYPE:7,MANUFACTURER_NAME:8,RADIO_FIRMWARE_VERSION:9,LWP_PROTOCOL_VERSION:10,SYSTEM_TYPE_ID:11,HW_NETWORK_ID:12,PRIMARY_MAC_ADDRESS:13,SECONDARY_MAC_ADDRESS:14,HW_NETWORK_FAMILY:15},u=o(E),T={NAME:0,RAW:1,PCT:2,SI:3,SYMBOL:4,MAPPING:5,USED_INTERNALLY:6,MOTOR_BIAS:7,CAPABILITY_BITS:8,VALUE_FORMAT:128},d=o(T),R={A:0,B:1,C:2,D:3,HUB_LED:50,CURRENT_SENSOR:59,VOLTAGE_SENSOR:60,ACCELEROMETER:97,GYRO_SENSOR:98,TILT_SENSOR:99},_=o(R);e.exports={MessageType:n,MessageTypeNames:r,Event:i,EventNames:a,BrakingStyle:{FLOAT:0,HOLD:126,BRAKE:127},DeviceMode:{POWER:0,SPEED:1,ROTATION:2,ABSOLUTE:3,COLOR:0,RGB:1,TILT_POS:0,TILT_INPACT_COUNT:1},DeviceType:c,DeviceTypeNames:l,ModeInformationType:T,ModeInformationTypeNames:d,PortMap:R,PortMapNames:_,HubPropertyPayload:E,HubPropertyPayloadNames:u,ErrorCodeNames:h}},{}],4:[function(t,e,s){t("./CallbackEmitter");const{MessageType:o,PortMapNames:i}=t("./Const"),{log:a,toUint32:n}=t("./Util"),r={};e.exports=class{constructor(t,e,s){this.hubDevice=t,this.portId=e,this.type=s,this.name=i[e],this.feedbackCallback=null,this.valueCallback=void 0,this.mode=void 0,this.waitEnd=!1,this.notificationEnabled=!1,this.waitStale=!1,this.actions=[],this.availableActions=[]}execAction(t){console.error(`action ${t} is not implemented`)}isActionEnabled(t){return!0}async writePortCommand(t,...e){return this.waitEnd=t,new Promise(async t=>{this.feedbackCallback=t,await this.hubDevice.writePortCommand(this.portId,e)})}handleFeedback(t){"function"==typeof this.feedbackCallback&&(1!=t||this.waitEnd?10==t&&this.waitEnd?this.feedbackCallback():44==t&&this.waitStale&&(this.waitStale=!1,this.feedbackCallback()):this.feedbackCallback())}writeDirectMode(t,...e){return a("writeDirectMode",this.portId,{mode:t}),this.writePortCommand(!0,81,t,e)}setMode(t,e,s=1){return console.log("setMode",this.portId,{mode:t,notificationEnabled:e}),this.mode=t,this.notificationEnabled=e,this.hubDevice.sendMsg(o.PORT_INPUT_FORMAT_SETUP_SINGLE,this.portId,t,n(s),e?1:0)}async readInfo(){let t=r[this.type];return null==t&&(console.log("readInfo",this.portId),t=await this.hubDevice.getPortInformation(this.portId),r[this.type]=t),t}decodeValue(t){const e=r[this.type];if(null!=e){const{VALUE_FORMAT:s,RAW:o,SI:i}=e.modes[this.mode],a=$$.util.mapRange(o.min,o.max,i.min,i.max),{dataType:n,numValues:r}=s,c=[];let l,h=4;console.log("decodeValue",{RAW:o,SI:i,dataType:n,numValues:r});for(let e=0;e<r;e++){switch(n){case"16bit":l=t.getInt16(h,!0),h+=2;break;case"8bit":l=t.getInt8(h),h+=1;break;case"32bit":l=t.getInt32(h,!0),h+=4;break;case"float":l=t.getFloat32(h,!0),h+=4}console.log("val",l),c.push(Math.trunc(a(l)))}return 1==c.length?c[0]:c}console.error("No info for this port")}handleValue(t){const e=this.decodeValue(t);null!=e&&"function"==typeof this.valueCallback&&this.valueCallback(e)}async getValue(t){return console.log("getValue",this.portId,{mode:t}),await this.setMode(t,!1),new Promise(async t=>{this.valueCallback=(e=>(console.log("value",e),t(e),!0)),await this.hubDevice.sendMsg(o.PORT_INFORMATION_REQUEST,this.portId,0)})}async waitTestValue(t,e){await this.setMode(t,!0);const s=await new Promise(async t=>{this.valueCallback=(async s=>{e(s)&&(a("waitTestValue OK"),t(s))})});return this.valueCallback=null,await this.setMode(t,!1),s}async subscribe(t,e,s=1){await this.setMode(t,!0,s),this.valueCallback=(async t=>{await e(t)})}async unsubscribe(){this.notificationEnabled&&this.setMode(this.mode,!1)}}},{"./CallbackEmitter":1,"./Const":3,"./Util":12}],5:[function(t,e,s){const o=t("./Device");e.exports=class extends o{constructor(t,e,s){super(t,e,s)}async setBrightness(t,e,s,o){return await this.setMode(5,!1),this.writeDirectMode(5,t,s,e,o)}}},{"./Device":4}],6:[function(t,e,s){const o=t("./Motor"),{BrakingStyle:i}=t("./Const"),{toInt16:a,toInt32:n}=t("./Util"),r=100;e.exports=class extends o{constructor(t,e,s){super(t,e,"Virtual Device"),this.name=s}setSpeed(t,e){return this.writePortCommand(!0,8,t,e,r,0)}setSpeedForTime(t,e,s,o=!1,n=i.BRAKE){return console.log("setSpeedForTime",this.portId,{speed1:t,speed2:e,time:s,waitFeedback:o,brakingStyle:n}),this.writePortCommand(o,10,a(s),t,e,r,n)}rotateDegrees(t,e,s,o,a=i.BRAKE){return console.log("rotateDegrees",this.portId,{degrees:t,speed1:e,speed2:s,waitFeedback:o,brakingStyle:a}),this.writePortCommand(o,12,n(t),e,s,r,a)}gotoAngle(t,e,s,o,a=i.BRAKE){return console.log("gotoAngle",this.portId,{angle1:t,angle2:e,speed:s,waitFeedback:o,brakingStyle:a}),this.writePortCommand(o,14,n(t),n(e),s,r,a)}}},{"./Const":3,"./Motor":8,"./Util":12}],7:[function(t,e,s){const o=t("./Device"),{PortMapNames:i,DeviceMode:a}=t("./Const");e.exports=class extends o{constructor(t,e,s){super(t,e,s)}setBrightness(t){return console.log("setBrightness",this.portId,{brightness:t}),this.writeDirectMode(a.POWER,t)}}},{"./Const":3,"./Device":4}],8:[function(t,e,s){const o=t("./Device"),{PortMapNames:i,DeviceMode:a}=t("./Const");e.exports=class extends o{constructor(t,e,s){super(t,e,s),this.availableActions=["FWD","BKD","STOP"],this.power=50}execAction(t){switch(t){case"FWD":return this.setPower(this.power);case"BKD":return this.setPower(-this.power);case"STOP":return this.setPower(0);default:return super.execAction(t)}}async setPower(t,e=!1){console.log("setPower",this.portId,{power:t,waitStale:e}),await this.writeDirectMode(a.POWER,t),this.waitStale=!0,e&&await new Promise(async t=>{this.feedbackCallback=t})}}},{"./Const":3,"./Device":4}],9:[function(t,e,s){const o=t("./Device"),{PortMapNames:i}=t("./Const"),a={COLOR:0,RGB:1};e.exports=class extends o{constructor(t,e,s){super(t,e,s)}async setColor(t){return console.log("setColor",this.portId,{color:t}),await this.setMode(a.COLOR,!1),this.writeDirectMode(a.COLOR,t)}async setRGBColor(t,e,s){return console.log("setColor",this.portId,{r:t,g:e,b:s}),await this.setMode(a.RGB,!1),this.writeDirectMode(a.RGB,t,e,s)}}},{"./Const":3,"./Device":4}],10:[function(t,e,s){const o=t("./Motor"),{PortMapNames:i,DeviceMode:a,BrakingStyle:n}=t("./Const"),{toInt32:r,toInt16:c}=t("./Util"),l=100;e.exports=class extends o{constructor(t,e,s){super(t,e,s),this.calibrated=!1,this.minAngle=0,this.maxAngle=0,this.availableActions.push("CALIBRATE","RIGHT","CENTER","LEFT")}execAction(t){switch(t){case"CALIBRATE":return this.calibrate();case"RIGHT":return this.gotoRight();case"LEFT":return this.gotoLeft();case"CENTER":return this.gotoCenter();default:return super.execAction(t)}}isActionEnabled(t){return["RIGHT","LEFT","CENTER"].includes(t)?this.calibrated:super.isActionEnabled(t)}setSpeed(t){return console.log("#setSpeed",this.portId,{speed:t}),0==t?this.setPower(0):this.writePortCommand(!0,7,t,l,0)}rotateDegrees(t,e,s,o=n.BRAKE){return console.log("rotateDegrees",this.portId,{degrees:t,speed:e,waitEnd:s,brakingStyle:o}),this.writePortCommand(s,11,r(t),e,l,o)}gotoAngle(t,e,s,o=n.BRAKE){return console.log("gotoAngle",this.portId,{angle:t,speed:e,waitEnd:s,brakingStyle:o}),this.writePortCommand(s,13,r(t),e,l,o)}async gotoAbsPosition(t,e,s,o=n.BRAKE){const i=await this.getAbsolutePosition();console.log("gotoAbsPosition",this.portId,{angle:t,absPos:i,speed:e,waitEnd:s,brakingStyle:o});let a=t-i;return a<0&&(e=-e),a=Math.abs(a),this.rotateDegrees(a,e,s,o)}setSpeedForTime(t,e,s=!1,o=n.BRAKE){return console.log("setSpeedForTime",this.portId,{speed:t,time:e,waitEnd:s,brakingStyle:o}),this.writePortCommand(s,9,c(e),t,l,o)}resetZero(){return console.log("resetZero",this.portId),this.writeDirectMode(a.ROTATION,0,0,0,0)}getSpeed(){return this.getValue(a.SPEED)}getPosition(){return this.getValue(a.ROTATION)}async getAbsolutePosition(){const t=await this.getValue(a.ABSOLUTE);return t<0?t+360:t}async calibrate(t=30){console.log("calibrate"),await this.readInfo(),await this.setPower(-t,!0),await $$.util.wait(1e3),this.minAngle=await this.getValue(a.ROTATION),await this.setPower(t,!0),await $$.util.wait(1e3),this.maxAngle=await this.getValue(a.ROTATION),console.log({minAngle:this.minAngle,maxAngle:this.maxAngle}),this.calibrated=!0,this.gotoCenter()}async gotoCenter(){if(this.calibrated){const t=(this.maxAngle+this.minAngle)/2;await this.gotoAngle(t,10,!0)}else console.error("Motor not calibrated")}async gotoLeft(){this.calibrated?await this.gotoAngle(this.maxAngle,10,!0):console.error("Motor not calibrated")}async gotoRight(){this.calibrated?await this.gotoAngle(this.minAngle,10,!0):console.error("Motor not calibrated")}async calibrate3(t=30){console.log("calibrate"),await this.setPower(-t);const e=await this.waitTestValue(a.ROTATION,makeStallDetector());await this.setPower(0),console.log({minAngle:e}),await this.setPower(t);const s=await this.waitTestValue(a.ROTATION,makeStallDetector());await this.setPower(0),console.log({minAngle:e,maxAngle:s})}async calibrate2(){console.log("calibrate",this.portId),this.setPower(50),await this.waitTestValue(a.SPEED,t=>t>10),await this.waitTestValue(a.SPEED,t=>0==t),this.setPower(0),await $$.util.wait(1e3),await this.resetZero(),this.setPower(-50),await this.waitTestValue(a.SPEED,t=>Math.abs(t)>10),await this.waitTestValue(a.SPEED,t=>0==t),this.setPower(0);const t=await this.getValue(a.ROTATION);console.log(t);const e=Math.floor(t/2);console.log({offset:e}),await this.gotoAngle(e,10,!0),await this.resetZero(),this.calibrationValue=Math.abs(e)}}},{"./Const":3,"./Motor":8,"./Util":12}],11:[function(t,e,s){const o=t("./Device"),{DeviceMode:i}=t("./Const"),{toInt32:a}=t("./Util");e.exports=class extends o{constructor(t,e,s){super(t,e,s)}getImpactCount(){return this.getValue(i.TILT_INPACT_COUNT)}setImpactCount(t){return this.writeDirectMode(i.TILT_INPACT_COUNT,a(t))}decodeValue(t){const e=super.decodeValue(t);if(this.mode==i.TILT_POS){const[t,s,o]=e;return{yaw:t,pitch:s,roll:o}}return e}}},{"./Const":3,"./Device":4,"./Util":12}],12:[function(t,e,s){e.exports={toInt16:function(t){const e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,t,!0),Array.from(e)},toInt32:function(t){const e=new Uint8Array(4);return new DataView(e.buffer).setInt32(0,t,!0),Array.from(e)},toUint32:function(t){const e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!0),Array.from(e)},log:function(...t){}}},{}],13:[function(t,e,s){!function(){const e=t("./CallbackEmitter"),{EventNames:s,DeviceMode:o,DeviceTypeNames:i,BrakingStyle:a,PortMap:n,HubPropertyPayloadNames:r,ModeInformationTypeNames:c,Event:l,DeviceType:h,PortMapNames:E,MessageType:u,HubPropertyPayload:T,ModeInformationType:d,ErrorCodeNames:R,MessageTypeNames:_}=t("./Const"),O=t("./Motor"),I=t("./DoubleMotor"),A=t("./TachoMotor"),g=t("./Device"),M=t("./RgbLed"),C=t("./Led"),m=t("./TiltSensor"),N=t("./ColorSensor"),p=t("./DistanceSensor"),{log:b}=t("./Util"),S={BLACK:0,PINK:1,PURPLE:2,BLUE:3,LIGHT_BLUE:4,CYAN:5,GREEN:6,YELLOW:7,ORANGE:8,RED:9,WHITE:10,NONE:255},P="00001623-1212-efde-1623-785feabcd123",w="00001624-1212-efde-1623-785feabcd123";function U(t){const e=new Uint8Array(t);let s="";for(let t=0;t<e.byteLength&&0!=e[t];t++)s+=String.fromCharCode(e[t]);return s}function D(t,...e){const s=e.flat(4),o=s.length+3,i=new ArrayBuffer(o),a=new Uint8Array(i);return a[0]=o,a[1]=0,a[2]=t,a.set(s,3),i}function f(t,e){return`${E[t]}_${E[e]}`}const y={[h.TECHNIC_LARGE_LINEAR_MOTOR]:A,[h.TECHNIC_LARGE_ANGULAR_MOTOR_GREY]:A,[h.TECHNIC_XLARGE_LINEAR_MOTOR]:A,[h.TECHNIC_MEDIUM_HUB_TILT_SENSOR]:m,[h.HUB_LED]:M,[h.LIGHT]:C,[h.TECHNIC_MEDIUM_ANGULAR_MOTOR_GREY]:A,[h.TECHNIC_COLOR_SENSOR]:N,[h.TECHNIC_DISTANCE_SENSOR]:p};class L extends EventEmitter2{constructor(){super(),this.charac=null,this.portCmdQueue={},this.portCmdCallback={},this.hubDevices={},this.busy=!1,this.attachCallbacks=new e,this.portCmdQueue=[],this.hubPropertyCallback=null}async writePortCommand(t,...e){console.log("#writePortCommand",{portId:t,data:e});const s=D(u.PORT_OUTPUT_COMMAND,t,17,e);this.busy?(this.portCmdQueue.push(s),console.log("# Busy ! wait feedback")):(this.busy=!0,await this.sendBuffer(s))}async init(t){const e=await t.gatt.connect();b("Connected");const s=await e.getPrimaryService(P);this.charac=await s.getCharacteristic(w);const o=t=>{this.decodeMsg(t.target.value)};t.addEventListener("gattserverdisconnected",()=>{console.log("onGattServerDisconnected",this),this.charac.removeEventListener("characteristicvaluechanged",o),this.charac=null,this.emit("disconnected")}),this.charac.addEventListener("characteristicvaluechanged",o),await this.charac.startNotifications(),await $$.util.wait(100)}async startNotification(){await this.sendMsg(u.HUB_PROPERTIES,T.BATTERY_VOLTAGE,2),await this.sendMsg(u.HUB_PROPERTIES,T.SYSTEM_TYPE_ID,5),await this.sendMsg(u.HUB_ALERTS,1,1)}async getName(){return this.name=await new Promise(async t=>{this.hubPropertyCallback=t,await this.sendMsg(u.HUB_PROPERTIES,T.ADVERTISING_NAME,5)}),this.name}async getPrimaryMACAddress(){return await new Promise(async t=>{this.hubPropertyCallback=t,await this.sendMsg(u.HUB_PROPERTIES,T.PRIMARY_MAC_ADDRESS,5)})}async getDblMotor(t,e){return new Promise(async s=>{const o=f(t,e),i=Object.values(this.hubDevices).find(t=>t.name==o);i?s(i):(this.attachCallbacks.on(t=>t.name==o&&(console.log(`device on portId ${t.portId} is ready`),s(t),!0)),await this.createVirtualPort(t,e))})}async sendBuffer(t){await this.charac.writeValueWithoutResponse(t)}sendMsg(t,...e){return b("sendMsg",_[t],e),this.sendBuffer(D(t,e))}async setName(t){const e=Array.from(t).map(t=>t.charCodeAt(0));b("name",e),await this.sendMsg(u.HUB_PROPERTIES,T.ADVERTISING_NAME,1,e),this.name=t}getPortIdFromName(t){for(const e of Object.values(this.hubDevices))if(e.name==t)return e.portId}createVirtualPort(t,e){return this.sendMsg(u.VIRTUAL_PORT_SETUP,1,t,e)}shutdown(){return this.sendMsg(u.HUB_ACTIONS,1)}getHubDevices(){return Object.values(this.hubDevices)}async readDeviceInfo(){for(const t of this.getHubDevices())await t.readInfo()}getDevice(t){return this.hubDevices[t]}async getPortInformation(t){const e=await this.getPortInformationRequest(t),{count:s,output:o,input:i,capabilities:a}=e,n=[];for(let e=0;e<s;e++){const s={};let a;s.mode=0,a=await this.getPortModeInformationRequest(t,e,d.NAME),s.name=a.name,s[(a=await this.getPortModeInformationRequest(t,e,d.RAW)).type]={min:a.min,max:a.max},s[(a=await this.getPortModeInformationRequest(t,e,d.SI)).type]={min:a.min,max:a.max},a=await this.getPortModeInformationRequest(t,e,d.SYMBOL),s.unit=a.symbol,a=await this.getPortModeInformationRequest(t,e,d.VALUE_FORMAT);const{numValues:r,dataType:c,totalFigures:l,decimals:h}=a;s[a.type]={numValues:r,dataType:c,totalFigures:l,decimals:h},i>>e&1&&(s.mode|=1),o>>e&1&&(s.mode|=2),n.push(s)}return{modes:n,capabilities:a}}getPortInformationRequest(t){return new Promise(async e=>{await this.sendMsg(u.PORT_INFORMATION_REQUEST,t,1),this.portCmdCallback[t]=e})}getPortModeInformationRequest(t,e,s){return new Promise(async o=>{await this.sendMsg(u.PORT_MODE_INFORMATION_REQUEST,t,e,s),this.portCmdCallback[t]=o})}decodeMsg(t){t.byteLength,t.getUint8(0);const e=t.getUint8(2);switch(b("decodeMsg",{msgType:_[e]}),e){case u.HUB_ATTACHED_IO:this.handlePortMsg(t);break;case u.GENERIC_ERROR_MESSAGES:this.handleGenericErrorMsg(t);break;case u.HUB_PROPERTIES:this.handleHubPropertyResponse(t);break;case u.HUB_ALERTS:this.handleHubAlerts(t);break;case u.PORT_OUTPUT_COMMAND_FEEDBACK:this.handlePortCommandFeedback(t);break;case u.PORT_MODE_INFORMATION:this.handlePortModeInformation(t);break;case u.PORT_INFORMATION:this.handlePortInformation(t);break;case u.PORT_VALUE_SINGLE:this.handlePortValueSingle(t)}}handlePortValueSingle(t){const e=t.getUint8(3),s=t.getUint8(0),o=this.hubDevices[e];console.log("handlePortValueSingle",{msgLen:s,portId:e}),o.handleValue(t)}handlePortModeInformation(t){const e=t.getUint8(3),s=t.getUint8(4),o=t.getUint8(5),i={portId:e,mode:s,type:c[o]};switch(o){case d.NAME:i.name=U(t.buffer.slice(6,t.byteLength));break;case d.RAW:case d.PCT:case d.SI:i.min=t.getFloat32(6,!0),i.max=t.getFloat32(10,!0);break;case d.SYMBOL:i.symbol=U(t.buffer.slice(6,t.byteLength));break;case d.VALUE_FORMAT:i.numValues=t.getUint8(6),i.dataType=["8bit","16bit","32bit","float"][t.getUint8(7)],i.totalFigures=t.getUint8(8),i.decimals=t.getUint8(9)}b("portModeInformation",i);const a=this.portCmdCallback[e];"function"==typeof a&&(a(i),delete this.portCmdCallback[e])}handlePortInformation(t){const e=t.getUint8(3);let s=t.getUint8(5);const o=t.getUint8(6),i=t.getUint16(7,!0),a=t.getUint16(9,!0);b(`Port ${e}, capabilities ${s}, total modes ${o}, \n                    input modes ${i}, output modes ${a}`);const n="output,input,logical combinable, logical synchronisable".split(",");let r=[];for(let t=0;t<4;t++)s>>t&1&&r.push(n[t]);const c={portId:e,capabilities:r.join(", "),count:o,input:i,output:a},l=this.portCmdCallback[e];"function"==typeof l&&l(c)}handleHubPropertyResponse(t){const e=t.getUint8(3),s=t.getUint8(4),o=t.getUint8(0);if(console.log("handleHubPropertyResponse",{property:r[e],msgLen:o,propType:s}),e==T.BATTERY_VOLTAGE){const e=t.getUint8(5);b({batteryLevel:e}),this.emit("batteryLevel",{batteryLevel:e})}else if(e==T.BUTTON_STATE){const e=t.getUint8(5);b({buttonState:e}),this.emit("buttonState",{buttonState:e})}else if(e==T.SYSTEM_TYPE_ID){const e=t.getUint8(5);b({systemType:e})}else if(e==T.PRIMARY_MAC_ADDRESS){const e=[];for(let s=0;s<6;s++)e.push(t.getUint8(5+s).toString(16).toLocaleUpperCase().padStart(2,"0"));b({bytes:e}),this.hubPropertyCallback(e.join(":"))}else if(e==T.ADVERTISING_NAME&&null!=this.hubPropertyCallback){const e=o-5,s=[];for(let o=0;o<e;o++)s.push(t.getUint8(5+o));const i=String.fromCharCode(...s);b({name:i}),this.hubPropertyCallback(i)}}handleGenericErrorMsg(t){const e=t.getUint8(3),s=t.getUint8(4);b({cmdType:e,errorCode:R[s]}),this.emit("error",{cmdType:e,errorCode:R[s]})}handleHubAlerts(t){const e=t.byteLength,s=t.getUint8(0),o=t.getUint8(3),i=t.getUint8(4),a=t.getUint8(5);b("handleHubAlerts",{bufferLen:e,msgLen:s,type:o,operation:i,payload:a}),this.emit("hubAlerts",{type:o,payload:a})}handlePortCommandFeedback(t){for(let e=3;e<t.byteLength;e+=2){const s=t.getUint8(e),o=t.getUint8(e+1),i=this.hubDevices[s];console.log("#handlePortCommandFeedback",{portId:s,feedback:o}),this.busy=!1,null!=i&&i.handleFeedback(o);const a=this.portCmdQueue.shift();a&&(console.log("# process queued cmd"),this.busy=!0,this.sendBuffer(a))}}handlePortMsg(t){const e=t.getUint8(3),o=t.getUint8(4),a=o?t.getUint16(5,!0):0,n=i[a]||"Unknown",r=s[o];if(console.log("handlePortMsg",{portId:e,eventName:r,deviceTypeName:n}),o==l.ATTACHED_IO){let t=y[a];t||(t=g);const s=new t(this,e,n);this.hubDevices[e]=s,this.attachCallbacks.emit(s),this.emit("attach",s)}else if(o==l.DETACHED_IO)delete this.hubDevices[e],this.emit("detach",{portId:e});else if(o==l.ATTACHED_VIRTUAL_IO){const s=t.getUint8(7),o=t.getUint8(8),i=new I(this,e,f(s,o));this.hubDevices[e]=i,this.attachCallbacks.emit(i),this.emit("attach",i)}}}$$.service.registerService("hub",{init:function(){return{connect:async function(){b("connect");const t=await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[P]}),e=new L;return await e.init(t),e},Color:S,PortMap:n,PortMapNames:E,DeviceMode:o,BrakingStyle:a,DeviceTypeNames:i,isMotor:function(t){return t instanceof O},isTachoMotor:function(t){return t instanceof A},isLed:function(t){return t instanceof C},isDoubleMotor:function(t){return t instanceof I},isColorSensor:function(t){return t instanceof N},isDistanceSensor:function(t){return t instanceof p}}}})}()},{"./CallbackEmitter":1,"./ColorSensor":2,"./Const":3,"./Device":4,"./DistanceSensor":5,"./DoubleMotor":6,"./Led":7,"./Motor":8,"./RgbLed":9,"./TachoMotor":10,"./TiltSensor":11,"./Util":12}]},{},[13]);
//# sourceMappingURL=hub.js.map
