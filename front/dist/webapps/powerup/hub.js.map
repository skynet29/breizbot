{"version":3,"sources":["../../../../node_modules/browser-pack/_prelude.js","lib/CallbackEmitter.js","lib/ColorSensor.js","lib/Const.js","lib/Device.js","lib/DistanceSensor.js","lib/DoubleMotor.js","lib/Led.js","lib/Motor.js","lib/RgbLed.js","lib/TachoMotor.js","lib/TiltSensor.js","lib/Util.js","lib/hub.js"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","[object Object]","this","callbacks","callback","push","data","console","log","splice","Device","hubDevice","portId","type","super","firstSegment","secondSegment","thirdSegment","setMode","writeDirectMode","getEnumName","$$","util","Event","DETACHED_IO","ATTACHED_IO","ATTACHED_VIRTUAL_IO","EventNames","MessageType","HUB_PROPERTIES","HUB_ACTIONS","HUB_ALERTS","HUB_ATTACHED_IO","GENERIC_ERROR_MESSAGES","HW_NETWORK_COMMANDS","FW_UPDATE_GO_INTO_BOOT_MODE","FW_UPDATE_LOCK_MEMORY","FW_UPDATE_LOCK_STATUS_REQUEST","FW_LOCK_STATUS","PORT_INFORMATION_REQUEST","PORT_MODE_INFORMATION_REQUEST","PORT_INPUT_FORMAT_SETUP_SINGLE","PORT_INPUT_FORMAT_SETUP_COMBINEDMODE","PORT_INFORMATION","PORT_MODE_INFORMATION","PORT_VALUE_SINGLE","PORT_VALUE_COMBINEDMODE","PORT_INPUT_FORMAT_SINGLE","PORT_INPUT_FORMAT_COMBINEDMODE","VIRTUAL_PORT_SETUP","PORT_OUTPUT_COMMAND","PORT_OUTPUT_COMMAND_FEEDBACK","MessageTypeNames","DeviceType","UNKNOWN","SIMPLE_MEDIUM_LINEAR_MOTOR","TRAIN_MOTOR","LIGHT","VOLTAGE_SENSOR","CURRENT_SENSOR","PIEZO_BUZZER","HUB_LED","TILT_SENSOR","MOTION_SENSOR","COLOR_DISTANCE_SENSOR","MEDIUM_LINEAR_MOTOR","MOVE_HUB_MEDIUM_LINEAR_MOTOR","MOVE_HUB_TILT_SENSOR","DUPLO_TRAIN_BASE_MOTOR","DUPLO_TRAIN_BASE_SPEAKER","DUPLO_TRAIN_BASE_COLOR_SENSOR","DUPLO_TRAIN_BASE_SPEEDOMETER","TECHNIC_LARGE_LINEAR_MOTOR","TECHNIC_XLARGE_LINEAR_MOTOR","TECHNIC_MEDIUM_ANGULAR_MOTOR","TECHNIC_LARGE_ANGULAR_MOTOR","TECHNIC_MEDIUM_HUB_GEST_SENSOR","REMOTE_CONTROL_BUTTON","REMOTE_CONTROL_RSSI","TECHNIC_MEDIUM_HUB_ACCELEROMETER","TECHNIC_MEDIUM_HUB_GYRO_SENSOR","TECHNIC_MEDIUM_HUB_TILT_SENSOR","TECHNIC_MEDIUM_HUB_TEMPERATURE_SENSOR","TECHNIC_COLOR_SENSOR","TECHNIC_DISTANCE_SENSOR","TECHNIC_FORCE_SENSOR","TECHNIC_3X3_COLOR_LIGHT_MATRIX","TECHNIC_SMALL_ANGULAR_MOTOR","MARIO_ACCELEROMETER","MARIO_BARCODE_SENSOR","MARIO_PANTS_SENSOR","TECHNIC_MEDIUM_ANGULAR_MOTOR_GREY","TECHNIC_LARGE_ANGULAR_MOTOR_GREY","VIRTUAL_DEVICE","DeviceTypeNames","ErrorCodeNames","ACK","MACK","BUFFER_OVERFLOW","TIMEOUT","COMMAND_NOT_RECOGNIZED","INVALID_USE","OVERCURRENT","INTERNAL_ERROR","HubPropertyPayload","ADVERTISING_NAME","BUTTON_STATE","FW_VERSION","HW_VERSION","RSSI","BATTERY_VOLTAGE","BATTERY_TYPE","MANUFACTURER_NAME","RADIO_FIRMWARE_VERSION","LWP_PROTOCOL_VERSION","SYSTEM_TYPE_ID","HW_NETWORK_ID","PRIMARY_MAC_ADDRESS","SECONDARY_MAC_ADDRESS","HW_NETWORK_FAMILY","HubPropertyPayloadNames","ModeInformationType","NAME","RAW","PCT","SI","SYMBOL","MAPPING","USED_INTERNALLY","MOTOR_BIAS","CAPABILITY_BITS","VALUE_FORMAT","ModeInformationTypeNames","PortMap","A","B","C","D","ACCELEROMETER","GYRO_SENSOR","PortMapNames","BrakingStyle","FLOAT","HOLD","BRAKE","DeviceMode","POWER","SPEED","ROTATION","ABSOLUTE","COLOR","RGB","TILT_POS","TILT_INPACT_COUNT","toUint32","deviceInfo","name","feedbackCallback","valueCallback","undefined","mode","waitEnd","notificationEnabled","waitStale","actions","availableActions","actionName","error","Promise","async","resolve","writePortCommand","feedback","deltaInterval","sendMsg","info","getPortInformation","msg","modes","range","mapRange","min","max","dataType","numValues","ret","val","offset","idx","getInt16","getInt8","getInt32","getFloat32","Math","trunc","value","decodeValue","testFn","cbk","topLeft","bottomLeft","topRight","bottomRight","Motor","toInt16","toInt32","maxPower","speed1","speed2","time","waitFeedback","brakingStyle","degrees","angle1","angle2","speed","brightness","power","setPower","execAction","color","g","b","calibrated","minAngle","maxAngle","calibrate","gotoRight","gotoLeft","gotoCenter","includes","isActionEnabled","angle","absPos","getAbsolutePosition","diff","abs","rotateDegrees","getValue","readInfo","wait","middleAngle","gotoAngle","waitTestValue","makeStallDetector","resetZero","floor","calibrationValue","count","yaw","pitch","roll","buff","Uint8Array","DataView","buffer","setInt16","Array","from","setInt32","setUint32","CallbackEmitter","DoubleMotor","TachoMotor","RgbLed","Led","TiltSensor","ColorSensor","DistanceSensor","Color","BLACK","PINK","PURPLE","BLUE","LIGHT_BLUE","CYAN","GREEN","YELLOW","ORANGE","RED","WHITE","NONE","LPF2_SERVICE_UUID","LPF2_CHARAC_UUID","abToString","buf","uint8buff","byteLength","String","fromCharCode","formatMsg","msgType","flat","msgLen","ArrayBuffer","uint8Buffer","set","getVirtualPortName","portId1","portId2","constructorMap","HubDevice","EventEmitter2","charac","portCmdQueue","portCmdCallback","hubDevices","busy","attachCallbacks","hubPropertyCallback","sendBuffer","device","server","gatt","connect","service","getPrimaryService","getCharacteristic","onCharacteristicvaluechanged","event","decodeMsg","target","addEventListener","removeEventListener","emit","startNotifications","Object","values","find","d","on","createVirtualPort","writeValueWithoutResponse","map","charCodeAt","getHubDevices","portInfo","getPortInformationRequest","output","input","capabilities","getPortModeInformationRequest","unit","symbol","totalFigures","decimals","getUint8","handlePortMsg","handleGenericErrorMsg","handleHubPropertyResponse","handleHubAlerts","handlePortCommandFeedback","handlePortModeInformation","handlePortInformation","handlePortValueSingle","handleValue","slice","cb","getUint16","availableCaps","split","cap","join","property","propType","batteryLevel","buttonState","systemType","bytes","toString","toLocaleUpperCase","padStart","nameLength","cmdType","errorCode","bufferLen","operation","payload","handleFeedback","shift","eventType","deviceTypeName","eventName","constructor","registerService","init","navigator","bluetooth","requestDevice","acceptAllDevices","optionalServices","isMotor","isTachoMotor","isLed","isDoubleMotor","isColorSensor","isDistanceSensor"],"mappings":"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","file":"hub.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","class CallbackEmitter {\n    constructor() {\n        this.callbacks = []\n    }\n\n    /**\n     * \n     * @param {(data) => boolean} callback \n     */\n    on(callback) {\n        this.callbacks.push(callback)\n    }\n\n    emit(data) {\n        console.log('emit', data)\n        let i = this.callbacks.length\n\n        while (i--) {\n            const callback = this.callbacks[i]\n            if (callback(data)) {\n                this.callbacks.splice(i, 1)\n            }\n        }\n    }\n}\n\nmodule.exports = CallbackEmitter","const Device = require('./Device')\n\n\nclass ColorSensor extends Device {\n    constructor(hubDevice, portId, type) {\n        super(hubDevice, portId, type)\n    }\n\n    async setBrightness (firstSegment, secondSegment, thirdSegment) {\n        await this.setMode(0x03, false)\n\n        return this.writeDirectMode(0x03, firstSegment, secondSegment, thirdSegment)\n    }\n}\n\nmodule.exports = ColorSensor","//@ts-check\n\nconst { getEnumName } = $$.util\n\nconst Event = {\n    DETACHED_IO: 0x00,\n    ATTACHED_IO: 0x01,\n    ATTACHED_VIRTUAL_IO: 0x02,\n}\nconst EventNames = getEnumName(Event)\n\nconst HubAlertType = {\n    LOW_VOLTAGE: 0x01,\n    HIGH_CURRENT: 0x02,\n    LOW_SIGNAL_STRENGTH: 0x03,\n    OVER_POWER_CONDITION: 0x04\n}\n\nconst MessageType = {\n    HUB_PROPERTIES: 0x01,\n    HUB_ACTIONS: 0x02,\n    HUB_ALERTS: 0x03,\n    HUB_ATTACHED_IO: 0x04,\n    GENERIC_ERROR_MESSAGES: 0x05,\n    HW_NETWORK_COMMANDS: 0x08,\n    FW_UPDATE_GO_INTO_BOOT_MODE: 0x10,\n    FW_UPDATE_LOCK_MEMORY: 0x11,\n    FW_UPDATE_LOCK_STATUS_REQUEST: 0x12,\n    FW_LOCK_STATUS: 0x13,\n    PORT_INFORMATION_REQUEST: 0x21,\n    PORT_MODE_INFORMATION_REQUEST: 0x22,\n    PORT_INPUT_FORMAT_SETUP_SINGLE: 0x41,\n    PORT_INPUT_FORMAT_SETUP_COMBINEDMODE: 0x42,\n    PORT_INFORMATION: 0x43,\n    PORT_MODE_INFORMATION: 0x44,\n    PORT_VALUE_SINGLE: 0x45,\n    PORT_VALUE_COMBINEDMODE: 0x46,\n    PORT_INPUT_FORMAT_SINGLE: 0x47,\n    PORT_INPUT_FORMAT_COMBINEDMODE: 0x48,\n    VIRTUAL_PORT_SETUP: 0x61,\n    PORT_OUTPUT_COMMAND: 0x81,\n    PORT_OUTPUT_COMMAND_FEEDBACK: 0x82,\n}\n\n\n\nconst MessageTypeNames = getEnumName(MessageType)\n\nconst DeviceType = {\n    UNKNOWN: 0,\n    SIMPLE_MEDIUM_LINEAR_MOTOR: 1,\n    TRAIN_MOTOR: 2,\n    LIGHT: 8,\n    VOLTAGE_SENSOR: 20,\n    CURRENT_SENSOR: 21,\n    PIEZO_BUZZER: 22,\n    HUB_LED: 23,\n    TILT_SENSOR: 34,\n    MOTION_SENSOR: 35,\n    COLOR_DISTANCE_SENSOR: 37,\n    MEDIUM_LINEAR_MOTOR: 38,\n    MOVE_HUB_MEDIUM_LINEAR_MOTOR: 39,\n    MOVE_HUB_TILT_SENSOR: 40,\n    DUPLO_TRAIN_BASE_MOTOR: 41,\n    DUPLO_TRAIN_BASE_SPEAKER: 42,\n    DUPLO_TRAIN_BASE_COLOR_SENSOR: 43,\n    DUPLO_TRAIN_BASE_SPEEDOMETER: 44,\n    TECHNIC_LARGE_LINEAR_MOTOR: 46, // Technic Control+\n    TECHNIC_XLARGE_LINEAR_MOTOR: 47, // Technic Control+\n    TECHNIC_MEDIUM_ANGULAR_MOTOR: 48, // Spike Prime\n    TECHNIC_LARGE_ANGULAR_MOTOR: 49, // Spike Prime\n    TECHNIC_MEDIUM_HUB_GEST_SENSOR: 54,\n    REMOTE_CONTROL_BUTTON: 55,\n    REMOTE_CONTROL_RSSI: 56,\n    TECHNIC_MEDIUM_HUB_ACCELEROMETER: 57,\n    TECHNIC_MEDIUM_HUB_GYRO_SENSOR: 58,\n    TECHNIC_MEDIUM_HUB_TILT_SENSOR: 59,\n    TECHNIC_MEDIUM_HUB_TEMPERATURE_SENSOR: 60,\n    TECHNIC_COLOR_SENSOR: 61, // Spike Prime\n    TECHNIC_DISTANCE_SENSOR: 62, // Spike Prime\n    TECHNIC_FORCE_SENSOR: 63, // Spike Prime\n    TECHNIC_3X3_COLOR_LIGHT_MATRIX: 64, // Spike Essential\n    TECHNIC_SMALL_ANGULAR_MOTOR: 65, // Spike Essential\n    MARIO_ACCELEROMETER: 71,\n    MARIO_BARCODE_SENSOR: 73,\n    MARIO_PANTS_SENSOR: 74,\n    TECHNIC_MEDIUM_ANGULAR_MOTOR_GREY: 75, // Mindstorms\n    TECHNIC_LARGE_ANGULAR_MOTOR_GREY: 76, // Technic Control+\n    VIRTUAL_DEVICE: 100\n}\n\nconst DeviceTypeNames = getEnumName(DeviceType)\n\nconst ErrorCode = {\n    ACK: 0x01,\n    MACK: 0x02,\n    BUFFER_OVERFLOW: 0x03,\n    TIMEOUT: 0x04,\n    COMMAND_NOT_RECOGNIZED: 0x05,\n    INVALID_USE: 0x06,\n    OVERCURRENT: 0x07,\n    INTERNAL_ERROR: 0x08,\n}\n\nconst ErrorCodeNames = getEnumName(ErrorCode)\n\n\nconst HubPropertyPayload = {\n    ADVERTISING_NAME: 0x01,\n    BUTTON_STATE: 0x02,\n    FW_VERSION: 0x03,\n    HW_VERSION: 0x04,\n    RSSI: 0x05,\n    BATTERY_VOLTAGE: 0x06,\n    BATTERY_TYPE: 0x07,\n    MANUFACTURER_NAME: 0x08,\n    RADIO_FIRMWARE_VERSION: 0x09,\n    LWP_PROTOCOL_VERSION: 0x0A,\n    SYSTEM_TYPE_ID: 0x0B,\n    HW_NETWORK_ID: 0x0C,\n    PRIMARY_MAC_ADDRESS: 0x0D,\n    SECONDARY_MAC_ADDRESS: 0x0E,\n    HW_NETWORK_FAMILY: 0x0F\n}\n\nconst HubPropertyPayloadNames = getEnumName(HubPropertyPayload)\n\nconst ModeInformationType = {\n    NAME: 0x00,\n    RAW: 0x01,\n    PCT: 0x02,\n    SI: 0x03,\n    SYMBOL: 0x04,\n    MAPPING: 0x05,\n    USED_INTERNALLY: 0x06,\n    MOTOR_BIAS: 0x07,\n    CAPABILITY_BITS: 0x08,\n    VALUE_FORMAT: 0x80,\n}\n\nconst ModeInformationTypeNames = getEnumName(ModeInformationType)\n\nconst PortMap = {\n    \"A\": 0,\n    \"B\": 1,\n    \"C\": 2,\n    \"D\": 3,\n    \"HUB_LED\": 50,\n    \"CURRENT_SENSOR\": 59,\n    \"VOLTAGE_SENSOR\": 60,\n    \"ACCELEROMETER\": 97,\n    \"GYRO_SENSOR\": 98,\n    \"TILT_SENSOR\": 99\n}\n\nconst DeviceMode = {\n    POWER: 0x00,\n    SPEED: 0x01,\n    ROTATION: 0x02,\n    ABSOLUTE: 0x03,\n    COLOR: 0x00,\n    RGB: 0x01,\n    TILT_POS: 0x00,\n    TILT_INPACT_COUNT: 0x01\n}\n\nconst BrakingStyle = {\n    FLOAT: 0,\n    HOLD: 126,\n    BRAKE: 127\n}\n\nconst PortMapNames = getEnumName(PortMap)\n\nmodule.exports = {\n    MessageType,\n    MessageTypeNames,\n    Event,\n    EventNames,\n    BrakingStyle,\n    DeviceMode,\n    DeviceType,\n    DeviceTypeNames,\n    ModeInformationType,\n    ModeInformationTypeNames,\n    PortMap,\n    PortMapNames,\n    HubPropertyPayload,\n    HubPropertyPayloadNames,\n    ErrorCodeNames\n}","//@ts-check\n\nconst CallbackEmitter = require('./CallbackEmitter')\nconst { MessageType, PortMapNames } = require('./Const')\nconst { log, toUint32 } = require('./Util')\n\nconst deviceInfo = {}\n\nclass Device {\n    /**\n     * \n     * @param {HUB.HubDevice} hubDevice \n     * @param {number} portId \n     * @param {string} type \n     */\n    constructor(hubDevice, portId, type) {\n        this.hubDevice = hubDevice\n        this.portId = portId\n        this.type = type\n        this.name = PortMapNames[portId]\n        this.feedbackCallback = null\n        this.valueCallback = undefined\n        this.mode = undefined\n        this.waitEnd = false\n        this.notificationEnabled = false\n        this.waitStale = false\n        this.actions = []\n        this.availableActions = []\n\n    }\n\n    execAction(actionName) {\n        console.error(`action ${actionName} is not implemented`)\n    }\n\n    isActionEnabled(actionName) {\n        return true\n    }\n\n    /**\n     * \n     * @param {boolean} waitEnd \n     * @param  {...any} data \n     * @returns \n     */\n    async writePortCommand(waitEnd, ...data) {\n        this.waitEnd = waitEnd\n        return new Promise(async (resolve) => {\n            this.feedbackCallback = resolve\n            await this.hubDevice.writePortCommand(this.portId, data)\n        })  \n\n    }\n\n    handleFeedback(feedback) {\n        if (typeof this.feedbackCallback == 'function') {\n            if (feedback == 1 && !this.waitEnd) {\n                this.feedbackCallback()\n            }\n            else if (feedback == 10 && this.waitEnd) {\n                this.feedbackCallback()\n            }\n            else if (feedback == 44 && this.waitStale) {\n                this.waitStale  = false\n                this.feedbackCallback()\n            }\n            \n        }\n    }\n\n    /**\n     * \n     * @param {number} mode\n     * @param  {...any} data \n     * @returns \n     */\n    writeDirectMode(mode, ...data) {\n        log('writeDirectMode', this.portId, { mode })\n        return this.writePortCommand(true, 0x51, mode, data)\n    }\n\n    /**\n     * \n     * @param {number} mode \n     * @param {boolean} notificationEnabled \n     * @param {number} deltaInterval \n     * @returns \n     */\n    setMode(mode, notificationEnabled, deltaInterval = 1) {\n        console.log('setMode', this.portId, { mode, notificationEnabled })\n\n        this.mode = mode\n        this.notificationEnabled = notificationEnabled\n\n        return this.hubDevice.sendMsg(MessageType.PORT_INPUT_FORMAT_SETUP_SINGLE,\n            this.portId, mode, toUint32(deltaInterval), notificationEnabled ? 0x01 : 0)\n    }\n\n    async readInfo() {\n        let info = deviceInfo[this.type]\n        if (info == undefined) {\n            console.log('readInfo', this.portId)\n            info = await this.hubDevice.getPortInformation(this.portId)\n            deviceInfo[this.type] = info\n        }\n        return info\n    }\n\n    /**\n     * \n     * @param {DataView} msg \n     */\n    decodeValue(msg) {\n        const info = deviceInfo[this.type]\n        //console.log('decodeValue', this.type, deviceInfo)\n        if (info != undefined) {\n            const { VALUE_FORMAT, RAW, SI } = info.modes[this.mode]\n            const range = $$.util.mapRange(RAW.min, RAW.max, SI.min, SI.max)\n            const { dataType, numValues } = VALUE_FORMAT\n            const ret = []\n            let offset = 4\n            let val\n            console.log('decodeValue', {RAW, SI, dataType, numValues})\n            for (let idx = 0; idx < numValues; idx++) {\n                switch (dataType) {\n                    case '16bit':\n                        val = msg.getInt16(offset, true)\n                        offset += 2\n                        break;\n                    case '8bit':\n                        val = msg.getInt8(offset)\n                        offset += 1\n                        break;\n                    case '32bit':\n                        val = msg.getInt32(offset, true)\n                        offset += 4\n                        break;\n                    case 'float':\n                        val = msg.getFloat32(offset, true)\n                        offset += 4\n                        break;\n\n                }\n                console.log('val', val)\n                ret.push(Math.trunc(range(val)))\n            }\n            if (ret.length == 1) {\n                return ret[0]\n            }\n            return ret\n\n        }\n        else {\n            console.error('No info for this port')\n        }\n    }\n    /**\n     * \n     * @param {DataView} msg \n     */\n    handleValue(msg) {\n        const value = this.decodeValue(msg)\n        //console.log('handleValue', this.portId, value, typeof this.valueCallback)\n\n        if (value != undefined && typeof this.valueCallback == 'function') {\n            this.valueCallback(value)\n        }\n    }\n\n\n    /**\n     * \n     * @param {number} mode \n     * @returns \n    */\n    async getValue(mode) {\n        console.log('getValue', this.portId, { mode })\n\n        await this.setMode(mode, false)\n        return new Promise(async (resolve) => {\n            this.valueCallback = (data) => {\n                console.log('value', data)\n                resolve(data)\n                return true\n            }\n            await this.hubDevice.sendMsg(MessageType.PORT_INFORMATION_REQUEST, this.portId, 0x00)\n\n        })\n    }\n\n    /**\n     * \n     * @param {number} mode \n     * @param {(data) => Promise<boolean>} testFn \n     * @returns \n     */\n    async waitTestValue(mode, testFn) {\n        await this.setMode(mode, true)\n\n        const ret = await new Promise(async (resolve) => {\n            this.valueCallback = async (value) => {\n                //console.log('waitTestValue', value)\n                const ret = testFn(value)\n                if (ret) {\n                    log('waitTestValue OK')\n                    //await this.setMode(mode, false)\n                    resolve(value)\n                }\n            }\n\n        })\n\n        this.valueCallback = null\n        await this.setMode(mode, false)\n        return ret\n    }\n\n    async subscribe(mode, cbk, deltaInterval = 1) {\n        await this.setMode(mode, true, deltaInterval)\n        this.valueCallback = async (data) => {\n            await cbk(data)\n        }\n    }\n\n    async unsubscribe() {\n        if (this.notificationEnabled) {\n            this.setMode(this.mode, false)\n        }\n    }\n\n}\n\nmodule.exports = Device","const Device = require('./Device')\n\n\nclass DistanceSensor extends Device {\n    constructor(hubDevice, portId, type) {\n        super(hubDevice, portId, type)\n    }\n\n    async setBrightness (topLeft, bottomLeft, topRight, bottomRight) {\n        await this.setMode(0x05, false)\n\n        return this.writeDirectMode(0x05, topLeft, topRight, bottomLeft, bottomRight)\n    }\n}\n\nmodule.exports = DistanceSensor","//@ts-check\n\nconst Motor = require('./Motor')\nconst {BrakingStyle} = require('./Const')\nconst {toInt16, toInt32} = require('./Util')\n\nconst maxPower = 100\n\nclass DoubleMotor extends Motor {\n\n\n    constructor(hubDevice, portId, name) {\n        super(hubDevice, portId, 'Virtual Device')\n        this.name = name\n\n    }\n\n    /**\n     * \n     * @param {number} speed1 \n     * @param {number} speed2 \n     * @returns \n     */\n    setSpeed(speed1, speed2) {\n        return this.writePortCommand(true, 0x08, speed1, speed2, maxPower, 0)\n    }\n\n    setSpeedForTime(speed1, speed2, time, waitFeedback = false, brakingStyle = BrakingStyle.BRAKE) {\n\n        console.log('setSpeedForTime', this.portId, { speed1, speed2, time, waitFeedback, brakingStyle })\n        return this.writePortCommand(waitFeedback, 0x0A, toInt16(time), speed1, speed2, maxPower, brakingStyle)\n    }\n\n    rotateDegrees(degrees, speed1, speed2, waitFeedback, brakingStyle = BrakingStyle.BRAKE) {\n        console.log('rotateDegrees', this.portId, { degrees, speed1, speed2, waitFeedback, brakingStyle })\n        return this.writePortCommand(waitFeedback, 0x0C, toInt32(degrees), speed1, speed2, maxPower, brakingStyle)\n    }\n\n    gotoAngle(angle1, angle2, speed, waitFeedback, brakingStyle = BrakingStyle.BRAKE) {\n        console.log('gotoAngle', this.portId, { angle1, angle2, speed, waitFeedback, brakingStyle })\n\n        return this.writePortCommand(waitFeedback, 0x0E, toInt32(angle1), toInt32(angle2), speed, maxPower, brakingStyle)\n    }\n}\n\nmodule.exports = DoubleMotor","//@ts-check\n\nconst Device = require('./Device')\nconst {PortMapNames, DeviceMode} = require('./Const')\n\nclass Led extends Device {\n\n    /**\n    * \n    * @param {HubDevice} hubDevice \n    * @param {number} portId \n    */\n    constructor(hubDevice, portId, type) {\n        super(hubDevice, portId, type)\n\n    }\n\n    setBrightness(brightness) {\n        console.log('setBrightness', this.portId, { brightness })\n        return this.writeDirectMode(DeviceMode.POWER, brightness)\n    }\n\n\n}\n\nmodule.exports = Led","//@ts-check\n\nconst Device = require('./Device')\nconst { PortMapNames, DeviceMode } = require('./Const')\n\nconst maxPower = 100\n\nclass Motor extends Device {\n\n    /**\n     * \n     * @param {HubDevice} hubDevice \n     * @param {number} portId \n     */\n    constructor(hubDevice, portId, type) {\n        super(hubDevice, portId, type)\n\n        this.availableActions = ['FWD', 'BKD', 'STOP']\n\n        this.power = 50\n    }\n\n    execAction(actionName) {\n        switch (actionName) {\n            case 'FWD':\n                return this.setPower(this.power)\n            case 'BKD':\n                return this.setPower(-this.power)\n            case 'STOP':\n                return this.setPower(0)\n            default:\n                return super.execAction(actionName)\n        }\n\n    }\n\n    async setPower(power, waitStale = false) {\n        console.log('setPower', this.portId, { power, waitStale })\n        await this.writeDirectMode(DeviceMode.POWER, power)\n\n        this.waitStale = true\n\n        if (waitStale) {\n            await new Promise(async (resolve) => {\n                this.feedbackCallback = resolve\n            })\n        }\n\n\n    }\n\n\n}\n\nmodule.exports = Motor","//@ts-check\n\nconst Device = require('./Device')\nconst {PortMapNames} = require('./Const')\n\nconst DeviceMode = {\n    COLOR: 0x00,\n    RGB: 0x01\n}\n\nclass RgbLed extends Device {\n\n    /**\n    * \n    * @param {HubDevice} hubDevice \n    * @param {number} portId \n    */\n    constructor(hubDevice, portId, type) {\n        super(hubDevice, portId, type)\n\n    }\n\n    async setColor(color) {\n        console.log('setColor', this.portId, { color })\n        await this.setMode(DeviceMode.COLOR, false)\n        return this.writeDirectMode(DeviceMode.COLOR, color)\n    }\n\n    async setRGBColor(r, g, b) {\n        console.log('setColor', this.portId, { r, g, b })\n        await this.setMode(DeviceMode.RGB, false)\n        return this.writeDirectMode(DeviceMode.RGB, r, g, b)\n    }\n}\n\nmodule.exports = RgbLed","//@ts-check\n\nconst Motor = require('./Motor')\nconst { PortMapNames, DeviceMode, BrakingStyle } = require('./Const')\nconst { toInt32, toInt16 } = require('./Util')\n\nconst maxPower = 100\n\n\nclass TachoMotor extends Motor {\n\n    /**\n     * \n     * @param {HubDevice} hubDevice \n     * @param {number} portId \n     */\n    constructor(hubDevice, portId, type) {\n        super(hubDevice, portId, type)\n        this.calibrated = false\n        this.minAngle = 0\n        this.maxAngle = 0\n        this.availableActions.push(...['CALIBRATE', 'RIGHT', 'CENTER', 'LEFT'])\n    }\n\n    execAction(actionName) {\n        switch (actionName) {\n            case 'CALIBRATE':\n                return this.calibrate()\n            case 'RIGHT':\n                return this.gotoRight()\n            case 'LEFT':\n                return this.gotoLeft()\n            case 'CENTER':\n                return this.gotoCenter()\n            default:\n                return super.execAction(actionName)\n        }\n\n    }\n\n    isActionEnabled(actionName) {\n        if (['RIGHT', 'LEFT', 'CENTER'].includes(actionName)) {\n            return this.calibrated\n        }\n\n        return super.isActionEnabled(actionName)\n    }\n\n    setSpeed(speed) {\n        console.log('#setSpeed', this.portId, { speed })\n        if (speed == 0) {\n            return this.setPower(0)\n        }\n        return this.writePortCommand(true, 0x07, speed, maxPower, 0)\n    }\n\n    rotateDegrees(degrees, speed, waitEnd, brakingStyle = BrakingStyle.BRAKE) {\n        console.log('rotateDegrees', this.portId, { degrees, speed, waitEnd, brakingStyle })\n        return this.writePortCommand(waitEnd, 0x0B, toInt32(degrees), speed, maxPower, brakingStyle)\n    }\n\n    /**\n     * \n     * @param {number} angle \n     * @param {number} speed \n     * @param {boolean} waitEnd \n     * @param {number} brakingStyle \n     * @returns \n     */\n    gotoAngle(angle, speed, waitEnd, brakingStyle = BrakingStyle.BRAKE) {\n        console.log('gotoAngle', this.portId, { angle, speed, waitEnd, brakingStyle })\n\n        return this.writePortCommand(waitEnd, 0x0D, toInt32(angle), speed, maxPower, brakingStyle)\n    }\n\n    async gotoAbsPosition(angle, speed, waitEnd, brakingStyle = BrakingStyle.BRAKE) {\n        const absPos = await this.getAbsolutePosition()\n        console.log('gotoAbsPosition', this.portId, { angle, absPos, speed, waitEnd, brakingStyle })\n\n        let diff = angle - absPos\n        if (diff < 0) {\n            speed = -speed\n        }\n        diff = Math.abs(diff)\n        return this.rotateDegrees(diff, speed, waitEnd, brakingStyle)\n\n    }\n\n    setSpeedForTime(speed, time, waitEnd = false, brakingStyle = BrakingStyle.BRAKE) {\n\n        console.log('setSpeedForTime', this.portId, { speed, time, waitEnd, brakingStyle })\n        return this.writePortCommand(waitEnd, 0x09, toInt16(time), speed, maxPower, brakingStyle)\n    }\n\n    resetZero() {\n        console.log('resetZero', this.portId)\n        return this.writeDirectMode(DeviceMode.ROTATION, 0x00, 0x00, 0x00, 0x00)\n    }\n\n    getSpeed() {\n        return this.getValue(DeviceMode.SPEED)\n    }\n\n    getPosition() {\n        return this.getValue(DeviceMode.ROTATION)\n    }\n\n    async getAbsolutePosition() {\n        const angle = await this.getValue(DeviceMode.ABSOLUTE)\n        return (angle < 0) ? angle + 360 : angle\n    }\n\n\n    async calibrate(power = 30) {\n        console.log('calibrate')\n        await this.readInfo()\n\n        await this.setPower(-power, true)\n\n        await $$.util.wait(1000)\n\n        this.minAngle = await this.getValue(DeviceMode.ROTATION);\n\n        //await this.setPower(0)\n\n\n        await this.setPower(power, true)\n\n        await $$.util.wait(1000)\n\n        this.maxAngle = await this.getValue(DeviceMode.ROTATION);\n        console.log({ minAngle: this.minAngle, maxAngle: this.maxAngle })\n\n        this.calibrated = true\n        this.gotoCenter()\n\n        //await this.setPower(0)\n\n    }\n\n    async gotoCenter() {\n        if (this.calibrated) {\n            const middleAngle = (this.maxAngle + this.minAngle) / 2\n            await this.gotoAngle(middleAngle, 10, true)\n        }\n        else {\n            console.error('Motor not calibrated')\n        }\n\n    }\n\n    async gotoLeft() {\n        if (this.calibrated) {\n            await this.gotoAngle(this.maxAngle, 10, true)\n        }\n        else {\n            console.error('Motor not calibrated')\n        }\n    }\n\n    async gotoRight() {\n        if (this.calibrated) {\n            await this.gotoAngle(this.minAngle, 10, true)\n        }\n        else {\n            console.error('Motor not calibrated')\n        }\n    }\n\n    async calibrate3(power = 30) {\n        console.log('calibrate')\n        await this.setPower(-power)\n\n        const minAngle = await this.waitTestValue(\n            DeviceMode.ROTATION,\n            makeStallDetector()\n        )\n\n\n        await this.setPower(0)\n        console.log({ minAngle })\n\n\n        await this.setPower(power)\n\n        const maxAngle = await this.waitTestValue(\n            DeviceMode.ROTATION,\n            makeStallDetector()\n        )\n\n        await this.setPower(0)\n        console.log({ minAngle, maxAngle })\n\n    }\n\n    async calibrate2() {\n\n        console.log('calibrate', this.portId)\n        this.setPower(50)\n        await this.waitTestValue(DeviceMode.SPEED, (value) => value > 10)\n        await this.waitTestValue(DeviceMode.SPEED, (value) => value == 0)\n\n\n        this.setPower(0)\n\n        await $$.util.wait(1000)\n\n        // await this.hubDevice.setPortFormat(this.portId, DeviceMode.ROTATION)\n        // let value = await this.hubDevice.getPortValue(this.portId)\n        // console.log(value)\t\n\n        await this.resetZero()\n\n\n        this.setPower(-50)\n        await this.waitTestValue(DeviceMode.SPEED, (value) => Math.abs(value) > 10)\n        await this.waitTestValue(DeviceMode.SPEED, (value) => value == 0)\n\n        this.setPower(0)\n        const value = await this.getValue(DeviceMode.ROTATION)\n        console.log(value)\n        const offset = Math.floor(value / 2)\n        console.log({ offset })\n        await this.gotoAngle(offset, 10, true)\n        await this.resetZero()\n        this.calibrationValue = Math.abs(offset)\n    }\n\n}\n\nmodule.exports = TachoMotor","//@ts-check\n\nconst Device = require('./Device')\nconst { DeviceMode } = require('./Const')\nconst {toInt32} = require('./Util')\n\n\nclass TiltSensor extends Device {\n    constructor(hubDevice, portId, type) {\n        super(hubDevice, portId, type)\n    }\n\n    getImpactCount() {\n        return this.getValue(DeviceMode.TILT_INPACT_COUNT)\n    }\n\n    setImpactCount(count) {\n        return this.writeDirectMode(DeviceMode.TILT_INPACT_COUNT, toInt32(count))\n    }\n\n    /**\n     * \n     * @param {DataView} msg \n     */\n    decodeValue(msg) {\n        /**@type {Array<number>} */\n        const value = super.decodeValue(msg)\n\n        if (this.mode == DeviceMode.TILT_POS) {\n            const [yaw, pitch, roll] = value\n            return { yaw, pitch, roll }\n        }\n\n        return value\n    }\n}\n\nmodule.exports = TiltSensor\n","//@ts-check\n\n/**\n  * \n  * @param {number} val \n  * @returns {Array}\n  */\nfunction toInt16(val) {\n    const buff = new Uint8Array(2)\n    const view = new DataView(buff.buffer)\n    view.setInt16(0, val, true)\n    return Array.from(buff)\n}\n\n/**\n * \n * @param {number} val \n * @returns {Array}\n */\nfunction toInt32(val) {\n    const buff = new Uint8Array(4)\n    const view = new DataView(buff.buffer)\n    view.setInt32(0, val, true)\n    return Array.from(buff)\n}\n\nfunction toUint32(val) {\n    const buff = new Uint8Array(4)\n    const view = new DataView(buff.buffer)\n    view.setUint32(0, val, true)\n    return Array.from(buff)\n}\n\nconst debug = false\n\nconst log = function (...data) {\n    if (debug) {\n        console.log.apply(console, data)\n    }\n}\n\nmodule.exports = {\n    toInt16,\n    toInt32,\n    toUint32,\n    log\n}","//@ts-check\n\n\n(function () {\n\n    const CallbackEmitter = require('./CallbackEmitter')\n    const { EventNames, DeviceMode, DeviceTypeNames, BrakingStyle, PortMap, HubPropertyPayloadNames, ModeInformationTypeNames, Event, DeviceType, PortMapNames, MessageType, HubPropertyPayload, ModeInformationType, ErrorCodeNames, MessageTypeNames } = require('./Const')\n    const Motor = require('./Motor')\n    const DoubleMotor = require('./DoubleMotor')\n    const TachoMotor = require('./TachoMotor');\n    const Device = require('./Device')\n    const RgbLed = require('./RgbLed')\n    const Led = require('./Led')\n    const TiltSensor = require('./TiltSensor')\n    const ColorSensor = require('./ColorSensor')\n    const DistanceSensor = require('./DistanceSensor')\n    const { log } = require('./Util')\n\n    const Color = {\n        BLACK: 0,\n        PINK: 1,\n        PURPLE: 2,\n        BLUE: 3,\n        LIGHT_BLUE: 4,\n        CYAN: 5,\n        GREEN: 6,\n        YELLOW: 7,\n        ORANGE: 8,\n        RED: 9,\n        WHITE: 10,\n        NONE: 255\n    }\n\n    const LPF2_SERVICE_UUID = '00001623-1212-efde-1623-785feabcd123'\n    const LPF2_CHARAC_UUID = '00001624-1212-efde-1623-785feabcd123'\n\n\n    /**\n     * \n     * @param {ArrayBuffer} buf \n     */\n    function abToString(buf) {\n        const uint8buff = new Uint8Array(buf)\n        let ret = \"\"\n        for (let i = 0; i < uint8buff.byteLength && uint8buff[i] != 0; i++) {\n            ret += String.fromCharCode(uint8buff[i])\n        }\n        return ret\n    }\n\n\n    /**\n     * \n     * @param  {...any} data \n     * @returns {ArrayBuffer}\n     */\n    function formatMsg(msgType, ...data) {\n        const buff = data.flat(4)\n        const msgLen = buff.length + 3\n        const buffer = new ArrayBuffer(msgLen)\n        const uint8Buffer = new Uint8Array(buffer)\n        uint8Buffer[0] = msgLen\n        uint8Buffer[1] = 0\n        uint8Buffer[2] = msgType\n        uint8Buffer.set(buff, 3)\n        return buffer\n    }\n\n\n    function getVirtualPortName(portId1, portId2) {\n        const portIdA = PortMapNames[portId1]\n        const portIdB = PortMapNames[portId2]\n        return `${portIdA}_${portIdB}`\n    }\n\n    const constructorMap = {\n        [DeviceType.TECHNIC_LARGE_LINEAR_MOTOR]: TachoMotor,\n        [DeviceType.TECHNIC_LARGE_ANGULAR_MOTOR_GREY]: TachoMotor,\n        [DeviceType.TECHNIC_XLARGE_LINEAR_MOTOR]: TachoMotor,\n        [DeviceType.TECHNIC_MEDIUM_HUB_TILT_SENSOR]: TiltSensor,\n        [DeviceType.HUB_LED]: RgbLed,\n        [DeviceType.LIGHT]: Led,\n        [DeviceType.TECHNIC_MEDIUM_ANGULAR_MOTOR_GREY]: TachoMotor,\n        [DeviceType.TECHNIC_COLOR_SENSOR]: ColorSensor,\n        [DeviceType.TECHNIC_DISTANCE_SENSOR]: DistanceSensor\n    }\n\n    /**@implements HUB.HubDevice */\n    class HubDevice extends EventEmitter2 {\n\n        constructor() {\n            super()\n            this.charac = null\n            this.portCmdQueue = {}\n            this.portCmdCallback = {}\n            /**@type {{[portId: string]: Device}} */\n            this.hubDevices = {}\n            this.busy = false\n            this.attachCallbacks = new CallbackEmitter()\n            this.portCmdQueue = []\n            this.hubPropertyCallback = null\n\n        }\n\n        async writePortCommand(portId, ...data) {\n\n            console.log('#writePortCommand', { portId, data })\n\n            const buffer = formatMsg(MessageType.PORT_OUTPUT_COMMAND, portId, 0x11, data)\n\n            if (!this.busy) {\n                this.busy = true\n                await this.sendBuffer(buffer)\n            }\n            else {\n                this.portCmdQueue.push(buffer)\n                console.log('# Busy ! wait feedback')\n\n            }\n\n        }\n\n\n\n        /**\n         * \n         * @param {BluetoothDevice} device \n         */\n        async init(device) {\n\n            const server = await device.gatt.connect()\n            log('Connected')\n            const service = await server.getPrimaryService(LPF2_SERVICE_UUID)\n            this.charac = await service.getCharacteristic(LPF2_CHARAC_UUID)\n\n            const onCharacteristicvaluechanged = (event) => {\n                this.decodeMsg(event.target.value)\n            }\n\n            device.addEventListener('gattserverdisconnected', () => {\n                console.log('onGattServerDisconnected', this)\n                this.charac.removeEventListener('characteristicvaluechanged', onCharacteristicvaluechanged)\n\n                this.charac = null\n                this.emit('disconnected')\n            })\n\n            this.charac.addEventListener('characteristicvaluechanged', onCharacteristicvaluechanged)\n            await this.charac.startNotifications()\n            await $$.util.wait(100)\n        }\n\n        async startNotification() {\n            await this.sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.BATTERY_VOLTAGE, 0x02)\n            await this.sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.SYSTEM_TYPE_ID, 0x05)\n            //await this.sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.PRIMARY_MAC_ADDRESS, 0x05)\n            //await this.sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.ADVERTISING_NAME, 0x05)\n            // const name = await this.getName()\n            // const address = await this.getPrimaryMACAddress()\n            // console.log('startNotification', {name, address})\n\n            await this.sendMsg(MessageType.HUB_ALERTS, 0x01, 0x01)\n            // await this.sendMsg(MessageType.HUB_ALERTS, 0x02, 0x01)\n            // await this.sendMsg(MessageType.HUB_ALERTS, 0x03, 0x01)\n            // await this.sendMsg(MessageType.HUB_ALERTS, 0x04, 0x01)\n\n        }\n\n        async getName() {\n            this.name = await new Promise(async (resolve) => {\n                this.hubPropertyCallback = resolve\n                await this.sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.ADVERTISING_NAME, 0x05)\n            })\n            return this.name\n\n        }\n\n        async getPrimaryMACAddress() {\n            const address = await new Promise(async (resolve) => {\n                this.hubPropertyCallback = resolve\n                await this.sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.PRIMARY_MAC_ADDRESS, 0x05)\n            })\n            return address\n\n        }\n\n\n        async getDblMotor(portId1, portId2) {\n            return new Promise(async (resolve) => {\n                const name = getVirtualPortName(portId1, portId2)\n                const device = Object.values(this.hubDevices).find((d) => d.name == name)\n                if (device) {\n                    resolve(device)\n\n                }\n                else {\n                    this.attachCallbacks.on((device) => {\n                        if (device.name == name) {\n                            console.log(`device on portId ${device.portId} is ready`)\n                            resolve(device)\n                            return true\n                        }\n                        return false\n                    })\n\n                    await this.createVirtualPort(portId1, portId2)\n                }\n            })\n        }\n\n        /**\n         * \n         * @param  {ArrayBuffer} buffer \n         */\n        async sendBuffer(buffer) {\n            //console.log('# sendBuffer', buffer)\n            await this.charac.writeValueWithoutResponse(buffer)\n            // console.log('OK')\n            // if (!this.busy) {\n            //     this.busy = true\n            //     await this.charac.writeValueWithoutResponse(buffer)\n            //     this.busy = false\n            //     if (this.cmdQueue.length > 0) {\n            //         console.log('process queued cmd')\n            //         await this.charac.writeValueWithoutResponse(this.cmdQueue.shift())\n            //     }\n\n            // }\n            // else {\n            //     console.log('busy! push in queue')\n            //     this.cmdQueue.push(buffer)\n            // }\n\n        }\n\n        /**\n         * \n         * @param {number} msgType\n         * @param  {...any} data \n         */\n        sendMsg(msgType, ...data) {\n            log('sendMsg', MessageTypeNames[msgType], data)\n            return this.sendBuffer(formatMsg(msgType, data))\n        }\n\n        /**\n         * \n         * @param {string} name \n         */\n        async setName(name) {\n            const data = Array.from(name).map(c => c.charCodeAt(0))\n            log('name', data)\n            await this.sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.ADVERTISING_NAME, 0x01, data)\n            this.name = name\n        }\n\n        /**\n         * \n         * @param {string} name \n         * @returns {number}\n         */\n        getPortIdFromName(name) {\n            for (const info of Object.values(this.hubDevices)) {\n                if (info.name == name) {\n                    return info.portId\n                }\n            }\n        }\n\n        /**\n         * @param {number} portId1\n         * @param {number} portId2\n         */\n        createVirtualPort(portId1, portId2) {\n\n            return this.sendMsg(MessageType.VIRTUAL_PORT_SETUP, 0x01, portId1, portId2)\n        }\n\n        shutdown() {\n            return this.sendMsg(MessageType.HUB_ACTIONS, 0x01)\n        }\n\n\n        getHubDevices() {\n            return Object.values(this.hubDevices)\n        }\n\n        async readDeviceInfo() {\n            for (const device of this.getHubDevices()) {\n                await device.readInfo()\n            }\n        }\n\n        getDevice(portId) {\n            return this.hubDevices[portId]\n        }\n\n        /**\n         * \n         * @param {number} portId \n         * @returns {Promise<HUB.PortInformation>}\n         */\n        async getPortInformation(portId) {\n\n            const portInfo = await this.getPortInformationRequest(portId)\n            const { count, output, input, capabilities } = portInfo\n            const modes = []\n            for (let mode = 0; mode < count; mode++) {\n                const data = {}\n                let ret\n                data.mode = 0\n                ret = await this.getPortModeInformationRequest(portId, mode, ModeInformationType.NAME)\n                data.name = ret.name\n                ret = await this.getPortModeInformationRequest(portId, mode, ModeInformationType.RAW)\n                data[ret.type] = { min: ret.min, max: ret.max }\n                ret = await this.getPortModeInformationRequest(portId, mode, ModeInformationType.SI)\n                data[ret.type] = { min: ret.min, max: ret.max }\n                ret = await this.getPortModeInformationRequest(portId, mode, ModeInformationType.SYMBOL)\n                data.unit = ret.symbol\n                ret = await this.getPortModeInformationRequest(portId, mode, ModeInformationType.VALUE_FORMAT)\n                const { numValues, dataType, totalFigures, decimals } = ret\n                data[ret.type] = { numValues, dataType, totalFigures, decimals }\n                if ((input >> mode) & 0x1) {\n                    data.mode |= 1\n                }\n                if ((output >> mode) & 0x1) {\n                    data.mode |= 2\n                }\n                modes.push(data)\n            }\n\n            return { modes, capabilities }\n        }\n\n\n        getPortInformationRequest(portId) {\n            return new Promise(async (resolve) => {\n                await this.sendMsg(MessageType.PORT_INFORMATION_REQUEST, portId, 0x01)\n                this.portCmdCallback[portId] = resolve\n            })\n        }\n\n\n\n        getPortModeInformationRequest(portId, mode, type) {\n            return new Promise(async (resolve) => {\n                await this.sendMsg(MessageType.PORT_MODE_INFORMATION_REQUEST, portId, mode, type)\n                this.portCmdCallback[portId] = resolve\n            })\n        }\n\n        /**\n         * \n         * @param {DataView} msg \n         */\n        decodeMsg(msg) {\n            const bufferLen = msg.byteLength\n            const msgLen = msg.getUint8(0)\n            const msgType = msg.getUint8(2)\n            log('decodeMsg', { msgType: MessageTypeNames[msgType] })\n            switch (msgType) {\n                case MessageType.HUB_ATTACHED_IO:\n                    this.handlePortMsg(msg)\n                    break;\n                case MessageType.GENERIC_ERROR_MESSAGES:\n                    this.handleGenericErrorMsg(msg)\n                    break;\n                case MessageType.HUB_PROPERTIES:\n                    this.handleHubPropertyResponse(msg)\n                    break\n                case MessageType.HUB_ALERTS:\n                    this.handleHubAlerts(msg);\n                    break\n                case MessageType.PORT_OUTPUT_COMMAND_FEEDBACK:\n                    this.handlePortCommandFeedback(msg)\n                    break;\n                case MessageType.PORT_MODE_INFORMATION:\n                    this.handlePortModeInformation(msg)\n                    break;\n                case MessageType.PORT_INFORMATION:\n                    this.handlePortInformation(msg)\n                    break;\n                case MessageType.PORT_VALUE_SINGLE:\n                    this.handlePortValueSingle(msg)\n                    break;\n            }\n        }\n\n\n        /**\n          * \n          * @param {DataView} msg \n          */\n        handlePortValueSingle(msg) {\n            //log('msg', msg)\n            const portId = msg.getUint8(3)\n            const msgLen = msg.getUint8(0)\n            const device = this.hubDevices[portId]\n            console.log('handlePortValueSingle', { msgLen, portId })\n            device.handleValue(msg)\n        }\n\n\n        /**\n         * \n         * @param {DataView} msg \n         */\n        handlePortModeInformation(msg) {\n            const portId = msg.getUint8(3)\n            const mode = msg.getUint8(4)\n            const type = msg.getUint8(5)\n            const data = { portId, mode, type: ModeInformationTypeNames[type] }\n            switch (type) {\n                case ModeInformationType.NAME:\n                    data.name = abToString(msg.buffer.slice(6, msg.byteLength))\n                    break\n                case ModeInformationType.RAW:\n                case ModeInformationType.PCT:\n                case ModeInformationType.SI:\n                    data.min = msg.getFloat32(6, true)\n                    data.max = msg.getFloat32(10, true)\n                    break\n                case ModeInformationType.SYMBOL:\n                    data.symbol = abToString(msg.buffer.slice(6, msg.byteLength))\n                    break\n                case ModeInformationType.VALUE_FORMAT:\n                    data.numValues = msg.getUint8(6)\n                    data.dataType = [\"8bit\", \"16bit\", \"32bit\", \"float\"][msg.getUint8(7)]\n                    data.totalFigures = msg.getUint8(8)\n                    data.decimals = msg.getUint8(9)\n                    break\n            }\n            log('portModeInformation', data)\n            const cb = this.portCmdCallback[portId]\n            if (typeof cb == 'function') {\n                cb(data)\n                delete this.portCmdCallback[portId]\n            }\n        }\n        /**\n         * \n         * @param {DataView} msg \n         */\n        handlePortInformation(msg) {\n            const portId = msg.getUint8(3)\n            let capabilities = msg.getUint8(5)\n            const count = msg.getUint8(6)\n            const input = msg.getUint16(7, true)\n            const output = msg.getUint16(9, true)\n            log(`Port ${portId}, capabilities ${capabilities}, total modes ${count}, \n                    input modes ${input}, output modes ${output}`)\n            const availableCaps = 'output,input,logical combinable, logical synchronisable'.split(',')\n            let cap = []\n            for (let i = 0; i < 4; i++) {\n                if ((capabilities >> i) & 1) {\n                    cap.push(availableCaps[i])\n                }\n            }\n            const data = { portId, capabilities: cap.join(', '), count, input, output }\n            const cb = this.portCmdCallback[portId]\n            if (typeof cb == 'function') {\n                cb(data)\n            }\n        }\n\n\n        /**\n         * \n         * @param {DataView} msg \n         * @returns \n         */\n        handleHubPropertyResponse(msg) {\n            const property = msg.getUint8(3)\n            const propType = msg.getUint8(4)\n            const msgLen = msg.getUint8(0)\n            console.log('handleHubPropertyResponse', { property: HubPropertyPayloadNames[property], msgLen, propType })\n            if (property == HubPropertyPayload.BATTERY_VOLTAGE) {\n                const batteryLevel = msg.getUint8(5)\n                log({ batteryLevel })\n                this.emit('batteryLevel', { batteryLevel })\n            }\n            else if (property == HubPropertyPayload.BUTTON_STATE) {\n                const buttonState = msg.getUint8(5)\n                log({ buttonState })\n                this.emit('buttonState', { buttonState })\n            }\n            else if (property == HubPropertyPayload.SYSTEM_TYPE_ID) {\n                const systemType = msg.getUint8(5)\n                log({ systemType })\n                //this.emit('buttonState', { buttonState })\n            }\n            else if (property == HubPropertyPayload.PRIMARY_MAC_ADDRESS) {\n                const bytes = []\n                for (let i = 0; i < 6; i++) {\n                    bytes.push(msg.getUint8(5 + i).toString(16).toLocaleUpperCase().padStart(2, '0'))\n                }\n                log({ bytes })\n                //this.emit('address', { address: bytes.join(':') })\n                this.hubPropertyCallback(bytes.join(':'))\n            }\n            else if (property == HubPropertyPayload.ADVERTISING_NAME) {\n                if (this.hubPropertyCallback != null) {\n                    const nameLength = msgLen - 5\n                    const bytes = []\n                    for (let i = 0; i < nameLength; i++) {\n                        bytes.push(msg.getUint8(5 + i))\n                    }\n                    const name = String.fromCharCode(...bytes)\n                    log({name})\n                    this.hubPropertyCallback(name)\n                }\n            }\n        }\n        /**\n         * \n         * @param {DataView} msg \n         */\n        handleGenericErrorMsg(msg) {\n            const cmdType = msg.getUint8(3)\n            const errorCode = msg.getUint8(4)\n            log({ cmdType, errorCode: ErrorCodeNames[errorCode] })\n            this.emit('error', { cmdType, errorCode: ErrorCodeNames[errorCode] })\n        }\n\n        /**\n         * \n         * @param {DataView} msg \n         */\n        handleHubAlerts(msg) {\n            const bufferLen = msg.byteLength\n            const msgLen = msg.getUint8(0)\n            const type = msg.getUint8(3)\n            const operation = msg.getUint8(4)\n            const payload = msg.getUint8(5)\n\n            log('handleHubAlerts', { bufferLen, msgLen, type, operation, payload })\n            this.emit('hubAlerts', { type, payload })\n        }\n\n        /**\n         * \n         * @param {DataView} msg \n         */\n        handlePortCommandFeedback(msg) {\n            for (let offset = 3; offset < msg.byteLength; offset += 2) {\n                const portId = msg.getUint8(offset)\n                const feedback = msg.getUint8(offset + 1)\n                const device = this.hubDevices[portId]\n                console.log('#handlePortCommandFeedback', { portId, feedback })\n                this.busy = false\n                if (device != undefined) {\n                    device.handleFeedback(feedback)\n                }\n\n                const buffer = this.portCmdQueue.shift()\n                if (buffer) {\n                    console.log('# process queued cmd')\n                    this.busy = true\n                    this.sendBuffer(buffer)\n                }\n\n            }\n        }\n        /**\n         * \n         * @param {DataView} msg \n         */\n        handlePortMsg(msg) {\n\n            const portId = msg.getUint8(3)\n            const eventType = msg.getUint8(4)\n            const type = eventType ? msg.getUint16(5, true) : 0\n            const deviceTypeName = DeviceTypeNames[type] || \"Unknown\"\n            const eventName = EventNames[eventType]\n\n            console.log('handlePortMsg', { portId, eventName, deviceTypeName })\n            if (eventType == Event.ATTACHED_IO) {\n\n                let constructor = constructorMap[type]\n                if (!constructor) {\n                    constructor = Device\n                }\n                const device = new constructor(this, portId, deviceTypeName)\n                this.hubDevices[portId] = device\n                this.attachCallbacks.emit(device)\n\n                this.emit('attach', device)\n            }\n            else if (eventType == Event.DETACHED_IO) {\n                delete this.hubDevices[portId]\n                this.emit('detach', { portId })\n            }\n            else if (eventType == Event.ATTACHED_VIRTUAL_IO) {\n                const portId1 = msg.getUint8(7)\n                const portId2 = msg.getUint8(8)\n\n                const device = new DoubleMotor(this, portId, getVirtualPortName(portId1, portId2))\n                this.hubDevices[portId] = device\n                this.attachCallbacks.emit(device)\n\n                this.emit('attach', device)\n            }\n        }\n    }\n\n    $$.service.registerService('hub', {\n\n        init: function () {\n\n            /**\n             * \n             * @param {Device} device \n             * @returns {boolean}\n             */\n            function isMotor(device) {\n                return device instanceof Motor\n            }\n\n            /**\n             * \n             * @param {Device} device \n             * @returns {boolean}\n             */\n            function isDoubleMotor(device) {\n                return device instanceof DoubleMotor\n            }\n\n            /**\n             * \n             * @param {Device} device \n             * @returns {boolean}\n             */\n            function isLed(device) {\n                return device instanceof Led\n            }\n\n            /**\n             * \n             * @param {Device} device \n             * @returns {boolean}\n             */\n            function isTachoMotor(device) {\n                return device instanceof TachoMotor\n            }\n\n            /**\n             * \n             * @param {Device} device \n             * @returns {boolean}\n             */\n            function isColorSensor(device) {\n                return device instanceof ColorSensor\n            }\n\n            /**\n             * \n             * @param {Device} device \n             * @returns {boolean}\n             */\n            function isDistanceSensor(device) {\n                return device instanceof DistanceSensor\n            }\n\n            /**\n             * \n             * @returns {Promise<HubDevice>}\n             */\n            async function connect() {\n                log('connect')\n\n                const device = await navigator.bluetooth.requestDevice({\n                    acceptAllDevices: true,\n                    optionalServices: [LPF2_SERVICE_UUID]\n                })\n\n                const hubDevice = new HubDevice()\n                await hubDevice.init(device)\n\n                return hubDevice\n\n                //await sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.BATTERY_TYPE, 0x05)\n                //await sendMsg(formatMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.BATTERY_VOLTAGE, 0x02))\n                //await sendMsg(MessageType.HUB_PROPERTIES, HubPropertyPayload.BUTTON_STATE, 0x02)\n            }\n\n            return {\n                connect,\n                Color,\n                PortMap,\n                PortMapNames,\n                DeviceMode,\n                BrakingStyle,\n                DeviceTypeNames,\n                isMotor,\n                isTachoMotor,\n                isLed,\n                isDoubleMotor,\n                isColorSensor,\n                isDistanceSensor\n            }\n        }\n    });\n\n})();\n\n\n"]}