$$.control.registerControl("friendsPage",{template:'<div bn-control="breizbot.friends" \n\tdata-show-selection="true"\n\tbn-iface="friends"\n\t></div>',props:{$pager:null},buttons:[{name:"call",icon:"fa fa-check"}],init:function(t){const{$pager:n}=this.props,e=$$.viewController(t);this.onAction=function(t){console.log("onAction",t);const s=e.scope.friends.getSelection();if(null==s)return void $$.ui.showAlert({title:"Error",content:"Please select a friend"});const{friendUserName:o,isConnected:a}=s;console.log("userName",o),a?n.popPage(o):$$.ui.showAlert({title:"Error",content:`User <strong>${o}</strong> is not connected`})}}}),$$.control.registerControl("rootPage",{template:'<div class="toolbar">\n\n\t\t<div>\n\t\t\t<p>Status: <span bn-text="status"></span></p>\n\t\t\t<p>Distant: <strong bn-text="distant"></strong></p>\t\t\t\t\t\t\n\t\t</div>\t\t\n\n\t\t<div>\n\t\t\t<button \n\t\t\t\ttitle="Call a friend" \n\t\t\t\tbn-event="click: onCall"\n\t\t\t\tbn-show="[\'ready\', \'disconnected\', \'refused\', \'canceled\'].includes(status)"\n\t\t\t\tclass="w3-btn w3-green"><i class="fa fa-user"></i></button>\n\n\t\t\t<button \n\t\t\t\tbn-event="click: onCancel"\n\t\t\t\tbn-show="status == \'calling\'"\n\t\t\t\tclass="w3-btn w3-blue">Cancel</button>\n\n\t\t\t<button \n\t\t\t\ttitle="Hangup" \n\t\t\t\tbn-event="click: onHangup"\n\t\t\t\tbn-show="status == \'connected\'"\n\t\t\t\tclass="w3-btn w3-red"><i class="fa fa-comment-slash"></i></button>\t\t\t\n\t\t</div>\n\n\n</div>\n\n<div class="content" bn-show="status == \'connected\'" bn-bind="content">\n\t<div bn-each="messages" class="messages">\n\t\t<div class="me" bn-show="$i.me">\n\t\t\t<div bn-text="$i.text" class="text"></div>\n\t\t\t<div bn-text="$i.time"></div>\t\t\t\n\t\t</div>\n\t\t<div class="you" bn-show="!$i.me">\n\t\t\t<div bn-text="$i.time"></div>\t\t\t\n\t\t\t<div bn-text="$i.text" class="text"></div>\n\t\t</div>\n\t</div>\n\t\n</div>\n\n<div class="footer" bn-show="status == \'connected\'">\n\t<form bn-event="submit: onSubmit">\n\t\t<input type="text" name="message" required="" placeholder="Write a message..." autocomplete="off">\n\t\t<button class="w3-button w3-blue" type="submit">Send</button>\n\t</form>\n</div>',props:{$pager:null},deps:["breizbot.rtc","breizbot.broker","breizbot.params"],init:function(t,n,e,s){const{$pager:o}=this.props,a={status:"ready",distant:"",messages:[]};null!=s.caller&&(a.status="connected",a.distant=s.caller,n.setRemoteClientId(s.clientId));const i=$$.viewController(t,{data:a,events:{onCall:function(t){console.log("onCall"),o.pushPage("friendsPage",{title:"Select a friend to tchat with",onReturn:function(t){n.call(t,"tchat","fa fa-comments").then(()=>{i.setData({status:"calling",distant:t})}).catch(t=>{$$.ui.showAlert({title:"Error",content:t.responseText})})}})},onCancel:function(t){n.cancel(i.model.distant).then(()=>{i.setData({status:"canceled",distant:""})}).catch(t=>{$$.ui.showAlert({title:"Error",content:t.responseText})})},onHangup:function(t){n.bye(),i.setData({status:"ready",distant:"",messages:[]})},onSubmit:function(t){t.preventDefault();const{message:e}=$(this).getFormData();$(this).resetForm(),console.log("onSubmit",e),n.sendData("tchat",e),i.model.messages.push({text:e,me:!0,time:(new Date).toLocaleTimeString()}),i.update(),i.scope.content.scrollToBottom()}}});e.onTopic("breizbot.rtc.accept",function(t){!0!==t.hist&&(console.log("msg",t),n.cancel(i.model.distant),n.setRemoteClientId(t.srcId),i.setData({status:"connected"}))}),e.onTopic("breizbot.rtc.deny",function(t){!0!==t.hist&&(console.log("msg",t),i.setData({status:"refused"}),n.cancel(i.model.distant))}),e.onTopic("breizbot.rtc.tchat",function(t){!0!==t.hist&&(i.model.messages.push({text:t.data,me:!1,time:new Date(t.time).toLocaleTimeString()}),i.update(),i.scope.content.scrollToBottom())}),e.onTopic("breizbot.rtc.bye",function(t){!0!==t.hist&&(console.log("msg",t),i.setData({status:"disconnected",distant:"",messages:[]}))}),e.on("ready",t=>{n.setLocalClientId(t.clientId),null!=s.caller&&n.accept()}),window.onbeforeunload=function(){"connected"==i.model.status&&n.bye()}}});