$$.control.registerControl("rootPage",{deps:["breizbot.rtc"],template:'<div bn-control="breizbot.rtc" \n\tbn-data="{\n\t\tappName:\'video\',\n\t\ticonCls: \'fa fa-phone fa-flip-vertical\',\n\t\ttitle: \'Select a friend to call\'\n\t}"\n\tbn-event="rtchangup: onHangup"\n>\n</div>\n<div class="video">\n\n\t  <video bn-bind="localVideo" autoplay muted playsinline bn-class="{reduced: isConnected}"></video>\n\t  <video bn-bind="remoteVideo" autoplay playsinline bn-show="isConnected"></video>\t\n</div>\t\t\n\n\n\n',init:function(e,n){n.on("status",e=>{t.setData({status:e.status})});const t=$$.viewController(e,{data:{status:"ready",isConnected:function(){return"connected"==this.status}},events:{onHangup:function(e){l()}}}),o={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},a=t.scope.localVideo.on("canplay",function(){console.log("canplay",this.videoHeight,this.videoWidth),t.setData({videoSize:this.videoWidth+"x"+this.videoHeight})}).get(0),i=t.scope.remoteVideo.get(0);let c,s,d;function r(){try{(c=new RTCPeerConnection(o)).onicecandidate=function(e){const t=e.candidate;t&&n.sendData("candidate",{label:t.sdpMLineIndex,id:t.sdpMid,candidate:t.candidate})},c.onaddstream=function(e){d=e.stream,i.srcObject=d}}catch(e){console.log("Failed to create PeerConnection, exception: "+e.message),alert("Cannot create RTCPeerConnection object.")}}function l(){c.close(),c=null}n.on("accept",async function(){r(),c.addStream(s);const e=await c.createOffer();c.setLocalDescription(e),n.sendData("offer",e)}),n.onData("candidate",function(e){const{label:n,candidate:t}=e;c.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:n,candidate:t}))}),n.onData("offer",async function(e){c.setRemoteDescription(new RTCSessionDescription(e));const t=await c.createAnswer();c.setLocalDescription(t),n.sendData("answer",t)}),n.onData("answer",function(e){c.setRemoteDescription(new RTCSessionDescription(e))}),n.on("bye",function(){l()}),n.on("ready",()=>{!async function(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});a.srcObject=e,s=e,n.isCallee&&(n.accept(),r(),c.addStream(s))}catch(e){console.log("error",e),n.isCallee&&n.deny()}}()}),this.onAppExit=function(){return n.exit()}}});