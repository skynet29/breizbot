$$.control.registerControl("friendsPage",{template:'<div bn-control="breizbot.friends" \n\tdata-show-selection="true"\n\tbn-iface="friends"\n\t></div>',props:{$pager:null},buttons:[{name:"call",icon:"fa fa-check"}],init:function(t){const{$pager:e}=this.props,n=$$.viewController(t);this.onAction=function(t){console.log("onAction",t);const o=n.scope.friends.getSelection();if(null==o)return void $$.ui.showAlert({title:"Error",content:"Please select a friend"});const{friendUserName:a,isConnected:i}=o;console.log("userName",a),i?e.popPage(a):$$.ui.showAlert({title:"Error",content:`User <strong>${a}</strong> is not connected`})}}}),$$.control.registerControl("rootPage",{props:{$pager:null},deps:["breizbot.rtc","breizbot.broker","breizbot.params"],template:'\n\n<div class="toolbar">\n\n\t\t<div>\n\t\t\t<p>Status: <span bn-text="status"></span></p>\n\t\t\t<p>Distant: <strong bn-text="distant"></strong></p>\t\t\t\t\t\t\n\x3c!-- \t\t\t<p>Video Size: <span bn-text="videoSize"></span></p>\t\t\t\t\t\t\n --\x3e\t\t</div>\t\t\n\n\t\t<div>\n\t\t\t<button \n\t\t\t\ttitle="Call a friend" \n\t\t\t\tbn-event="click: onCall"\n\t\t\t\tbn-show="[\'ready\', \'disconnected\', \'refused\', \'canceled\'].includes(status)"\n\t\t\t\tclass="w3-btn w3-green"><i class="fa fa-phone fa-flip-vertical"></i></button>\n\n\t\t\t<button \n\t\t\t\tbn-event="click: onCancel"\n\t\t\t\tbn-show="status == \'calling\'"\n\t\t\t\tclass="w3-btn w3-blue">Cancel</button>\n\n\t\t\t<button \n\t\t\t\ttitle="Hangup" \n\t\t\t\tbn-event="click: onHangup"\n\t\t\t\tbn-show="status == \'connected\'"\n\t\t\t\tclass="w3-btn w3-red"><i class="fa fa-phone-slash"></i></button>\t\t\t\n\t\t</div>\n\n\n</div>\n\n\t\n\n<div class="video">\n\n\t  <video bn-bind="localVideo" autoplay muted playsinline bn-class="{reduced: status == \'connected\'}"></video>\n\t  <video bn-bind="remoteVideo" autoplay playsinline bn-show="status == \'connected\'"></video>\t\n</div>\t\t\n\n\n\n',init:function(t,e,n,o){const{$pager:a}=this.props,i={status:"ready",distant:"",videoSize:""};null!=o.caller&&(i.status="connected",i.distant=o.caller,e.setRemoteClientId(o.clientId));const s=$$.viewController(t,{data:i,events:{onCall:function(t){console.log("onCall"),a.pushPage("friendsPage",{title:"Select a friend",onReturn:function(t){e.call(t,"video","fa fa-phone fa-flip-vertical").then(()=>{s.setData({status:"calling",distant:t})}).catch(t=>{$$.ui.showAlert({title:"Error",content:t.responseText})})}})},onCancel:function(t){e.cancel(s.model.distant).then(()=>{s.setData({status:"canceled",distant:""})}).catch(t=>{$$.ui.showAlert({title:"Error",content:t.responseText})})},onHangup:function(t){e.bye(),s.setData({status:"ready",distant:""}),f()}}}),c={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},l=s.scope.localVideo.on("canplay",function(){console.log("canplay",this.videoHeight,this.videoWidth),s.setData({videoSize:this.videoWidth+"x"+this.videoHeight})}).get(0),r=s.scope.remoteVideo.get(0);let d,u,p;function b(){console.log("createPeerConnection");try{(d=new RTCPeerConnection(c)).onicecandidate=function(t){const n=t.candidate;n&&e.sendData("candidate",{label:n.sdpMLineIndex,id:n.sdpMid,candidate:n.candidate})},d.onaddstream=function(t){console.log("onaddstream",t),p=t.stream,r.srcObject=p},console.log("Created RTCPeerConnnection")}catch(t){console.log("Failed to create PeerConnection, exception: "+t.message),alert("Cannot create RTCPeerConnection object.")}}function f(){d.close(),d=null}n.onTopic("breizbot.rtc.accept",function(t){!0!==t.hist&&(console.log("msg",t),e.cancel(s.model.distant),e.setRemoteClientId(t.srcId),s.setData({status:"connected"}),b(),d.addStream(u),d.createOffer().then(t=>{console.log("createOffer",t),d.setLocalDescription(t),e.sendData("offer",t)}))}),n.onTopic("breizbot.rtc.deny",function(t){!0!==t.hist&&(console.log("msg",t),s.setData({status:"refused"}),e.cancel(s.model.distant))}),n.onTopic("breizbot.rtc.candidate",function(t){if(!0===t.hist)return;console.log("msg",t);const{label:e,candidate:n}=t.data;d.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:e,candidate:n}))}),n.onTopic("breizbot.rtc.offer",function(t){!0!==t.hist&&(console.log("msg",t),d.setRemoteDescription(new RTCSessionDescription(t.data)),console.log("Sending answer to peer."),d.createAnswer().then(t=>{d.setLocalDescription(t),e.sendData("answer",t)}))}),n.onTopic("breizbot.rtc.answer",function(t){!0!==t.hist&&(console.log("msg",t),d.setRemoteDescription(new RTCSessionDescription(t.data)))}),n.onTopic("breizbot.rtc.bye",function(t){!0!==t.hist&&(console.log("msg",t),s.setData({status:"disconnected",distant:""}),f())}),n.on("ready",t=>{e.setLocalClientId(t.clientId),console.log("openMedia"),navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(t){console.log("localStream ready"),l.srcObject=t,u=t,null!=o.caller&&(e.accept(),b(),d.addStream(u))}).catch(function(t){console.log("error",t),null!=o.caller&&e.deny(),s.setData({distant:"",status:"failed"})})}),window.onbeforeunload=function(){null!=d&&e.bye()}}});