$$.control.registerControl("rootPage",{deps:["breizbot.rtc"],template:'<div bn-control="breizbot.rtc" \n\tbn-data="{\n\t\tappName:\'video\',\n\t\ticonCls: \'fa fa-phone fa-flip-vertical\',\n\t\ttitle: \'Select a friend to call\'\n\t}"\n\tbn-event="rtchangup: onHangup"\n>\n</div>\n<div class="video">\n\n\t  <video bn-bind="localVideo" autoplay muted playsinline bn-class="{reduced: status == \'connected\'}"></video>\n\t  <video bn-bind="remoteVideo" autoplay playsinline bn-show="status == \'connected\'"></video>\t\n</div>\t\t\n\n\n\n',init:function(e,n){n.on("status",e=>{t.setData({status:e.status})});const t=$$.viewController(e,{data:{status:"ready"},events:{onHangup:function(e){r()}}}),o={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},a=t.scope.localVideo.on("canplay",function(){console.log("canplay",this.videoHeight,this.videoWidth),t.setData({videoSize:this.videoWidth+"x"+this.videoHeight})}).get(0),i=t.scope.remoteVideo.get(0);let c,s,d;function l(){console.log("createPeerConnection");try{(c=new RTCPeerConnection(o)).onicecandidate=function(e){const t=e.candidate;t&&n.sendData("candidate",{label:t.sdpMLineIndex,id:t.sdpMid,candidate:t.candidate})},c.onaddstream=function(e){console.log("onaddstream",e),d=e.stream,i.srcObject=d},console.log("Created RTCPeerConnnection")}catch(e){console.log("Failed to create PeerConnection, exception: "+e.message),alert("Cannot create RTCPeerConnection object.")}}function r(){c.close(),c=null}n.on("accept",function(){l(),c.addStream(s),c.createOffer().then(e=>{console.log("createOffer",e),c.setLocalDescription(e),n.sendData("offer",e)})}),n.onData("candidate",function(e){const{label:n,candidate:t}=e;c.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:n,candidate:t}))}),n.onData("offer",function(e){c.setRemoteDescription(new RTCSessionDescription(e)),console.log("Sending answer to peer."),c.createAnswer().then(e=>{c.setLocalDescription(e),n.sendData("answer",e)})}),n.onData("answer",function(e){c.setRemoteDescription(new RTCSessionDescription(e))}),n.on("bye",function(){r()}),n.on("ready",()=>{console.log("openMedia"),navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(e){console.log("localStream ready"),a.srcObject=e,s=e,n.isCallee&&(n.accept(),l(),c.addStream(s))}).catch(function(e){console.log("error",e),n.isCallee&&n.deny()})}),this.onAppExit=function(){return n.bye()}}});